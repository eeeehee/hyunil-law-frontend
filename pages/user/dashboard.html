<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* [ê³µí†µ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size: 15px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }

        /* [ì‚¬ì´ë“œë°” ê³µí†µ ìŠ¤íƒ€ì¼] */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }
        
        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; padding: 50px; }
        .page-title { font-size: 26px; font-weight: 700; color: #1a1a1a; margin-bottom: 5px; }
        .page-subtitle { font-size: 15px; color: #666; }

        /* (ê¸°íƒ€ ëŒ€ì‹œë³´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) */
        .welcome-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; }
        .btn-admin { background-color: #ff4d4f; color: #fff; padding: 10px 20px; border-radius: 6px; font-weight: 700; font-size: 14px; display: none; box-shadow: 0 4px 10px rgba(255, 77, 79, 0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: #fff; padding: 25px 30px; border-radius: 12px; border: 1px solid #eee; display: flex; flex-direction: column; justify-content: center; min-height: 120px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; transition: 0.2s; }
        .stat-card:hover { transform: translateY(-3px); border-color: #2c5bf2; }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .stat-title { font-size: 15px; color: #888; font-weight: 600; }
        .stat-value { font-size: 32px; font-weight: 800; color: #1a1a1a; line-height: 1; }
        .quick-actions { display: flex; gap: 20px; margin-bottom: 40px; }
        .action-card { flex: 1; background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: 0.2s; }
        .action-card:hover { border-color: #1a1a1a; background-color: #fafafa; }
        .action-icon { width: 48px; height: 48px; background-color: #f5f7fa; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
        .action-text h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .analysis-container { background: #fff; border-radius: 12px; border: 1px solid #eee; padding: 30px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .analysis-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 15px; }
        .analysis-table th { background-color: #f9f9f9; padding: 14px; font-weight: 600; }
        .analysis-table td { padding: 14px; border-bottom: 1px solid #f0f0f0; }
        .analysis-table tr:last-child td { font-weight: 700; background-color: #fcfcfc; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: #fff; border-radius: 12px; border: 1px solid #eee; padding: 30px; min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .chart-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; width: 100%; text-align: left; }
        .chart-area { position: relative; width: 100%; height: 320px; }
        .badge-ceo { background: #1a1a1a; color: #fff; font-size: 11px; padding: 3px 8px; border-radius: 4px; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px; }
            .stats-grid, .quick-actions, .chart-grid { grid-template-columns: 1fr; flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Sidebar Skeleton (ê¹œë¹¡ì„ ë°©ì§€) -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a>
        </div>
        <div class="user-profile-area">
            <div class="user-name">ë¡œë”©ì¤‘...</div>
            <div class="user-email">...</div>
            <div class="user-role badge-staff">...</div>
        </div>
        <ul class="menu-list">
            <li><a href="../../pages/user/dashboard.html" class="menu-link active">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
            <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
            <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="../../pages/public/user_guide.html" class="menu-link">ğŸ“˜ ì´ìš© ê°€ì´ë“œ (FAQ)</a></li>
        </ul>
        <div class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</div>
    </nav>

    <main class="main-content">
        <div class="welcome-section">
            <div>
                <h2 class="page-title">ì•ˆë…•í•˜ì„¸ìš”, <span id="userName">...</span>ë‹˜! ğŸ‘‹</h2>
                <p class="page-subtitle"><span id="userCompany">...</span>ì˜ ë²•ë¥  ë¦¬ìŠ¤í¬ë¥¼ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <a href="../admin/admin.html" class="btn-admin" id="adminBtn">âš™ï¸ ê´€ë¦¬ì í˜ì´ì§€</a>
        </div>

        <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
            <div class="stat-card" onclick="location.href='board_list.html'">
                <div class="stat-header"><span class="stat-title">ì´ ìë¬¸ì‹ ì²­</span></div>
                <div class="stat-value" id="countTotal">-</div>
            </div>
            <div class="stat-card" onclick="location.href='board_list.html?status=pending'">
                <div class="stat-header"><span class="stat-title">ì ‘ìˆ˜ ëŒ€ê¸°</span></div>
                <div class="stat-value" id="countPending" style="color:#2c5bf2;">-</div>
            </div>
            <div class="stat-card" onclick="location.href='board_list.html?status=processing'">
                <div class="stat-header"><span class="stat-title">ë‹µë³€ ëŒ€ê¸°ì¤‘</span></div>
                <div class="stat-value" id="countProcessing" style="color:#ff9800;">-</div>
            </div>
            <div class="stat-card" onclick="location.href='board_list.html?status=done'">
                <div class="stat-header"><span class="stat-title">ë‹µë³€ ì™„ë£Œ</span></div>
                <div class="stat-value" id="countDone" style="color:#52c41a;">-</div>
            </div>
             <div class="stat-card" onclick="location.href='board_list.html?filter=followup'">
                <div class="stat-header"><span class="stat-title">ì¶”ê°€ ì§ˆë¬¸</span></div>
                <div class="stat-value" id="countFollowup" style="color:#722ed1;">-</div>
            </div>
        </div>

        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 15px;">ë¹ ë¥¸ ì‹¤í–‰</h3>
        <div class="quick-actions">
            <div class="action-card" onclick="location.href='board_write.html'">
                <div class="action-icon">âœï¸</div>
                <div class="action-text"><h3>ì„œë©´ ìë¬¸ ì‹ ì²­</h3><p>ë¬¸ì„œ ê²€í† , ë²•ë¥  ì„œë©´ ìë¬¸ì„ ì‹ ì²­í•©ë‹ˆë‹¤.</p></div>
            </div>
            <div class="action-card" onclick="location.href='../public/phone_consult.html'">
                <div class="action-icon">ğŸ“</div>
                <div class="action-text"><h3>ì „í™” ìƒë‹´ ì‹ ì²­</h3><p>ë³€í˜¸ì‚¬ì™€ ì§ì ‘ í†µí™” ìƒë‹´ì„ ì˜ˆì•½í•©ë‹ˆë‹¤.</p></div>
            </div>
            <div class="action-card" onclick="location.href='board_list.html'">
                <div class="action-icon">ğŸ“‚</div>
                <div class="action-text"><h3>ë‚´ì—­ í™•ì¸í•˜ê¸°</h3><p>ì§„í–‰ ì¤‘ì¸ ìë¬¸ê³¼ ì™„ë£Œëœ ë‚´ì—­ì„ í™•ì¸í•©ë‹ˆë‹¤.</p></div>
            </div>
        </div>

        <div class="analysis-container">
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">ğŸ“Š ìë¬¸ í˜„í™© ë¶„ì„</div>
            <table class="analysis-table">
                <thead><tr><th style="width:20%">êµ¬ë¶„</th><th style="width:15%">ì´ ê±´ìˆ˜</th><th>ê³„ì•½</th><th>ë…¸ë¬´</th><th>ì±„ê¶Œ</th><th>IP</th><th>ê¸°íƒ€</th></tr></thead>
                <tbody id="analysisTableBody"><tr><td colspan="7">ë°ì´í„° ë¶„ì„ ì¤‘...</td></tr></tbody>
            </table>
        </div>

        <div class="chart-grid">
            <div class="chart-box"><div class="chart-title">ë‚´ ë¶€ì„œ ë¶„ì•¼ë³„ ë¹„ì¤‘</div><div class="chart-area"><canvas id="myDeptChart"></canvas></div></div>
            <div class="chart-box" id="ownerChartBox" style="display:none;"><div class="chart-title"><span>ğŸ† ë¶€ì„œë³„ ìë¬¸ ë­í‚¹</span><span class="badge-ceo">CEO ì „ìš©</span></div><div class="chart-area"><canvas id="companyRankingChart"></canvas></div></div>
            <div class="chart-box" id="normalChartBox"><div class="chart-title">ğŸ¢ ì „ì‚¬ ëŒ€ë¹„ ìš°ë¦¬ ë¶€ì„œ ë¹„ì¤‘</div><div class="chart-area"><canvas id="compareChart"></canvas></div></div>
        </div>
    </main>

    <script type="module">
        import { auth, users, requireAuth, posts } from "../../js/api.js";
        import { renderClientSidebar } from "../../js/client_ui.js";

        (async () => {
            if (!requireAuth()) {
                location.href = "../../pages/public/login.html";
                return;
            }

            const user = auth.getCurrentUser();
            if (!user) {
                location.href = "../../pages/public/login.html";
                return;
            }

            try {
                const userData = await users.getMe();
                renderClientSidebar('dashboard', userData);

                // ì‚¬ìš©ì ì´ë¦„ê³¼ íšŒì‚¬ëª… í‘œì‹œ
                const userNameEl = document.getElementById('userName');
                const userCompanyEl = document.getElementById('userCompany');
                if (userNameEl) userNameEl.textContent = userData.managerName || 'ì‚¬ìš©ì';
                if (userCompanyEl) userCompanyEl.textContent = userData.companyName || 'íšŒì‚¬';

                // ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (master, admin, general_manager, lawyer ì ‘ê·¼ ê°€ëŠ¥)
                const adminBtn = document.getElementById('adminBtn');
                if (adminBtn) {
                    if (['master', 'admin', 'general_manager', 'lawyer'].includes(userData.role)) {
                        adminBtn.style.display = 'inline-flex';
                    } else {
                        adminBtn.style.display = 'none';
                    }
                }

                console.log('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ:', userData);

                // ìë¬¸ ì¹´ìš´íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
                await loadPostsCounts();

                // ìë¬¸ í˜„í™© ë¶„ì„ ë° ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                await loadAnalysisData(userData);

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì—ëŸ¬:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })();

        // ìë¬¸ ì¹´ìš´íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ê³„ì‚°)
        async function loadPostsCounts() {
            try {
                // ì‹œìŠ¤í…œ ì¹´í…Œê³ ë¦¬ ì œì™¸ (ìë¬¸ì´ ì•„ë‹Œ ìš”ì²­ë“¤)
                const EXCLUDED_CATEGORIES = [
                    'extra_usage_quote', 'payment_request', 'plan_change', 'payment_method',
                    'member_req', 'member_req_internal', 'member_req_admin', 'phone_log', 'guest'
                ];

                const postsData = await posts.getAll({ limit: 5000 }); // ëª¨ë“  ìë¬¸ ê°€ì ¸ì˜¤ê¸°
                const allPosts = (postsData.posts || []).filter(p => !EXCLUDED_CATEGORIES.includes(p.category));

                let pendingCount = 0;
                let processingCount = 0;
                let doneCount = 0;
                let followupCount = 0;

                allPosts.forEach(post => {
                    const status = post.status || 'pending';
                    const hasFollowup = post.content && post.content.includes('[FOLLOWUP_SEPARATOR]');

                    if (status === 'pending' || status === 'waiting') {
                        pendingCount++;
                    } else if (status === 'analyzing' || status === 'processing' || status === 'InProgress') {
                        processingCount++;
                    } else if (['done', 'completed', 'Completed'].includes(status)) {
                        doneCount++;
                    }

                    // ì¶”ê°€ ì§ˆë¬¸ì€ ìƒíƒœì™€ ë³„ê°œë¡œ ì¹´ìš´íŠ¸ë  ìˆ˜ ìˆìŒ
                    if (hasFollowup && !(['done', 'completed', 'Completed'].includes(status))) {
                       followupCount++;
                    }
                });

                document.getElementById('countTotal').textContent = allPosts.length;
                document.getElementById('countPending').textContent = pendingCount;
                document.getElementById('countProcessing').textContent = processingCount;
                document.getElementById('countDone').textContent = doneCount;
                document.getElementById('countFollowup').textContent = followupCount;

            } catch (error) {
                console.error('ìë¬¸ ì¹´ìš´íŠ¸ ë¡œë“œ ì—ëŸ¬:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œ ëª¨ë“  ì¹´ìš´íŠ¸ë¥¼ 0ìœ¼ë¡œ ì„¤ì •
                document.getElementById('countTotal').textContent = 0;
                document.getElementById('countPending').textContent = 0;
                document.getElementById('countProcessing').textContent = 0;
                document.getElementById('countDone').textContent = 0;
                document.getElementById('countFollowup').textContent = 0;
            }
        }

        // ìë¬¸ í˜„í™© ë¶„ì„ ë°ì´í„° ë¡œë“œ
        async function loadAnalysisData(userData) {
            try {
                // ì „ì²´ ê²Œì‹œê¸€ ì¡°íšŒ
                const postsData = await posts.getAll({ limit: 1000 });
                let allPosts = postsData.posts || [];

                // ì‹œìŠ¤í…œ ì¹´í…Œê³ ë¦¬ ì œì™¸ (ìë¬¸ì´ ì•„ë‹Œ ìš”ì²­ë“¤)
                const EXCLUDED_CATEGORIES = [
                    'extra_usage_quote',
                    'payment_request',
                    'plan_change',
                    'payment_method',
                    'member_req',
                    'member_req_internal',
                    'member_req_admin',
                    'phone_log'
                ];
                allPosts = allPosts.filter(post => !EXCLUDED_CATEGORIES.includes(post.category));

                console.log('ğŸ“Š ì „ì²´ ê²Œì‹œê¸€ ìˆ˜:', allPosts.length);

                // CEO ì—¬ë¶€ í™•ì¸
                const isCEO = ['master', 'admin', 'owner'].includes(userData.role);
                const myDepartment = userData.department || 'ë¶€ì„œ ë¯¸ì§€ì •';
                const myCompany = userData.companyName || '';

                // ì¹´í…Œê³ ë¦¬ ë§¤í•‘
                const categoryMap = {
                    'contract': 'ê³„ì•½',
                    'labor': 'ë…¸ë¬´',
                    'debt': 'ì±„ê¶Œ',
                    'ip': 'IP',
                    'default': 'ê¸°íƒ€'
                };

                // ë¶€ì„œë³„ ë°ì´í„° ì§‘ê³„
                const deptData = {};

                allPosts.forEach(post => {
                    const dept = post.userDepartment || post.department || 'ë¶€ì„œ ë¯¸ì§€ì •';
                    const category = post.category || 'default';

                    if (!deptData[dept]) {
                        deptData[dept] = {
                            total: 0,
                            contract: 0,
                            labor: 0,
                            debt: 0,
                            ip: 0,
                            default: 0
                        };
                    }

                    deptData[dept].total++;
                    if (category === 'contract') deptData[dept].contract++;
                    else if (category === 'labor') deptData[dept].labor++;
                    else if (category === 'debt') deptData[dept].debt++;
                    else if (category === 'ip') deptData[dept].ip++;
                    else deptData[dept].default++;
                });

                // í…Œì´ë¸” ë Œë”ë§
                renderAnalysisTable(deptData, myDepartment, isCEO);

                // ì°¨íŠ¸ ë Œë”ë§
                renderCharts(deptData, myDepartment, isCEO);

            } catch (error) {
                console.error('ë¶„ì„ ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
                document.getElementById('analysisTableBody').innerHTML = '<tr><td colspan="7" style="color:#ff4d4f;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // ë¶„ì„ í…Œì´ë¸” ë Œë”ë§
        function renderAnalysisTable(deptData, myDepartment, isCEO) {
            const tbody = document.getElementById('analysisTableBody');
            if (!tbody) return;

            let html = '';
            let totalRow = { total: 0, contract: 0, labor: 0, debt: 0, ip: 0, default: 0 };

            // CEOëŠ” ì „ì²´ ë¶€ì„œ, ì¼ë°˜ ì‚¬ìš©ìëŠ” ë³¸ì¸ ë¶€ì„œë§Œ
            const depts = isCEO ? Object.keys(deptData) : [myDepartment];

            depts.forEach(dept => {
                const data = deptData[dept] || { total: 0, contract: 0, labor: 0, debt: 0, ip: 0, default: 0 };

                html += `
                    <tr>
                        <td><strong>${dept}</strong></td>
                        <td><strong>${data.total}</strong></td>
                        <td>${data.contract}</td>
                        <td>${data.labor}</td>
                        <td>${data.debt}</td>
                        <td>${data.ip}</td>
                        <td>${data.default}</td>
                    </tr>
                `;

                totalRow.total += data.total;
                totalRow.contract += data.contract;
                totalRow.labor += data.labor;
                totalRow.debt += data.debt;
                totalRow.ip += data.ip;
                totalRow.default += data.default;
            });

            // í•©ê³„ í–‰
            if (isCEO) {
                html += `
                    <tr style="background:#f9f9f9; font-weight:700;">
                        <td>í•©ê³„</td>
                        <td>${totalRow.total}</td>
                        <td>${totalRow.contract}</td>
                        <td>${totalRow.labor}</td>
                        <td>${totalRow.debt}</td>
                        <td>${totalRow.ip}</td>
                        <td>${totalRow.default}</td>
                    </tr>
                `;
            }

            tbody.innerHTML = html || '<tr><td colspan="7">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }

        // ì°¨íŠ¸ ë Œë”ë§
        function renderCharts(deptData, myDepartment, isCEO) {
            const myData = deptData[myDepartment] || { total: 0, contract: 0, labor: 0, debt: 0, ip: 0, default: 0 };

            // 1. ë‚´ ë¶€ì„œ ë¶„ì•¼ë³„ ë¹„ì¤‘ (íŒŒì´ ì°¨íŠ¸)
            const myDeptCtx = document.getElementById('myDeptChart');
            if (myDeptCtx) {
                new Chart(myDeptCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ê³„ì•½', 'ë…¸ë¬´', 'ì±„ê¶Œ', 'IP', 'ê¸°íƒ€'],
                        datasets: [{
                            data: [myData.contract, myData.labor, myData.debt, myData.ip, myData.default],
                            backgroundColor: ['#2c5bf2', '#52c41a', '#fa8c16', '#722ed1', '#999']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // CEO ì „ìš© ì°¨íŠ¸
            if (isCEO) {
                document.getElementById('ownerChartBox').style.display = 'flex';
                document.getElementById('normalChartBox').style.display = 'none';

                // 2. ë¶€ì„œë³„ ìë¬¸ ë­í‚¹ (ë°” ì°¨íŠ¸)
                const rankingCtx = document.getElementById('companyRankingChart');
                if (rankingCtx) {
                    const depts = Object.keys(deptData).sort((a, b) => deptData[b].total - deptData[a].total);
                    const counts = depts.map(d => deptData[d].total);

                    new Chart(rankingCtx, {
                        type: 'bar',
                        data: {
                            labels: depts,
                            datasets: [{
                                label: 'ìë¬¸ ê±´ìˆ˜',
                                data: counts,
                                backgroundColor: '#2c5bf2'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } else {
                // ì¼ë°˜ ì‚¬ìš©ì ì°¨íŠ¸
                document.getElementById('ownerChartBox').style.display = 'none';
                document.getElementById('normalChartBox').style.display = 'flex';

                // 3. ì „ì‚¬ ëŒ€ë¹„ ìš°ë¦¬ ë¶€ì„œ ë¹„ì¤‘
                const compareCtx = document.getElementById('compareChart');
                if (compareCtx) {
                    const totalCompany = Object.values(deptData).reduce((sum, d) => sum + d.total, 0);
                    const otherDepts = totalCompany - myData.total;

                    new Chart(compareCtx, {
                        type: 'pie',
                        data: {
                            labels: [myDepartment, 'ë‹¤ë¥¸ ë¶€ì„œ'],
                            datasets: [{
                                data: [myData.total, otherDepts],
                                backgroundColor: ['#2c5bf2', '#e0e0e0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }
            }
        }

        window.handleLogout = async () => {
            await auth.logout();
            location.href = "../../index.html";
        };
    </script>
</body>
</html>
