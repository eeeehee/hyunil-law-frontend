<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ/êµ¬ë… ê´€ë¦¬ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input, select, textarea { font-family: inherit; }

        /* [ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ - client_ui.js ëŒ€ì‘] */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }
        
        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }

        .main-content { flex: 1; margin-left: 260px; padding: 60px 50px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; margin-bottom: 30px; }

        /* ì¹´ë“œ ë°•ìŠ¤ */
        .card-box { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f5f5f5; padding-bottom: 15px; }
        .card-title { font-size: 18px; font-weight: 700; color: #1a1a1a; }

        .plan-info-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .current-plan-name { font-size: 20px; font-weight: 800; color: #2c5bf2; }
        .plan-badge { font-size: 13px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }
        .badge-qa { background: #e6f7ff; color: #096dd9; border: 1px solid #91d5ff; }
        .badge-phone { background: #fff7e6; color: #d46b08; border: 1px solid #ffd591; }
        .plan-desc { font-size: 14px; color: #666; line-height: 1.6; }
        
        .btn-group-right { display: flex; gap: 10px; }
        .btn-change-plan { background: #fff; border: 1px solid #ddd; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-change-plan:hover { background: #f9f9f9; border-color: #bbb; }
        .btn-extra-pay { background: #fff; border: 1px solid #fa8c16; color: #fa8c16; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-extra-pay:hover { background: #fff7e6; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .history-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .history-table th { text-align: left; padding: 12px; border-bottom: 1px solid #eee; color: #888; font-weight: 600; background: #fafafa; }
        .history-table td { padding: 15px 12px; border-bottom: 1px solid #f5f5f5; color: #333; }
        .amount { font-weight: 700; color: #1a1a1a; }
        .st-scheduled { color: #fa8c16; font-weight: 700; }
        .st-paid { color: #52c41a; font-weight: 700; }
        .st-refund { color: #595959; font-weight: 700; }
        .st-cancel { color: #ff4d4f; font-weight: 700; }
        .st-overdue { color: #ff4d4f; font-weight: 700; }
        
        .btn-approve { background: #2c5bf2; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; }
        .btn-approve:hover { background: #1b42c4; }

        /* ê¸°ë³¸ ì•¡ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-action {
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
            color: #fff; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            transition: background-color 0.2s;
        }
        .btn-action:hover {
            opacity: 0.9; /* í˜¸ë²„ ì‹œ ì•½ê°„ ì–´ë‘¡ê²Œ */
        }

        /* ìŠ¹ì¸ ë²„íŠ¼ (íŒŒë‘) */
        .btn-action-approve {
            background: #2c5bf2;
        }
        .btn-action-approve:hover {
            background: #1b42c4;
        }

        /* ê±°ì ˆ/ì·¨ì†Œ ë²„íŠ¼ (ë¹¨ê°•) */
        .btn-action-danger {
            background: #ff4d4f;
        }
        .btn-action-danger:hover {
            background: #cf1322;
        }

        /* ê²°ì œìˆ˜ë‹¨ íƒ­ */
        .payment-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 14px; font-weight: 600; color: #888; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-btn:hover { color: #333; }
        .tab-btn.active { color: #2c5bf2; border-bottom-color: #2c5bf2; font-weight: 700; }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; margin-bottom: 15px; }
        .label { display: block; font-size: 13px; font-weight: 700; color: #555; margin-bottom: 8px; }
        .input-box { width: 100%; height: 44px; border: 1px solid #ddd; border-radius: 6px; padding: 0 15px; outline: none; transition: 0.2s; font-size: 14px; }
        .input-box:focus { border-color: #1a1a1a; }
        .terms-box { width: 100%; height: 80px; border: 1px solid #eee; background: #f9f9f9; padding: 12px; font-size: 12px; color: #666; overflow-y: auto; border-radius: 6px; margin-bottom: 8px; line-height: 1.5; }
        .check-label { font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 600; }
        .btn-save-payment { width: 100%; height: 50px; background: #1a1a1a; color: #fff; font-size: 16px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        .btn-save-payment:hover { background: #333; }
        .staff-view-box { padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #555; font-size: 14px; }
        .status-on { color: #2c5bf2; font-weight: 700; }
        .status-off { color: #ff4d4f; font-weight: 700; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .plan-option { display: block; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .plan-option:hover { border-color: #2c5bf2; background: #f0f7ff; }
        .plan-option.selected { border-color: #2c5bf2; background: #e6f7ff; font-weight: 700; }
        .btn-modal-submit { width: 100%; height: 46px; background: #2c5bf2; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .textarea-basic { width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 6px; padding: 15px; resize: none; font-family: inherit; margin-bottom: 10px; font-size: 14px; line-height: 1.5; }

        /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .pagination-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 15px; }
        .pagination-btn { padding: 8px 15px; border: 1px solid #ddd; background: #fff; color: #555; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .pagination-btn:hover:not(:disabled) { background: #f5f5f5; border-color: #2c5bf2; color: #2c5bf2; }
        .pagination-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination-btn.active { background: #2c5bf2; color: #fff; border-color: #2c5bf2; }
        .pagination-info { font-size: 14px; color: #666; font-weight: 600; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 30px 20px; }
            .form-row { flex-direction: column; gap: 10px; }
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; border-radius: 12px; padding: 40px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; color: #1a1a1a; }
        .modal-desc { font-size: 14px; color: #666; margin-bottom: 30px; line-height: 1.6; }
        .modal-close { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: #999; }
        .btn-submit-modal { background: #1a1a1a; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; font-size: 15px; }
        .btn-submit-modal:hover { background: #333; }
        .btn-cancel-modal { background: #fff; color: #666; border: 1px solid #ddd; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; font-size: 15px; margin-top: 10px; }
        .btn-cancel-modal:hover { background: #f9f9f9; }
    </style>
</head>
<body>

    
    <!-- Sidebar Skeleton (ê¹œë¹¡ì„ ë°©ì§€) -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a>
        </div>
        <div class="user-profile-area">
            <div class="user-name">ë¡œë”©ì¤‘...</div>
            <div class="user-email">...</div>
            <div class="user-role badge-staff">...</div>
        </div>
        <ul class="menu-list">
            <li><a href="../../pages/user/dashboard.html" class="menu-link">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
            <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
            <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="../../pages/public/user_guide.html" class="menu-link">ğŸ“˜ ì´ìš© ê°€ì´ë“œ (FAQ)</a></li>
        </ul>
        <div class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</div>
    </nav>

<main class="main-content">
        <h2 class="page-title">ê²°ì œ/êµ¬ë… ê´€ë¦¬</h2>

        <div class="card-box">
            <div class="card-header">
                <span class="card-title">í˜„ì¬ ì´ìš© ì¤‘ì¸ ìš”ê¸ˆì œ</span>
                <div class="btn-group-right">
                    <button class="btn-extra-pay" onclick="openExtraPayModal()">ğŸ’¸ ì¶”ê°€ ì´ìš© ë¬¸ì˜</button>
                    <button class="btn-change-plan" onclick="openPlanModal()">ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­</button>
                </div>
            </div>
            
            <div class="plan-info-row">
                <span id="currentPlanName" class="current-plan-name">ë¡œë”© ì¤‘...</span>
                <span class="plan-badge badge-qa" id="qaUsageBadge">ğŸ“ ì„œë©´: - / -</span>
                <span class="plan-badge badge-phone" id="phoneUsageBadge">ğŸ“ ì „í™”: - / -</span>
            </div>
            <p class="plan-desc">ì •ê¸° êµ¬ë… ì¤‘ì…ë‹ˆë‹¤. </p>
        </div>

        <div class="card-box">
            <div class="card-header">
                <span class="card-title">ğŸ’¸ ì¶”ê°€ ì´ìš© ë° ê²¬ì  ìš”ì²­ ë‚´ì—­</span>
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th width="12%">ìš”ì²­ì¼</th>
                        <th>ìš”ì²­ ë‚´ìš©</th>
                        <th width="15%">ìš”ì²­ì</th>
                        <th width="15%">ê²¬ì  ê¸ˆì•¡</th>
                        <th width="12%">ìƒíƒœ</th>
                        <th width="15%">ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="requestListBody">
                    <tr><td colspan="5" style="text-align:center; padding:20px;">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div id="requestPaginationContainer" class="pagination-container" style="display:none;">
                <button class="pagination-btn" onclick="window.goToRequestPage(1)" id="btnRequestFirst">ì²˜ìŒ</button>
                <button class="pagination-btn" onclick="window.goToPrevRequestPage()" id="btnRequestPrev">ì´ì „</button>
                <span class="pagination-info" id="requestPageInfo">1 / 1</span>
                <button class="pagination-btn" onclick="window.goToNextRequestPage()" id="btnRequestNext">ë‹¤ìŒ</button>
                <button class="pagination-btn" onclick="window.goToLastRequestPage()" id="btnRequestLast">ë§ˆì§€ë§‰</button>
            </div>
        </div>

        <div class="card-box" id="paymentHistoryCard">
            <div class="card-header">
                <span class="card-title">ê²°ì œ ë‚´ì—­</span>
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>ê²°ì œì¼</th>
                        <th>ë‚´ìš©</th>
                        <th>ê¸ˆì•¡ <span style="font-size:11px; color:#888;">(VAT í¬í•¨)</span></th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="paymentHistoryList">
                    <tr><td colspan="4" style="text-align:center; padding:20px;">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div id="paymentPaginationContainer" class="pagination-container" style="display:none;">
                <button class="pagination-btn" onclick="window.goToPaymentPage(1)" id="btnPaymentFirst">ì²˜ìŒ</button>
                <button class="pagination-btn" onclick="window.goToPrevPaymentPage()" id="btnPaymentPrev">ì´ì „</button>
                <span class="pagination-info" id="paymentPageInfo">1 / 1</span>
                <button class="pagination-btn" onclick="window.goToNextPaymentPage()" id="btnPaymentNext">ë‹¤ìŒ</button>
                <button class="pagination-btn" onclick="window.goToLastPaymentPage()" id="btnPaymentLast">ë§ˆì§€ë§‰</button>
            </div>
        </div>

        <div class="card-box">
            <div class="card-header">
                <span class="card-title">ê²°ì œ ìˆ˜ë‹¨ ì •ë³´ ë“±ë¡</span>
            </div>

            <div id="ceoPaymentForm" style="display:none;">
                <div class="payment-tabs">
                    <div class="tab-btn active" onclick="togglePaymentTab('cms')">ğŸ¦ ê³„ì¢Œ ìë™ì´ì²´ (CMS)</div>
                    <div class="tab-btn" onclick="togglePaymentTab('card')">ğŸ’³ ì‹ ìš©ì¹´ë“œ ì •ê¸°ê²°ì œ</div>
                </div>

                <div id="cmsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="label">ì€í–‰ ì„ íƒ</label>
                            <select id="cmsBank" class="input-box">
                                <option value="êµ­ë¯¼ì€í–‰">êµ­ë¯¼ì€í–‰</option>
                                <option value="ì‹ í•œì€í–‰">ì‹ í•œì€í–‰</option>
                                <option value="ìš°ë¦¬ì€í–‰">ìš°ë¦¬ì€í–‰</option>
                                <option value="í•˜ë‚˜ì€í–‰">í•˜ë‚˜ì€í–‰</option>
                                <option value="ê¸°ì—…ì€í–‰">ê¸°ì—…ì€í–‰</option>
                                <option value="ë†í˜‘">ë†í˜‘</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">ê³„ì¢Œë²ˆí˜¸ (-ì—†ì´ ì…ë ¥)</label>
                            <input type="text" id="cmsAccount" class="input-box" placeholder="1234567890">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="label">ì˜ˆê¸ˆì£¼ëª… (ì‚¬ì—…ìëª…)</label>
                            <input type="text" id="cmsOwner" class="input-box" placeholder="ì˜ˆê¸ˆì£¼ëª… ì…ë ¥">
                        </div>
                        <div class="form-group">
                            <label class="label">ìƒë…„ì›”ì¼(6ìë¦¬) ë˜ëŠ” ì‚¬ì—…ìë²ˆí˜¸(10ìë¦¬)</label>
                            <input id="cmsBirth" type="text" id="cmsBirth" class="input-box" placeholder="ì¶œê¸ˆ ë™ì˜ìš© í•„ìˆ˜ ì •ë³´">
                        </div>
                    </div>
                    <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">
                    <div class="form-group">
                        <label class="label">ì¦ë¹™ ì„œë¥˜ ë°œí–‰</label>
                        <select id="taxEvidenceType" class="input-box" onchange="toggleTaxFields(this.value)">
                            <option value="none" selected>ë°œí–‰ ì•ˆí•¨</option>
                            <option value="tax_invoice">ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰</option>
                            <option value="cash_receipt">í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰</option>
                        </select>
                    </div>

                    <div id="taxInvoiceFields" style="display:none;">
                        <h5 style="font-size:14px; margin-bottom:10px; color:#1a1a1a;">ì„¸ê¸ˆê³„ì‚°ì„œ ì •ë³´</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="label">ê¸°ì—…ëª…</label>
                                <input type="text" id="taxCompanyName" class="input-box">
                            </div>
                            <div class="form-group">
                                <label class="label">ì‚¬ì—…ìë²ˆí˜¸</label>
                                <input type="text" id="taxBizNum" class="input-box">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="label">ìˆ˜ì‹  ì´ë©”ì¼ì£¼ì†Œ</label>
                            <input type="email" id="taxEmail" class="input-box">
                        </div>
                    </div>

                    <div id="cashReceiptFields" style="display:none;">
                        <h5 style="font-size:14px; margin-bottom:10px; color:#1a1a1a;">í˜„ê¸ˆì˜ìˆ˜ì¦ ì •ë³´</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="label">ì´ë¦„</label>
                                <input type="text" id="cashReceiptName" class="input-box">
                            </div>
                            <div class="form-group">
                                <label class="label">íœ´ëŒ€í°ë²ˆí˜¸</label>
                                <input type="tel" id="cashReceiptPhone" class="input-box">
                            </div>
                        </div>
                    </div>
                    <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">
                    <div class="form-group">
                        <label class="label" style="color:#2c5bf2;">[í•„ìˆ˜] ì¶œê¸ˆ ì´ì²´ ë™ì˜</label>
                        <div class="terms-box">
                            <strong>[CMS ì¶œê¸ˆì´ì²´ ì•½ê´€ ë™ì˜]</strong><br>
                            1. ì‹ ì²­ì¸ì€ ë³¸ì¸ì´ ì„œëª…í•œ ê³„ì¢Œì—ì„œ ë²•ë¬´ê·¸ë£¹ í˜„ì¼ì´ ì²­êµ¬í•˜ëŠ” ê¸ˆì•¡ì„ ë§¤ì›” ìë™ ì¶œê¸ˆí•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.<br>
                            2. ì¶œê¸ˆì¼: ë§¤ì›” ì§€ì •ëœ ê²°ì œì¼ (íœ´ì¼ì¸ ê²½ìš° ìµì˜ì—…ì¼)<br>
                            3. ë³¸ ë™ì˜ëŠ” í•´ì§€ ì‹ ì²­ ì‹œê¹Œì§€ ìœ íš¨í•˜ë©°, ì”ê³  ë¶€ì¡± ë“±ìœ¼ë¡œ ì¶œê¸ˆ ì‹¤íŒ¨ ì‹œ ì¬ì¶œê¸ˆì´ ì‹œë„ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                        <label class="check-label"><input type="checkbox" id="cmsAgree1"> ìœ„ ì¶œê¸ˆ ì´ì²´ ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
                    </div>
                    <div class="form-group">
                        <label class="label" style="color:#2c5bf2;">[í•„ìˆ˜] ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜</label>
                        <div class="terms-box">
                            <strong>[ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜]</strong><br>
                            ê¸ˆìœµê²°ì œì› ë° íš¨ì„±ì—í”„ì— ì—ìŠ¤(ì£¼) ë“± CMS ì¤‘ê³„ê¸°ê´€ì— ê²°ì œ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.<br>
                            - ì œê³µë°›ëŠ” ì: ê¸ˆìœµê²°ì œì›, íš¨ì„±ì—í”„ì— ì—ìŠ¤(ì£¼), ê±°ë˜ ì€í–‰<br>
                            - ì œê³µ í•­ëª©: ì„±ëª…, ìƒë…„ì›”ì¼(ì‚¬ì—…ìë²ˆí˜¸), ì „í™”ë²ˆí˜¸, ì€í–‰ëª…, ê³„ì¢Œë²ˆí˜¸
                        </div>
                        <label class="check-label"><input type="checkbox" id="cmsAgree2"> ìœ„ ì œ3ì ì œê³µ ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
                    </div>
                </div>

                <div id="cardForm" style="display:none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="label">ì¹´ë“œì‚¬ ì„ íƒ</label>
                            <select id="cardCompany" class="input-box">
                                <option value="êµ­ë¯¼ì¹´ë“œ">êµ­ë¯¼ì¹´ë“œ</option>
                                <option value="ì‹ í•œì¹´ë“œ">ì‹ í•œì¹´ë“œ</option>
                                <option value="ì‚¼ì„±ì¹´ë“œ">ì‚¼ì„±ì¹´ë“œ</option>
                                <option value="í˜„ëŒ€ì¹´ë“œ">í˜„ëŒ€ì¹´ë“œ</option>
                                <option value="ë¡¯ë°ì¹´ë“œ">ë¡¯ë°ì¹´ë“œ</option>
                                <option value="ìš°ë¦¬ì¹´ë“œ">ìš°ë¦¬ì¹´ë“œ</option>
                                <option value="í•˜ë‚˜ì¹´ë“œ">í•˜ë‚˜ì¹´ë“œ</option>
                                <option value="BCì¹´ë“œ">BCì¹´ë“œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">ì¹´ë“œë²ˆí˜¸ (-ì—†ì´ ì…ë ¥)</label>
                            <input type="text" id="cardNum" class="input-box" placeholder="1234123412341234">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="label">ìœ íš¨ê¸°ê°„ (MM/YY)</label>
                            <input type="text" id="cardExpiry" class="input-box" placeholder="01/28">
                        </div>
                        <div class="form-group">
                            <label class="label">ìƒë…„ì›”ì¼(6ìë¦¬) ë˜ëŠ” ì‚¬ì—…ìë²ˆí˜¸(10ìë¦¬)</label>
                            <input type="text" id="cardBizNum" class="input-box" placeholder="ë³¸ì¸ í™•ì¸ìš© í•„ìˆ˜ ì •ë³´">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label" style="color:#2c5bf2;">[í•„ìˆ˜] ì •ê¸°ê³¼ê¸ˆ ì´ìš© ë™ì˜</label>
                        <div class="terms-box">
                            <strong>[ì‹ ìš©ì¹´ë“œ ì •ê¸°ê³¼ê¸ˆ ì´ìš© ë™ì˜]</strong><br>
                            1. ì‹ ì²­ì¸ì€ ë“±ë¡ëœ ì‹ ìš©ì¹´ë“œë¡œ ë²•ë¬´ê·¸ë£¹ í˜„ì¼ì´ ì²­êµ¬í•˜ëŠ” ì„œë¹„ìŠ¤ ì´ìš©ìš”ê¸ˆì„ ë§¤ì›” ì •ê¸° ê²°ì œí•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.<br>
                            2. ì¹´ë“œ ì •ë³´ ë³€ê²½/ë¶„ì‹¤ ì‹œ ì¦‰ì‹œ ì¬ë“±ë¡í•´ì•¼ í•˜ë©°, ë¯¸ë‚© ì‹œ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                            3. ê²°ì œ ëŒ€í–‰ì‚¬(PGì‚¬)ì— ê²°ì œ ìŠ¹ì¸ì„ ìœ„í•œ ìµœì†Œí•œì˜ ì •ë³´ê°€ ì œê³µë©ë‹ˆë‹¤.
                        </div>
                        <label class="check-label"><input type="checkbox" id="cardAgree"> ìœ„ ì •ê¸°ê³¼ê¸ˆ ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
                    </div>
                </div>

                <button class="btn-save-payment" id="btnSavePayment" onclick="savePaymentInfo()">ê²°ì œ ì •ë³´ ì €ì¥ (ì •ê¸°ê²°ì œ ì‹œì‘)</button>
            </div>

            <div id="staffPaymentView" class="staff-view-box" style="display:none;">
                ğŸ”’ ê²°ì œ ìˆ˜ë‹¨ ê´€ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (CEO ì „ìš©)<br>
                <div style="margin-top:10px; font-size:16px;">
                    í˜„ì¬ ìƒíƒœ: <span id="paymentStatusText">í™•ì¸ ì¤‘...</span>
                </div>
            </div>
        </div>
    </main>
<script src="../../js/channel-service.js"></script>
<script type="module">
        import { auth, users, requireAuth, payments, posts, billing, approvalRequests } from '../../js/api.js';
        import { renderClientSidebar } from '../../js/client_ui.js';

        // ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©ì ë°ì´í„° ì„ ì–¸
        window.gUserData = null;

        // âœ… expose imported modules for non-module onclick handlers
        window.posts = posts;
        window.payments = payments;
        window.billing = billing;
        window.auth = auth;
        window.users = users;
        window.requireAuth = requireAuth;
        window.approvalRequests = approvalRequests;

        const PLANS = {
            'none': { name: 'ë¯¸ê°€ì…', price: 0 },
            'Basic': { name: 'Basic', price: 100000 },
            'Standard': { name: 'Standard', price: 200000 },
            'Pro': { name: 'Pro', price: 300000 },
            'Premium': { name: 'Premium', price: 500000 },
            'Enterprise': { name: 'Enterprise', price: 1000000 }
        };

        // í˜ì´ì§€ë„¤ì´ì…˜ ì „ì—­ ë³€ìˆ˜ (ì¶”ê°€ì´ìš© ë° ê²¬ì  ìš”ì²­)
        let gAllRequests = [];
        let gCurrentRequestPage = 1;
        const REQUEST_ITEMS_PER_PAGE = 5;

        // í˜ì´ì§€ë„¤ì´ì…˜ ì „ì—­ ë³€ìˆ˜ (ê²°ì œ ë‚´ì—­)
        let gAllPayments = [];
        let gCurrentPaymentPage = 1;
        const PAYMENT_ITEMS_PER_PAGE = 5;

        const PLAN_SPECS = {
            'none': { qa: 0, phone: 0, label: 'ë¯¸ê°€ì…' },
            'Basic': { qa: 1, phone: 0, label: 'ğŸŒ± Basic' },
            'Standard': { qa: 3, phone: 1, label: 'â­ Standard' },
            'Pro': { qa: 5, phone: 2, label: 'ğŸ’ Pro' },
            'Premium': { qa: 8, phone: 5, label: 'ğŸ‘‘ Premium' },
            'Enterprise': { qa: 999, phone: 999, label: 'ğŸ¢ Enterprise' }
        };

        function renderUsageBadges(userData, paymentsData) {
            if (!userData) userData = {};

            const qaEl = document.getElementById("qaUsageBadge");
            const phoneEl = document.getElementById("phoneUsageBadge");

            const spec = PLAN_SPECS[userData.plan] || PLAN_SPECS['none'];
            const qaLimit = userData.plan === 'Enterprise' ? (userData.customQaLimit || 0) : spec.qa;
            const phoneLimit = userData.plan === 'Enterprise' ? (userData.customPhoneLimit || 0) : spec.phone;

            const qaUsed = userData.qaUsedCount || 0;
            const phoneUsed = userData.phoneUsedCount || 0;
            const qaRemaining = Math.max(0, qaLimit - qaUsed);
            const phoneRemaining = Math.max(0, phoneLimit - phoneUsed);

            if (qaEl) {
                qaEl.textContent = `ğŸ“ ì„œë©´: ${qaUsed} / ${qaLimit} (ë‚¨ì€ ${qaRemaining}ê±´)`;
            }
            if (phoneEl) {
                phoneEl.textContent = `ğŸ“ ì „í™”: ${phoneUsed} / ${phoneLimit} (ë‚¨ì€ ${phoneRemaining}ê±´)`;
            }
        }

        function setOwnerPaymentSectionVisible(userData) {
            const isOwner = (userData?.role === "owner");
            const ceoForm = document.getElementById("ceoPaymentForm");
            const staffView = document.getElementById("staffPaymentView");
            if (isOwner) {
                if (ceoForm) ceoForm.style.display = "block";
                if (staffView) staffView.style.display = "none";
            } else {
                if (ceoForm) ceoForm.style.display = "none";
                if (staffView) staffView.style.display = "block";
                const st = document.getElementById("paymentStatusText");
                if (st) st.textContent = "ê¶Œí•œ ì—†ìŒ";
            }
        }

        function renderRequestList(requests) {
            const tbody = document.getElementById("requestListBody");
            if (!tbody) return;

            if (!Array.isArray(requests) || requests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#888;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                document.getElementById('requestPaginationContainer').style.display = 'none';
                return;
            }

            gAllRequests = requests;
            
            // ì§„ë‹¨ìš© ë¡œê·¸ ì¶”ê°€: ì–´ë–¤ ê°’ì´ ë“¤ì–´ì˜¤ëŠ”ì§€ í™•ì¸
            console.log('--- renderRequestList Debug ---');
            currentPageRequests.forEach(r => {
                console.log(`DocId: ${r.docId}, quotedPrice: ${r.quotedPrice}, Status: ${r.status}`);
            });
            console.log('--- End Debug ---');

            const totalPages = Math.ceil(requests.length / REQUEST_ITEMS_PER_PAGE);
            const startIndex = (gCurrentRequestPage - 1) * REQUEST_ITEMS_PER_PAGE;
            const endIndex = startIndex + REQUEST_ITEMS_PER_PAGE;
            const currentPageRequests = requests.slice(startIndex, endIndex);

            const paginationContainer = document.getElementById('requestPaginationContainer');
            if (requests.length > REQUEST_ITEMS_PER_PAGE) {
                paginationContainer.style.display = 'flex';
                updateRequestPaginationUI(totalPages);
            } else {
                paginationContainer.style.display = 'none';
            }

            tbody.innerHTML = currentPageRequests.map(r => {
                const createdAt = r.createdAt || r.requestedAt || r.date || "";
                let amount = (r.quotedPrice ?? r.amount ?? r.quoteAmount ?? r.price);
                const status = r.status || r.state || "-";

                // --- 1. ìš”ì²­ ë‚´ìš© í¬ë§·íŒ… ---
                let formattedTitle = r.title || r.content || r.reason || "-";
                try {
                    const category = r.category || '';
                    const requestType = r.requestType || '';

                    if (category === 'extra_usage_quote' || requestType === 'ì¶”ê°€ì´ìš©ë¬¸ì˜') {
                        const contentString = r.content || (r.requestData ? r.requestData.content : '') || '';
                        const typeMatch = contentString.match(/\[ìœ í˜•\]\s*(.*)/);
                        let typeText = typeMatch ? typeMatch[1].trim() : 'ì¶”ê°€ ë¬¸ì˜';
                        if(typeText === 'qa_extra') typeText = 'ì„œë©´ ìë¬¸ ì¶”ê°€';
                        if(typeText === 'phone_extra') typeText = 'ì „í™” ìƒë‹´ ì¶”ê°€';
                        if(typeText === 'case_quote') typeText = 'ê±´ë³„ ê²¬ì  ìš”ì²­';
                        
                        const contentMatch = contentString.match(/\[ë‚´ìš©\]\n([\s\S]*)/);
                        const mainContent = contentMatch ? contentMatch[1].trim() : contentString;
                        formattedTitle = `[${typeText}] ${mainContent}`;

                    } else if (category === 'plan_change' || requestType === 'ìš”ê¸ˆì œë³€ê²½ì‹ ì²­') {
                        const newPlanMatch = (r.title || '').match(/\(([^)]+)\)/);
                        const newPlan = newPlanMatch ? newPlanMatch[1] : 'í”Œëœ';
                        formattedTitle = `[ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­] ${newPlan}`;

                    } else if (category === 'payment_method') {
                        const paymentInfo = JSON.parse(r.content);
                        const type = paymentInfo.type === 'card' ? 'ì‹ ìš©ì¹´ë“œ' : 'CMS/ê³„ì¢Œì´ì²´';
                        formattedTitle = `[ê²°ì œìˆ˜ë‹¨ë“±ë¡] ${type} ì •ë³´`;
                    }
                } catch (e) { /* íŒŒì‹± ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš© */ }

                // --- 2. ìƒíƒœ ë° ì•¡ì…˜ ë²„íŠ¼ ---
                const statusLabelMap = {
                    waiting: 'ì ‘ìˆ˜', pending: 'ì ‘ìˆ˜', quoted: 'ê²¬ì  ë„ì°©', approved: 'ìŠ¹ì¸ë¨', accepted: 'ìŠ¹ì¸ ì™„ë£Œ',
                    done: 'ì²˜ë¦¬ ì™„ë£Œ', completed: 'ì²˜ë¦¬ ì™„ë£Œ', archived: 'ì™„ë£Œ', archive: 'ì™„ë£Œ',
                    admin_cancelled: 'ê´€ë¦¬ì ì·¨ì†Œ', auto_cancelled: 'ìë™ ì·¨ì†Œ', ìŠ¹ì¸ìš”ì²­: 'ìŠ¹ì¸ ëŒ€ê¸°ì¤‘',
                    rejected: 'ì²˜ë¦¬ ì™„ë£Œ', // ë³€ê²½: ê±°ì ˆ ì‹œ 'ì²˜ë¦¬ ì™„ë£Œ'ë¡œ í‘œì‹œ
                    cancelled: 'ì‚¬ìš©ì ì·¨ì†Œ'
                };
                const statusLabel = statusLabelMap[String(status)] || String(status);
                
                let actionHtml = "";
                if (status === 'ìŠ¹ì¸ìš”ì²­') {
                    actionHtml = `<span style="color:#fa8c16; font-weight:700;">ìŠ¹ì¸ ëŒ€ê¸°ì¤‘</span>`;
                } else if (status === 'quoted') {
                    actionHtml = `<button class="btn-action btn-action-approve" onclick="approveQuote('${r.docId}')">ìŠ¹ì¸</button> <button class="btn-action btn-action-danger" onclick="rejectQuote('${r.docId}')">ê±°ì ˆ</button>`;
                } else if (status === 'approved' || status === 'accepted') {
                    actionHtml = `<span style="color:#52c41a; font-weight:700;">âœ“ ìŠ¹ì¸ë¨</span>`;
                } else if (status === 'waiting' || status === 'pending') {
                    actionHtml = `<button class="btn-action btn-action-danger" onclick="cancelRequest('${r.docId}')">ì·¨ì†Œ</button>`;
                } else if (status === 'admin_cancelled' || status === 'auto_cancelled' || status === 'cancelled') {
                    actionHtml = `<span style="color:#ff4d4f; font-weight:700;">ì·¨ì†Œë¨</span>`;
                } else if (status === 'rejected') {
                    actionHtml = `<span style="color:#ff4d4f; font-weight:700;">ê±°ì ˆ ì™„ë£Œ</span>`; // ë³€ê²½: ê±°ì ˆ ì‹œ 'ê±°ì ˆ ì™„ë£Œ'ë¡œ í‘œì‹œ
                } else {
                    actionHtml = `<span style="color:#888;">${escapeHtml(String(statusLabel))}</span>`;
                }
                
                // --- 3. ê¸ˆì•¡ í‘œì‹œ ---
                let amountDisplay = (typeof amount === 'number' && amount >= 0) ? `${Number(amount).toLocaleString()}ì›` : "-";

                // --- 4. ìµœì¢… HTML ---
                const titleHtml = `<a href="javascript:void(0)" onclick="showRequestDetail('${r.docId}')" style="color:#2c5bf2; text-decoration:underline; cursor:pointer;">${escapeHtml(String(formattedTitle))}</a>`;
                const requesterName = r.authorName || r.userManagerName || r.userCompanyName || '-';

                return `
                    <tr>
                        <td>${createdAt ? new Date(createdAt).toLocaleDateString() : "-"}</td>
                        <td>${titleHtml}</td>
                        <td>${requesterName}</td>
                        <td class="amount">${amountDisplay}</td>
                        <td>${escapeHtml(String(statusLabel))}</td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
            }).join("");
        }

        function renderPaymentHistory(items) {
            const tbody = document.getElementById("paymentHistoryList");
            if (!tbody) return;

            if (!Array.isArray(items) || items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                document.getElementById('paymentPaginationContainer').style.display = 'none';
                return;
            }

            // ì „ì²´ ê²°ì œ ë‚´ì—­ ì €ì¥
            gAllPayments = items;

            // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
            const totalPages = Math.ceil(items.length / PAYMENT_ITEMS_PER_PAGE);
            const startIndex = (gCurrentPaymentPage - 1) * PAYMENT_ITEMS_PER_PAGE;
            const endIndex = startIndex + PAYMENT_ITEMS_PER_PAGE;
            const currentPagePayments = items.slice(startIndex, endIndex);

            // 5ê°œ ì´ìƒì¼ ë•Œë§Œ í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ
            const paginationContainer = document.getElementById('paymentPaginationContainer');
            if (items.length > 5) {
                paginationContainer.style.display = 'flex';
                updatePaymentPaginationUI(totalPages);
            } else {
                paginationContainer.style.display = 'none';
            }

            // âœ… ì´ë¯¸ ë°±ì—”ë“œì—ì„œ ì •ë ¬ë˜ì–´ ì˜¤ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            tbody.innerHTML = currentPagePayments.map(p => {
                // âœ… ë‚ ì§œ: date í•„ë“œ ìš°ì„ , ì—†ìœ¼ë©´ sentAt
                const at = p.date || p.sentAt || p.paidAt || p.createdAt || "";
                const dateText = at ? new Date(at).toLocaleDateString() : "-";

                // âœ… ë‚´ìš©: title ìš°ì„ , ì—†ìœ¼ë©´ note
                const desc = p.title || p.note || p.description || p.content || "-";
                const amount = (p.amount ?? p.price ?? 0);
                const refundAmount = p.refundAmount || 0;

                // âœ… ìƒíƒœ íŒë‹¨ (ìš°ì„ ìˆœìœ„: íŠ¹ìˆ˜ ìƒíƒœ > ì™„ë£Œ > ì²­êµ¬)
                const status = String(p.status || "").toLowerCase();

                let statusLabel = "", statusColor = "", stClass = "", amountStyle = "";

                if (status === 'refund' || status === 'refunded') {
                    statusLabel = "í™˜ë¶ˆ"; statusColor = "#595959"; stClass = "st-refund"; amountStyle = "text-decoration: line-through;";
                } else if (['cancel', 'cancelled', 'canceled'].includes(status)) {
                    statusLabel = "ì·¨ì†Œ"; statusColor = "#ff4d4f"; stClass = "st-cancel"; amountStyle = "text-decoration: line-through;";
                } else if (status === 'overdue') {
                    statusLabel = "ì—°ì²´"; statusColor = "#ff4d4f"; stClass = "st-overdue";
                } else if (p.source === 'payment' || p.linkedToPayment || p.paymentId || ["paid", "completed", "done", "archived", "archive"].includes(status)) {
                    statusLabel = "ì™„ë£Œ"; statusColor = "#52c41a"; stClass = "st-paid";
                } else {
                    statusLabel = "ì²­êµ¬ë¨"; statusColor = "#fa8c16"; stClass = "st-scheduled";
                }
                let amountDisplay = `<span style="${amountStyle}">${Number(amount || 0).toLocaleString()}ì›</span>`;
                if (refundAmount > 0) {
                    amountDisplay += `<br><span style="font-size:12px; color:#595959;">(í™˜ë¶ˆ: ${Number(refundAmount).toLocaleString()}ì›)</span>`;
                }

                return `
                    <tr>
                        <td>${dateText}</td>
                        <td>${escapeHtml(String(desc))}</td>
                        <td class="amount">${amountDisplay}</td>
                        <td class="${stClass}"><span style="color:${statusColor}; font-weight:700;">${statusLabel}</span></td>
                    </tr>
                `;
            }).join("");
        }
        
        function escapeHtml(str) { return str.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;"); }
        function updateRequestPaginationUI(totalPages) {
            const pageInfo = document.getElementById('requestPageInfo');
            if (pageInfo) pageInfo.textContent = `${gCurrentRequestPage} / ${totalPages}`;
            document.getElementById('btnRequestFirst').disabled = gCurrentRequestPage === 1;
            document.getElementById('btnRequestPrev').disabled = gCurrentRequestPage === 1;
            document.getElementById('btnRequestNext').disabled = gCurrentRequestPage === totalPages;
            document.getElementById('btnRequestLast').disabled = gCurrentRequestPage === totalPages;
        }
        window.goToRequestPage = function(page) { const totalPages = Math.ceil(gAllRequests.length / REQUEST_ITEMS_PER_PAGE); if (page < 1 || page > totalPages) return; gCurrentRequestPage = page; renderRequestList(gAllRequests); };
        window.goToNextRequestPage = function() { window.goToRequestPage(gCurrentRequestPage + 1); };
        window.goToPrevRequestPage = function() { window.goToRequestPage(gCurrentRequestPage - 1); };
        window.goToLastRequestPage = function() { window.goToRequestPage(Math.ceil(gAllRequests.length / REQUEST_ITEMS_PER_PAGE)); };

        function updatePaymentPaginationUI(totalPages) {
            const pageInfo = document.getElementById('paymentPageInfo');
            if (pageInfo) pageInfo.textContent = `${gCurrentPaymentPage} / ${totalPages}`;
            document.getElementById('btnPaymentFirst').disabled = gCurrentPaymentPage === 1;
            document.getElementById('btnPaymentPrev').disabled = gCurrentPaymentPage === 1;
            document.getElementById('btnPaymentNext').disabled = gCurrentPaymentPage === totalPages;
            document.getElementById('btnPaymentLast').disabled = gCurrentPaymentPage === totalPages;
        }
        window.goToPaymentPage = function(page) { const totalPages = Math.ceil(gAllPayments.length / PAYMENT_ITEMS_PER_PAGE); if (page < 1 || page > totalPages) return; gCurrentPaymentPage = page; renderPaymentHistory(gAllPayments); };
        window.goToNextPaymentPage = function() { window.goToPaymentPage(gCurrentPaymentPage + 1); };
        window.goToPrevPaymentPage = function() { window.goToPaymentPage(gCurrentPaymentPage - 1); };
        window.goToLastPaymentPage = function() { window.goToPaymentPage(Math.ceil(gAllPayments.length / PAYMENT_ITEMS_PER_PAGE)); };

        (async () => {
            if (!requireAuth()) return;
            const user = auth.getCurrentUser();
            if (!user) { location.href = "../../pages/public/login.html"; return; }
            try {
                const userData = await users.getMe();
                window.gUserData = userData;
                renderClientSidebar('payment', userData);
                setOwnerPaymentSectionVisible(userData);
                renderUsageBadges(userData);
                const userPlan = userData.plan || 'none';
                const planSpec = PLAN_SPECS[userPlan] || PLAN_SPECS['none'];
                const planNameEl = document.querySelector('.current-plan-name');
                if (planNameEl) planNameEl.innerText = planSpec.label;
                if (userData.role !== 'owner') {
                    const paymentHistoryCard = document.getElementById('paymentHistoryCard');
                    if (paymentHistoryCard) paymentHistoryCard.style.display = 'none';
                }
                try {
                    if (userData.role === 'owner') {
                        const billingData = await billing.getMyLogs();
                        renderPaymentHistory(billingData?.logs || []);
                    }
                    const requestsData = await posts.getAll({ category: 'payment_method,plan_change,extra_usage_quote' });
                    const postsList = requestsData?.posts || [];
                    const approvalData = await approvalRequests.getRequests({ status: 'Pending' });
                    const approvalList = approvalData?.requests || [];
                    const mappedApprovals = approvalList
                        .filter(req => ['ì¶”ê°€ì´ìš©ë¬¸ì˜', 'ìš”ê¸ˆì œë³€ê²½ì‹ ì²­'].includes(req.requestType))
                        .map(req => {
                            let category = '';
                            if (req.requestType === 'ì¶”ê°€ì´ìš©ë¬¸ì˜') category = 'extra_usage_quote';
                            else if (req.requestType === 'ìš”ê¸ˆì œë³€ê²½ì‹ ì²­') category = 'plan_change';
                            return {
                                docId: `approval_${req.id}`, createdAt: req.createdAt, title: req.requestData.title || `[${req.requestType}]`,
                                content: req.requestData.content, authorName: req.requesterName, status: 'ìŠ¹ì¸ìš”ì²­', category: category,
                                userDepartment: req.requesterDepartment, authorUid: req.uid
                            };
                        });
                    let allRequests = [...postsList, ...mappedApprovals];
                    if (userData.role === 'manager') {
                        allRequests = allRequests.filter(r => r.userDepartment === userData.department || r.authorName === userData.managerName);
                    } else if (userData.role === 'user' || userData.role === 'staff') {
                        allRequests = allRequests.filter(r => r.authorUid === userData.uid || r.authorName === userData.managerName);
                    }
                    allRequests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    renderRequestList(allRequests);
                    renderUsageBadges(userData);
                } catch (err) {
                    console.error('âŒ ê²°ì œ/ìš”ì²­ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', err);
                    renderPaymentHistory([]);
                    renderRequestList([]);
                }
                if (userData.role === 'owner') {
                    await loadSavedPaymentInfo();
                }
            } catch (error) { console.error('í˜ì´ì§€ ë¡œë“œ ì—ëŸ¬:', error); }
        })();

        async function loadSavedPaymentInfo() {
            try {
                const requestsData = await posts.getAll({ category: 'payment_method' });
                const paymentMethods = requestsData?.posts || [];
                if (paymentMethods.length === 0) return;
                const latestPayment = paymentMethods[0];
                let paymentInfo;
                try { paymentInfo = JSON.parse(latestPayment.content); } catch (e) { console.error('ê²°ì œìˆ˜ë‹¨ ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', e); return; }
                if (paymentInfo.type === 'card') {
                    togglePaymentTab('card');
                    if (paymentInfo.cardCompany) document.getElementById('cardCompany').value = paymentInfo.cardCompany;
                    if (paymentInfo.cardNum) document.getElementById('cardNum').value = paymentInfo.cardNum;
                    if (paymentInfo.cardExpiry) document.getElementById('cardExpiry').value = paymentInfo.cardExpiry;
                    if (paymentInfo.cardBizNum) document.getElementById('cardBizNum').value = paymentInfo.cardBizNum;
                    if (paymentInfo.cardAgree) document.getElementById('cardAgree').checked = true;
                } else if (paymentInfo.type === 'cms') {
                    togglePaymentTab('cms');
                    if (paymentInfo.bank) document.getElementById('cmsBank').value = paymentInfo.bank;
                    if (paymentInfo.accountNumber) document.getElementById('cmsAccount').value = paymentInfo.accountNumber;
                    if (paymentInfo.depositor) document.getElementById('cmsOwner').value = paymentInfo.depositor;
                    if (paymentInfo.birth) document.getElementById('cmsBirth').value = paymentInfo.birth;
                    if (paymentInfo.agreeCms) document.getElementById('cmsAgree1').checked = true;
                    if (paymentInfo.agreeThirdParty) document.getElementById('cmsAgree2').checked = true;
                }
                if (paymentInfo.taxEvidenceType && paymentInfo.taxEvidenceType !== 'none') {
                    const taxEvidenceSelect = document.getElementById('taxEvidenceType');
                    taxEvidenceSelect.value = paymentInfo.taxEvidenceType;
                    toggleTaxFields(paymentInfo.taxEvidenceType);
                    if (paymentInfo.taxEvidenceType === 'tax_invoice') {
                        document.getElementById('taxCompanyName').value = paymentInfo.taxCompanyName || '';
                        document.getElementById('taxBizNum').value = paymentInfo.taxBizNum || '';
                        document.getElementById('taxEmail').value = paymentInfo.taxEmail || '';
                    } else if (paymentInfo.taxEvidenceType === 'cash_receipt') {
                        document.getElementById('cashReceiptName').value = paymentInfo.cashReceiptName || '';
                        document.getElementById('cashReceiptPhone').value = paymentInfo.cashReceiptPhone || '';
                    }
                }
                const btn = document.getElementById('btnSavePayment');
                if (btn) btn.textContent = 'ê²°ì œì •ë³´ ìˆ˜ì •';
            } catch (error) { console.error('ê²°ì œìˆ˜ë‹¨ ì •ë³´ ë¡œë“œ ì—ëŸ¬:', error); }
        }

        window.toggleTaxFields = function(type) {
            document.getElementById('taxInvoiceFields').style.display = (type === 'tax_invoice') ? 'block' : 'none';
            document.getElementById('cashReceiptFields').style.display = (type === 'cash_receipt') ? 'block' : 'none';
        }

        window.savePaymentInfo = async function() {
            try {
                const isCard = document.getElementById('cardForm').style.display !== 'none';
                let payload = {};
                if (isCard) {
                    const cardNumEl = document.getElementById('cardNum');
                    const cardBizNumEl = document.getElementById('cardBizNum');
                    payload = {
                        type: 'card',
                        cardCompany: document.getElementById('cardCompany')?.value || '',
                        cardNum: cardNumEl?.getAttribute('data-original') || cardNumEl?.value || '',
                        cardExpiry: document.getElementById('cardExpiry')?.value || '',
                        cardBizNum: cardBizNumEl?.getAttribute('data-original') || cardBizNumEl?.value || '',
                        cardAgree: document.getElementById('cardAgree')?.checked || false
                    };
                    if (!payload.cardCompany || !payload.cardNum || !payload.cardExpiry || !payload.cardBizNum || !payload.cardAgree) {
                        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ê³  ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.'); return;
                    }
                } else {
                    const cmsAccountEl = document.getElementById('cmsAccount');
                    const birthInput = document.getElementById('cmsBirth');
                    payload = {
                        type: 'cms',
                        bank: document.getElementById('cmsBank')?.value || '',
                        accountNumber: cmsAccountEl?.getAttribute('data-original') || cmsAccountEl?.value || '',
                        depositor: document.getElementById('cmsOwner')?.value || '',
                        birth: birthInput?.getAttribute('data-original') || birthInput?.value || '',
                        agreeCms: document.getElementById('cmsAgree1')?.checked || false,
                        agreeThirdParty: document.getElementById('cmsAgree2')?.checked || false
                    };
                    if (!payload.bank || !payload.accountNumber || !payload.depositor || !payload.birth || !payload.agreeCms || !payload.agreeThirdParty) {
                        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ê³  ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.'); return;
                    }
                    const taxEvidenceType = document.getElementById('taxEvidenceType').value;
                    payload.taxEvidenceType = taxEvidenceType;
                    if (taxEvidenceType === 'tax_invoice') {
                        payload.taxCompanyName = document.getElementById('taxCompanyName').value;
                        payload.taxBizNum = document.getElementById('taxBizNum').value;
                        payload.taxEmail = document.getElementById('taxEmail').value;
                    } else if (taxEvidenceType === 'cash_receipt') {
                        payload.cashReceiptName = document.getElementById('cashReceiptName').value;
                        payload.cashReceiptPhone = document.getElementById('cashReceiptPhone').value;
                    }
                }
                const title = payload.type === 'card' ? `ê²°ì œìˆ˜ë‹¨ ë“±ë¡ (ì¹´ë“œ - ${payload.cardCompany})` : `ê²°ì œìˆ˜ë‹¨ ë“±ë¡ (CMS - ${payload.bank})`;
                await posts.create({ category: 'payment_method', title: title, content: JSON.stringify(payload, null, 2), status: 'pending' });
                alert('ê²°ì œ ìˆ˜ë‹¨ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadSavedPaymentInfo();
            } catch (e) { console.error('ê²°ì œìˆ˜ë‹¨ ì €ì¥ ì‹¤íŒ¨:', e); alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        };

        window.togglePaymentTab = function(tab) {
            const cmsForm = document.getElementById('cmsForm');
            const cardForm = document.getElementById('cardForm');
            const btns = Array.from(document.querySelectorAll('.payment-tabs .tab-btn'));
            if (btns.length >= 2) {
                btns[0].classList.toggle('active', tab !== 'card');
                btns[1].classList.toggle('active', tab === 'card');
            }
            if (cardForm) cardForm.style.display = tab === 'card' ? 'block' : 'none';
            if (cmsForm) cmsForm.style.display = tab === 'card' ? 'none' : 'block';
        };

        window.handleLogout = async function() {
            try { await auth.logout(); location.href = "../../index.html"; } catch (error) { console.error('ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:', error); }
        };
</script>
    <!-- ì¶”ê°€ ì´ìš© ë¬¸ì˜ ëª¨ë‹¬ -->
    <div id="extraPayModal" class="modal-overlay">
        <div class="modal-content" style="position:relative;">
            <span class="modal-close" onclick="closeExtraPayModal()">Ã—</span>
            <h3 class="modal-title">ğŸ’¸ ì¶”ê°€ ì´ìš© ë¬¸ì˜</h3>
            <p class="modal-desc">ìš”ê¸ˆì œ í•œë„ë¥¼ ì´ˆê³¼í•œ ì¶”ê°€ ì´ìš©ì„ ì›í•˜ì‹œë‚˜ìš”?<br>ë¬¸ì˜ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì‹œë©´ ë‹´ë‹¹ìê°€ í™•ì¸ í›„ ì—°ë½ë“œë¦½ë‹ˆë‹¤.</p>
            
            <div class="form-group">
                <label class="label">ë¬¸ì˜ ìœ í˜•</label>
                <select id="extraType" class="input-box">
                    <option value="qa_extra">ì„œë©´ ìë¬¸ ì¶”ê°€</option>
                    <option value="phone_extra">ì „í™” ìƒë‹´ ì¶”ê°€</option>
                    <option value="case_quote">ê±´ë³„ ê²¬ì  ìš”ì²­</option>
                </select>
            </div>

            <div class="form-group">
                <label class="label">ë¬¸ì˜ ë‚´ìš©</label>
                <textarea id="extraContent" class="input-box" rows="5" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
            </div>

            <div class="form-group">
                <label class="label">íšŒì‹  ì—°ë½ì²˜</label>
                <input type="tel" id="extraPhone" class="input-box" placeholder="010-1234-5678">
            </div>

            <button class="btn-submit-modal" onclick="submitExtraPay()">ë¬¸ì˜ ì œì¶œí•˜ê¸°</button>
            <button class="btn-cancel-modal" onclick="closeExtraPayModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ìš”ê¸ˆì œ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="planModal" class="modal-overlay">
        <div class="modal-content" style="position:relative;">
            <span class="modal-close" onclick="closePlanModal()">Ã—</span>
            <h3 class="modal-title">ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­</h3>
            <p class="modal-desc">ë³€ê²½ì„ ì›í•˜ì‹œëŠ” ìš”ê¸ˆì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.<br>ë‹¤ìŒ ê²°ì œì¼ë¶€í„° ì ìš©ë©ë‹ˆë‹¤.</p>
            
            <div class="form-group">
                <label class="label">ë³€ê²½í•  ìš”ê¸ˆì œ</label>
                <select id="newPlan" class="input-box">
                    <option value="Basic">ğŸŒ± Basic - ì›” 100,000ì›</option>
                    <option value="Standard">â­ Standard - ì›” 200,000ì›</option>
                    <option value="Pro">ğŸ’ Pro - ì›” 300,000ì›</option>
                    <option value="Premium">ğŸ‘‘ Premium - ì›” 500,000ì›</option>
                    <option value="Enterprise">ğŸ¢ Enterprise - ì›” 1,000,000ì›</option>
                </select>
            </div>

            <div class="form-group">
                <label class="label">ë³€ê²½ ì‚¬ìœ  (ì„ íƒ)</label>
                <textarea id="planReason" class="input-box" rows="3" placeholder="ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
            </div>

            <button class="btn-submit-modal" onclick="submitPlanChange()">ë³€ê²½ ì‹ ì²­í•˜ê¸°</button>
            <button class="btn-cancel-modal" onclick="closePlanModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // ì¼ë°˜ ìŠ¤í¬ë¦½íŠ¸: onclick í•¨ìˆ˜ë“¤
        // ì¶”ê°€ ì´ìš© ë¬¸ì˜ ëª¨ë‹¬
        window.openExtraPayModal = function() {
            document.getElementById('extraPayModal').classList.add('active');
            updateExtraPayButtonText(); // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        };

        window.closeExtraPayModal = function() {
            document.getElementById('extraPayModal').classList.remove('active');
        };

        // ì¶”ê°€ ì´ìš© ë¬¸ì˜ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateExtraPayButtonText() {
            const btn = document.querySelector('#extraPayModal .btn-submit-modal');
            if (!btn || !window.gUserData) return;

            const useApprovalFlow = window.gUserData.useApproval === 1;
            const isStaff = window.gUserData.role === 'user' || window.gUserData.role === 'manager';

            if (useApprovalFlow && isStaff) {
                btn.textContent = 'ìŠ¹ì¸ ìš”ì²­í•˜ê¸°';
            } else {
                btn.textContent = 'ë¬¸ì˜ ì œì¶œí•˜ê¸°';
            }
            btn.disabled = false;
        }

        window.submitExtraPay = async function() {
            const type = document.getElementById('extraType')?.value;
            const content = document.getElementById('extraContent')?.value;
            const phone = document.getElementById('extraPhone')?.value;

            if (!type || !content) {
                alert('ë¬¸ì˜ ìœ í˜•ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                if (!window.gUserData || !window.posts || !window.approvalRequests) {
                    throw new Error('APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                const useApprovalFlow = window.gUserData.useApproval === 1;
                const isStaff = window.gUserData.role === 'user' || window.gUserData.role === 'manager';
                
                const title = `ì¶”ê°€ ì´ìš© ë¬¸ì˜ (${type})`;
                const fullContent = `[ìœ í˜•] ${type}\n[íšŒì‹ ì²˜] ${phone || 'ë¯¸ê¸°ì¬'}\n\n[ë‚´ìš©]\n${content}`;

                if (useApprovalFlow && isStaff) {
                    // ìŠ¹ì¸ ìš”ì²­ ìƒì„±
                    await window.approvalRequests.createRequest({
                        requestType: 'ì¶”ê°€ì´ìš©ë¬¸ì˜',
                        requestData: { title, content: fullContent, authorName: window.gUserData.managerName }
                    });
                    alert('ì¶”ê°€ ì´ìš© ë¬¸ì˜ê°€ ëŒ€í‘œì—ê²Œ ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ì§ì ‘ ìƒì„±
                    await window.posts.create({
                        category: 'extra_usage_quote',
                        title: title,
                        content: fullContent,
                        authorName: window.gUserData.managerName, // ìš”ì²­ì ì´ë¦„ ëª…ì‹œ
                        status: 'pending'
                    });
                    alert('ì¶”ê°€ ì´ìš© ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                }

                closeExtraPayModal();
                location.reload(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ì¶”ê°€ ì´ìš© ë¬¸ì˜ ì˜¤ë¥˜:', error);
                alert('ì¶”ê°€ ì´ìš© ë¬¸ì˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
                updateExtraPayButtonText();
            }
        };
    
        // ìš”ê¸ˆì œ ë³€ê²½ ëª¨ë‹¬
        window.openPlanModal = function() {
            document.getElementById('planModal').classList.add('active');
            updatePlanChangeButtonText(); // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        };

        window.closePlanModal = function() {
            document.getElementById('planModal').classList.remove('active');
        };

        // ìš”ê¸ˆì œ ë³€ê²½ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updatePlanChangeButtonText() {
            const btn = document.querySelector('#planModal .btn-submit-modal');
            if (!btn || !window.gUserData) return;

            const useApprovalFlow = window.gUserData.useApproval === 1;
            const isStaff = window.gUserData.role === 'user' || window.gUserData.role === 'manager';

            if (useApprovalFlow && isStaff) {
                btn.textContent = 'ìŠ¹ì¸ ìš”ì²­í•˜ê¸°';
            } else {
                btn.textContent = 'ë³€ê²½ ì‹ ì²­í•˜ê¸°';
            }
            btn.disabled = false;
        }

        window.submitPlanChange = async function() {
            const newPlan = document.getElementById('newPlan')?.value;
            const reason = document.getElementById('planReason')?.value || '';

            if (!newPlan) {
                alert('ë³€ê²½í•  ìš”ê¸ˆì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                if (!window.gUserData || !window.posts || !window.approvalRequests) {
                    throw new Error('APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                const useApprovalFlow = window.gUserData.useApproval === 1;
                const isStaff = window.gUserData.role === 'user' || window.gUserData.role === 'manager';
                
                const title = `ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­ (${newPlan})`;
                const content = `í˜„ì¬ ìš”ê¸ˆì œë¥¼ ${newPlan}ìœ¼ë¡œ ë³€ê²½ ì‹ ì²­í•©ë‹ˆë‹¤.\në³€ê²½ ì‚¬ìœ : ${reason || 'ì—†ìŒ'}`;

                if (useApprovalFlow && isStaff) {
                    // ìŠ¹ì¸ ìš”ì²­ ìƒì„±
                    await window.approvalRequests.createRequest({
                        requestType: 'ìš”ê¸ˆì œë³€ê²½ì‹ ì²­',
                        requestData: { newPlan, reason, title, content, authorName: window.gUserData.managerName }
                    });
                    alert('ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­ì´ ëŒ€í‘œì—ê²Œ ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ì§ì ‘ ìƒì„±
                    await window.posts.create({
                        category: 'plan_change',
                        title: title,
                        content: content,
                        authorName: window.gUserData.managerName, // ìš”ì²­ì ì´ë¦„ ëª…ì‹œ
                        status: 'pending'
                    });
                    alert('ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ì ìš©ë©ë‹ˆë‹¤.');
                }

                closePlanModal();
                location.reload(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­ ì˜¤ë¥˜:', error);
                alert('ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
                updatePlanChangeButtonText(); // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
                document.querySelector('#planModal .btn-submit-modal').disabled = false;
            }
        };

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const extraModal = document.getElementById('extraPayModal');
            const planModal = document.getElementById('planModal');
            const detailModal = document.getElementById('requestDetailModal');

            if (event.target === extraModal) {
                closeExtraPayModal();
            }
            if (event.target === planModal) {
                closePlanModal();
            }
            if (event.target === detailModal) {
                closeRequestDetailModal();
            }
        };

        // ìš”ì²­ ìƒì„¸ ë‚´ìš© íŒì—…
        window.showRequestDetail = async function(docId) {
            try {
                let post;
                if (String(docId).startsWith('approval_')) {
                    const request = window.gAllRequests.find(r => r.docId === docId);
                    if (!request) {
                        alert('ìš”ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    post = {
                        title: request.title,
                        content: request.content,
                        createdAt: request.createdAt,
                        status: request.status,
                        quotedPrice: null
                    };
                } else {
                    post = await window.posts.getById(docId);
                }

                const modal = document.getElementById('requestDetailModal');
                const modalTitle = document.getElementById('requestDetailTitle');
                const modalBody = document.getElementById('requestDetailBody');

                modalTitle.textContent = post.title || 'ìš”ì²­ ìƒì„¸ ë‚´ìš©';

                let detailHtml = `
                    <div style="line-height:1.8;">
                        <div style="margin-bottom:15px; padding:15px; background:#f9f9f9; border-radius:6px;">
                            <strong style="color:#555;">ìš”ì²­ì¼:</strong> ${post.createdAt ? new Date(post.createdAt).toLocaleString('ko-KR') : '-'}<br>
                            <strong style="color:#555;">ìƒíƒœ:</strong> ${post.status || '-'}<br>
                `;

                if (post.quotedPrice) {
                    detailHtml += `<strong style="color:#555;">ê²¬ì  ê¸ˆì•¡:</strong> <span style="color:#2c5bf2; font-weight:700; font-size:16px;">${Number(post.quotedPrice).toLocaleString()}ì›</span><br>`;
                    if (post.quotedAt) {
                        detailHtml += `<strong style="color:#555;">ê²¬ì  ë°œì†¡ì¼:</strong> ${new Date(post.quotedAt).toLocaleString('ko-KR')}<br>`;
                    }
                }
                
                // ê±°ì ˆ ì‚¬ìœ  í‘œì‹œ (ì¶”ê°€)
                if (post.status === 'rejected' && post.rejectReason) {
                    detailHtml += `<strong style="color:#ff4d4f;">ê±°ì ˆ ì‚¬ìœ :</strong> <span style="color:#ff4d4f; font-weight:700;">${post.rejectReason}</span><br>`;
                }

                detailHtml += `</div>`;
                detailHtml += `
                    <div style="margin-top:20px;">
                        <strong style="color:#333; font-size:15px;">ğŸ“ ìš”ì²­ ë‚´ìš©:</strong>
                        <pre style="white-space:pre-wrap; word-break:break-all; margin-top:10px; padding:15px; background:#fff; border:1px solid #eee; border-radius:6px; line-height:1.6;">${post.content || 'ë‚´ìš© ì—†ìŒ'}</pre>
                    </div>
                `;

                modalBody.innerHTML = detailHtml;
                modal.style.display = 'block';

            } catch (error) {
                console.error('ìƒì„¸ ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        window.closeRequestDetailModal = function() {
            document.getElementById('requestDetailModal').style.display = 'none';
        };

        // ê²¬ì  ìŠ¹ì¸
        window.approveQuote = async function(docId) {
            if (!confirm('ê²¬ì ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìŠ¹ì¸ í›„ ê´€ë¦¬ìê°€ ê²°ì œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                await window.posts.update(docId, {
                    status: 'approved'
                });

                alert('âœ… ê²¬ì ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìê°€ í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                location.reload();
            } catch (error) {
                console.error('ê²¬ì  ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                alert('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ê²¬ì  ê±°ì ˆ
        window.rejectQuote = async function(docId) {
            const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­):');
            if (reason === null) return; // ì·¨ì†Œ

            if (!confirm('ê²¬ì ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await window.posts.update(docId, {
                    status: 'rejected',
                    rejectReason: reason || 'ì‚¬ìœ  ì—†ìŒ'
                });

                alert('ê²¬ì ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } catch (error) {
                console.error('ê²¬ì  ê±°ì ˆ ì‹¤íŒ¨:', error);
                alert('ê±°ì ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ìš”ì²­ ì·¨ì†Œ
        window.cancelRequest = async function(docId) {
            if (!confirm('ì •ë§ë¡œ ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await window.posts.update(docId, {
                    status: 'cancelled', // ë˜ëŠ” 'rejected' ë“±ìœ¼ë¡œ ìƒíƒœ ë³€ê²½
                    rejectReason: 'ì‚¬ìš©ì ì·¨ì†Œ'
                });

                alert('âœ… ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } catch (error) {
                console.error('ìš”ì²­ ì·¨ì†Œ ì‹¤íŒ¨:', error);
                alert('ìš”ì²­ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };
    </script>

    <!-- ìš”ì²­ ìƒì„¸ ë‚´ìš© íŒì—… ëª¨ë‹¬ -->
    <div id="requestDetailModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div style="background-color:#fff; margin:5% auto; padding:0; border-radius:12px; width:90%; max-width:600px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="requestDetailTitle" style="margin:0; font-size:18px; color:#333;">ìš”ì²­ ìƒì„¸ ë‚´ìš©</h3>
                <button onclick="closeRequestDetailModal()" style="background:none; border:none; font-size:28px; cursor:pointer; color:#999; line-height:1;">&times;</button>
            </div>
            <div id="requestDetailBody" style="padding:20px; max-height:500px; overflow-y:auto;">
                ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            <div style="padding:15px 20px; border-top:1px solid #eee; text-align:right;">
                <button onclick="closeRequestDetailModal()" style="padding:10px 24px; background:#2c5bf2; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

</body>
</html>