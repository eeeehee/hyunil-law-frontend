<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ìë¬¸ ë‚´ì—­ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size: 15px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }

        /* â–¼â–¼â–¼ [ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ í•„ìˆ˜ í¬í•¨] â–¼â–¼â–¼ */
        /* client_ui.jsê°€ HTMLì„ ê°€ì ¸ì˜¤ë”ë¼ë„, ìŠ¤íƒ€ì¼ì€ ì—¬ê¸°ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤ */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }
        
        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }
        /* â–²â–²â–² [ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ë] â–²â–²â–² */

        .main-content { flex: 1; margin-left: 260px; padding: 50px; max-width: 1600px; } 
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; }

        /* ì‚¬ìš©ëŸ‰ ë°•ìŠ¤ */
        .usage-container { display: flex; gap: 15px; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; border: 1px solid #eee; margin-right: 20px; }
        .usage-box { display: flex; align-items: center; gap: 5px; font-size: 14px; }
        .u-label { font-weight: 700; color: #555; }
        .u-val { font-weight: 800; color: #2c5bf2; font-size: 16px; }
        .u-max { color: #999; font-size: 12px; }

        /* ë²„íŠ¼ */
        .header-actions { display: flex; gap: 10px; }
        .btn-write { background-color: #1a1a1a; color: #fff; padding: 10px 20px; border-radius: 6px; font-weight: 700; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-write:hover { background-color: #333; transform: translateY(-2px); }
        .btn-phone { background-color: #fff; border: 1px solid #2c5bf2; color: #2c5bf2; padding: 10px 20px; border-radius: 6px; font-weight: 700; font-size: 14px; transition: 0.2s; }
        .btn-phone:hover { background-color: #e3f2fd; }

        /* ê²€ìƒ‰ë°” */
        .search-bar { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .date-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none; }
        .btn-search { padding: 8px 20px; background: #2c5bf2; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .btn-reset { padding: 8px 15px; background: #f5f5f5; color: #555; border: 1px solid #ddd; border-radius: 6px; font-weight: 600; cursor: pointer; }

        /* í…Œì´ë¸” */
        .board-table-container { background: #fff; border-radius: 12px; border: 1px solid #eee; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .board-table { width: 100%; border-collapse: collapse; }
        .board-table th, .board-table td { padding: 18px 20px; text-align: left; border-bottom: 1px solid #f5f5f5; font-size: 15px; }
        .board-table th { background-color: #fafafa; font-weight: 700; color: #555; border-bottom: 1px solid #eee; }
        .board-table tr:hover { background-color: #f9f9f9; }
        
        .td-title { font-weight: 600; color: #333; cursor: pointer; }
        .td-title:hover { text-decoration: underline; color: #2c5bf2; }

        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; min-width: 60px; text-align: center; }
        .status-waiting { background-color: #f0f0f0; color: #666; }
        .status-progress { background-color: #e3f2fd; color: #1976d2; }
        .status-done { background-color: #e8f5e9; color: #2e7d32; }

        /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .pagination-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; padding: 20px; }
        .pagination-btn { padding: 8px 15px; border: 1px solid #ddd; background: #fff; color: #555; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .pagination-btn:hover:not(:disabled) { background: #f5f5f5; border-color: #2c5bf2; color: #2c5bf2; }
        .pagination-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination-btn.active { background: #2c5bf2; color: #fff; border-color: #2c5bf2; }
        .pagination-info { font-size: 14px; color: #666; font-weight: 600; }

        @media (max-width: 900px) {
            .main-content { margin-left: 0; padding: 20px; }
            .header-actions { width: 100%; justify-content: space-between; margin-top: 10px; }
            .search-bar { flex-direction: column; align-items: stretch; }
            .sidebar { display: none; } /* ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ ì²˜ë¦¬ */
        }
    </style>
</head>
<body>

    
    <!-- Sidebar Skeleton (ê¹œë¹¡ì„ ë°©ì§€) -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a>
        </div>
        <div class="user-profile-area">
            <div class="user-name">ë¡œë”©ì¤‘...</div>
            <div class="user-email">...</div>
            <div class="user-role badge-staff">...</div>
        </div>
        <ul class="menu-list">
            <li><a href="../../pages/user/dashboard.html" class="menu-link">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
            <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
            <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="../../pages/public/user_guide.html" class="menu-link">ğŸ“˜ ì´ìš© ê°€ì´ë“œ (FAQ)</a></li>
        </ul>
        <div class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</div>
    </nav>

<main class="main-content">
        <div class="page-header">
            <h2 class="page-title" id="pageTitleText">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</h2>
            
            <div style="display:flex; align-items:center; flex-wrap:wrap; gap:10px;">
                <div class="usage-container" id="usageContainer" style="display:none;">
                    <div class="usage-box">
                        <span class="u-label">ğŸ“ ì„œë©´</span> 
                        <span id="qaVal" class="u-val">0</span>
                        <span id="qaMax" class="u-max">/ 0</span>
                    </div>
                    <div class="usage-box">
                        <span class="u-label">ğŸ“ ì „í™”</span> 
                        <span id="phVal" class="u-val">0</span>
                        <span id="phMax" class="u-max">/ 0</span>
                    </div>
                </div>

                <div class="header-actions">
                    <a href="../../pages/public/phone_consult.html" class="btn-phone">ğŸ“ ì „í™”ìƒë‹´ ì˜ˆì•½</a>
                    <a href="../../pages/user/board_write.html" class="btn-write">âœï¸ ìë¬¸ ì‹ ì²­í•˜ê¸°</a>
                </div>
            </div>
        </div>

        <div class="search-bar">
            <select id="searchCategory" class="date-input" style="width:130px;">
                <option value="">ì „ì²´ ë¶„ì•¼</option>
                <option value="contract">ê³„ì•½ ê²€í† </option>
                <option value="labor">ë…¸ë¬´/ì¸ì‚¬</option>
                <option value="debt">ì±„ê¶Œ/ë¯¸ìˆ˜ê¸ˆ</option>
                <option value="ip">ì§€ì‹ì¬ì‚°ê¶Œ</option>
                <option value="etc">ê¸°íƒ€ ìë¬¸</option>
            </select>

            <div id="deptSearchWrapper" style="display:none; position:relative;">
                <input list="deptList" id="searchDeptInput" class="date-input" style="width:160px;" placeholder="ë¶€ì„œëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ">
                <datalist id="deptList"></datalist>
            </div>

            <span style="font-weight:600; font-size:14px; color:#555; margin-left:10px;">ğŸ“… ê¸°ê°„:</span>
            <input type="date" id="startDate" class="date-input">
            <span style="color:#888;">~</span>
            <input type="date" id="endDate" class="date-input">
            
            <button class="btn-search" onclick="window.triggerSearch()">ê²€ìƒ‰</button>
            <button class="btn-reset" onclick="window.resetSearch()">ì´ˆê¸°í™”</button>
        </div>

        <div class="board-table-container">
            <table class="board-table">
                <thead>
                    <tr id="tableHeader">
                        <th style="width: 12%;">ìƒíƒœ</th>
                        <th style="width: 15%;">ë¶„ì•¼</th>
                        <th>ì œëª©</th>
                        <th style="width: 15%;">ë‹´ë‹¹ì</th>
                        <th style="width: 15%;">ì‘ì„±ì¼</th>
                    </tr>
                </thead>
                <tbody id="postListBody">
                    <tr><td colspan="5" style="text-align:center; padding:50px; color:#999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="paginationContainer" class="pagination-container" style="display:none;">
            <button class="pagination-btn" onclick="window.goToPage(1)" id="btnFirst">ì²˜ìŒ</button>
            <button class="pagination-btn" onclick="window.goToPrevPage()" id="btnPrev">ì´ì „</button>
            <span class="pagination-info" id="pageInfo">1 / 1</span>
            <button class="pagination-btn" onclick="window.goToNextPage()" id="btnNext">ë‹¤ìŒ</button>
            <button class="pagination-btn" onclick="window.goToLastPage()" id="btnLast">ë§ˆì§€ë§‰</button>
        </div>
    </main>

    <script src="../../js/channel-service.js"></script>

    <script type="module">
        import { auth, users, requireAuth, posts, approvalRequests } from "../../js/api.js";
        import { renderClientSidebar } from "../../js/client_ui.js";

        const PLAN_SPECS = {
            'none': { qa: 0, phone: 0, label: 'ë¯¸ê°€ì…' },
            'Basic': { qa: 1, phone: 0, label: 'ğŸŒ± Basic' },
            'Standard': { qa: 3, phone: 1, label: 'â­ Standard' },
            'Pro': { qa: 5, phone: 2, label: 'ğŸ’ Pro' },
            'Premium': { qa: 8, phone: 5, label: 'ğŸ‘‘ Premium' },
            'Enterprise': { qa: 999, phone: 999, label: 'ğŸ¢ Enterprise' }
        };

        let gUserData = null;
        let gAllPosts = []; // ì „ì²´ ê²Œì‹œê¸€ ì €ì¥
        let gCurrentPage = 1;
        const ITEMS_PER_PAGE = 10;

        (async () => {
            if (!requireAuth()) return;
            const user = auth.getCurrentUser();
            if (!user) {
                location.href = "../../pages/public/login.html";
                return;
            }

            try {
                const userData = await users.getMe();
                gUserData = userData;
                renderClientSidebar('board_list', userData);

                // ì‚¬ìš©ëŸ‰ í‘œì‹œ (ëª¨ë“  ì‚¬ìš©ì)
                const usageContainer = document.getElementById('usageContainer');
                if (usageContainer) {
                    usageContainer.style.display = 'flex';

                    const spec = PLAN_SPECS[userData.plan] || PLAN_SPECS['none'];
                    const qaLimit = userData.plan === 'Enterprise' ? (userData.customQaLimit || 0) : spec.qa;
                    const phoneLimit = userData.plan === 'Enterprise' ? (userData.customPhoneLimit || 0) : spec.phone;

                    const qaUsed = userData.qaUsedCount || 0;
                    const phoneUsed = userData.phoneUsedCount || 0;
                    const qaRemaining = Math.max(0, qaLimit - qaUsed);
                    const phoneRemaining = Math.max(0, phoneLimit - phoneUsed);

                    document.getElementById('qaVal').textContent = qaRemaining;
                    document.getElementById('qaMax').textContent = `/ ${qaLimit}`;
                    document.getElementById('phVal').textContent = phoneRemaining;
                    document.getElementById('phMax').textContent = `/ ${phoneLimit}`;
                }

                // ownerì¼ ê²½ìš° íƒ€ì´í‹€ ë³€ê²½ ë° ë¶€ì„œ ê²€ìƒ‰ í‘œì‹œ
                if (userData.role === 'owner') {
                    document.getElementById('pageTitleText').innerText = 'ìš°ë¦¬ íšŒì‚¬ ìë¬¸ ë‚´ì—­ (ì „ì²´)';
                    document.getElementById('deptSearchWrapper').style.display = 'block';

                    // í…Œì´ë¸” í—¤ë”ì— ë¶€ì„œ ì»¬ëŸ¼ ì¶”ê°€
                    const tableHeader = document.getElementById('tableHeader');
                    if (tableHeader) {
                        const deptTh = document.createElement('th');
                        deptTh.style.width = '12%';
                        deptTh.textContent = 'ë¶€ì„œ';
                        tableHeader.insertBefore(deptTh, tableHeader.children[3]); // ë‹´ë‹¹ì ì•ì— ì‚½ì…
                    }
                }

                // ìë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const statusFilter = urlParams.get('status') || '';

                console.log('--- ğŸ“‹ ìë¬¸ ë‚´ì—­ ë¡œë“œ ì‹œì‘ ---');
                const postsResponse = await posts.getAll({
                    status: statusFilter,
                    limit: 100
                });
                console.log('1. API ì‘ë‹µ (posts.getAll):', postsResponse);
                
                // ìë¬¸ë‚´ì—­ê³¼ ê´€ë ¨ ì—†ëŠ” ì¹´í…Œê³ ë¦¬ ì œì™¸
                let postsData = (postsResponse.posts || []).filter(post => {
                    return !['payment_method', 'plan_change', 'extra_usage_quote', 'member_req_internal', 'member_req_admin'].includes(post.category);
                });
                console.log('2. ìë¬¸ ê´€ë ¨ ê²Œì‹œê¸€ í•„í„°ë§ í›„:', postsData);

                // ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì¸ ìš”ì²­ ê°€ì ¸ì˜¤ê¸°
                const approvalData = await approvalRequests.getRequests({ status: 'Pending' });
                console.log('3. API ì‘ë‹µ (approvalRequests.getRequests):', approvalData);
                const approvalList = approvalData?.requests || [];

                // ìŠ¹ì¸ ìš”ì²­ ë°ì´í„°ë¥¼ ê²Œì‹œê¸€ ë°ì´í„° í˜•ì‹ê³¼ ìœ ì‚¬í•˜ê²Œ ë§¤í•‘ (ìë¬¸/ì „í™”ìƒë‹´ ìš”ì²­ë§Œ)
                const mappedApprovals = approvalList
                    .filter(req => ['ìë¬¸ìš”ì²­', 'ì „í™”ìƒë‹´'].includes(req.requestType))
                    .map(req => ({
                        docId: `approval_${req.id}`,
                        createdAt: req.createdAt,
                        category: req.requestData.category || 'etc',
                        title: req.requestData.title || `[${req.requestType}]`,
                        userDepartment: req.requesterDepartment,
                        userManagerName: req.requesterName,
                        authorUid: req.uid,
                        status: 'ìŠ¹ì¸ìš”ì²­' // ì‚¬ìš©ì ì •ì˜ ìƒíƒœ
                    }));
                console.log('4. ë§¤í•‘ëœ ìŠ¹ì¸ìš”ì²­:', mappedApprovals);
                
                // ë‘ ë¦¬ìŠ¤íŠ¸ ë³‘í•©
                let allItems = [...postsData, ...mappedApprovals];
                console.log('5. ë³‘í•©ëœ ì „ì²´ ëª©ë¡:', allItems);

                // âœ… ë¶€ì„œ ê¶Œí•œ í•„í„°: ì¼ë°˜ ì§ì›ì€ ë³¸ì¸ ë¶€ì„œ ìë¬¸ë§Œ ì—´ëŒ ê°€ëŠ¥
                if (userData.role !== 'owner') {
                    const myDept = (userData.department || '').trim();
                    if (myDept && myDept !== 'ì „ì‚¬') {
                        allItems = allItems.filter(p => ((p.userDepartment || '').trim() === myDept));
                        console.log(`6. ë¶€ì„œ í•„í„°ë§ (${myDept}) í›„:`, allItems);
                    }
                }

                // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
                allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                gAllPosts = allItems;
                gCurrentPage = 1;
                renderPosts(gAllPosts);

                // ownerì¼ ê²½ìš° ë¶€ì„œ ëª©ë¡ ë¡œë“œ
                if (userData.role === 'owner') {
                    loadDepartments(gAllPosts);
                }

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
                const tbody = document.getElementById('postListBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
                }
            }
        })();

        // ê²Œì‹œê¸€ ë Œë”ë§ í•¨ìˆ˜ (í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©)
        function renderPosts(posts) {
            const tbody = document.getElementById('postListBody');
            if (!tbody) return;

            const isOwner = gUserData && gUserData.role === 'owner';
            const colspan = isOwner ? 6 : 5;

            if (!posts || posts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center; padding:40px; color:#999;">ìë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
            const totalPages = Math.ceil(posts.length / ITEMS_PER_PAGE);
            const startIndex = (gCurrentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const currentPagePosts = posts.slice(startIndex, endIndex);

            // 10ê°œ ì´ìƒì¼ ë•Œë§Œ í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ
            const paginationContainer = document.getElementById('paginationContainer');
            if (posts.length > 10) {
                paginationContainer.style.display = 'flex';
                updatePaginationUI(totalPages);
            } else {
                paginationContainer.style.display = 'none';
            }

            tbody.innerHTML = currentPagePosts.map(post => {
                // ì¶”ê°€ ì§ˆë¬¸ ì—¬ë¶€ í™•ì¸
                const hasFollowup = post.content && post.content.includes('[FOLLOWUP_SEPARATOR]');
                const hasAnswer = post.answer && post.answer.trim();

                // ìƒíƒœ ë§¤í•‘ (ë°ì´í„°ë² ì´ìŠ¤ ê°’ -> í‘œì‹œ)
                let statusClass = 'status-done';
                let statusText = 'ë‹µë³€ ì™„ë£Œ';
                let rowClickAction = `location.href='board_view.html?id=${post.docId}'`;
                let cursorStyle = 'pointer';

                // ì¹´í…Œê³ ë¦¬ ë§¤í•‘
                const categoryMap = {
                    'contract': 'ê³„ì•½ ê²€í† ',
                    'labor': 'ë…¸ë¬´/ì¸ì‚¬',
                    'debt': 'ì±„ê¶Œ/ë¯¸ìˆ˜ê¸ˆ',
                    'ip': 'ì§€ì‹ì¬ì‚°ê¶Œ',
                    'etc': 'ê¸°íƒ€ ìë¬¸',
                    'guest': 'ë¹„íšŒì› ìƒë‹´',
                    'plan_change': 'ìš”ê¸ˆì œ ë³€ê²½',
                    'payment_method': 'ê²°ì œìˆ˜ë‹¨ ë“±ë¡',
                    'extra_usage_quote': 'ì¶”ê°€ ì´ìš© ê²¬ì ',
                    'member_req_internal': 'ë¶€ì„œ ë³€ê²½ ìš”ì²­',
                    'member_req_admin': 'íšŒì› ì •ë³´ ë³€ê²½',
                    'phone_request': 'ì „í™”ìƒë‹´ ìš”ì²­',
                    'phone_log': 'ì „í™”ìƒë‹´ ê¸°ë¡'
                };
                const displayCategory = categoryMap[post.category] || post.category || '-';
                
                if (post.status === 'ìŠ¹ì¸ìš”ì²­') {
                    statusClass = 'status-waiting';
                    statusText = 'ìŠ¹ì¸ ëŒ€ê¸°ì¤‘';
                    rowClickAction = ''; // ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì—ëŠ” ìƒì„¸ í˜ì´ì§€ ì´ë™ ë¶ˆê°€
                    cursorStyle = 'default';
                } else if (hasFollowup && (post.status === 'analyzing' || post.status === 'processing')) {
                    statusClass = 'status-progress';
                    statusText = 'ì¶”ê°€ì§ˆë¬¸';
                } else if (post.status === 'pending' || post.status === 'waiting') {
                    statusClass = 'status-waiting';
                    statusText = 'ë‹µë³€ ëŒ€ê¸°ì¤‘';
                } else if (post.status === 'analyzing' || post.status === 'processing' || post.status === 'InProgress') {
                    statusClass = 'status-progress';
                    statusText = 'ê²€í† ì¤‘';
                } else if (post.status === 'done' || post.status === 'completed' || post.status === 'Completed') {
                    statusClass = 'status-done';
                    statusText = 'ë‹µë³€ ì™„ë£Œ';
                }

                // ë‹´ë‹¹ìëŠ” ì‘ì„±ìì˜ ë‹´ë‹¹ì ì´ë¦„ (ê³ ì •)
                const displayManager = post.userManagerName || '-';
                const displayDept = post.userDepartment || '-';

                // ownerì¼ ë•ŒëŠ” ë¶€ì„œ ì»¬ëŸ¼ ì¶”ê°€
                const deptCell = isOwner ? `<td>${displayDept}</td>` : '';

                return `
                    <tr onclick="${rowClickAction}" style="cursor:${cursorStyle};">
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${displayCategory}</td>
                        <td class="title-cell">${post.title || '(ì œëª© ì—†ìŒ)'}</td>
                        ${deptCell}
                        <td>${displayManager}</td>
                        <td>${post.createdAt ? new Date(post.createdAt).toLocaleDateString('ko-KR') : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // ë¶€ì„œ ëª©ë¡ ë¡œë“œ (owner ì „ìš©)
        function loadDepartments(posts) {
            const deptSet = new Set();
            posts.forEach(post => {
                if (post.userDepartment && post.userDepartment.trim()) {
                    deptSet.add(post.userDepartment.trim());
                }
            });

            const datalist = document.getElementById('deptList');
            if (datalist) {
                datalist.innerHTML = Array.from(deptSet).sort().map(dept =>
                    `<option value="${dept}">`
                ).join('');
            }
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        window.triggerSearch = async function() {
            const category = document.getElementById('searchCategory').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const deptInput = document.getElementById('searchDeptInput');
            const department = deptInput ? deptInput.value.trim() : '';

            try {
                const params = { limit: 100 };
                if (category) params.category = category;
                if (department) params.department = department;

                const response = await posts.getAll(params);
                let postsData = (response.posts || []).filter(post => {
                    return post.category !== 'payment_method'
                        && post.category !== 'plan_change'
                        && post.category !== 'extra_usage_quote'
                        && post.category !== 'member_req_internal'
                        && post.category !== 'member_req_admin';
                });

                // âœ… ë¶€ì„œ ê¶Œí•œ í•„í„°: ì¼ë°˜ ì§ì›ì€ ë³¸ì¸ ë¶€ì„œ ìë¬¸ë§Œ ì—´ëŒ ê°€ëŠ¥
                if (gUserData && gUserData.role !== 'owner') {
                    const myDept = (gUserData.department || '').trim();
                    // ë¶€ì„œê°€ 'ì „ì‚¬'ë©´ ì „ì²´ ì—´ëŒ
                    if (myDept && myDept !== 'ì „ì‚¬') {
                        postsData = postsData.filter(p => ((p.userDepartment || '').trim() === myDept));
                    }
                }


                // ë‚ ì§œ í•„í„°ë§ (í”„ë¡ íŠ¸ì—”ë“œ)
                if (startDate || endDate) {
                    postsData = postsData.filter(post => {
                        if (!post.createdAt) return false;
                        const postDate = new Date(post.createdAt).toISOString().split('T')[0];
                        if (startDate && postDate < startDate) return false;
                        if (endDate && postDate > endDate) return false;
                        return true;
                    });
                }

                gAllPosts = postsData;
                gCurrentPage = 1;
                renderPosts(postsData);
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸
        function updatePaginationUI(totalPages) {
            const pageInfo = document.getElementById('pageInfo');
            const btnFirst = document.getElementById('btnFirst');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const btnLast = document.getElementById('btnLast');

            pageInfo.textContent = `${gCurrentPage} / ${totalPages}`;

            btnFirst.disabled = gCurrentPage === 1;
            btnPrev.disabled = gCurrentPage === 1;
            btnNext.disabled = gCurrentPage === totalPages;
            btnLast.disabled = gCurrentPage === totalPages;
        }

        // í˜ì´ì§€ ì´ë™ í•¨ìˆ˜ë“¤
        window.goToPage = function(page) {
            const totalPages = Math.ceil(gAllPosts.length / ITEMS_PER_PAGE);
            if (page < 1 || page > totalPages) return;
            gCurrentPage = page;
            renderPosts(gAllPosts);
        };

        window.goToNextPage = function() {
            const totalPages = Math.ceil(gAllPosts.length / ITEMS_PER_PAGE);
            if (gCurrentPage < totalPages) {
                gCurrentPage++;
                renderPosts(gAllPosts);
            }
        };

        window.goToPrevPage = function() {
            if (gCurrentPage > 1) {
                gCurrentPage--;
                renderPosts(gAllPosts);
            }
        };

        window.goToLastPage = function() {
            const totalPages = Math.ceil(gAllPosts.length / ITEMS_PER_PAGE);
            gCurrentPage = totalPages;
            renderPosts(gAllPosts);
        };

        // ê²€ìƒ‰ ì´ˆê¸°í™”
        window.resetSearch = function() {
            document.getElementById('searchCategory').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            const deptInput = document.getElementById('searchDeptInput');
            if (deptInput) deptInput.value = '';
            window.location.reload();
        };

        // ë¡œê·¸ì•„ì›ƒ
        window.handleLogout = async function() {
            try {
                await auth.logout();
                location.href = "../../index.html";
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:', error);
            }
        };
    </script>
</body>
</html>
