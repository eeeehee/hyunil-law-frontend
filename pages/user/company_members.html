<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ì› ê´€ë¦¬ (CEO) - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }

        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }

        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }

        .main-content { flex: 1; margin-left: 260px; padding: 60px 50px; }
        .page-header { margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 20px; display:flex; justify-content:space-between; align-items:center; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; }

        /* [NEW] ìŠ¹ì¸ ìš”ì²­ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .approval-box { background-color: #fffbe6; border: 1px solid #ffe58f; padding: 25px; border-radius: 12px; margin-bottom: 40px; display: none; /* ìš”ì²­ ì—†ìœ¼ë©´ ìˆ¨ê¹€ */ }
        .approval-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #faad14; padding-bottom: 10px; }
        .approval-title { font-size: 18px; font-weight: 700; color: #d48806; display: flex; align-items: center; gap: 8px; }
        .btn-approve-all { background-color: #d48806; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 13px; }
        .btn-approve-all:hover { background-color: #ad6800; }

        .req-table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; }
        .req-table th { text-align: left; padding: 10px; background-color: #fff1b8; font-weight: 700; color: #d46b08; }
        .req-table td { padding: 12px 10px; border-bottom: 1px solid #fff1b8; }
        .req-highlight { color: #2c5bf2; font-weight: 700; }

        .btn-act { padding: 4px 10px; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 12px; font-weight: 600; }
        .btn-act.ok { border-color: #2c5bf2; color: #2c5bf2; }
        .btn-act.ok:hover { background: #f0f5ff; }
        .btn-act.no { border-color: #ff4d4f; color: #ff4d4f; margin-left: 5px; }
        .btn-act.no:hover { background: #fff1f0; }

        /* ë¶€ì„œ ì„¤ì • ë°•ìŠ¤ */
        .dept-settings-box { background-color: #f0f5ff; border: 1px solid #adc6ff; padding: 25px; border-radius: 12px; margin-bottom: 30px; }
        .dept-settings-title { font-size: 16px; font-weight: 700; color: #1d39c4; margin-bottom: 15px; }
        .dept-input-area { display: flex; gap: 10px; align-items: flex-start; }
        .dept-input { flex: 1; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; }
        .dept-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .dept-tag { background: #1890ff; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; }
        .dept-tag-remove { cursor: pointer; font-weight: 700; }
        .btn-add-dept { padding: 10px 20px; background: #1890ff; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .btn-add-dept:hover { background: #096dd9; }

        /* ì§ì› ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */
        .member-table-container { background: #fff; border-radius: 12px; border: 1px solid #eee; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .member-table { width: 100%; border-collapse: collapse; }
        .member-table th, .member-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
        .member-table th { background-color: #fafafa; font-weight: 600; color: #555; }
        
        .role-select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 13px; }

        /* ìŠ¹ì¸ê²°ì¬ í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .approval-toggle-wrapper { display: flex; align-items: center; gap: 10px; }
        .toggle-label { font-size: 14px; font-weight: 600; color: #555; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #1890ff; }
        input:checked + .slider:before { transform: translateX(22px); }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 30px 20px; }
        }
    </style>
</head>
<body>

    
    <!-- Sidebar Skeleton (ê¹œë¹¡ì„ ë°©ì§€) -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a>
        </div>
        <div class="user-profile-area">
            <div class="user-name">ë¡œë”©ì¤‘...</div>
            <div class="user-email">...</div>
            <div class="user-role badge-staff">...</div>
        </div>
        <ul class="menu-list">
            <li><a href="../../pages/user/dashboard.html" class="menu-link">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
            <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
            <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="../../pages/public/user_guide.html" class="menu-link">ğŸ“˜ ì´ìš© ê°€ì´ë“œ (FAQ)</a></li>
        </ul>
        <div class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h2 class="page-title">ì§ì› ê´€ë¦¬ (CEO ì „ìš©)</h2>
            <div class="approval-toggle-wrapper">
                <span class="toggle-label">ìŠ¹ì¸ê²°ì¬ ê¸°ëŠ¥</span>
                <label class="switch">
                    <input type="checkbox" id="approvalToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div class="dept-settings-box">
            <div class="dept-settings-title">ğŸ¢ íšŒì‚¬ ë¶€ì„œ ëª©ë¡ ì„¤ì •</div>
            <div style="font-size:13px; color:#666; margin-bottom:15px;">
                íšŒì‚¬ì˜ ëª¨ë“  ë¶€ì„œë¥¼ ë“±ë¡í•˜ì„¸ìš”. ì§ì›ì—ê²Œ "ì „ì‚¬ ê¶Œí•œ"ì„ ë¶€ì—¬í•˜ë©´ ìë¬¸ ì‹ ì²­ ì‹œ ëª¨ë“  ë¶€ì„œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
            <div class="dept-input-area">
                <input type="text" id="newDeptInput" class="dept-input" placeholder="ë¶€ì„œëª… ì…ë ¥ (ì˜ˆ: ì¸ì‚¬íŒ€, ë§ˆì¼€íŒ…íŒ€)" onkeypress="if(event.key==='Enter') addDepartment()">
                <button class="btn-add-dept" onclick="addDepartment()">ë¶€ì„œ ì¶”ê°€</button>
            </div>
            <div class="dept-list" id="deptList">
                <!-- ë¶€ì„œ íƒœê·¸ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div id="approvalSection" class="approval-box">
            <div class="approval-header">
                <span class="approval-title">ğŸ”” ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ <span id="reqCount">0</span>ê±´ ìˆìŠµë‹ˆë‹¤.</span>
                <button class="btn-approve-all" onclick="approveAll()">âš¡ ì „ì²´ ì¼ê´„ ìŠ¹ì¸</button>
            </div>
            <table class="req-table">
                <thead>
                    <tr>
                        <th>ìš”ì²­ì</th>
                        <th>ìŠ¹ì¸ìš”ì²­</th>
                        <th>ìš”ì²­ ë‚´ìš©</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="reqListBody">
                    </tbody>
            </table>
        </div>

        <div class="member-table-container">
            <table class="member-table">
                <thead>
                    <tr>
                        <th>ì´ë¦„</th>
                        <th>ë¶€ì„œ</th>
                        <th>ì´ë©”ì¼ (ID)</th>
                        <th>ì—°ë½ì²˜</th>
                        <th>ê¶Œí•œ(ì§ê¸‰) ê´€ë¦¬</th>
                        <th>ì „ì‚¬ ê¶Œí•œ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="memberListBody">
                    <tr><td colspan="7" style="text-align:center; padding:30px;">ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script type="module">
        import { auth, users, requireAuth, posts } from "../../js/api.js";
        import { renderClientSidebar } from "../../js/client_ui.js";

    const PLANS = {
        'none': {limit:1},
        'Basic':{limit:3},
        'Standard':{limit:7},
        'Pro':{limit:12},
        'Premium':{limit:17},
        'Enterprise':{limit:999}
    };

    const categoryMap = {
        'contract': 'ê³„ì•½ ê²€í† ',
        'labor': 'ë…¸ë¬´/ì¸ì‚¬',
        'debt': 'ì±„ê¶Œ/ë¯¸ìˆ˜ê¸ˆ',
        'ip': 'ì§€ì‹ì¬ì‚°ê¶Œ',
        'etc': 'ê¸°íƒ€ ìë¬¸',
    };

    const requestTypeKoreanMap = {
        'ìë¬¸ìš”ì²­': 'ìë¬¸ ìš”ì²­',
        'ë¶€ì„œë³€ê²½': 'ë¶€ì„œ ë³€ê²½ ìš”ì²­',
        'ì „í™”ìƒë‹´': 'ì „í™” ìƒë‹´ ìš”ì²­',
        'ì¶”ê°€ì´ìš©ë¬¸ì˜': 'ì¶”ê°€ ì´ìš© ë¬¸ì˜',
        'ìš”ê¸ˆì œë³€ê²½ì‹ ì²­': 'ìš”ê¸ˆì œ ë³€ê²½ ì‹ ì²­'
    };
    
    let allCompanies = [];
    let inactiveCompanies = [];
    let gOwnerData = null; // ëŒ€í‘œ ì •ë³´
    let gCompanyDepartments = []; // ë¶€ì„œ ëª©ë¡

        (async () => {
            if (!requireAuth()) {
                location.href = "../../pages/public/login.html";
                return;
            }

            const user = auth.getCurrentUser();
            if (!user) {
                location.href = "../../pages/public/login.html";
                return;
            }

            try {
                const userData = await users.getMe();

                // master, admin, ownerë§Œ ì ‘ê·¼ ê°€ëŠ¥
                if (!['master', 'admin', 'owner'].includes(userData.role)) {
                    alert('ëŒ€í‘œ(CEO) ë˜ëŠ” ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    location.href = '../../pages/user/dashboard.html';
                    return;
                }

                gOwnerData = userData;
                renderClientSidebar('company_members', userData);

                // ìŠ¹ì¸ê²°ì¬ í† ê¸€ ê¸°ëŠ¥ ì´ˆê¸°í™”
                initApprovalToggle();

                // íšŒì‚¬ ë¶€ì„œ ëª©ë¡ ë¡œë“œ
                await loadCompanyDepartments();

                // ìŠ¹ì¸ ìš”ì²­ ë¡œë“œ
                await loadApprovalRequests();

                // ì§ì› ëª©ë¡ ë¡œë“œ
                await loadMembers();

            } catch (error) {
                console.error('ì§ì› ê´€ë¦¬ ë¡œë“œ ì—ëŸ¬:', error);
                alert('ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })();

        // íšŒì‚¬ ë¶€ì„œ ëª©ë¡ ë¡œë“œ
        async function loadCompanyDepartments() {
            try {
                const userData = await users.getMe();

                // departments íŒŒì‹±
                if (userData.departments) {
                    if (typeof userData.departments === 'string') {
                        try {
                            gCompanyDepartments = JSON.parse(userData.departments);
                        } catch (e) {
                            gCompanyDepartments = [];
                        }
                    } else if (Array.isArray(userData.departments)) {
                        gCompanyDepartments = userData.departments;
                    }
                }

                // ë¶€ì„œ ëª©ë¡ í‘œì‹œ
                renderDepartmentList();
            } catch (error) {
                console.error('ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë¶€ì„œ ëª©ë¡ ë Œë”ë§
        function renderDepartmentList() {
            const deptList = document.getElementById('deptList');
            if (!deptList) return;

            if (gCompanyDepartments.length === 0) {
                deptList.innerHTML = '<div style="color:#999; font-size:13px; padding:10px;">ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ë¶€ì„œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            deptList.innerHTML = gCompanyDepartments.map(dept => `
                <div class="dept-tag">
                    ${dept}
                    <span class="dept-tag-remove" onclick="removeDepartment('${dept}')">âœ•</span>
                </div>
            `).join('');
        }

        // ë¶€ì„œ ì¶”ê°€
        window.addDepartment = async function() {
            const input = document.getElementById('newDeptInput');
            const deptName = input.value.trim();

            if (!deptName) {
                alert('ë¶€ì„œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (gCompanyDepartments.includes(deptName)) {
                alert('ì´ë¯¸ ë“±ë¡ëœ ë¶€ì„œì…ë‹ˆë‹¤.');
                return;
            }

            gCompanyDepartments.push(deptName);
            console.log('ë¶€ì„œ ì¶”ê°€ ì‹œë„:', deptName);
            console.log('í˜„ì¬ ë¶€ì„œ ëª©ë¡:', gCompanyDepartments);

            try {
                // ëŒ€í‘œì˜ departments ì—…ë°ì´íŠ¸
                const updateData = { departments: gCompanyDepartments };
                console.log('ì „ì†¡í•  ë°ì´í„°:', updateData);

                const result = await users.updateMe(updateData);
                console.log('ì—…ë°ì´íŠ¸ ê²°ê³¼:', result);

                input.value = '';
                renderDepartmentList();
                alert(`"${deptName}" ë¶€ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ë¶€ì„œ ì¶”ê°€ ì‹¤íŒ¨ - ì „ì²´ ì—ëŸ¬:', error);
                console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
                alert('ë¶€ì„œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                gCompanyDepartments.pop(); // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
            }
        };

        // ë¶€ì„œ ì‚­ì œ
        window.removeDepartment = async function(deptName) {
            if (!confirm(`"${deptName}" ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const index = gCompanyDepartments.indexOf(deptName);
            if (index > -1) {
                gCompanyDepartments.splice(index, 1);
            }

            try {
                await users.updateMe({ departments: gCompanyDepartments });
                renderDepartmentList();
                alert(`"${deptName}" ë¶€ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ë¶€ì„œ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ë¶€ì„œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                gCompanyDepartments.push(deptName); // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
            }
        };

        // ì§ì› ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
        async function loadMembers() {
            try {
                const response = await users.getAll();
                const allUsers = response.users || [];

                console.log('ì§ì› ëª©ë¡:', allUsers);

                const tbody = document.getElementById('memberListBody');

                if (allUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = allUsers.map(member => {
                    console.log('ì§ì› ì •ë³´:', member.managerName, 'role:', member.role, 'email:', member.email);
                    const roleKorean = getRoleKorean(member.role);

                    // ì „ì‚¬ ê¶Œí•œ í™•ì¸
                    let hasAllDeptAccess = false;
                    if (member.departments) {
                        if (typeof member.departments === 'string') {
                            try {
                                const depts = JSON.parse(member.departments);
                                hasAllDeptAccess = Array.isArray(depts) && depts.length > 0;
                            } catch (e) {
                                hasAllDeptAccess = false;
                            }
                        } else if (Array.isArray(member.departments)) {
                            hasAllDeptAccess = member.departments.length > 0;
                        }
                    }

                    const checkboxChecked = hasAllDeptAccess ? 'checked' : '';
                    const accessBadge = hasAllDeptAccess ? '<span style="color:#52c41a; font-size:12px;">âœ“ ì „ì‚¬ ê¶Œí•œ</span>' : '<span style="color:#999; font-size:12px;">ë¶€ì„œ ì œí•œ</span>';

                    return `
                        <tr>
                            <td>${member.managerName || '-'}</td>
                            <td>${member.department || '-'}</td>
                            <td>${member.email}</td>
                            <td>${member.phone || '-'}</td>
                            <td>
                                <select class="role-select" data-uid="${member.uid}" data-current-role="${member.role}">
                                    <option value="owner" ${member.role === 'owner' ? 'selected' : ''}>ëŒ€í‘œ (CEO)</option>
                                    <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>ë¶€ì„œì¥ (Manager)</option>
                                    <option value="user" ${member.role === 'user' || member.role === 'staff' || member.role === 'employee' ? 'selected' : ''}>ì¼ë°˜ ì§ì›</option>
                                </select>
                                <button class="btn-act ok" onclick="changeRole('${member.uid}', this.previousElementSibling.value)">ë³€ê²½</button>
                            </td>
                            <td>
                                <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-start;">
                                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                        <input type="checkbox" ${checkboxChecked} onchange="toggleAllDeptAccess('${member.uid}', this.checked)" style="cursor:pointer;">
                                        ${accessBadge}
                                    </label>
                                </div>
                            </td>
                            <td>
                                <button class="btn-act no" onclick="deleteMember('${member.uid}', '${member.managerName}')">ì‚­ì œ</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì§ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                const tbody = document.getElementById('memberListBody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:red;">ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // ì—­í•  í•œê¸€ ë³€í™˜
        function getRoleKorean(role) {
            const roleMap = {
                'master': 'ìµœê³  ê´€ë¦¬ì',
                'admin': 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
                'owner': 'ëŒ€í‘œ (CEO)',
                'manager': 'ë¶€ì„œì¥',
                'user': 'ì¼ë°˜ ì§ì›',
                'staff': 'ì¼ë°˜ ì§ì›',
                'employee': 'ì¼ë°˜ ì§ì›'
            };
            return roleMap[role] || role;
        }

        // ì „ì‚¬ ê¶Œí•œ í† ê¸€
        window.toggleAllDeptAccess = async function(uid, isChecked) {
            if (gCompanyDepartments.length === 0) {
                alert('ë¨¼ì € íšŒì‚¬ ë¶€ì„œ ëª©ë¡ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                await loadMembers(); // ì²´í¬ë°•ìŠ¤ ë³µì›
                return;
            }

            const action = isChecked ? 'ë¶€ì—¬' : 'í•´ì œ';
            if (!confirm(`ì „ì‚¬ ê¶Œí•œì„ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n${isChecked ? 'ì´ ì§ì›ì€ ìë¬¸ ì‹ ì²­ ì‹œ ëª¨ë“  ë¶€ì„œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 'ì´ ì§ì›ì€ ìì‹ ì˜ ë¶€ì„œë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'}`)) {
                await loadMembers(); // ì²´í¬ë°•ìŠ¤ ë³µì›
                return;
            }

            try {
                const updateData = {
                    departments: isChecked ? gCompanyDepartments : null
                };

                await users.update(uid, updateData);
                alert(`ì „ì‚¬ ê¶Œí•œì´ ${action}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                await loadMembers();
            } catch (error) {
                console.error('ì „ì‚¬ ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨:', error);
                alert('ì „ì‚¬ ê¶Œí•œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                await loadMembers(); // ì²´í¬ë°•ìŠ¤ ë³µì›
            }
        };

        // ì—­í•  ë³€ê²½
        window.changeRole = async function(uid, newRole) {
            if (!confirm('ì´ ì§ì›ì˜ ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await users.update(uid, { role: newRole });
                alert('ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadMembers();
            } catch (error) {
                console.error('ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨:', error);
                alert('ê¶Œí•œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ì§ì› ì‚­ì œ
        window.deleteMember = async function(uid, name) {
            if (!confirm(`ì •ë§ "${name}" ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                await users.delete(uid);
                alert('ì§ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadMembers();
            } catch (error) {
                console.error('ì§ì› ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì§ì› ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ìŠ¹ì¸ê²°ì¬ ê¸°ëŠ¥ í† ê¸€ ì´ˆê¸°í™”
        function initApprovalToggle() {
            const toggleWrapper = document.querySelector('.approval-toggle-wrapper');
            const toggle = document.getElementById('approvalToggle');
            if (!toggleWrapper || !toggle) return;

            // owner ì—­í• ì¼ ë•Œë§Œ í† ê¸€ ë³´ì„
            if (gOwnerData && gOwnerData.role === 'owner') {
                toggleWrapper.style.display = 'flex';
                
                // ì´ˆê¸° ìƒíƒœ ì„¤ì •
                toggle.checked = gOwnerData.useApproval === 1;

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                toggle.addEventListener('change', handleToggleChange);
            } else {
                toggleWrapper.style.display = 'none';
            }
        }

        // í† ê¸€ ë³€ê²½ í•¸ë“¤ëŸ¬
        async function handleToggleChange(event) {
            const isChecked = event.target.checked;
            const status = isChecked ? 'ON' : 'OFF';

            if (!confirm(`ìŠ¹ì¸ê²°ì¬ ê¸°ëŠ¥ì„ ${status} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n${isChecked ? 'ì§ì›ì´ ìë¬¸ ìš”ì²­ ì‹œ ëŒ€í‘œì˜ ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' : 'ëª¨ë“  ìš”ì²­ì´ ìŠ¹ì¸ ì—†ì´ ë°”ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.'}`)) {
                event.target.checked = !isChecked; // ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¼
                return;
            }

            try {
                await users.updateMe({ useApproval: isChecked });
                alert(`ìŠ¹ì¸ê²°ì¬ ê¸°ëŠ¥ì´ ${status} ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                // í•„ìš”í•˜ë‹¤ë©´ UI ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ìŠ¹ì¸ê²°ì¬ ê¸°ëŠ¥ ë³€ê²½ ì‹¤íŒ¨:', error);
                alert('ê¸°ëŠ¥ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                event.target.checked = !isChecked; // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¼
            }
        }

        // [REVISED] ìŠ¹ì¸ ìš”ì²­ ë¡œë“œ
        async function loadApprovalRequests() {
            try {
                const filters = { 
                    category: 'member_req_internal', 
                    status: 'pending' 
                };
                if (gOwnerData && gOwnerData.bizNum) {
                    filters.bizNum = gOwnerData.bizNum;
                }

                const response = await posts.getAll(filters);
                const requests = response.posts || [];

                if (requests.length === 0) {
                    document.getElementById('approvalSection').style.display = 'none';
                    return;
                }

                document.getElementById('approvalSection').style.display = 'block';
                document.getElementById('reqCount').textContent = requests.length;

                const tbody = document.getElementById('reqListBody');
                tbody.innerHTML = '';

                requests.forEach(req => {
                    const requestData = JSON.parse(req.content || '{}');
                    // âœ… newDepartment í•„ë“œ ì‚¬ìš© (member_info.htmlì—ì„œ ì €ì¥í•˜ëŠ” í•„ë“œëª…)
                    const requestContentHtml = `${requestData.fromDepartment || 'ë¯¸ì§€ì •'} â†’ <span class="req-highlight">${requestData.newDepartment || 'ë¯¸ì§€ì •'}</span>`;
                    const dateStr = new Date(req.createdAt).toLocaleString('ko-KR');

                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <div style="font-weight:700;">${req.userManagerName || 'ì´ë¦„ ì—†ìŒ'}</div>
                                <div style="font-size:11px; color:#888;">${req.userDepartment || '-'}</div>
                                <div style="font-size:11px; color:#999;">ìš”ì²­ì¼: ${dateStr}</div>
                            </td>
                            <td>ë¶€ì„œ ë³€ê²½</td>
                            <td>${requestContentHtml}</td>
                            <td>
                                <button class="btn-act ok" onclick="handleDeptChangeApproval('${req.docId}')">âœ“ ìŠ¹ì¸</button>
                                <button class="btn-act no" onclick="handleDeptChangeRejection('${req.docId}')">âœ• ê±°ì ˆ</button>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('âŒ ìŠ¹ì¸ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('approvalSection').style.display = 'none';
            }
        }

        // [REVISED] ê°œë³„ ìŠ¹ì¸ ì²˜ë¦¬
        window.handleDeptChangeApproval = async function(docId) {
            try {
                if (!confirm('ì´ ë¶€ì„œ ë³€ê²½ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                await posts.approveDepartmentChange(docId);
                alert('âœ… ìš”ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì§ì›ì˜ ë¶€ì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadApprovalRequests();
                await loadMembers();
            } catch (error) {
                console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì—ëŸ¬:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // [NEW] ë¶€ì„œ ë³€ê²½ ê±°ì ˆ ì²˜ë¦¬
        window.handleDeptChangeRejection = async function(docId) {
            try {
                const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ "ì‚¬ìœ  ì—†ìŒ"ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤)');
                if (reason === null) return; // ì‚¬ìš©ìê°€ ì·¨ì†Œ ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš°

                await posts.rejectDepartmentChange(docId, reason);
                alert('âŒ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadApprovalRequests();
            } catch (error) {
                console.error('ê±°ì ˆ ì²˜ë¦¬ ì—ëŸ¬:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ì „ì²´ ì¼ê´„ ìŠ¹ì¸
        window.approveAll = async function() {
            alert('ì¼ê´„ ìŠ¹ì¸ ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        };

        window.handleLogout = async () => {
            await auth.logout();
            location.href = "../../index.html";
        };
    </script>
</body>
</html>
