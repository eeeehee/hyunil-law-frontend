<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë²•ë¥  ìë¬¸ ë¦¬í¬íŠ¸</title>
    <link rel="stylesheet" as="style" crossorigin="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        body { background-color: #f0f2f5; font-family: "Pretendard", sans-serif; margin: 0; padding: 40px 20px; }
        .report-container { max-width: 800px; margin: 0 auto; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .report-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 30px; }
        .report-title h1 { font-size: 28px; font-weight: 900; margin: 0 0 10px; color: #1a1a2e; }
        .report-meta { font-size: 14px; color: #666; line-height: 1.6; }
        .report-actions button { background: #333; color: #fff; border: none; padding: 10px 20px; font-size: 14px; border-radius: 6px; cursor: pointer; font-weight: 700; }
        .section { margin-bottom: 40px; }
        .section-title { font-size: 18px; font-weight: 700; color: #1a1a2e; margin-bottom: 15px; padding-left: 10px; border-left: 3px solid #2c5bf2; }
        .opinion-box { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 25px; line-height: 1.7; white-space: pre-wrap; font-size: 15px; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: #e9ecef; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden; text-align: center; }
        .summary-item { background: #fff; padding: 20px; }
        .summary-item .label { font-size: 14px; color: #666; margin-bottom: 8px; }
        .summary-item .value { font-size: 24px; font-weight: 700; color: #1a1a2e; }
        .summary-item .value.red { color: #e53935; }
        .summary-item .value.green { color: #43a047; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .report-table th, .report-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .report-table th { background-color: #f9fafb; font-weight: 600; text-align: center; }
        .report-table td { text-align: center; }
        .report-table td:nth-child(2) { text-align: left; }
    </style>
</head>
<body>

<div class="report-container" id="reportContainer">
    <!-- ë°ì´í„° ë¡œë”© ì „ í‘œì‹œë  ë‚´ìš© -->
    <div style="text-align: center; padding: 80px 0;">
        <h2 id="loadingText">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
    </div>
</div>

<script type="module">
    import { reports, users } from '../../js/api.js';

    function renderReport(report) {
        const container = document.getElementById('reportContainer');
        
        try {
            const data = JSON.parse(report.content);
            const [year, month] = report.period.split('-');

            container.innerHTML = `
                <div class="report-header">
                    <div class="report-title">
                        <h1>${year}ë…„ ${month}ì›” ë²•ë¥  ìë¬¸ ë¦¬í¬íŠ¸</h1>
                        <div class="report-meta">
                            <strong>ìˆ˜ì‹ :</strong> ${data.companyName} ê·€ì¤‘<br>
                            <strong>ê¸°ê°„:</strong> ${report.period}<br>
                            <strong>ë°œí–‰:</strong> ë²•ë¬´ê·¸ë£¹ í˜„ì¼ ê¸°ì—…ìë¬¸ì„¼í„°
                        </div>
                    </div>
                    <div class="report-actions">
                        <button onclick="window.print()">ğŸ–¨ï¸ PDF ì €ì¥/ì¸ì‡„</button>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">ì¢…í•© ì˜ê²¬</h2>
                    <div class="opinion-box">${data.opinion || 'ì‘ì„±ëœ ì¢…í•© ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                </div>

                <div class="section">
                    <h2 class="section-title">ìë¬¸ í˜„í™© ìš”ì•½</h2>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="label">ì´ ìš”ì²­</div>
                            <div class="value">${data.stats.total}ê±´</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">ì²˜ë¦¬ ì™„ë£Œ</div>
                            <div class="value green">${data.stats.completed}ê±´</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">ì§„í–‰ ì¤‘</div>
                            <div class="value red">${data.stats.pending}ê±´</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">ë¶€ì„œë³„ í˜„í™©</h2>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>ë¶€ì„œëª…</th>
                                <th>ê±´ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(data.deptStats).map(([dept, count]) => `
                                <tr>
                                    <td>${dept}</td>
                                    <td>${count}ê±´</td>
                                </tr>
                            `).join('')}
                            ${Object.keys(data.deptStats).length === 0 ? '<tr><td colspan="2">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <h2 class="section-title">ìƒì„¸ ìë¬¸ ë‚´ì—­</h2>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>ì¼ì</th>
                                <th>ìë¬¸ ì œëª©</th>
                                <th>ìš”ì²­ì</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.posts.map(post => `
                                <tr>
                                    <td>${new Date(post.date).toLocaleDateString()}</td>
                                    <td style="text-align:left;">${post.title}</td>
                                    <td>${post.requester}</td>
                                    <td>${post.status}</td>
                                </tr>
                            `).join('')}
                            ${data.posts.length === 0 ? '<tr><td colspan="4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (e) {
            console.error('ë¦¬í¬íŠ¸ ë‚´ìš© íŒŒì‹± ì‹¤íŒ¨:', e);
            container.innerHTML = '<div style="text-align: center; padding: 80px 0;"><h2 id="loadingText">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜•ì‹ ì˜¤ë¥˜)</h2></div>';
        }
    }

    (async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');
        const loadingText = document.getElementById('loadingText');

        if (!docId) {
            loadingText.innerText = 'âŒ ë¦¬í¬íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        try {
            const report = await reports.getById(docId);
            renderReport(report);
        } catch (error) {
            console.error("ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:", error);
            loadingText.innerText = `âŒ ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`;
        }
    })();
</script>

</body>
</html>