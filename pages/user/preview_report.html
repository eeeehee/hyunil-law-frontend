<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë²•ë¥  ìë¬¸ ë¦¬í¬íŠ¸</title>
    <link rel="stylesheet" as="style" crossorigin="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #f5f7fa; font-family: "Pretendard", sans-serif; margin: 0; padding: 0; }

        /* ìƒë‹¨ í—¤ë”ë°” */
        .top-header {
            background: #fff;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .top-header-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        .top-header-actions {
            position: absolute;
            right: 30px;
            display: flex;
            gap: 10px;
        }
        .btn-close {
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-close:hover {
            background: #f5f5f5;
        }
        .btn-pdf {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
        }
        .btn-pdf:hover {
            background: #555;
        }

        /* í•„í„° ì„¹ì…˜ */
        .filter-section {
            background: #e8f4fc;
            border-bottom: 1px solid #d0e8f5;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .filter-select {
            height: 38px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 0 12px;
            font-size: 14px;
            background: #fff;
            cursor: pointer;
            min-width: 120px;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .report-container {
            max-width: 850px;
            margin: 30px auto;
            background: #fff;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.05);
        }

        /* ë¦¬í¬íŠ¸ ì œëª© */
        .report-title-section {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }
        .report-main-title {
            font-size: 26px;
            font-weight: 900;
            color: #1a1a2e;
            margin-bottom: 15px;
        }
        .report-meta {
            font-size: 14px;
            color: #666;
            line-height: 1.8;
        }
        .report-meta strong {
            color: #333;
        }

        /* ì„¹ì…˜ */
        .section {
            margin-bottom: 40px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title-icon {
            font-size: 18px;
        }

        /* ì¢…í•© ì˜ê²¬ ë°•ìŠ¤ */
        .opinion-box {
            background-color: #e8f4fc;
            border: 1px solid #d0e8f5;
            border-radius: 8px;
            padding: 25px;
            line-height: 1.8;
            white-space: pre-wrap;
            font-size: 14px;
            color: #333;
        }

        /* ìš”ì•½ í…Œì´ë¸” */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        .summary-table th,
        .summary-table td {
            padding: 18px 20px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }
        .summary-table th {
            background-color: #f9fafb;
            font-weight: 600;
            font-size: 14px;
            color: #555;
        }
        .summary-table td {
            font-size: 18px;
            font-weight: 700;
        }
        .summary-table td.green {
            color: #2e7d32;
        }
        .summary-table td.red {
            color: #c62828;
        }

        /* ì¼ë°˜ í…Œì´ë¸” */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            border: 1px solid #e9ecef;
        }
        .report-table th,
        .report-table td {
            padding: 14px 18px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .report-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #555;
        }
        .report-table tbody tr:hover {
            background-color: #fafafa;
        }
        .report-table td.left {
            text-align: left;
        }

        /* ë¶€ì„œë³„ í˜„í™© ë ˆì´ë¸” */
        .dept-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
        @media print {
            .top-header,
            .filter-section {
                display: none !important;
            }
            body {
                background: #fff;
            }
            .report-container {
                margin: 0;
                padding: 30px;
                box-shadow: none;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>

<!-- ìƒë‹¨ í—¤ë” -->
<div class="top-header" id="topHeader">
    <span class="top-header-title">ë¦¬í¬íŠ¸</span>
    <div class="top-header-actions">
        <button class="btn-close" onclick="closeReport()">ë‹«ê¸°</button>
        <button class="btn-pdf" onclick="window.print()">PDF ì €ì¥/ì¸ì‡„</button>
    </div>
</div>

<!-- í•„í„° ì„¹ì…˜ -->
<div class="filter-section" id="filterSection">
    <select class="filter-select" id="filterDept" onchange="applyFilter()">
        <option value="all">ì „ì²´ ë¶€ì„œ (CEOìš©)</option>
    </select>
    <select class="filter-select" id="filterYear" onchange="applyFilter()"></select>
    <select class="filter-select" id="filterMonth" onchange="applyFilter()"></select>
</div>

<div class="report-container" id="reportContainer">
    <!-- ë°ì´í„° ë¡œë”© ì „ í‘œì‹œë  ë‚´ìš© -->
    <div style="text-align: center; padding: 80px 0;">
        <h2 id="loadingText">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
    </div>
</div>

<script type="module">
    import { reports, users, posts, admin } from '../../js/api.js';

    let currentReport = null;
    let allPosts = [];
    let currentBizNum = '';

    function closeReport() {
        window.history.back();
    }
    window.closeReport = closeReport;

    function renderReport(report, filteredData = null) {
        const container = document.getElementById('reportContainer');

        try {
            const data = filteredData || JSON.parse(report.content);
            const [year, month] = report.period.split('-');

            container.innerHTML = `
                <div class="report-title-section">
                    <h1 class="report-main-title">${year}ë…„ ${parseInt(month)}ì›” ë²•ë¥  ìë¬¸ ë¦¬í¬íŠ¸</h1>
                    <div class="report-meta">
                        <strong>ìˆ˜ì‹ :</strong> ${data.companyName} ëŒ€í‘œì´ì‚¬ ê·€ì¤‘<br>
                        <strong>ê¸°ê°„:</strong> ${year}ë…„ ${parseInt(month)}ì›”<br>
                        <strong>ë°œí–‰:</strong> ë²•ë¬´ê·¸ë£¹ í˜„ì¼ ê¸°ì—…ìë¬¸ì„¼í„°
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="section-title-icon">â­</span> ì¢…í•© ì˜ê²¬</h2>
                    <div class="opinion-box">${data.opinion || 'ì‘ì„±ëœ ì¢…í•© ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="section-title-icon">ğŸ“Š</span> ìë¬¸ í˜„í™© ìš”ì•½</h2>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>ì´ ìš”ì²­</th>
                                <th>ì²˜ë¦¬ ì™„ë£Œ</th>
                                <th>ì§„í–‰ ì¤‘</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${data.stats.total}ê±´</td>
                                <td class="green">${data.stats.completed}ê±´</td>
                                <td class="red">${data.stats.pending}ê±´</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <div class="dept-label">[ë¶€ì„œë³„ í˜„í™©]</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>ë¶€ì„œëª…</th>
                                <th>ê±´ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(data.deptStats).map(([dept, count]) => `
                                <tr>
                                    <td>${dept}</td>
                                    <td>${count}ê±´</td>
                                </tr>
                            `).join('')}
                            ${Object.keys(data.deptStats).length === 0 ? '<tr><td colspan="2" style="color:#999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="section-title-icon">â­</span> ìƒì„¸ ìë¬¸ ë‚´ì—­</h2>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th style="width:100px;">ì¼ì</th>
                                <th>ìë¬¸ ì œëª©</th>
                                <th style="width:100px;">ìš”ì²­ì</th>
                                <th style="width:80px;">ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.posts.map(post => {
                                const statusText = getStatusText(post.status);
                                return `
                                    <tr>
                                        <td>${formatDate(post.date)}</td>
                                        <td class="left">${post.title}</td>
                                        <td>${post.requester}</td>
                                        <td>${statusText}</td>
                                    </tr>
                                `;
                            }).join('')}
                            ${data.posts.length === 0 ? '<tr><td colspan="4" style="color:#999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (e) {
            console.error('ë¦¬í¬íŠ¸ ë‚´ìš© íŒŒì‹± ì‹¤íŒ¨:', e);
            container.innerHTML = '<div style="text-align: center; padding: 80px 0;"><h2 id="loadingText">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜•ì‹ ì˜¤ë¥˜)</h2></div>';
        }
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
    }

    function getStatusText(status) {
        const statusMap = {
            'pending': 'ëŒ€ê¸°',
            'in_progress': 'ì§„í–‰ì¤‘',
            'done': 'ì™„ë£Œ',
            'completed': 'ì™„ë£Œ',
            'answered': 'ë‹µë³€ì™„ë£Œ'
        };
        return statusMap[status] || status || '-';
    }

    function initFilters(report) {
        const [year, month] = report.period.split('-');
        const currentYear = parseInt(year);
        const currentMonth = parseInt(month);

        // ë…„ë„ ì…€ë ‰íŠ¸
        const yearSelect = document.getElementById('filterYear');
        yearSelect.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const y = currentYear - i;
            yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}ë…„</option>`;
        }

        // ì›” ì…€ë ‰íŠ¸
        const monthSelect = document.getElementById('filterMonth');
        monthSelect.innerHTML = '';
        for (let i = 1; i <= 12; i++) {
            monthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${i}ì›”</option>`;
        }
    }

    async function loadDepartments(bizNum) {
        const deptSelect = document.getElementById('filterDept');
        try {
            const response = await admin.getEmployees(bizNum);
            const employees = response.employees || [];
            const depts = new Set(employees.map(e => e.department).filter(Boolean));

            deptSelect.innerHTML = '<option value="all">ì „ì²´ ë¶€ì„œ (CEOìš©)</option>';
            depts.forEach(d => {
                deptSelect.innerHTML += `<option value="${d}">${d}</option>`;
            });
        } catch(e) {
            console.log('ë¶€ì„œ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    window.applyFilter = async function() {
        if (!currentReport) return;

        const dept = document.getElementById('filterDept').value;
        const year = document.getElementById('filterYear').value;
        const month = document.getElementById('filterMonth').value;

        try {
            // ê¸°ì¡´ ë¦¬í¬íŠ¸ ë°ì´í„°ì—ì„œ ì›ë³¸ opinion ê°€ì ¸ì˜¤ê¸°
            const originalData = JSON.parse(currentReport.content);

            // ìƒˆ ê¸°ê°„ì— ë§ëŠ” posts í•„í„°ë§
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 1);

            const filteredPosts = allPosts.filter(p => {
                const postDate = new Date(p.createdAt);
                const isInDate = postDate >= startDate && postDate < endDate;
                if (!isInDate) return false;
                if (dept === 'all') return true;
                return p.userDepartment === dept || p.department === dept;
            });

            const stats = {
                total: filteredPosts.length,
                completed: filteredPosts.filter(p => ['done', 'completed', 'answered'].includes(p.status)).length,
                pending: filteredPosts.filter(p => !['done', 'completed', 'answered'].includes(p.status)).length
            };

            const deptStats = filteredPosts.reduce((acc, p) => {
                const deptName = p.userDepartment || p.department || 'ë¯¸ì§€ì •';
                acc[deptName] = (acc[deptName] || 0) + 1;
                return acc;
            }, {});

            const filteredData = {
                companyName: originalData.companyName,
                opinion: originalData.opinion,
                stats,
                deptStats,
                posts: filteredPosts.map(p => ({
                    date: p.createdAt,
                    category: p.category,
                    title: p.title,
                    requester: p.userManagerName || 'N/A',
                    status: p.status
                }))
            };

            // ê°€ìƒì˜ report ê°ì²´ ìƒì„± (periodë§Œ ë³€ê²½)
            const virtualReport = {
                ...currentReport,
                period: `${year}-${String(month).padStart(2, '0')}`
            };

            renderReport(virtualReport, filteredData);

        } catch(e) {
            console.error('í•„í„° ì ìš© ì‹¤íŒ¨:', e);
        }
    }

    (async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');
        const loadingText = document.getElementById('loadingText');

        if (!docId) {
            loadingText.innerText = 'ë¦¬í¬íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        try {
            const report = await reports.getById(docId);
            currentReport = report;
            currentBizNum = report.target_biz_num;

            // í•„í„° ì´ˆê¸°í™”
            initFilters(report);
            await loadDepartments(currentBizNum);

            // ì „ì²´ posts ë¡œë“œ (í•„í„°ìš©)
            try {
                const postsResponse = await posts.getAll({
                    bizNum: currentBizNum,
                    category: 'general_counsel,contract_review,legal_document,certification,phone_log,visit_consult,case_representation'
                });
                allPosts = postsResponse.posts || [];
            } catch(e) {
                console.log('Posts ë¡œë“œ ì‹¤íŒ¨:', e);
                allPosts = [];
            }

            renderReport(report);
        } catch (error) {
            console.error("ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:", error);
            loadingText.innerText = `ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`;
        }
    })();
</script>

</body>
</html>
