<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¦¬í¬íŠ¸ ë°œì†¡ ë””ìì¸ ë¯¸ë¦¬ë³´ê¸°</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #f0f2f5; margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; }
        .controls { text-align: center; margin-bottom: 30px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin: 0 5px; font-weight: bold; }
        button.active { background: #1a1a2e; color: #fff; border-color: #1a1a2e; }
        
        .preview-wrapper { width: 210mm; margin: 0 auto; background: white; padding: 0; box-shadow: 0 0 20px rgba(0,0,0,0.1); min-height: 297mm; position: relative; }
        .guide { text-align: center; color: #666; margin-bottom: 10px; font-size: 14px; }
        
        /* PDFìš© ìŠ¤íƒ€ì¼ (ë‚˜ëˆ”ê³ ë”• ê°•ì œ) */
        .pdf-content { padding: 50px; font-family: 'Nanum Gothic', sans-serif; color: #333; line-height: 1.6; }
        .pdf-header { border-bottom: 2px solid #082545; padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .pdf-title { font-size: 28px; font-weight: 800; color: #082545; margin: 0; }
        .pdf-sub { font-size: 12px; color: #555; }
        
        .stat-box { display: flex; gap: 10px; margin-bottom: 30px; }
        .stat-item { flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat-label { font-size: 12px; color: #666; margin-bottom: 5px; display: block; }
        .stat-val { font-size: 20px; font-weight: 800; color: #082545; }

        .pdf-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 30px; }
        .pdf-table th { background: #082545; color: white; padding: 8px; text-align: center; font-weight: normal; }
        .pdf-table td { border-bottom: 1px solid #ddd; padding: 8px; text-align: center; }
        .td-left { text-align: left !important; }
        
        .opinion-box { border: 1px solid #082545; border-radius: 8px; padding: 20px; margin-top: 30px; position: relative; }
        .op-title { position: absolute; top: -12px; left: 20px; background: white; padding: 0 10px; font-weight: bold; color: #082545; }

        /* ì´ë©”ì¼ìš© ìŠ¤íƒ€ì¼ */
        .email-wrapper { max-width: 600px; margin: 0 auto; background: #fff; padding: 40px; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="controls">
    <button id="pdfBtn" onclick="show('pdf')" class="active">ğŸ“Š ë¦¬í¬íŠ¸ (PDF)</button>
    <button id="emailBtn" onclick="show('email')">ğŸ“§ ì´ë©”ì¼ ë³¸ë¬¸</button>
</div>

<p class="guide" id="guideText">â€» ì„œë²„ì—ì„œ ìë™ ìƒì„±ë˜ì–´ ì²¨ë¶€ë  PDF ë””ìì¸ì…ë‹ˆë‹¤.</p>

<div id="viewer"></div>

<script type="module">
    import { reports } from '../../js/api.js';

    let reportData = null;

    function buildViews(report) {
        const today = new Date();
        const dateStr = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›”`;
        const companyName = report.companyName || (report.title.match(/\[(.*?)\]/) ? report.title.match(/\[(.*?)\]/)[1] : 'ê³ ê°ì‚¬');
        
        // period (YYYY-MM) -> YYYY.MM.01 ~ YYYY.MM.ë§ˆì§€ë§‰ì¼
        const [year, month] = report.period.split('-');
        const startDate = new Date(year, month - 1, 2).toISOString().slice(0, 10).replace(/-/g, '.');
        const endDate = new Date(year, month, 1).toISOString().slice(0, 10).replace(/-/g, '.');

        return {
            pdf: `
                <div class="preview-wrapper"><div class="pdf-content">
                    <div class="pdf-header">
                        <div>
                            <h1 class="pdf-title">${report.type === 'month' ? 'ì›”ê°„' : 'ì •ê¸°'} ë²•ë¥  ìë¬¸ ë¦¬í¬íŠ¸</h1>
                            <span class="pdf-sub">ê¸°ê°„: ${startDate} ~ ${endDate}</span>
                        </div>
                        <div style="text-align:right;">
                            <strong style="font-size:16px; color:#082545;">${companyName} ê·€ì¤‘</strong><br>
                            <span style="font-size:11px;">ë°œí–‰ì¼: ${new Date(report.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>

                    <div class="opinion-box">
                        <span class="op-title">âš–ï¸ ì „ë‹´ ë³€í˜¸ì‚¬ ì¢…í•© ì˜ê²¬</span>
                        <p style="font-size:13px; margin:0; white-space: pre-wrap;">${report.content || 'ì¢…í•© ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                    </div>

                    <div style="position:absolute; bottom:50px; width:calc(100% - 100px); text-align:center; border-top:1px solid #eee; padding-top:20px;">
                        <strong style="color:#082545;">ë²•ë¬´ê·¸ë£¹ í˜„ì¼ ê¸°ì—…ìë¬¸ì„¼í„°</strong><br>
                        <span style="font-size:11px; color:#888;">ë³¸ ë¬¸ì„œëŠ” ê¸°ì—… ë²•ë¬´ ìë¬¸ ë‚´ì—­ì„ ì •ë¦¬í•œ ë¦¬í¬íŠ¸ì´ë©°, ë²•ì  íš¨ë ¥ì´ ìˆëŠ” ì¦ëª…ì„œëŠ” ì•„ë‹™ë‹ˆë‹¤.</span>
                    </div>
                </div></div>
            `,
            email: `
                <div class="email-wrapper">
                    <h2 style="color:#082545; margin-top:0;">[ë²•ë¬´ê·¸ë£¹ í˜„ì¼] ${year}ë…„ ${month}ì›” ìë¬¸ ë¦¬í¬íŠ¸</h2>
                    <p style="font-size:15px; line-height:1.6; color:#333;">
                        <strong>${companyName}</strong> ë‹´ë‹¹ìë‹˜, ì•ˆë…•í•˜ì„¸ìš”.<br>
                        ë²•ë¬´ê·¸ë£¹ í˜„ì¼ì…ë‹ˆë‹¤.<br><br>
                        ${year}ë…„ ${month}ì›” ì§„í–‰ëœ ë²•ë¥  ìë¬¸ ë‚´ì—­ì„ ì •ë¦¬í•˜ì—¬<br>
                        <strong>ì›”ê°„ ë¦¬í¬íŠ¸(PDF)</strong>ë¥¼ ì†¡ë¶€ë“œë¦½ë‹ˆë‹¤.<br><br>
                        ìì„¸í•œ ë‚´ìš©ì€ ì²¨ë¶€íŒŒì¼ì„ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ë¼ë©°,<br>
                        ë¬¸ì˜ì‚¬í•­ì€ ì–¸ì œë“  ì—°ë½ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                    </p>
                    
                    <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:25px 0; border:1px solid #eee;">
                        <strong>ğŸ“ ì²¨ë¶€íŒŒì¼:</strong> 
                        <span style="color:#082545; font-weight:bold;">${year}ë…„_${month}ì›”_ë²•ë¥ ìë¬¸ë¦¬í¬íŠ¸.pdf</span>
                    </div>

                    <div style="border-top:1px solid #eee; padding-top:20px; margin-top:30px; font-size:12px; color:#888; text-align:center;">
                        ë³¸ ë©”ì¼ì€ ë°œì‹  ì „ìš©ì…ë‹ˆë‹¤.<br>
                        ë²•ë¬´ê·¸ë£¹ í˜„ì¼ | 1533-6092
                    </div>
                </div>
            `
        };
    }

    function show(type) {
        const container = document.getElementById('viewer');
        const guide = document.getElementById('guideText');
        
        document.getElementById('pdfBtn').classList.toggle('active', type === 'pdf');
        document.getElementById('emailBtn').classList.toggle('active', type === 'email');

        if (!reportData) {
            container.innerHTML = "ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
"
            return;
        }

        const views = buildViews(reportData);

        if(type === 'pdf') {
            container.innerHTML = views.pdf;
            guide.innerText = "â€» ì„œë²„ì—ì„œ ìë™ ìƒì„±ë˜ì–´ ì²¨ë¶€ë  PDF ë””ìì¸ì…ë‹ˆë‹¤.";
        } else {
            container.innerHTML = views.email;
            guide.innerText = "â€» ë‹´ë‹¹ìì—ê²Œ ë°œì†¡ë  ì´ë©”ì¼ ë³¸ë¬¸ì…ë‹ˆë‹¤.";
        }
    }

    // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë…¸ì¶œ
    window.show = show;

    // ë©”ì¸ ë¡œì§
    (async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');
        const viewer = document.getElementById('viewer');

        if (!docId) {
            viewer.innerHTML = '<h2 style="text-align:center; padding:50px;">âŒ ë¦¬í¬íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.</h2>';
            return;
        }

        try {
            viewer.innerHTML = '<h2 style="text-align:center; padding:50px;">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>';
            reportData = await reports.getById(docId);
            console.log("Fetched Report Data:", reportData);
            show('pdf');
        } catch(error) {
            console.error("ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:", error);
            viewer.innerHTML = `<h2 style="text-align:center; padding:50px;">âŒ ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}</h2>`;
        }
    })();
</script>

</body>
</html>