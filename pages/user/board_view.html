<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë¬¸ ìƒì„¸ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        textarea { font-family: inherit; }

        /* [ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ - board_listì™€ í†µì¼] */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }

        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }

        .main-content { flex: 1; margin-left: 260px; padding: 50px; max-width: 1800px; margin-right: auto; }
        .layout-flex { display: flex; gap: 40px; align-items: flex-start; justify-content: center; }
        .content-left { flex: 1; min-width: 600px; max-width: 1100px; }
        .content-right { width: 450px; flex-shrink: 0; }

        .page-header { margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        .header-top { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .badge { padding: 4px 10px; border-radius: 4px; font-size: 13px; font-weight: 700; }
        
        .badge-waiting { background-color: #e0e0e0; color: #555; }
        .badge-pending { background-color: #fff7e6; color: #fa8c16; border: 1px solid #ffe7ba; }
        .badge-progress { background-color: #e3f2fd; color: #1976d2; }
        .badge-done { background-color: #e8f5e9; color: #2e7d32; }
        
        .category { font-size: 14px; color: #666; font-weight: 600; }
        .post-title { font-size: 28px; font-weight: 700; line-height: 1.4; color: #1a1a1a; }

        .chat-stream { display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px; }
        .msg-box { position: relative; padding: 30px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); line-height: 1.6; font-size: 16px; }
        .msg-question { background-color: #fff; border: 1px solid #e0e0e0; margin-right: 40px; }
        .msg-question::before { content: "Q"; position: absolute; top: 25px; left: -15px; width: 30px; height: 30px; background: #333; color: #fff; border-radius: 50%; text-align: center; line-height: 30px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg-answer { background-color: #fdfdfd; border: 1px solid #2c5bf2; margin-left: 40px; }
        .msg-answer::before { content: "A"; position: absolute; top: 25px; right: -15px; width: 30px; height: 30px; background: #2c5bf2; color: #fff; border-radius: 50%; text-align: center; line-height: 30px; font-weight: 700; box-shadow: 0 2px 5px rgba(44, 91, 242, 0.2); }

        .msg-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .writer-name { font-weight: 700; font-size: 15px; color: #333; }
        .msg-content { white-space: pre-wrap; color: #333; min-height: 60px; }
        .msg-time { text-align: right; font-size: 12px; color: #999; margin-top: 10px; font-weight: 500; }

        .file-download-box { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd; }
        .btn-download { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background-color: #f5f7fa; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; font-weight: 600; color: #333; text-decoration: none; transition: 0.2s; }
        .btn-download:hover { background-color: #eee; border-color: #bbb; }
        .admin-file-link { background-color: #e6f7ff; border-color: #91d5ff; color: #0050b3; }

        /* ì˜ˆì•½ ì •ë³´ ë°•ìŠ¤ (ì „í™”ìƒë‹´ìš©) */
        .booking-info-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .booking-label { display: block; margin-bottom: 8px; color: #2c5bf2; font-weight: 700; font-size: 14px; }
        .booking-list { list-style: none; padding: 0; font-size: 14px; color: #555; }
        .booking-list li { margin-bottom: 4px; }

        .followup-form-box { background: #fff; padding: 30px; border-radius: 12px; border: 1px solid #ddd; border-left: 4px solid #2c5bf2; margin-top: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: none; }
        .form-guide { font-size: 16px; font-weight: 700; color: #2c5bf2; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .followup-input { width: 100%; height: 160px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; font-size: 15px; resize: none; outline: none; margin-top: 15px; line-height: 1.6; }
        .followup-input:focus { border-color: #2c5bf2; }
        .form-bottom { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 12px; }
        .btn-submit-sub { background-color: #2c5bf2; color: #fff; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 700; font-size: 15px; cursor: pointer; transition: 0.2s; }
        
        .admin-form { border: 2px solid #ff9800; background-color: #fffaf0; padding: 25px; border-radius: 12px; margin-top: 20px; display: none; }
        .admin-label { font-weight: 700; color: #e65100; margin-bottom: 10px; display: block; }
        .admin-textarea { width: 100%; height: 120px; padding: 15px; border: 1px solid #ffcc80; border-radius: 6px; resize: none; outline: none; background: #fff; }
        .admin-file-area { margin-top: 10px; padding: 10px; background: #fff; border: 1px dashed #ffcc80; border-radius: 6px; }
        .btn-admin-submit { background-color: #ff9800; color: #fff; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; float: right; margin-top: 10px; }

        .history-box { background: #fff; border-radius: 12px; border: 1px solid #eee; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: sticky; top: 20px; }
        .history-title { font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 15px; border-bottom: 2px solid #1a1a1a; padding-bottom: 10px; }
        .history-list { list-style: none; padding: 0; }
        .history-item { padding: 12px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .history-item:hover { background-color: #fafafa; }
        .h-status { font-size: 11px; font-weight: 700; padding: 3px 6px; border-radius: 4px; flex-shrink: 0; }
        .h-status.done { background: #e8f5e9; color: #4caf50; }
        .h-status.waiting { background: #f0f0f0; color: #888; }
        .h-status.pending { background: #fff7e6; color: #fa8c16; }
        .h-status.active { background: #e6f7ff; color: #1890ff; }
        .h-subject { font-size: 14px; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .h-date { font-size: 12px; color: #999; flex-shrink: 0; }

        .btn-wrap { margin-top: 40px; display: flex; justify-content: center; gap: 10px; }
        .btn-list { background: #fff; border: 1px solid #ddd; color: #555; padding: 12px 30px; border-radius: 6px; font-weight: 700; cursor: pointer; text-decoration: none; }
        .btn-cancel { background: #fff; border: 1px solid #ff4d4f; color: #ff4d4f; padding: 12px 30px; border-radius: 6px; font-weight: 700; cursor: pointer; display: none; }
        .btn-cancel:hover { background: #fff1f0; }
        .btn-instant { background: #fff; border: 1px solid #2c5bf2; color: #2c5bf2; padding: 12px 30px; border-radius: 6px; font-weight: 700; cursor: pointer; display: none; }
        .btn-instant:hover { background: #f0f5ff; }

        @media (max-width: 1300px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px; max-width: 100%; }
            .layout-flex { flex-direction: column; }
            .content-left { width: 100%; min-width: auto; }
            .content-right { width: 100%; margin-top: 40px; }
            .msg-question, .msg-answer { margin: 0; }
            .msg-question::before, .msg-answer::before { display: none; }
        }
    </style>
</head>
<body>

 <nav class="sidebar">
    <div class="sidebar-logo"><a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a></div>
    <ul class="menu-list">
        <li><a href="../../pages/user/dashboard.html" class="menu-link">ëŒ€ì‹œë³´ë“œ</a></li>
        <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
        <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
        <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
        <li><a href="../../pages/public/faq.html" target="_blank" class="menu-link">â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</a></li>
        <li><a href="../../pages/user/company_members.html" class="menu-link" id="menuCeoOnly">ğŸ‘¥ ì§ì› ê´€ë¦¬ (CEO)</a></li>
    </ul>
    <div class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</div>
</nav>

    <main class="main-content">
        <div class="layout-flex">
            <div class="content-left">
                <div class="page-header">
                    <div class="header-top">
                        <span class="badge badge-waiting" id="postBadge">ë¡œë”©ì¤‘</span>
                        <span class="category" id="postCategory">ë¶„ì•¼</span>
                    </div>
                    <h1 class="post-title" id="postTitle">ë¡œë”©ì¤‘...</h1>
                </div>

                <div class="chat-stream" id="chatStream"></div>

                <div class="admin-form" id="adminMainForm">
                    <span class="admin-label">ğŸ‘®â€â™‚ï¸ [ê´€ë¦¬ì] 1ì°¨ ë‹µë³€ ì‘ì„±</span>
                    <textarea id="adminMainInput" class="admin-textarea" placeholder="ë‹µë³€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                    <div class="admin-file-area">
                        <label style="font-size:13px; font-weight:600; margin-right:10px;">ğŸ“ ì²¨ë¶€íŒŒì¼ (ê²€í† ëœ ê³„ì•½ì„œ ë“±):</label>
                        <input type="file" id="adminFileMain">
                    </div>
                    <button class="btn-admin-submit" onclick="submitMainAnswer()">ë‹µë³€ ë“±ë¡</button>
                    <div style="clear:both;"></div>
                </div>

                <div class="followup-form-box" id="followUpForm">
                    <div class="form-guide">ğŸ’¬ ì¶”ê°€ ë¬¸ì˜í•˜ê¸° <span style="font-size:13px; color:#999;">(ìµœëŒ€ 2íšŒ)</span></div>
                    <textarea id="subQuestionInput" class="followup-input" placeholder="ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                    <div class="form-bottom">
                        <span style="font-size:13px; color:#888;">â€» ê°„ë‹¨í•œ ì§ˆì˜ì‘ë‹µ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</span>
                        <button class="btn-submit-sub" onclick="submitFollowUp()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>

                <div class="btn-wrap">
                    <a href="../../pages/user/board_list.html" class="btn-list">ëª©ë¡ìœ¼ë¡œ</a>
                    <button class="btn-instant" id="btnInstant" onclick="instantAccept()">âš¡ ì¦‰ì‹œ ì ‘ìˆ˜í•˜ê¸°</button>
                    <button class="btn-cancel" id="btnCancel" onclick="cancelRequest()">ì ‘ìˆ˜ ì·¨ì†Œ</button>
                </div>
            </div> 
            
            <aside class="content-right">
                <div class="history-box">
                    <div class="history-title">ğŸ“‚ ìµœê·¼ ìë¬¸ ë‚´ì—­</div>
                    <ul class="history-list" id="historyList">
                        <li class="history-item" style="text-align:center; color:#999; font-size:13px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
                    </ul>
                </div>
            </aside>
        </div> 
    </main>

    <script type="module">
        import { auth, users, requireAuth, posts } from "../../js/api.js";
        import { renderClientSidebar } from "../../js/client_ui.js";

        (async () => {
            if (!requireAuth()) {
                location.href = "../../pages/public/login.html";
                return;
            }

            const user = auth.getCurrentUser();
            if (!user) {
                location.href = "../../pages/public/login.html";
                return;
            }

            try {
                const userData = await users.getMe();
                renderClientSidebar('board_view', userData);

                // URLì—ì„œ ID ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');

                if (!postId) {
                    alert('ê²Œì‹œê¸€ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                    location.href = '../../pages/user/board_list.html';
                    return;
                }

                const post = await posts.getById(postId);
                console.log('ê²Œì‹œê¸€:', post);
                renderPost(post, userData);

                // ìµœê·¼ ìë¬¸ ë‚´ì—­ ë¡œë“œ
                await loadRecentPosts();

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì—ëŸ¬:', error);
                alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                location.href = '../../pages/user/board_list.html';
            }
        })();

        
        // ì¶”ê°€ë¬¸ì˜/ì¶”ê°€ë‹µë³€ ë¬¸ìì—´ì—ì„œ (YYYY. M. D. ì˜¤ì „/ì˜¤í›„ H:MM:SS) í˜•íƒœì˜ ì‹œê°„ì„ ì¶”ì¶œ
        function getFollowupTime(text) {
            if (!text) return '';
            const firstLine = String(text).split('\n')[0] || '';
            const m = firstLine.match(/\(([^)]+)\)/);
            if (m && m[1]) return m[1].trim();
            return '';
        }

        // ì¶”ê°€ë¬¸ì˜/ì¶”ê°€ë‹µë³€ì˜ ì²« ì¤„ í—¤ë”([ì¶”ê°€ë¬¸ì˜ n] (...))ë¥¼ ì œê±°í•˜ê³  ë³¸ë¬¸ë§Œ ë°˜í™˜
        function stripFollowupHeader(text) {
            if (!text) return '';
            const lines = String(text).split('\n');
            if (lines.length === 0) return '';
            const first = (lines[0] || '').trim();
            if (first.startsWith('[') && first.includes('ì¶”ê°€') && first.includes('(') && first.includes(')')) {
                return lines.slice(1).join('\n').trim();
            }
            if (/^\[?(ì¶”ê°€ë¬¸ì˜|ì¶”ê°€ë‹µë³€)/.test(first) && first.includes('(') && first.includes(')')) {
                return lines.slice(1).join('\n').trim();
            }
            return String(text).trim();
        }

// ê²Œì‹œê¸€ ë Œë”ë§ í•¨ìˆ˜
        function renderPost(post, userData) {
            // ìƒíƒœ ë°°ì§€ ì„¤ì •
            const badge = document.getElementById('postBadge');
            const category = document.getElementById('postCategory');
            const title = document.getElementById('postTitle');
            const chatStream = document.getElementById('chatStream');

            if (post.status === 'pending' || post.status === 'waiting') {
                badge.className = 'badge badge-pending';
                badge.textContent = 'ë‹µë³€ ëŒ€ê¸°ì¤‘';
            } else if (post.status === 'analyzing' || post.status === 'processing' || post.status === 'InProgress') {
                badge.className = 'badge badge-progress';
                badge.textContent = 'ê²€í† ì¤‘';
            } else if (post.status === 'done' || post.status === 'completed' || post.status === 'Completed') {
                badge.className = 'badge badge-done';
                badge.textContent = 'ë‹µë³€ ì™„ë£Œ';
            } else {
                badge.className = 'badge badge-waiting';
                badge.textContent = post.status || 'ëŒ€ê¸°ì¤‘';
            }

            category.textContent = post.category || 'ë¶„ì•¼ ë¯¸ì§€ì •';
            title.textContent = post.title || '(ì œëª© ì—†ìŒ)';

            // ì²¨ë¶€íŒŒì¼ íŒŒì‹±
            let fileUrls = [];
            if (post.fileUrls) {
                try {
                    fileUrls = typeof post.fileUrls === 'string' ? JSON.parse(post.fileUrls) : post.fileUrls;
                    if (!Array.isArray(fileUrls)) fileUrls = [];
                } catch (e) {
                    fileUrls = [];
                }
            }

            // contentì—ì„œ ì›ë³¸ ì§ˆë¬¸ê³¼ ì¶”ê°€ ë¬¸ì˜ ë¶„ë¦¬
            let originalContent = post.content || '';
            let followupQuestions = [];

            if (originalContent.includes('[FOLLOWUP_SEPARATOR]')) {
                const parts = originalContent.split('[FOLLOWUP_SEPARATOR]');
                originalContent = parts[0].trim();
                followupQuestions = parts.slice(1).filter(q => q.trim());
            }

            // answerì—ì„œ ì›ë³¸ ë‹µë³€ê³¼ ì¶”ê°€ ë‹µë³€ ë¶„ë¦¬
            let originalAnswer = post.answer || '';
            let followupAnswers = [];

            if (originalAnswer && originalAnswer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
                const answerParts = originalAnswer.split('[FOLLOWUP_ANSWER_SEPARATOR]');
                originalAnswer = answerParts[0].trim();
                followupAnswers = answerParts.slice(1).filter(a => a.trim());
            }

            // ëŒ€í™”í˜• í˜•ì‹ìœ¼ë¡œ ë Œë”ë§
            let questionHTML = '';

            // 1. ì›ë³¸ ì§ˆë¬¸
            questionHTML += `
                <div class="msg-box msg-question">
                    <div class="msg-header">
                        <span class="writer-name">${post.userManagerName || 'ì‘ì„±ì'}</span>
                        <span style="background:#2c5bf2; color:#fff; font-size:11px; padding:2px 6px; border-radius:3px; margin-left:8px;">Q</span>
                    </div>
                    <div class="msg-content">${originalContent}</div>
                    ${fileUrls.length > 0 ? `
                        <div class="msg-files" style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
                            <div style="font-weight:700; color:#555; margin-bottom:8px; font-size:13px;">ğŸ“ ì²¨ë¶€íŒŒì¼ (${fileUrls.length})</div>
                            ${fileUrls.map(url => {
                                const fileName = url.split('/').pop();
                                return `<div style="margin-bottom:5px;">
                                    <a href="http://localhost:3000${url}" target="_blank" style="color:#2c5bf2; text-decoration:none; font-size:13px;">
                                        ğŸ“„ ${decodeURIComponent(fileName)}
                                    </a>
                                </div>`;
                            }).join('')}
                        </div>
                    ` : ''}
                    <div class="msg-time">${post.createdAt ? new Date(post.createdAt).toLocaleString('ko-KR') : ''}</div>
                </div>
            `;

            // 2. ì›ë³¸ ë‹µë³€ (ìˆìœ¼ë©´)
            if (originalAnswer) {
                questionHTML += `
                    <div class="msg-box msg-answer">
                        <div class="msg-header">
                            <span class="writer-name">${post.answeredBy || 'ë²•ë¬´ê·¸ë£¹ í˜„ì¼'}</span>
                            <span style="background:#52c41a; color:#fff; font-size:11px; padding:2px 6px; border-radius:3px; margin-left:8px;">A</span>
                        </div>
                        <div class="msg-content">${originalAnswer}</div>
                        <div class="msg-time">${post.answeredAt ? new Date(post.answeredAt).toLocaleString('ko-KR') : ''}</div>
                    </div>
                `;
            }

            // 3. ì¶”ê°€ ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ëŒ€í™”í˜•ìœ¼ë¡œ í‘œì‹œ
            followupQuestions.forEach((followup, index) => {
                // ì¶”ê°€ ì§ˆë¬¸ - íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹±
                const followupText = stripFollowupHeader(followup);
                const followupTimeMatch = followup.match(/\((\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.\s*ì˜¤[ì „í›„]\s*\d{1,2}:\d{2}:\d{2})\)/);
                const followupTime = followupTimeMatch ? followupTimeMatch[1] : '';

                questionHTML += `
                    <div class="msg-box msg-question" style="margin-top:15px; border-left:4px solid #ff9800;">
                        <div class="msg-header">
                            <span class="writer-name">${post.userManagerName || 'ì‘ì„±ì'}</span>
                            <span style="background:#ff9800; color:#fff; font-size:11px; padding:2px 6px; border-radius:3px; margin-left:8px;">Q ${index + 2}</span>
                        </div>
                        <div class="msg-content" style="white-space:pre-wrap;">${followupText}</div>
                        <div class="msg-time">${followupTime || 'ì¶”ê°€ì§ˆë¬¸'}</div>
                    </div>
                `;

                // í•´ë‹¹ ì¶”ê°€ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ (ìˆìœ¼ë©´)
                if (followupAnswers[index]) {
                    questionHTML += `
                        <div class="msg-box msg-answer">
                            <div class="msg-header">
                                <span class="writer-name">${post.answeredBy || 'ë²•ë¬´ê·¸ë£¹ í˜„ì¼'}</span>
                                <span style="background:#52c41a; color:#fff; font-size:11px; padding:2px 6px; border-radius:3px; margin-left:8px;">A ${index + 2}</span>
                            </div>
                            <div class="msg-content" style="white-space:pre-wrap;">${stripFollowupHeader(followupAnswers[index])}</div>
                            <div class="msg-time">${post.answeredAt ? new Date(post.answeredAt).toLocaleString('ko-KR') : 'ë‹µë³€ ì™„ë£Œ'}</div>
                        </div>
                    `;
                }
            });

            chatStream.innerHTML = questionHTML;

            // ê´€ë¦¬ìì¸ ê²½ìš° ë‹µë³€ ì‘ì„± í¼ í‘œì‹œ
            const isAdmin = ['master', 'admin', 'general_manager', 'lawyer'].includes(userData.role);
            if (isAdmin) {
                // ì›ë³¸ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì´ ì—†ëŠ” ê²½ìš°
                if (!originalAnswer) {
                    document.getElementById('adminMainForm').style.display = 'block';
                }
                // ì¶”ê°€ ì§ˆë¬¸ì´ ìˆëŠ”ë° ë‹µë³€ì´ ë¶€ì¡±í•œ ê²½ìš°
                else if (followupQuestions.length > followupAnswers.length) {
                    document.getElementById('adminMainForm').style.display = 'block';

                    // ì–´ë–¤ ì¶”ê°€ ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ”ì§€ ì•ˆë‚´ í‘œì‹œ
                    const answerGuide = document.createElement('div');
                    answerGuide.style.cssText = 'background:#fff3e0; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #ff9800;';
                    answerGuide.innerHTML = `
                        <div style="font-weight:700; color:#ff9800; margin-bottom:8px;">ğŸ“ ì¶”ê°€ ì§ˆë¬¸ ${followupAnswers.length + 1}ì— ëŒ€í•œ ë‹µë³€ ì‘ì„±</div>
                        <div style="font-size:14px; color:#666; white-space:pre-wrap;">${followupQuestions[followupAnswers.length].trim()}</div>
                    `;

                    const adminForm = document.getElementById('adminMainForm');
                    adminForm.insertBefore(answerGuide, adminForm.firstChild);
                }
            }

            // ë‹µë³€ì´ ìˆê³  ì‚¬ìš©ìê°€ ì‘ì„±ìì¸ ê²½ìš° ì¶”ê°€ ë¬¸ì˜ í¼ í‘œì‹œ
            if (originalAnswer && post.authorUid === userData.uid) {
                const followUpFormEl = document.getElementById('followUpForm');

                // ì¶”ê°€ ë¬¸ì˜ íšŸìˆ˜ í™•ì¸
                if (followupQuestions.length >= 2) {
                    // 2íšŒ ëª¨ë‘ ì‚¬ìš©í•œ ê²½ìš°
                    followUpFormEl.innerHTML = `
                        <div class="form-guide" style="color:#666;">ğŸ’¬ ì¶”ê°€ ë¬¸ì˜
                            <span style="font-size:13px; color:#ff4d4f; font-weight:700;">(2/2 ëª¨ë‘ ì‚¬ìš©)</span>
                        </div>
                        <div style="padding:20px; background:#f5f5f5; border-radius:8px; text-align:center; color:#888;">
                            ì¶”ê°€ ë¬¸ì˜ ê°€ëŠ¥ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                    followUpFormEl.style.display = 'block';
                } else if (followupQuestions.length > followupAnswers.length) {
                    // ì¶”ê°€ ì§ˆë¬¸ì€ í–ˆì§€ë§Œ ì•„ì§ ë‹µë³€ì´ ì—†ëŠ” ê²½ìš° - í¼ í‘œì‹œ ì•ˆ í•¨
                    followUpFormEl.style.display = 'none';
                } else {
                    // ì¶”ê°€ ë¬¸ì˜ ê°€ëŠ¥í•œ ê²½ìš°
                    const remainingCount = 2 - followupQuestions.length;
                    followUpFormEl.querySelector('.form-guide span').textContent = `(${followupQuestions.length}/2 ì‚¬ìš©, ${remainingCount}íšŒ ë‚¨ìŒ)`;
                    followUpFormEl.style.display = 'block';
                }
            }

            // ëŒ€ê¸°ì¤‘ ìƒíƒœì´ê³  ì‘ì„±ìì¸ ê²½ìš° ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
            if ((post.status === 'pending' || post.status === 'waiting') && post.authorUid === userData.uid) {
                document.getElementById('btnCancel').style.display = 'inline-block';
            }
        }

        // ìµœê·¼ ìë¬¸ ë‚´ì—­ ë¡œë“œ
        async function loadRecentPosts() {
            try {
                const response = await posts.getAll({ limit: 10 });
                const recentPosts = response.posts || [];

                const historyList = document.getElementById('historyList');
                if (recentPosts.length === 0) {
                    historyList.innerHTML = '<li class="history-item" style="text-align:center; color:#999; font-size:13px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</li>';
                    return;
                }

                historyList.innerHTML = recentPosts.map(p => {
                    let statusClass = 'waiting';
                    let statusText = 'ëŒ€ê¸°';
                    if (p.status === 'done' || p.status === 'completed' || p.status === 'Completed') {
                        statusClass = 'done';
                        statusText = 'ì™„ë£Œ';
                    } else if (p.status === 'analyzing' || p.status === 'processing' || p.status === 'InProgress') {
                        statusClass = 'active';
                        statusText = 'ê²€í† ì¤‘';
                    } else if (p.status === 'pending' || p.status === 'waiting') {
                        statusClass = 'pending';
                        statusText = 'ëŒ€ê¸°';
                    }

                    return `
                        <li class="history-item" onclick="location.href='board_view.html?id=${p.docId}'">
                            <span class="h-status ${statusClass}">${statusText}</span>
                            <span class="h-subject">${p.title || '(ì œëª© ì—†ìŒ)'}</span>
                            <span class="h-date">${p.createdAt ? new Date(p.createdAt).toLocaleDateString('ko-KR') : ''}</span>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                console.error('ìµœê·¼ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê´€ë¦¬ì ë‹µë³€ ë“±ë¡
        window.submitMainAnswer = async function() {
            const newAnswer = document.getElementById('adminMainInput').value.trim();
            if (!newAnswer) {
                alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            try {
                // í˜„ì¬ ê²Œì‹œê¸€ ì¡°íšŒ
                const post = await posts.getById(postId);

                // ê¸°ì¡´ ë‹µë³€ì´ ìˆëŠ”ì§€ í™•ì¸
                let finalAnswer = newAnswer;

                if (post.answer && post.answer.trim()) {
                    // ì¶”ê°€ ë‹µë³€ì¸ ê²½ìš° [FOLLOWUP_ANSWER_SEPARATOR]ë¡œ êµ¬ë¶„í•˜ì—¬ ì¶”ê°€
                    finalAnswer = post.answer + '\n[FOLLOWUP_ANSWER_SEPARATOR]\n' + newAnswer;
                }

                await posts.update(postId, {
                    answer: finalAnswer,
                    status: 'completed',
                    answeredAt: new Date().toISOString()
                });
                alert('ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } catch (error) {
                console.error('ë‹µë³€ ë“±ë¡ ì‹¤íŒ¨:', error);
                alert('ë‹µë³€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ì¶”ê°€ ë¬¸ì˜ ë“±ë¡
        window.submitFollowUp = async function() {
            const input = document.getElementById('subQuestionInput');
            const followupContent = input.value.trim();

            if (!followupContent) {
                alert('ì¶”ê°€ ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // í˜„ì¬ ê²Œì‹œê¸€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            if (!postId) {
                alert('ê²Œì‹œê¸€ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                // í˜„ì¬ ê²Œì‹œê¸€ ì¡°íšŒ
                const post = await posts.getById(postId);

                // ì¶”ê°€ ë¬¸ì˜ íšŸìˆ˜ í™•ì¸
                let followupData = [];
                if (post.content && post.content.includes('[FOLLOWUP_SEPARATOR]')) {
                    const parts = post.content.split('[FOLLOWUP_SEPARATOR]');
                    followupData = parts.slice(1);
                }

                if (followupData.length >= 2) {
                    alert('ì¶”ê°€ ë¬¸ì˜ëŠ” ìµœëŒ€ 2íšŒê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    return;
                }

                // ìƒˆë¡œìš´ ì¶”ê°€ ë¬¸ì˜ ì¶”ê°€
                const timestamp = new Date().toLocaleString('ko-KR');
                const newFollowup = `[ì¶”ê°€ë¬¸ì˜ ${followupData.length + 1}] (${timestamp})\n${followupContent}`;

                // ê¸°ì¡´ contentì— ì¶”ê°€
                const originalContent = post.content.split('[FOLLOWUP_SEPARATOR]')[0];
                const updatedContent = originalContent + '\n[FOLLOWUP_SEPARATOR]\n' +
                    [...followupData, newFollowup].join('\n[FOLLOWUP_SEPARATOR]\n');

                // ê²Œì‹œê¸€ ì—…ë°ì´íŠ¸ (statusë¥¼ analyzingìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ê´€ë¦¬ìê°€ í™•ì¸í•˜ë„ë¡)
                await posts.update(postId, {
                    content: updatedContent,
                    status: 'analyzing'
                });

                alert('ì¶”ê°€ ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹´ë‹¹ìê°€ í™•ì¸ í›„ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                input.value = '';
                location.reload();
            } catch (error) {
                console.error('ì¶”ê°€ ë¬¸ì˜ ë“±ë¡ ì‹¤íŒ¨:', error);
                alert('ì¶”ê°€ ë¬¸ì˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ì ‘ìˆ˜ ì·¨ì†Œ
        window.cancelRequest = async function() {
            if (!confirm('ì •ë§ë¡œ ì´ ìë¬¸ ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            try {
                await posts.delete(postId);
                alert('ìë¬¸ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.href = '../../pages/user/board_list.html';
            } catch (error) {
                console.error('ì·¨ì†Œ ì‹¤íŒ¨:', error);
                alert('ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ì¦‰ì‹œ ì ‘ìˆ˜
        window.instantAccept = async function() {
            alert('ì¦‰ì‹œ ì ‘ìˆ˜ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        };

        window.handleLogout = async () => {
            await auth.logout();
            location.href = "../../index.html";
        };
    </script>
</body>
</html>
