<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ì •ë³´ ìˆ˜ì • - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input { font-family: inherit; }

        /* [ì‚¬ì´ë“œë°” ê³µí†µ ìŠ¤íƒ€ì¼] */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }
        
        /* [New] í”„ë¡œí•„ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }

        .main-content { flex: 1; margin-left: 260px; padding: 60px 50px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; margin-bottom: 40px; }

        .info-container { background: #fff; padding: 40px; border-radius: 12px; border: 1px solid #eee; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .form-group { margin-bottom: 24px; }
        .label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 15px; }
        .input-box { width: 100%; height: 48px; border: 1px solid #ddd; border-radius: 6px; padding: 0 15px; font-size: 15px; outline: none; transition: 0.2s; background-color: #fff; }
        .input-box:read-only { background-color: #f5f5f5; color: #888; cursor: not-allowed; }
        .input-box:focus { border-color: #1a1a1a; }

        select.input-box {
            background-color: #fff;
            cursor: pointer;
        }

        .input-group { display: flex; gap: 10px; }
        .btn-change { width: 100px; height: 48px; border: 1px solid #ddd; background: #fff; border-radius: 6px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .btn-change:hover { background: #f0f0f0; border-color: #bbb; }

        .help-text { font-size: 13px; color: #666; margin-top: 8px; line-height: 1.6; background: #f9f9f9; padding: 12px; border-radius: 6px; }
        .help-text b { color: #2c5bf2; }
        .highlight-red { color: #ff4d4f; font-weight: 700; }

        .btn-save { width: 100%; height: 50px; background-color: #1a1a1a; color: #fff; font-size: 16px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        .btn-save:hover { background-color: #333; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 450px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        
        .option-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; text-align: left; cursor: pointer; transition: 0.2s; }
        .option-btn:hover { background: #f5f7fa; border-color: #2c5bf2; }
        .opt-title { display: block; font-weight: 700; font-size: 15px; margin-bottom: 4px; color: #333; }
        .opt-desc { display: block; font-size: 12px; color: #888; }
        
        .btn-close-modal { width: 100%; padding: 10px; background: none; border: none; color: #888; cursor: pointer; margin-top: 10px; text-decoration: underline; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 30px 20px; }
        }
    </style>
</head>
<body>

    
    <!-- Sidebar Skeleton (ê¹œë¹¡ì„ ë°©ì§€) -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a>
        </div>
        <div class="user-profile-area">
            <div class="user-name">ë¡œë”©ì¤‘...</div>
            <div class="user-email">...</div>
            <div class="user-role badge-staff">...</div>
        </div>
        <ul class="menu-list">
            <li><a href="../../pages/user/dashboard.html" class="menu-link">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
            <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
            <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="../../pages/public/user_guide.html" class="menu-link">ğŸ“˜ ì´ìš© ê°€ì´ë“œ (FAQ)</a></li>
        </ul>
        <div class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</div>
    </nav>

<main class="main-content">
        <h2 class="page-title">ë‚´ ì •ë³´ ìˆ˜ì •</h2>

        <div class="info-container">
            <div class="form-group">
                <label class="label">ì´ë©”ì¼ (ì•„ì´ë””)</label>
                <input type="text" id="email" class="input-box" readonly>
            </div>

            <div class="form-group">
                <label class="label">íšŒì‚¬ëª…</label>
                <input type="text" id="company" class="input-box" readonly>
            </div>

            <div class="form-group">
                <label class="label">ë¶€ì„œ</label>
                <div class="input-group">
                    <input type="text" id="department" class="input-box" readonly>
                    <button class="btn-change" onclick="openChangeModal()">ë³€ê²½ ì‹ ì²­ ></button>
                </div>
                <div class="help-text">
                    â‘  <b>ì‚¬ë‚´ í•´ê²°:</b> ëŒ€í‘œì ìŠ¹ì¸ ì‹œ ì¦‰ì‹œ ë³€ê²½ (ì„œë¥˜ ë¶ˆí•„ìš”)<br>
                    â‘¡ <b>ì‚¬ì´íŠ¸ ë¬¸ì˜:</b> ê´€ë¦¬ìì—ê²Œ ì§ì ‘ ìš”ì²­ <span class="highlight-red">(ì¬ì§ì¦ëª…ì„œ ë“± ì„œë¥˜ í•„ìˆ˜)</span>
                </div>
            </div>

            <div class="form-group">
                <label class="label">ì§ê¸‰ (ê¶Œí•œ)</label>
                <div class="input-group">
                    <input type="text" id="role" class="input-box" readonly>
                    <button class="btn-change" onclick="openRankChangeModal()">ë³€ê²½ ì‹ ì²­ ></button>
                </div>
            </div>

            <div class="form-group">
                <label class="label">ì´ë¦„</label>
                <input type="text" id="name" class="input-box">
            </div>

            <div class="form-group">
                <label class="label">ì—°ë½ì²˜</label>
                <input type="text" id="phone" class="input-box">
            </div>

            <button class="btn-save" onclick="updateInfo()">ì •ë³´ ìˆ˜ì • ì €ì¥</button>
        </div>
    </main>

    <!-- ì§ê¸‰ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="rankChangeModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">ì§ê¸‰ ë³€ê²½ ì‹ ì²­</h3>
            <div class="form-group">
                <label class="label">í˜„ì¬ ì§ê¸‰</label>
                <input type="text" id="currentRankDisplay" class="input-box" readonly>
            </div>
            <div class="form-group">
                <label class="label">ë³€ê²½í•  ì§ê¸‰</label>
                <select id="newRankSelect" class="input-box">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="form-group">
                <label class="label">ë³€ê²½ ì‚¬ìœ  (ì„ íƒ)</label>
                <textarea id="rankChangeReason" class="input-box" rows="3" placeholder="ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
            </div>
            <button class="btn-save" onclick="submitRankChange()">ì§ê¸‰ ë³€ê²½ ì‹ ì²­</button>
            <button class="btn-close-modal" onclick="closeRankChangeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="changeModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">ë¶€ì„œ ë³€ê²½ ì‹ ì²­</h3>
            <div id="deptChangeFormArea">
                <div class="form-group">
                    <label class="label">í˜„ì¬ ë¶€ì„œ</label>
                    <input type="text" id="currentDepartmentDisplay" class="input-box" readonly>
                </div>
                <div class="form-group">
                    <label class="label">ë³€ê²½í•  ë¶€ì„œ</label>
                    <select id="newDepartmentSelect" class="input-box">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="label">ë³€ê²½ ì‚¬ìœ  (ì„ íƒ)</label>
                    <textarea id="departmentChangeReason" class="input-box" rows="3" placeholder="ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                </div>
                <button class="btn-save" onclick="submitDepartmentChange()">ëŒ€í‘œìì—ê²Œ ë³€ê²½ ìš”ì²­</button>
                <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">
                <button class="btn-save" onclick="showAdminForm()" style="background-color:#555; margin-top:0;">ğŸ‘©â€ğŸ’» ê´€ë¦¬ìì—ê²Œ ì„œë¥˜ ì²¨ë¶€ ìš”ì²­</button>
            </div>

            <div id="admin-form-area" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:15px;">
                <label class="label" style="font-size:13px;">ë³€ê²½ ìš”ì²­ ë‚´ìš©</label>
                <input type="text" id="req-content" class="input-box" style="height:40px; margin-bottom:10px;" placeholder="ì˜ˆ: ì¸ì‚¬íŒ€ìœ¼ë¡œ ë¶€ì„œ ì´ë™">
                <label class="label" style="font-size:13px;">ì¦ë¹™ ì„œë¥˜ ì²¨ë¶€ (í•„ìˆ˜)</label>
                <input type="file" id="req-file" style="margin-bottom:15px; font-size:13px;">
                <button class="btn-save" onclick="submitToAdmin()" style="margin-top:5px; height:44px;">ì‹ ì²­ì„œ ì œì¶œ</button>
            </div>
            <button class="btn-close-modal" onclick="closeChangeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { auth, users, posts } from "../../js/api.js";
        import { renderClientSidebar } from "../../js/client_ui.js";

        let gUserData = null;
        let gAllDepartments = []; // ëª¨ë“  ë¶€ì„œ ëª©ë¡ì„ ì €ì¥í•  ë³€ìˆ˜

        const ROLE_MAP = {
            'owner': 'ëŒ€í‘œ',
            'manager': 'ë¶€ì„œì¥',
            'staff': 'ì‚¬ì›'
        };

        const RANK_OPTIONS = [
            { name: 'ëŒ€í‘œ', value: 'owner' },
            { name: 'ë¶€ì„œì¥', value: 'manager' },
            { name: 'ì‚¬ì›', value: 'staff' }
        ];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë° ë¶€ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        (async () => {
            if (!auth.isLoggedIn()) {
                location.href = "../../pages/public/login.html";
                return;
            }

            try {
                // 1. ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                gUserData = await users.getMe();
                renderClientSidebar('member_info', gUserData);

                // 2. ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì™€ì„œ ë¶€ì„œ ëª©ë¡ ë§Œë“¤ê¸°
                try {
                    const allUsersData = await users.getAll();
                    const deptSet = new Set();
                    if (allUsersData && allUsersData.users) {
                        allUsersData.users.forEach(user => {
                            if (user.department) deptSet.add(user.department);
                        });
                    }
                    gAllDepartments = Array.from(deptSet).sort();
                } catch (deptError) {
                    console.error("ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", deptError);
                    gAllDepartments = ['ì˜ì—…íŒ€', 'ë§ˆì¼€íŒ…íŒ€', 'ê°œë°œíŒ€', 'ì¸ì‚¬íŒ€', 'ì¬ë¬´íŒ€', 'ë²•ë¬´íŒ€', 'ê¸°íƒ€']; // ì‹¤íŒ¨ ì‹œ í´ë°±
                }

                // 3. í¼ ì±„ìš°ê¸°
                document.getElementById('email').value = gUserData.email || '';
                document.getElementById('company').value = gUserData.companyName || '-';
                document.getElementById('department').value = gUserData.department || 'ë¯¸ì§€ì •';
                document.getElementById('name').value = gUserData.managerName || '';
                document.getElementById('phone').value = gUserData.phone || '';

                // 4. ê¶Œí•œë³„ UI ì²˜ë¦¬
                const roleName = ROLE_MAP[gUserData.role] || 'ì¼ë°˜ ì§ì›';
                document.getElementById('role').value = roleName;
                gUserData.roleName = roleName; // ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì €ì¥

                if (gUserData.role === 'owner' || gUserData.role === 'CEO') {
                    document.querySelector('.btn-change[onclick="openChangeModal()"]').style.display = 'none';
                    document.getElementById('department').readOnly = false;
                }

            } catch (error) {
                console.error('í˜ì´ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                location.href = "../../pages/public/login.html";
            }
        })();

        window.updateInfo = async function() {
            // (ê¸°ì¡´ê³¼ ë™ì¼)
        };

        // --- ë¶€ì„œ ë³€ê²½ ëª¨ë‹¬ ---
        window.openChangeModal = function() {
            document.getElementById('changeModal').style.display = 'flex';
            document.getElementById('deptChangeFormArea').style.display = 'block';
            document.getElementById('admin-form-area').style.display = 'none';

            document.getElementById('currentDepartmentDisplay').value = gUserData.department || 'ë¯¸ì§€ì •';

            const newDepartmentSelect = document.getElementById('newDepartmentSelect');
            newDepartmentSelect.innerHTML = gAllDepartments.map(dept => 
                `<option value="${dept}">${dept}</option>`
            ).join('');
            if (gUserData.department && gAllDepartments.includes(gUserData.department)) {
                newDepartmentSelect.value = gUserData.department;
            }

            document.getElementById('departmentChangeReason').value = '';
        }
        window.closeChangeModal = function() { document.getElementById('changeModal').style.display = 'none'; }
        
        window.submitDepartmentChange = async function() {
            const newDept = document.getElementById('newDepartmentSelect').value;
            const reason = document.getElementById('departmentChangeReason').value.trim();
            if (!newDept || newDept === gUserData.department) {
                alert("ë³€ê²½í•  ìƒˆë¡œìš´ ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!confirm(`'${newDept}' ë¶€ì„œë¡œ ë³€ê²½ì„ ëŒ€í‘œë‹˜ê»˜ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                await posts.create({
                    category: "member_req_internal",
                    title: `ë¶€ì„œ ë³€ê²½ ìš”ì²­ (${gUserData.department || 'ë¯¸ì§€ì •'} â†’ ${newDept})`,
                    content: JSON.stringify({
                        fromDepartment: gUserData.department || 'ë¯¸ì§€ì •',
                        newDepartment: newDept,
                        reason: reason,
                        requesterName: gUserData.managerName,
                        requestTo: 'ceo'
                    }),
                    status: 'pending'
                });

                alert("âœ… ëŒ€í‘œìì—ê²Œ ìŠ¹ì¸ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeChangeModal();
            } catch (error) {
                console.error('âŒ ë¶€ì„œ ë³€ê²½ ìš”ì²­ ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
        window.showAdminForm = function() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ };
        window.submitToAdmin = async function() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ };

        // --- ì§ê¸‰ ë³€ê²½ ëª¨ë‹¬ ---
        window.openRankChangeModal = function() {
            document.getElementById('rankChangeModal').style.display = 'flex';
            document.getElementById('currentRankDisplay').value = gUserData.roleName || 'ë¯¸ì§€ì •';

            const newRankSelect = document.getElementById('newRankSelect');
            newRankSelect.innerHTML = RANK_OPTIONS
                .filter(rank => rank.name !== gUserData.roleName)
                .map(rank => `<option value="${rank.value}">${rank.name}</option>`)
                .join('');
            
            document.getElementById('rankChangeReason').value = '';
        }
        window.closeRankChangeModal = function() { document.getElementById('rankChangeModal').style.display = 'none'; }

        window.submitRankChange = async function() {
            const newRankValue = document.getElementById('newRankSelect').value;
            const newRankName = RANK_OPTIONS.find(r => r.value === newRankValue)?.name;
            const reason = document.getElementById('rankChangeReason').value.trim();

            if (!newRankValue) {
                alert("ë³€ê²½í•  ì§ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!confirm(`'${gUserData.roleName}'ì—ì„œ '${newRankName}'(ìœ¼)ë¡œ ì§ê¸‰ ë³€ê²½ì„ ëŒ€í‘œë‹˜ê»˜ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                await posts.create({
                    category: "member_req_internal",
                    title: `ì§ê¸‰ ë³€ê²½ ìš”ì²­ (${gUserData.roleName} â†’ ${newRankName})`,
                    content: JSON.stringify({
                        fromRank: gUserData.role,
                        newRank: newRankValue, // ì‹¤ì œ role value ì „ì†¡
                        reason: reason,
                        requesterName: gUserData.managerName,
                        requestTo: 'ceo'
                    }),
                    status: 'pending'
                });

                alert("âœ… ëŒ€í‘œìì—ê²Œ ì§ê¸‰ ë³€ê²½ ìŠ¹ì¸ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeRankChangeModal();
            } catch (error) {
                console.error('âŒ ì§ê¸‰ ë³€ê²½ ìš”ì²­ ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        window.handleLogout = function() { /* (ê¸°ì¡´ê³¼ ë™ì¼) */ };
        document.getElementById('logoutBtn')?.addEventListener('click', () => auth.logout());
    </script>
</body>
</html>