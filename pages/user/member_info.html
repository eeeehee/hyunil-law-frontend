<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ì •ë³´ ìˆ˜ì • - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input { font-family: inherit; }

        /* [ì‚¬ì´ë“œë°” ê³µí†µ ìŠ¤íƒ€ì¼] */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }
        
        /* [New] í”„ë¡œí•„ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }

        .main-content { flex: 1; margin-left: 260px; padding: 60px 50px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; margin-bottom: 40px; }

        .info-container { background: #fff; padding: 40px; border-radius: 12px; border: 1px solid #eee; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .form-group { margin-bottom: 24px; }
        .label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 15px; }
        .input-box { width: 100%; height: 48px; border: 1px solid #ddd; border-radius: 6px; padding: 0 15px; font-size: 15px; outline: none; transition: 0.2s; background-color: #fff; }
        .input-box:read-only { background-color: #f5f5f5; color: #888; cursor: not-allowed; }
        .input-box:focus { border-color: #1a1a1a; }

        .input-group { display: flex; gap: 10px; }
        .btn-change { width: 100px; height: 48px; border: 1px solid #ddd; background: #fff; border-radius: 6px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .btn-change:hover { background: #f0f0f0; border-color: #bbb; }

        .help-text { font-size: 13px; color: #666; margin-top: 8px; line-height: 1.6; background: #f9f9f9; padding: 12px; border-radius: 6px; }
        .help-text b { color: #2c5bf2; }
        .highlight-red { color: #ff4d4f; font-weight: 700; }

        .btn-save { width: 100%; height: 50px; background-color: #1a1a1a; color: #fff; font-size: 16px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        .btn-save:hover { background-color: #333; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 450px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        
        .option-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; text-align: left; cursor: pointer; transition: 0.2s; }
        .option-btn:hover { background: #f5f7fa; border-color: #2c5bf2; }
        .opt-title { display: block; font-weight: 700; font-size: 15px; margin-bottom: 4px; color: #333; }
        .opt-desc { display: block; font-size: 12px; color: #888; }
        
        .btn-close-modal { width: 100%; padding: 10px; background: none; border: none; color: #888; cursor: pointer; margin-top: 10px; text-decoration: underline; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 30px 20px; }
        }
    </style>
</head>
<body>

    
    <!-- Sidebar Skeleton (ê¹œë¹¡ì„ ë°©ì§€) -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a>
        </div>
        <div class="user-profile-area">
            <div class="user-name">ë¡œë”©ì¤‘...</div>
            <div class="user-email">...</div>
            <div class="user-role badge-staff">...</div>
        </div>
        <ul class="menu-list">
            <li><a href="../../pages/user/dashboard.html" class="menu-link">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
            <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
            <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="../../pages/public/user_guide.html" class="menu-link">ğŸ“˜ ì´ìš© ê°€ì´ë“œ (FAQ)</a></li>
        </ul>
        <div class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</div>
    </nav>

<main class="main-content">
        <h2 class="page-title">ë‚´ ì •ë³´ ìˆ˜ì •</h2>

        <div class="info-container">
            <div class="form-group">
                <label class="label">ì´ë©”ì¼ (ì•„ì´ë””)</label>
                <input type="text" id="email" class="input-box" readonly>
            </div>

            <div class="form-group">
                <label class="label">íšŒì‚¬ëª…</label>
                <input type="text" id="company" class="input-box" readonly>
            </div>

            <div class="form-group">
                <label class="label">ë¶€ì„œ</label>
                <div class="input-group">
                    <input type="text" id="department" class="input-box" readonly>
                    <button class="btn-change" onclick="openChangeModal()">ë³€ê²½ ì‹ ì²­ ></button>
                </div>
                <div class="help-text">
                    â‘  <b>ì‚¬ë‚´ í•´ê²°:</b> ëŒ€í‘œì ìŠ¹ì¸ ì‹œ ì¦‰ì‹œ ë³€ê²½ (ì„œë¥˜ ë¶ˆí•„ìš”)<br>
                    â‘¡ <b>ì‚¬ì´íŠ¸ ë¬¸ì˜:</b> ê´€ë¦¬ìì—ê²Œ ì§ì ‘ ìš”ì²­ <span class="highlight-red">(ì¬ì§ì¦ëª…ì„œ ë“± ì„œë¥˜ í•„ìˆ˜)</span>
                </div>
            </div>

            <div class="form-group">
                <label class="label">ì§ê¸‰ (ê¶Œí•œ)</label>
                <input type="text" id="role" class="input-box" readonly>
            </div>

            <div class="form-group">
                <label class="label">ì´ë¦„</label>
                <input type="text" id="name" class="input-box">
            </div>

            <div class="form-group">
                <label class="label">ì—°ë½ì²˜</label>
                <input type="text" id="phone" class="input-box">
            </div>

            <button class="btn-save" onclick="updateInfo()">ì •ë³´ ìˆ˜ì • ì €ì¥</button>
        </div>
    </main>

    <div id="changeModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">ë¶€ì„œ/ì •ë³´ ë³€ê²½ ì‹ ì²­</h3>
            <div id="opt-ceo">
                <button class="option-btn" onclick="reqToCEO()">
                    <span class="opt-title">ğŸ¢ ëŒ€í‘œìì—ê²Œ ìŠ¹ì¸ ìš”ì²­ (ì¶”ì²œ)</span>
                    <span class="opt-desc">ë³„ë„ ì„œë¥˜ ì—†ì´ ëŒ€í‘œë‹˜ ìŠ¹ì¸ìœ¼ë¡œ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</span>
                </button>
            </div>
            <div id="opt-admin">
                <button class="option-btn" onclick="showAdminForm()">
                    <span class="opt-title">ğŸ‘©â€ğŸ’» ì‚¬ì´íŠ¸ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜</span>
                    <span class="opt-desc">ì¬ì§ì¦ëª…ì„œ ë“± <strong>ì¦ë¹™ì„œë¥˜ ì²¨ë¶€</strong>ê°€ í•„ìš”í•©ë‹ˆë‹¤.</span>
                </button>
            </div>
            <div id="admin-form-area" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:15px;">
                <label class="label" style="font-size:13px;">ë³€ê²½ ìš”ì²­ ë‚´ìš©</label>
                <input type="text" id="req-content" class="input-box" style="height:40px; margin-bottom:10px;" placeholder="ì˜ˆ: ì¸ì‚¬íŒ€ìœ¼ë¡œ ë¶€ì„œ ì´ë™">
                <label class="label" style="font-size:13px;">ì¦ë¹™ ì„œë¥˜ ì²¨ë¶€ (í•„ìˆ˜)</label>
                <input type="file" id="req-file" style="margin-bottom:15px; font-size:13px;">
                <button class="btn-save" onclick="submitToAdmin()" style="margin-top:5px; height:44px;">ì‹ ì²­ì„œ ì œì¶œ</button>
            </div>
            <button class="btn-close-modal" onclick="closeChangeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { auth, users, posts, approvalRequests } from "../../js/api.js";
        import { renderClientSidebar } from "../../js/client_ui.js";

        let gUserData = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        (async () => {
            // ì¸ì¦ í™•ì¸
            if (!auth.isLoggedIn()) {
                location.href = "../../pages/public/login.html";
                return;
            }

            try {
                // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                gUserData = await users.getMe();

                // â˜… 1. ì‚¬ì´ë“œë°” ë° í”„ë¡œí•„ ë Œë”ë§ (í˜„ì¬ í˜ì´ì§€: member_info)
                renderClientSidebar('member_info', gUserData);

                // 2. í¼ ì±„ìš°ê¸°
                document.getElementById('email').value = gUserData.email || '';
                document.getElementById('company').value = gUserData.companyName || '-';
                document.getElementById('department').value = gUserData.department || 'ë¯¸ì§€ì •';
                document.getElementById('name').value = gUserData.managerName || '';
                document.getElementById('phone').value = gUserData.phone || '';

                // 3. ê¶Œí•œë³„ UI ì²˜ë¦¬
                let roleName = "ì¼ë°˜ ì§ì›";
                if (gUserData.role === 'owner' || gUserData.role === 'CEO') {
                    roleName = "ğŸ‘‘ ì´ê´„ ê´€ë¦¬ì (ëŒ€í‘œ)";
                    // ëŒ€í‘œëŠ” ë¶€ì„œë³€ê²½ ì‹ ì²­ ë²„íŠ¼ ìˆ¨ê¹€ (ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)
                    document.querySelector('.btn-change').style.display = 'none';
                    document.querySelector('.help-text').style.display = 'none';
                    document.getElementById('department').readOnly = false;
                } else if (gUserData.role === 'manager') {
                    roleName = "ğŸ’¼ ë¶€ì„œ ê´€ë¦¬ì";
                } else if (gUserData.role === 'lawyer') {
                    roleName = "âš–ï¸ ë³€í˜¸ì‚¬";
                } else if (gUserData.role === 'staff') {
                    roleName = "ğŸ‘¤ ì¼ë°˜ ì§ì›";
                }
                document.getElementById('role').value = roleName;
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                location.href = "../../pages/public/login.html";
            }
        })();

        window.updateInfo = async function() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const dept = document.getElementById('department').value;

            if (!name || !phone) {
                return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            try {
                const updateData = {
                    managerName: name,
                    phone: phone
                };

                // ëŒ€í‘œëŠ” ë¶€ì„œ ì§ì ‘ ë³€ê²½ ê°€ëŠ¥
                if (gUserData.role === 'owner' || gUserData.role === 'CEO') {
                    updateData.department = dept;
                }

                await users.updateMe(updateData);
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } catch (error) {
                console.error('ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        }

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        window.openChangeModal = function() { 
            document.getElementById('changeModal').style.display = 'flex'; 
            document.getElementById('opt-ceo').style.display = 'block';
            document.getElementById('opt-admin').style.display = 'block';
            document.getElementById('admin-form-area').style.display = 'none';
        }
        window.closeChangeModal = function() { document.getElementById('changeModal').style.display = 'none'; }
        
        window.reqToCEO = async function() {
            const newDept = prompt("ë³€ê²½í•˜ê³  ì‹¶ì€ ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (!newDept) return;
            if (!confirm(`'${newDept}' ë¶€ì„œë¡œ ë³€ê²½ì„ ëŒ€í‘œë‹˜ê»˜ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // âœ… [REVISED] posts.createë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œì¤€ ìš”ì²­ ìƒì„±
                await posts.create({
                    category: "member_req_internal",
                    title: "ë¶€ì„œ ë³€ê²½ ìš”ì²­ (ëŒ€í‘œ ìŠ¹ì¸)",
                    content: JSON.stringify({
                        fromDepartment: gUserData.department || 'ë¯¸ì§€ì •',
                        newDepartment: newDept,
                        requesterName: gUserData.managerName,
                        requestTo: 'ceo'
                    }),
                    status: 'pending' // ê´€ë¦¬ì/ëŒ€í‘œ í™•ì¸ í•„ìš”
                });

                alert("âœ… ëŒ€í‘œìì—ê²Œ ìŠ¹ì¸ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n'ê²°ì œ/êµ¬ë… ê´€ë¦¬' ë©”ë‰´ì—ì„œ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”.");
                closeChangeModal();
            } catch (error) {
                console.error('âŒ ëŒ€í‘œì—ê²Œ ìš”ì²­ ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        }

        window.showAdminForm = function() {
            // ë¶€ì„œëª… ì§ì ‘ ì…ë ¥ ë°›ê¸°
            const newDept = prompt("ë³€ê²½í•˜ê³  ì‹¶ì€ ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (!newDept) return;

            // âœ… [REVISED] ë°”ë¡œ ê´€ë¦¬ìì—ê²Œ ìš”ì²­ ì œì¶œ
            submitToAdmin(newDept);
        }

        window.submitToAdmin = async function(newDept) {
            if (!confirm(`'${newDept}' ë¶€ì„œë¡œ ë³€ê²½ì„ ì‚¬ì´íŠ¸ ê´€ë¦¬ìì—ê²Œ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³„ë„ ì¦ë¹™ì„œë¥˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)`)) return;

            try {
                // âœ… [REVISED] posts.createë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œì¤€ ìš”ì²­ ìƒì„±
                await posts.create({
                    category: "member_req_internal",
                    title: "ë¶€ì„œ ë³€ê²½ ìš”ì²­ (ê´€ë¦¬ì ìŠ¹ì¸)",
                    content: JSON.stringify({
                        fromDepartment: gUserData.department || 'ë¯¸ì§€ì •',
                        newDepartment: newDept,
                        requesterName: gUserData.managerName,
                        requestTo: 'admin'
                    }),
                    status: 'pending' // ê´€ë¦¬ì í™•ì¸ í•„ìš”
                });

                alert("âœ… ê´€ë¦¬ìì—ê²Œ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n'ê²°ì œ/êµ¬ë… ê´€ë¦¬' ë©”ë‰´ì—ì„œ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”.");
                closeChangeModal();
            } catch (error) {
                console.error('âŒ ê´€ë¦¬ìì—ê²Œ ìš”ì²­ ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        }

        window.handleLogout = function() {
            auth.logout();
            location.href = "../../index.html";
        }

        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
    </script>
</body>
</html>