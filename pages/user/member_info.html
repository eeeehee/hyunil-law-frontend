<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ì •ë³´ ìˆ˜ì • - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input { font-family: inherit; }

        /* [ì‚¬ì´ë“œë°” ê³µí†µ ìŠ¤íƒ€ì¼] */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }
        
        /* [New] í”„ë¡œí•„ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }

        .main-content { flex: 1; margin-left: 260px; padding: 60px 50px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; margin-bottom: 40px; }

        .info-container { background: #fff; padding: 40px; border-radius: 12px; border: 1px solid #eee; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .form-group { margin-bottom: 24px; }
        .label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 15px; }
        .input-box { width: 100%; height: 48px; border: 1px solid #ddd; border-radius: 6px; padding: 0 15px; font-size: 15px; outline: none; transition: 0.2s; background-color: #fff; }
        .input-box:read-only { background-color: #f5f5f5; color: #888; cursor: not-allowed; }
        .input-box:focus { border-color: #1a1a1a; }

        select.input-box {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23333333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            background-color: #fff;
            cursor: pointer;
        }

        .input-group { display: flex; gap: 10px; }
        .btn-change { width: 100px; height: 48px; border: 1px solid #ddd; background: #fff; border-radius: 6px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .btn-change:hover { background: #f0f0f0; border-color: #bbb; }

        .help-text { font-size: 13px; color: #666; margin-top: 8px; line-height: 1.6; background: #f9f9f9; padding: 12px; border-radius: 6px; }
        .help-text b { color: #2c5bf2; }
        .highlight-red { color: #ff4d4f; font-weight: 700; }

        .btn-save { width: 100%; height: 50px; background-color: #1a1a1a; color: #fff; font-size: 16px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        .btn-save:hover { background-color: #333; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 450px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; text-align: center; }
        
        .option-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; text-align: left; cursor: pointer; transition: 0.2s; }
        .option-btn:hover { background: #f5f7fa; border-color: #2c5bf2; }
        .opt-title { display: block; font-weight: 700; font-size: 15px; margin-bottom: 4px; color: #333; }
        .opt-desc { display: block; font-size: 12px; color: #888; }
        
        .btn-close-modal { width: 100%; padding: 10px; background: none; border: none; color: #888; cursor: pointer; margin-top: 10px; text-decoration: underline; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 30px 20px; }
        }
    </style>
</head>
<body>

    
    <!-- Sidebar Skeleton (ê¹œë¹¡ì„ ë°©ì§€) -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <a href="../../index.html"><img src="../../assets/img/logo.png" alt="ë²•ë¬´ê·¸ë£¹ í˜„ì¼"></a>
        </div>
        <div class="user-profile-area">
            <div class="user-name">ë¡œë”©ì¤‘...</div>
            <div class="user-email">...</div>
            <div class="user-role badge-staff">...</div>
        </div>
        <ul class="menu-list">
            <li><a href="../../pages/user/dashboard.html" class="menu-link">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="../../pages/user/board_list.html" class="menu-link">ë‚˜ì˜ ìë¬¸ ë‚´ì—­</a></li>
            <li><a href="../../pages/user/payment.html" class="menu-link">ê²°ì œ/êµ¬ë… ê´€ë¦¬</a></li>
            <li><a href="../../pages/user/member_info.html" class="menu-link">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="../../pages/public/user_guide.html" class="menu-link">ğŸ“˜ ì´ìš© ê°€ì´ë“œ (FAQ)</a></li>
        </ul>
        <div class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</div>
    </nav>

<main class="main-content">
        <h2 class="page-title">ë‚´ ì •ë³´ ìˆ˜ì •</h2>

        <div class="info-container">
            <div class="form-group">
                <label class="label">ì´ë©”ì¼ (ì•„ì´ë””)</label>
                <input type="text" id="email" class="input-box" readonly>
            </div>

            <div class="form-group">
                <label class="label">íšŒì‚¬ëª…</label>
                <input type="text" id="company" class="input-box" readonly>
            </div>

            <div class="form-group">
                <label class="label">ë¶€ì„œ</label>
                <div class="input-group">
                    <input type="text" id="department" class="input-box" readonly>
                    <button class="btn-change" id="btnChangeDept" onclick="openChangeModal()">ë³€ê²½ ì‹ ì²­ ></button>
                </div>
                <div class="help-text">
                    â‘  <b>ì‚¬ë‚´ í•´ê²°:</b> ëŒ€í‘œì ìŠ¹ì¸ ì‹œ ì¦‰ì‹œ ë³€ê²½ (ì„œë¥˜ ë¶ˆí•„ìš”)<br>
                    â‘¡ <b>ì‚¬ì´íŠ¸ ë¬¸ì˜:</b> ê´€ë¦¬ìì—ê²Œ ì§ì ‘ ìš”ì²­ <span class="highlight-red">(ì¬ì§ì¦ëª…ì„œ ë“± ì„œë¥˜ í•„ìˆ˜)</span>
                </div>
            </div>

            <div class="form-group">
                <label class="label">ì§ê¸‰ (ê¶Œí•œ)</label>
                <div class="input-group">
                    <input type="text" id="role" class="input-box" readonly>
                    <button class="btn-change" id="btnChangeRank" onclick="openChangeModal('rank')">ë³€ê²½ ì‹ ì²­ ></button>
                </div>
            </div>

            <div class="form-group">
                <label class="label">ì´ë¦„</label>
                <input type="text" id="name" class="input-box">
            </div>

            <div class="form-group">
                <label class="label">ì—°ë½ì²˜</label>
                <input type="text" id="phone" class="input-box">
            </div>

            <button class="btn-save" onclick="updateInfo()">ì •ë³´ ìˆ˜ì • ì €ì¥</button>
        </div>
    </main>

    <div id="changeModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="changeModalTitle">ë¶€ì„œ/ì •ë³´ ë³€ê²½ ì‹ ì²­</h3>

            <!-- ì„ íƒ ì˜µì…˜ ì˜ì—­ -->
            <div id="optionArea">
                <div id="opt-ceo">
                    <button class="option-btn" onclick="showCeoForm()">
                        <span class="opt-title">ğŸ¢ ëŒ€í‘œìì—ê²Œ ìŠ¹ì¸ ìš”ì²­ (ì¶”ì²œ)</span>
                        <span class="opt-desc">ë³„ë„ ì„œë¥˜ ì—†ì´ ëŒ€í‘œë‹˜ ìŠ¹ì¸ìœ¼ë¡œ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</span>
                    </button>
                </div>
                <div id="opt-admin">
                    <button class="option-btn" onclick="showAdminForm()">
                        <span class="opt-title">ğŸ‘©â€ğŸ’» ì‚¬ì´íŠ¸ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜</span>
                        <span class="opt-desc">ì¬ì§ì¦ëª…ì„œ ë“± <strong>ì¦ë¹™ì„œë¥˜ ì²¨ë¶€</strong>ê°€ í•„ìš”í•©ë‹ˆë‹¤.</span>
                    </button>
                </div>
            </div>

            <!-- CEO ìŠ¹ì¸ ìš”ì²­ í¼ (ë¶€ì„œ/ì§ê¸‰ ì„ íƒ) -->
            <div id="ceo-form-area" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:15px;">
                <div id="deptSelectArea" style="display:none;">
                    <label class="label" style="font-size:13px;">í˜„ì¬ ë¶€ì„œ</label>
                    <input type="text" id="currentDeptDisplay" class="input-box" style="height:40px; margin-bottom:10px; background:#f5f5f5;" readonly>
                    <label class="label" style="font-size:13px;">ë³€ê²½í•  ë¶€ì„œ ì„ íƒ</label>
                    <select id="newDeptSelect" class="input-box" style="height:44px; margin-bottom:15px; background-color:#fff !important;">
                        <option value="">-- ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                    </select>
                </div>
                <div id="rankSelectArea" style="display:none;">
                    <label class="label" style="font-size:13px;">í˜„ì¬ ì§ê¸‰</label>
                    <input type="text" id="currentRankDisplay" class="input-box" style="height:40px; margin-bottom:10px; background:#f5f5f5;" readonly>
                    <label class="label" style="font-size:13px;">ë³€ê²½í•  ì§ê¸‰ ì„ íƒ</label>
                    <select id="newRankSelect" class="input-box" style="height:44px; margin-bottom:15px; background-color:#fff !important;">
                        <option value="">-- ì§ê¸‰ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                        <option value="manager">ë¶€ì„œì¥</option>
                        <option value="staff">ì‚¬ì›</option>
                    </select>
                </div>
                <button class="btn-save" onclick="submitToCEO()" style="margin-top:5px; height:44px;">ìŠ¹ì¸ ìš”ì²­í•˜ê¸°</button>
                <button class="btn-close-modal" onclick="backToOptions()" style="margin-top:5px;">â† ë’¤ë¡œ</button>
            </div>

            <!-- ê´€ë¦¬ì ë¬¸ì˜ í¼ -->
            <div id="admin-form-area" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:15px;">
                <div id="adminDeptSelectArea" style="display:none;">
                    <label class="label" style="font-size:13px;">í˜„ì¬ ë¶€ì„œ</label>
                    <input type="text" id="adminCurrentDeptDisplay" class="input-box" style="height:40px; margin-bottom:10px; background:#f5f5f5;" readonly>
                    <label class="label" style="font-size:13px;">ë³€ê²½í•  ë¶€ì„œ ì„ íƒ</label>
                    <select id="adminNewDeptSelect" class="input-box" style="height:44px; margin-bottom:15px; background-color:#fff !important;">
                        <option value="">-- ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                    </select>
                </div>
                <div id="adminRankSelectArea" style="display:none;">
                    <label class="label" style="font-size:13px;">í˜„ì¬ ì§ê¸‰</label>
                    <input type="text" id="adminCurrentRankDisplay" class="input-box" style="height:40px; margin-bottom:10px; background:#f5f5f5;" readonly>
                    <label class="label" style="font-size:13px;">ë³€ê²½í•  ì§ê¸‰ ì„ íƒ</label>
                    <select id="adminNewRankSelect" class="input-box" style="height:44px; margin-bottom:15px; background-color:#fff !important;">
                        <option value="">-- ì§ê¸‰ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                        <option value="manager">ë¶€ì„œì¥</option>
                        <option value="staff">ì‚¬ì›</option>
                    </select>
                </div>
                <label class="label" style="font-size:13px;">ì¦ë¹™ ì„œë¥˜ ì²¨ë¶€ (í•„ìˆ˜)</label>
                <input type="file" id="req-file" style="margin-bottom:15px; font-size:13px;">
                <button class="btn-save" onclick="submitToAdmin()" style="margin-top:5px; height:44px;">ì‹ ì²­ì„œ ì œì¶œ</button>
                <button class="btn-close-modal" onclick="backToOptions()" style="margin-top:5px;">â† ë’¤ë¡œ</button>
            </div>

            <button class="btn-close-modal" id="closeModalBtn" onclick="closeChangeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { auth, users, posts, admin } from "../../js/api.js";
        import { renderClientSidebar } from "../../js/client_ui.js";

        let gUserData = null;
        let gChangeType = 'department'; // 'department' or 'rank'
        let gCompanyDepartments = []; // íšŒì‚¬ ë¶€ì„œ ëª©ë¡

        const ROLE_MAP = {
            'owner': 'ëŒ€í‘œ',
            'manager': 'ë¶€ì„œì¥',
            'staff': 'ì‚¬ì›'
        };

        // íšŒì‚¬ ë¶€ì„œ ëª©ë¡ ë¡œë“œ (ëŒ€í‘œê°€ ë“±ë¡í•œ ë¶€ì„œ ëª©ë¡)
        async function loadCompanyDepartments() {
            try {
                if (!gUserData || !gUserData.bizNum) return;

                // ê°™ì€ íšŒì‚¬ ì§ì›ë“¤ ê°€ì ¸ì™€ì„œ ownerì˜ departments ì°¾ê¸°
                const response = await admin.getEmployees(gUserData.bizNum);
                const employees = response?.employees || response || [];

                // owner ì°¾ê¸°
                const owner = employees.find(emp => emp.role === 'owner');
                if (owner && owner.departments) {
                    let depts = owner.departments;
                    if (typeof depts === 'string') {
                        try { depts = JSON.parse(depts); } catch (e) { depts = []; }
                    }
                    if (Array.isArray(depts)) {
                        gCompanyDepartments = depts.sort();
                    }
                }

                // ë¶€ì„œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° (CEO í¼, Admin í¼ ë‘˜ ë‹¤)
                populateDeptSelect('newDeptSelect');
                populateDeptSelect('adminNewDeptSelect');
            } catch (error) {
                console.error('ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¶€ì„œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° í—¬í¼
        function populateDeptSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">-- ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
            gCompanyDepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        (async () => {
            if (!auth.isLoggedIn()) {
                location.href = "../../pages/public/login.html";
                return;
            }

            try {
                gUserData = await users.getMe();
                renderClientSidebar('member_info', gUserData);

                document.getElementById('email').value = gUserData.email || '';
                document.getElementById('company').value = gUserData.companyName || '-';
                document.getElementById('department').value = gUserData.department || 'ë¯¸ì§€ì •';
                document.getElementById('name').value = gUserData.managerName || '';
                document.getElementById('phone').value = gUserData.phone || '';

                const roleName = ROLE_MAP[gUserData.role] || 'ì¼ë°˜ ì§ì›';
                document.getElementById('role').value = roleName;
                gUserData.roleName = roleName;

                // ëŒ€í‘œ(owner)ì¸ ê²½ìš° ë³€ê²½ ì‹ ì²­ ë²„íŠ¼ ìˆ¨ê¸°ê³  ë¶€ì„œ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥
                if (gUserData.role === 'owner') {
                    document.getElementById('btnChangeDept').style.display = 'none';
                    document.getElementById('btnChangeRank').style.display = 'none';
                    document.getElementById('department').readOnly = false;
                } else {
                    // ì¼ë°˜ ì§ì›ì¸ ê²½ìš° ë¶€ì„œ ëª©ë¡ ë¡œë“œ
                    await loadCompanyDepartments();
                }

            } catch (error) {
                console.error('í˜ì´ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })();

        window.updateInfo = async function() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const dept = document.getElementById('department').value;
            if (!name || !phone) { return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); }
            try {
                const updateData = { managerName: name, phone: phone };
                if (gUserData.role === 'owner' || gUserData.role === 'CEO') {
                    updateData.department = dept;
                }
                await users.updateMe(updateData);
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } catch (error) {
                console.error('ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        };

        // --- í†µí•© ë³€ê²½ ëª¨ë‹¬ ---
        window.openChangeModal = function(type) {
            gChangeType = type === 'rank' ? 'rank' : 'department';
            const modalTitle = document.getElementById('changeModalTitle');
            if (type === 'rank') {
                modalTitle.textContent = 'ì§ê¸‰ ë³€ê²½ ì‹ ì²­';
            } else {
                modalTitle.textContent = 'ë¶€ì„œ ë³€ê²½ ì‹ ì²­';
            }

            // ëª¨ë‹¬ ì´ˆê¸°í™”
            document.getElementById('changeModal').style.display = 'flex';
            document.getElementById('optionArea').style.display = 'block';
            document.getElementById('ceo-form-area').style.display = 'none';
            document.getElementById('admin-form-area').style.display = 'none';
            document.getElementById('closeModalBtn').style.display = 'block';
        }

        window.closeChangeModal = function() {
            document.getElementById('changeModal').style.display = 'none';
        }

        // ë’¤ë¡œê°€ê¸° (ì˜µì…˜ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°)
        window.backToOptions = function() {
            document.getElementById('optionArea').style.display = 'block';
            document.getElementById('ceo-form-area').style.display = 'none';
            document.getElementById('admin-form-area').style.display = 'none';
            document.getElementById('closeModalBtn').style.display = 'block';
        }

        // CEO ìŠ¹ì¸ ìš”ì²­ í¼ ë³´ì—¬ì£¼ê¸°
        window.showCeoForm = function() {
            document.getElementById('optionArea').style.display = 'none';
            document.getElementById('ceo-form-area').style.display = 'block';
            document.getElementById('closeModalBtn').style.display = 'none';

            const isRankChange = gChangeType === 'rank';

            if (isRankChange) {
                document.getElementById('deptSelectArea').style.display = 'none';
                document.getElementById('rankSelectArea').style.display = 'block';
                document.getElementById('currentRankDisplay').value = gUserData.roleName || 'ë¯¸ì§€ì •';
                document.getElementById('newRankSelect').value = '';
            } else {
                document.getElementById('deptSelectArea').style.display = 'block';
                document.getElementById('rankSelectArea').style.display = 'none';
                document.getElementById('currentDeptDisplay').value = gUserData.department || 'ë¯¸ì§€ì •';
                document.getElementById('newDeptSelect').value = '';
            }
        }

        // CEOì—ê²Œ ìŠ¹ì¸ ìš”ì²­ ì œì¶œ
        window.submitToCEO = async function() {
            const isRankChange = gChangeType === 'rank';
            let newValue = '';
            let newDisplayValue = '';

            if (isRankChange) {
                const selectEl = document.getElementById('newRankSelect');
                newValue = selectEl.value;
                newDisplayValue = selectEl.options[selectEl.selectedIndex]?.text || '';
                if (!newValue) {
                    alert('ë³€ê²½í•  ì§ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            } else {
                newValue = document.getElementById('newDeptSelect').value;
                newDisplayValue = newValue;
                if (!newValue) {
                    alert('ë³€ê²½í•  ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            }

            if (!confirm(`'${newDisplayValue}'(ìœ¼)ë¡œ ë³€ê²½ì„ ëŒ€í‘œë‹˜ê»˜ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                let title = '';
                let content = {};

                if (isRankChange) {
                    title = `ì§ê¸‰ ë³€ê²½ ìš”ì²­ (${gUserData.roleName} â†’ ${newDisplayValue})`;
                    content = {
                        type: 'rank',
                        fromRank: gUserData.role,
                        fromRankName: gUserData.roleName,
                        newRank: newValue,
                        newRankName: newDisplayValue,
                        requesterName: gUserData.managerName,
                        requestTo: 'ceo'
                    };
                } else {
                    title = `ë¶€ì„œ ë³€ê²½ ìš”ì²­ (${gUserData.department || 'ë¯¸ì§€ì •'} â†’ ${newDisplayValue})`;
                    content = {
                        type: 'department',
                        fromDepartment: gUserData.department || 'ë¯¸ì§€ì •',
                        newDepartment: newValue,
                        requesterName: gUserData.managerName,
                        requestTo: 'ceo'
                    };
                }

                await posts.create({
                    category: "member_req_internal",
                    title: title,
                    content: JSON.stringify(content),
                    status: 'pending'
                });

                alert("âœ… ëŒ€í‘œìì—ê²Œ ìŠ¹ì¸ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeChangeModal();
            } catch (error) {
                console.error('âŒ ëŒ€í‘œì—ê²Œ ìš”ì²­ ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        }

        window.showAdminForm = function() {
            document.getElementById('optionArea').style.display = 'none';
            document.getElementById('admin-form-area').style.display = 'block';
            document.getElementById('closeModalBtn').style.display = 'none';
            document.getElementById('req-file').value = '';

            const isRankChange = gChangeType === 'rank';

            if (isRankChange) {
                document.getElementById('adminDeptSelectArea').style.display = 'none';
                document.getElementById('adminRankSelectArea').style.display = 'block';
                document.getElementById('adminCurrentRankDisplay').value = gUserData.roleName || 'ë¯¸ì§€ì •';
                document.getElementById('adminNewRankSelect').value = '';
            } else {
                document.getElementById('adminDeptSelectArea').style.display = 'block';
                document.getElementById('adminRankSelectArea').style.display = 'none';
                document.getElementById('adminCurrentDeptDisplay').value = gUserData.department || 'ë¯¸ì§€ì •';
                document.getElementById('adminNewDeptSelect').value = '';
            }
        };

        window.submitToAdmin = async function() {
            const isRankChange = gChangeType === 'rank';
            let newValue = '';
            let newDisplayValue = '';

            if (isRankChange) {
                const selectEl = document.getElementById('adminNewRankSelect');
                newValue = selectEl.value;
                newDisplayValue = selectEl.options[selectEl.selectedIndex]?.text || '';
                if (!newValue) {
                    alert('ë³€ê²½í•  ì§ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            } else {
                newValue = document.getElementById('adminNewDeptSelect').value;
                newDisplayValue = newValue;
                if (!newValue) {
                    alert('ë³€ê²½í•  ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            }

            const fileInput = document.getElementById('req-file');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('ì¦ë¹™ ì„œë¥˜ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`'${newDisplayValue}'(ìœ¼)ë¡œ ë³€ê²½ì„ ê´€ë¦¬ìì—ê²Œ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // íŒŒì¼ ì—…ë¡œë“œ (ì‹¤ì œ êµ¬í˜„ ì‹œ ì—…ë¡œë“œ API í˜¸ì¶œ í•„ìš”)
                // const formData = new FormData();
                // formData.append('file', fileInput.files[0]);
                // await fetch('/api/upload', { method: 'POST', body: formData });

                let title = '';
                let content = {};

                if (isRankChange) {
                    title = `[ê´€ë¦¬ì ë¬¸ì˜] ì§ê¸‰ ë³€ê²½ ìš”ì²­ (${gUserData.roleName} â†’ ${newDisplayValue})`;
                    content = {
                        type: 'rank',
                        fromRank: gUserData.role,
                        fromRankName: gUserData.roleName,
                        newRank: newValue,
                        newRankName: newDisplayValue,
                        requesterName: gUserData.managerName,
                        requestTo: 'admin',
                        hasAttachment: true
                    };
                } else {
                    title = `[ê´€ë¦¬ì ë¬¸ì˜] ë¶€ì„œ ë³€ê²½ ìš”ì²­ (${gUserData.department || 'ë¯¸ì§€ì •'} â†’ ${newDisplayValue})`;
                    content = {
                        type: 'department',
                        fromDepartment: gUserData.department || 'ë¯¸ì§€ì •',
                        newDepartment: newValue,
                        requesterName: gUserData.managerName,
                        requestTo: 'admin',
                        hasAttachment: true
                    };
                }

                await posts.create({
                    category: "member_req_admin",
                    title: title,
                    content: JSON.stringify(content),
                    status: 'pending'
                });

                alert("âœ… ê´€ë¦¬ìì—ê²Œ ë³€ê²½ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¦ë¹™ ì„œë¥˜ëŠ” ë³„ë„ë¡œ ì´ë©”ì¼ ë˜ëŠ” ì±„ë„í†¡ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.");
                closeChangeModal();
            } catch (error) {
                console.error('âŒ ê´€ë¦¬ì ìš”ì²­ ì˜¤ë¥˜:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        };

        window.handleLogout = function() { auth.logout(); location.href = "../../index.html"; };
        document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
    </script>
</body>
</html>