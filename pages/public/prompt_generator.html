<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI í”„ë¡¬í”„íŠ¸ ë§¤ë‹ˆì € Pro (v4.0)</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê³µí†µ í…Œë§ˆ] */
        :root { --bg-dark: #0f1015; --bg-panel: #1b1c25; --primary: #5046e5; --accent: #f59e0b; --text: #e2e8f0; --border: #2d3748; --safe: #10b981; --risk: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        .main-content { margin-left: 260px; padding: 30px 40px; width: calc(100% - 260px); display: flex; flex-direction: column; height: 100%; }
        
        .header { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header h1 { font-size: 24px; font-weight: 800; color: #fff; }
        .header h1 span { color: var(--accent); }

        /* [NEW] System Prompt Area (Common) */
        .system-section { flex-shrink: 0; margin-bottom: 20px; background: #14151b; border: 1px solid var(--accent); border-radius: 12px; padding: 15px; }
        .section-label { font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .system-textarea { 
            width: 100%; height: 120px; background: #0b0c10; border: 1px solid #333; outline: none;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #fcd34d; line-height: 1.5;
            resize: vertical; padding: 10px; border-radius: 6px;
        }

        /* Tabs */
        .tabs-container { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; flex-shrink: 0; }
        .tab-btn { 
            background: #252630; border: 1px solid #4a5568; color: #aaa; 
            padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s; 
            font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px;
        }
        .tab-btn:hover { background: #2d3748; color: white; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab-del { width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; background: rgba(255,255,255,0.1); }
        .tab-del:hover { background: var(--risk); }
        .btn-add-tab { background: #333; border: 1px dashed #666; color: #888; padding: 6px 10px; border-radius: 6px; cursor: pointer; }

        /* User Prompt Area (Specific) */
        .prompt-container { flex: 1; background: #14151b; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .toolbar { padding: 10px 20px; background: #1b1c25; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .toolbar-title { font-size: 13px; font-weight: bold; color: #fff; }
        
        .editor-area { 
            flex: 1; padding: 20px; background: #0b0c10; border: none; outline: none;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #d1d5db; line-height: 1.6;
            resize: none; width: 100%;
        }

        /* Buttons */
        .btn { padding: 6px 14px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; color: white; font-size: 12px; margin-left: 5px; }
        .btn-copy { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-save { background: #d97706; }
        .btn-hist { background: #475569; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #1b1c25; width: 600px; padding: 25px; border-radius: 12px; border: 1px solid var(--border); }
        .history-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; color:#ddd; font-size:13px; }
        .history-item:hover { background: #333; }

        @media print { body { display: none; } }
    </style>
</head>
<body>

    <script type="module">
        import { auth, users, requireAuth } from "/js/api.js";
        import { renderRehabSidebar } from './corp_rehab_sidebar.js';
        renderRehabSidebar('ov_prompt'); 
    </script>

    <div class="main-content">
        <div class="header">
            <div>
                <h1>ğŸ¤– í”„ë¡¬í”„íŠ¸ ë§¤ë‹ˆì € <span>Pro</span></h1>
                <p>ê³µí†µ ê·œì¹™ê³¼ ê°œë³„ ì§€ì‹œì‚¬í•­ì„ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
            </div>
            <div>
                <button class="btn btn-hist" onclick="openHistory()">ğŸ•’ íˆìŠ¤í† ë¦¬</button>
                <button class="btn btn-save" onclick="saveToFirebase()">â˜ï¸ ì €ì¥í•˜ê¸°</button>
                <button class="btn btn-copy" onclick="copyFullPrompt()">ğŸ“‹ ì „ì²´ ë³µì‚¬ (ê³µí†µ+ê°œë³„)</button>
            </div>
        </div>

        <div class="system-section">
            <div class="section-label">
                <span>ğŸ”’ ê³µí†µ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ëª¨ë“  íƒ­ì— ìë™ í¬í•¨)</span>
                <span style="color:#666; font-weight:normal;">* ì—­í• , ê·œì¹™, ë‹¨ìœ„ í†µì¼ ë“±</span>
            </div>
            <textarea id="systemEditor" class="system-textarea" oninput="markUnsaved()"></textarea>
        </div>

        <div class="tabs-container" id="tabsArea">
            <button class="btn-add-tab" onclick="addNewTab()">+ ìƒˆ íŒŒì¼ ì¶”ê°€</button>
        </div>

        <div class="prompt-container">
            <div class="toolbar">
                <div class="toolbar-title">ğŸ“ ê°œë³„ ì§€ì‹œì‚¬í•­ (<span id="currentTabName" style="color:var(--primary);">ì„ íƒë¨</span>)</div>
                <span id="saveStatus" style="font-size:11px; color:var(--safe); display:none;">âœ… ì €ì¥ë¨</span>
            </div>
            <textarea class="editor-area" id="userEditor" oninput="handleUserUnput()"></textarea>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:white; margin-bottom:15px;">ğŸ•’ ë³€ê²½ ì´ë ¥ ë³µì›</h3>
            <div id="historyList" style="max-height:400px; overflow-y:auto;"></div>
            <button class="btn btn-hist" style="margin-top:15px; float:right;" onclick="document.getElementById('historyModal').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        // REMOVED: Firebase config import
        // REMOVED: Firebase SDK import

        // Global State
        let systemPrompt = "";
        let templates = [];
        let activeTabId = null;

        // [ì´ˆê¸° ê³µí†µ í”„ë¡¬í”„íŠ¸ ê°’]
        const DEFAULT_SYSTEM = `ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ê¸°ì—…ì‹ ìš©ë¶„ì„ê°€ì´ì ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ì œê³µí•˜ëŠ” PDF í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬, ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆì— ë§ëŠ” ë°ì´í„°ë¥¼ ì •í™•í•˜ê²Œ ì¶”ì¶œí•˜ì‹­ì‹œì˜¤.

[ì‘ì„± ì›ì¹™]
1. ë°ì´í„° ë§¤í•‘: ë¬¸ì„œ ë‚´ìš©ì„ JSON í•„ë“œì— ì •í™•íˆ ë§¤í•‘í•˜ì‹­ì‹œì˜¤.
2. ê²°ì¸¡ì¹˜ ì²˜ë¦¬: ì •ë³´ê°€ ì—†ìœ¼ë©´ "-" ë˜ëŠ” "0"ìœ¼ë¡œ ê¸°ì…í•˜ì‹­ì‹œì˜¤. (null ê¸ˆì§€)
3. ë‹¨ìœ„ í†µì¼: ê¸ˆì•¡ì€ 'ì›' ë‹¨ìœ„ ìˆ«ì(ì½¤ë§ˆ ì œê±°), ë¹„ìœ¨ì€ '%' ì œì™¸í•œ ìˆ«ìë¡œ ë³€í™˜í•˜ì‹­ì‹œì˜¤.
4. JSON í¬ë§· ì¤€ìˆ˜: ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(\`\`\`json) ì•ˆì— ìˆœìˆ˜ JSONë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.`;

        // [ì´ˆê¸° í…œí”Œë¦¿ ê°’]
        const DEFAULT_TEMPLATES = [
            { id: 'credit', name: 'ì‹ ìš©ë³´ê³ ì„œ', content: '[ë¶„ì„ ëŒ€ìƒ] ì‹ ìš©ë³´ê³ ì„œ\n[Task] overview, ratings, credit_history ì¶”ì¶œ\n...' },
            { id: 'tech', name: 'ê¸°ìˆ /íŠ¹í—ˆ', content: '[ë¶„ì„ ëŒ€ìƒ] ê¸°ìˆ ì¸ì¦\n[Task] biz.rnd, biz.patent ì¶”ì¶œ\n...' }
        ];

        // 1. Init
        async function init() {
            try {
                const docRef = doc(db, "settings", "prompts_v4");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    systemPrompt = data.systemPrompt || DEFAULT_SYSTEM;
                    templates = data.list || DEFAULT_TEMPLATES;
                } else {
                    systemPrompt = DEFAULT_SYSTEM;
                    templates = DEFAULT_TEMPLATES;
                }

                // UI Setting
                document.getElementById('systemEditor').value = systemPrompt;
                if(templates.length > 0) activeTabId = templates[0].id;
                
                renderTabs();
                renderUserEditor();

            } catch (e) {
                console.error("Init Error:", e);
                alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + e.message);
            }
        }

        // 2. UI Logic
        window.markUnsaved = function() {
            document.getElementById('saveStatus').style.display = 'none';
        }

        window.handleUserUnput = function() {
            const val = document.getElementById('userEditor').value;
            const target = templates.find(t => t.id === activeTabId);
            if(target) target.content = val;
            markUnsaved();
        }

        function renderTabs() {
            const container = document.getElementById('tabsArea');
            const addBtn = container.querySelector('.btn-add-tab');
            container.innerHTML = ''; // Clear excluding addBtn logic handled by re-append
            
            templates.forEach(t => {
                const btn = document.createElement('div');
                btn.className = `tab-btn ${t.id === activeTabId ? 'active' : ''}`;
                btn.innerHTML = `
                    <span onclick="window.selectTab('${t.id}')">${t.name}</span>
                    <span class="tab-del" onclick="window.deleteTab('${t.id}', event)">âœ•</span>
                `;
                container.appendChild(btn);
            });
            container.appendChild(addBtn);
        }

        window.selectTab = function(id) {
            activeTabId = id;
            renderTabs();
            renderUserEditor();
        }

        function renderUserEditor() {
            const target = templates.find(t => t.id === activeTabId);
            const editor = document.getElementById('userEditor');
            const label = document.getElementById('currentTabName');

            if(target) {
                editor.value = target.content;
                editor.disabled = false;
                label.innerText = target.name;
            } else {
                editor.value = "";
                editor.disabled = true;
                label.innerText = "-";
            }
        }

        window.addNewTab = function() {
            const name = prompt("ìƒˆ íƒ­ ì´ë¦„ (ì˜ˆ: ë§¤ì…ëª…ì„¸ì„œ):");
            if(!name) return;
            const newId = 'tab_' + Date.now();
            templates.push({ id: newId, name: name, content: `[ë¶„ì„ ëŒ€ìƒ] ${name}\n[Task] JSON ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•˜ì„¸ìš”.` });
            activeTabId = newId;
            renderTabs();
            renderUserEditor();
            markUnsaved();
        }

        window.deleteTab = function(id, e) {
            e.stopPropagation();
            if(!confirm("ì´ íƒ­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            templates = templates.filter(t => t.id !== id);
            if(templates.length > 0) activeTabId = templates[0].id;
            else activeTabId = null;
            renderTabs();
            renderUserEditor();
            markUnsaved();
        }

        // 3. Action Logic (Save / Copy / History)
        window.saveToFirebase = async function() {
            if(!confirm("í˜„ì¬ ìƒíƒœë¥¼ í´ë¼ìš°ë“œì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            const currentSystem = document.getElementById('systemEditor').value;
            
            try {
                const data = {
                    systemPrompt: currentSystem,
                    list: templates,
                    updatedAt: serverTimestamp()
                };

                // Save Current
                await setDoc(doc(db, "settings", "prompts_v4"), data);
                
                // Save History
                await addDoc(collection(db, "settings", "prompts_v4", "history"), data);

                document.getElementById('saveStatus').style.display = 'block';
                alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch(e) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            }
        }

        window.copyFullPrompt = function() {
            const sys = document.getElementById('systemEditor').value;
            const usr = document.getElementById('userEditor').value;
            const fullText = sys + "\n\n--------------------------------------------------\n\n" + usr;

            navigator.clipboard.writeText(fullText).then(() => {
                alert("ğŸ“‹ [ê³µí†µ + ê°œë³„] í”„ë¡¬í”„íŠ¸ê°€ ëª¨ë‘ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nGPTì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");
            });
        }

        window.openHistory = async function() {
            const listDiv = document.getElementById('historyList');
            listDiv.innerHTML = "ë¡œë”© ì¤‘...";
            document.getElementById('historyModal').style.display = 'flex';

            const q = query(collection(db, "settings", "prompts_v4", "history"), orderBy("updatedAt", "desc"), limit(10));
            const snap = await getDocs(q);
            
            listDiv.innerHTML = "";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const date = d.updatedAt ? d.updatedAt.toDate().toLocaleString() : "Unknown";
                
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<span>${date} (íƒ­ ${d.list.length}ê°œ)</span> <span>ë³µì›</span>`;
                item.onclick = () => {
                    if(confirm("ì´ ì‹œì ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        systemPrompt = d.systemPrompt;
                        templates = d.list;
                        document.getElementById('systemEditor').value = systemPrompt;
                        if(templates.length>0) activeTabId = templates[0].id;
                        renderTabs();
                        renderUserEditor();
                        document.getElementById('historyModal').style.display = 'none';
                    }
                };
                listDiv.appendChild(item);
            });
        }

        init();
    </script>
</body>
</html>