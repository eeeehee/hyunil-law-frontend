<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „í™”ìƒë‹´ ì˜ˆì•½ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size: 15px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }

        /* [ì‚¬ì´ë“œë°” ê³µí†µ ìŠ¤íƒ€ì¼] */
        .sidebar { width: 260px; background-color: #fff; border-right: 1px solid #eee; padding: 40px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { margin-bottom: 30px; padding-left: 10px; }
        .sidebar-logo img { height: 32px; }

        .user-profile-area { background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee; }
        .user-name { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-bottom: 4px; }
        .user-email { font-size: 12px; color: #888; margin-bottom: 10px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-owner { background: #1a1a2e; color: #fff; }
        .badge-manager { background: #e6f7ff; color: #096dd9; }
        .badge-staff { background: #f0f0f0; color: #555; }

        .menu-list li { margin-bottom: 8px; }
        .menu-link { display: block; padding: 14px 15px; border-radius: 8px; color: #555; font-weight: 500; transition: 0.2s; font-size: 15px; }
        .menu-link:hover { background-color: #f0f0f0; color: #1a1a1a; }
        .menu-link.active { background-color: #1a1a1a; color: #fff; font-weight: 700; }
        .logout-btn { margin-top: auto; padding: 15px 20px; color: #999; font-size: 14px; cursor: pointer; }
        
        .main-content { flex: 1; margin-left: 260px; padding: 60px 50px; }
        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .page-subtitle { font-size: 14px; color: #666; margin-bottom: 30px; }
        .form-box { background: #fff; padding: 40px; border-radius: 12px; max-width: 800px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 24px; }
        .label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 15px; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        .input-box:focus { border-color: #1a1a1a; outline: none; }
        .textarea-box { height: 150px; resize: none; }
        .btn-submit { background: #1a1a1a; color: #fff; border: none; padding: 15px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; font-size: 16px; }
        .btn-submit:hover { background: #333; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        .usage-area { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; gap: 8px; }
        .usage-badge { background-color: #e6f7ff; color: #096dd9; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 700; border: 1px solid #91d5ff; }
        .usage-full { background-color: #fff1f0; color: #cf1322; border-color: #ffa39e; }

        .extra-usage-link { text-align: center; margin-top: 15px; }
        .extra-usage-link a { color: #096dd9; font-weight: 600; font-size: 14px; text-decoration: underline; }

        /* payment.htmlì—ì„œ ê°€ì ¸ì˜¨ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; border-radius: 12px; padding: 40px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; color: #1a1a1a; }
        .modal-desc { font-size: 14px; color: #666; margin-bottom: 30px; line-height: 1.6; }
        .modal-close { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: #999; }
        .btn-submit-modal { background: #1a1a1a; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; font-size: 15px; }
        .btn-submit-modal:hover { background: #333; }
        .btn-cancel-modal { background: #fff; color: #666; border: 1px solid #ddd; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; font-size: 15px; margin-top: 10px; }
        .btn-cancel-modal:hover { background: #f9f9f9; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 30px 20px; }
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°”ëŠ” JavaScriptë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->

    <main class="main-content">
        <h2 class="page-title">ğŸ“ ì „í™”ìƒë‹´ ì˜ˆì•½ ì‹ ì²­</h2>
        <p class="page-subtitle">Standard ë“±ê¸‰ ì´ìƒ íšŒì› ì „ìš© ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>

        <div class="form-box">
            <div class="form-group">
                <label class="label">ìƒë‹´ ë¶„ì•¼</label>
                <select id="category" class="input-box">
                    <option>ê³„ì•½ ê²€í† </option>
                    <option>ë…¸ë¬´/ì¸ì‚¬</option>
                    <option>ì±„ê¶Œ/ë¯¸ìˆ˜ê¸ˆ</option>
                    <option>ì§€ì‹ì¬ì‚°ê¶Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="label">í¬ë§ ìƒë‹´ ì¼ì‹œ (3ê°œ í•„ìˆ˜)</label>
                <input type="datetime-local" id="slot1" class="input-box" style="margin-bottom:10px;">
                <input type="datetime-local" id="slot2" class="input-box" style="margin-bottom:10px;">
                <input type="datetime-local" id="slot3" class="input-box">
            </div>

            <div class="form-group">
                <label class="label">ìˆ˜ì‹  ì—°ë½ì²˜</label>
                <input type="tel" id="phone" class="input-box" placeholder="010-1234-5678">
            </div>

            <div class="form-group">
                <label class="label">ìƒë‹´ ìš”ì•½</label>
                <textarea id="content" class="input-box textarea-box" placeholder="ìƒë‹´ ë‚´ìš©ì„ ê°„ëµíˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
            </div>

            <div class="usage-area">
                <span style="font-size:13px; color:#666;">ì´ë²ˆ ë‹¬ ì „í™”ìƒë‹´ í˜„í™©:</span>
                <div id="usageBadge" class="usage-badge">ë¡œë”©ì¤‘...</div>
            </div>

                        <button id="btnSubmit" class="btn-submit" onclick="submitRequest()">ì˜ˆì•½ ì‹ ì²­í•˜ê¸° (1íšŒ ì°¨ê°)</button>

            <div id="extraUsageInquiry" class="extra-usage-link" style="display: none;">
                <a href="#" onclick="event.preventDefault(); openExtraPayModal();">ì¶”ê°€ ì´ìš© ë¬¸ì˜í•˜ê¸°</a>
            </div>
        </div>
    </main>

    <!-- payment.htmlì—ì„œ ë³µì‚¬í•œ ì¶”ê°€ ì´ìš© ë¬¸ì˜ ëª¨ë‹¬ -->
    <div id="extraPayModal" class="modal-overlay">
        <div class="modal-content" style="position:relative;">
            <span class="modal-close" onclick="closeExtraPayModal()">Ã—</span>
            <h3 class="modal-title">ğŸ’¸ ì¶”ê°€ ì´ìš© ë¬¸ì˜</h3>
            <p class="modal-desc">ìš”ê¸ˆì œ í•œë„ë¥¼ ì´ˆê³¼í•œ ì¶”ê°€ ì´ìš©ì„ ì›í•˜ì‹œë‚˜ìš”?<br>ë¬¸ì˜ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì‹œë©´ ë‹´ë‹¹ìê°€ í™•ì¸ í›„ ì—°ë½ë“œë¦½ë‹ˆë‹¤.</p>
            
            <div class="form-group">
                <label class="label">ë¬¸ì˜ ìœ í˜•</label>
                <select id="extraType" class="input-box">
                    <option value="qa_extra">ì„œë©´ ìë¬¸ ì¶”ê°€</option>
                    <option value="phone_extra">ì „í™” ìƒë‹´ ì¶”ê°€</option>
                    <option value="case_quote">ê±´ë³„ ê²¬ì  ìš”ì²­</option>
                </select>
            </div>

            <div class="form-group">
                <label class="label">ë¬¸ì˜ ë‚´ìš©</label>
                <textarea id="extraContent" class="input-box" rows="5" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
            </div>

            <div class="form-group">
                <label class="label">íšŒì‹  ì—°ë½ì²˜</label>
                <input type="tel" id="extraPhone" class="input-box" placeholder="010-1234-5678">
            </div>

            <button class="btn-submit-modal" onclick="submitExtraPay()">ë¬¸ì˜ ì œì¶œí•˜ê¸°</button>
            <button class="btn-cancel-modal" onclick="closeExtraPayModal()">ì·¨ì†Œ</button>
        </div>
    </div>
    <!-- /ì¶”ê°€ ì´ìš© ë¬¸ì˜ ëª¨ë‹¬ -->

    <script type="module">
        import { auth, users, posts, approvalRequests } from '../../js/api.js';
        import { renderClientSidebar } from '../../js/client_ui.js';

        // expose imported modules for non-module onclick handlers
        window.posts = posts;
        window.approvalRequests = approvalRequests;

        const PLAN_SPECS = {
            'none': { qa: 0, phone: 0, label: 'ë¯¸ê°€ì…' },
            'Basic': { qa: 1, phone: 0, label: 'ğŸŒ± Basic' },
            'Standard': { qa: 3, phone: 1, label: 'â­ Standard' },
            'Pro': { qa: 5, phone: 2, label: 'ğŸ’ Pro' },
            'Premium': { qa: 8, phone: 5, label: 'ğŸ‘‘ Premium' },
            'Enterprise': { qa: 999, phone: 999, label: 'ğŸ¢ Enterprise' } // Enterprise í”Œëœì€ customLimitìœ¼ë¡œ ê´€ë¦¬
        };

        let currentUserData = null;

        // ì „í™” ìƒë‹´ ì‚¬ìš©ëŸ‰ ë°°ì§€ ì—…ë°ì´íŠ¸ ë° ë²„íŠ¼ ì œì–´ í•¨ìˆ˜
        function updatePhoneUsageBadge() {
            const badge = document.getElementById('usageBadge');
            const submitBtn = document.getElementById('btnSubmit');
            const extraLink = document.getElementById('extraUsageInquiry');
            if (!badge || !submitBtn || !extraLink || !currentUserData) return;

            const spec = PLAN_SPECS[currentUserData.plan] || PLAN_SPECS['none'];
            const phoneLimit = currentUserData.plan === 'Enterprise' ? (currentUserData.customPhoneLimit || 0) : spec.phone;
            const phoneUsed = currentUserData.phoneUsedCount || 0;
            const phoneRemaining = Math.max(0, phoneLimit - phoneUsed);

            if (phoneLimit === 0) {
                badge.textContent = 'í”Œëœ ë¯¸ê°€ì…';
                badge.className = 'usage-badge usage-full';
                submitBtn.disabled = true;
                submitBtn.textContent = 'í”Œëœì„ êµ¬ë…í•´ì£¼ì„¸ìš”';
                extraLink.style.display = 'block';
            } else if (phoneRemaining === 0) {
                badge.textContent = `${phoneRemaining} / ${phoneLimit} (í•œë„ ì´ˆê³¼)`;
                badge.className = 'usage-badge usage-full';
                submitBtn.disabled = true;
                submitBtn.textContent = 'ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜ ì´ˆê³¼';
                extraLink.style.display = 'block';
            } else {
                badge.textContent = `${phoneRemaining} / ${phoneLimit} (ë‚¨ì€ ${phoneRemaining}ê±´)`;
                badge.className = 'usage-badge';
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì˜ˆì•½ ì‹ ì²­í•˜ê¸° (1íšŒ ì°¨ê°)';
                extraLink.style.display = 'none';
            }
        }

        window.openExtraPayModal = function() {
            document.getElementById('extraPayModal').classList.add('active');
            const btn = document.querySelector('#extraPayModal .btn-submit-modal');
            if (btn && currentUserData) {
                const useApprovalFlow = currentUserData.useApproval === 1;
                const isStaff = currentUserData.role === 'user' || currentUserData.role === 'manager';
                btn.textContent = (useApprovalFlow && isStaff) ? 'ìŠ¹ì¸ ìš”ì²­í•˜ê¸°' : 'ë¬¸ì˜ ì œì¶œí•˜ê¸°';
                btn.disabled = false;
            }
        };

        window.closeExtraPayModal = function() {
            document.getElementById('extraPayModal').classList.remove('active');
        };

        window.submitExtraPay = async function() {
            const type = document.getElementById('extraType')?.value;
            const content = document.getElementById('extraContent')?.value;
            const phone = document.getElementById('extraPhone')?.value;

            if (!type || !content) {
                alert('ë¬¸ì˜ ìœ í˜•ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!window.currentUserData || !window.posts || !window.approvalRequests) {
                alert('ì‚¬ìš©ì ì •ë³´ ë˜ëŠ” APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const useApprovalFlow = window.currentUserData.useApproval === 1;
                const isStaff = window.currentUserData.role === 'user' || window.currentUserData.role === 'manager';
                
                const title = `ì¶”ê°€ ì´ìš© ë¬¸ì˜ (${type})`;
                const fullContent = `[ìœ í˜•] ${type}\n[íšŒì‹ ì²˜] ${phone || 'ë¯¸ê¸°ì¬'}\n\n[ë‚´ìš©]\n${content}`;

                if (useApprovalFlow && isStaff) {
                    await window.approvalRequests.createRequest({
                        requestType: 'ì¶”ê°€ì´ìš©ë¬¸ì˜',
                        requestData: { title, content: fullContent, authorName: window.currentUserData.managerName }
                    });
                    alert('ì¶”ê°€ ì´ìš© ë¬¸ì˜ê°€ ëŒ€í‘œì—ê²Œ ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    await window.posts.create({
                        category: 'extra_usage_quote',
                        title: title,
                        content: fullContent,
                        authorName: window.currentUserData.managerName, // ìš”ì²­ì ì´ë¦„ ëª…ì‹œ
                        status: 'pending'
                    });
                    alert('ì¶”ê°€ ì´ìš© ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                }

                closeExtraPayModal();
                location.reload(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ì¶”ê°€ ì´ìš© ë¬¸ì˜ ì˜¤ë¥˜:', error);
                alert('ì¶”ê°€ ì´ìš© ë¬¸ì˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
            }
        };

        window.onclick = function(event) {
            const extraModal = document.getElementById('extraPayModal');
            if (event.target === extraModal) {
                closeExtraPayModal();
            }
        };


        (async () => {
            const user = auth.getCurrentUser();
            
            if (user) {
                try {
                    currentUserData = await users.getMe();
                    renderClientSidebar('phone_consult', currentUserData);
                    
                    if (currentUserData.phone) {
                        document.getElementById('phone').value = currentUserData.phone;
                    }
                    
                    updatePhoneUsageBadge();
                    console.log('ì „í™”ìƒë‹´ í˜ì´ì§€ ë¡œë“œ:', currentUserData);
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    location.href = '../../pages/public/login.html';
                }
            } else {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '../../pages/public/login.html';
            }
        })();

        window.submitRequest = async function() {
            if (!currentUserData) {
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const spec = PLAN_SPECS[currentUserData.plan] || PLAN_SPECS['none'];
            const phoneLimit = currentUserData.plan === 'Enterprise' ? (currentUserData.customPhoneLimit || 0) : spec.phone;
            const phoneUsed = currentUserData.phoneUsedCount || 0;
            const phoneRemaining = Math.max(0, phoneLimit - phoneUsed);

            if (phoneLimit === 0) {
                alert('í”Œëœì„ ë¨¼ì € êµ¬ë…í•´ì£¼ì„¸ìš”.');
                openExtraPayModal();
                return;
            }
            if (phoneRemaining === 0) {
                alert('ì‚¬ìš© ê°€ëŠ¥í•œ ì „í™”ìƒë‹´ íšŸìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
                openExtraPayModal();
                return;
            }

            const category = document.getElementById('category').value;
            const slot1 = document.getElementById('slot1').value;
            const slot2 = document.getElementById('slot2').value;
            const slot3 = document.getElementById('slot3').value;
            const phone = document.getElementById('phone').value;
            const content = document.getElementById('content').value;

            if (!slot1 || !slot2 || !slot3) {
                alert('í¬ë§ ìƒë‹´ ì¼ì‹œ 3ê°œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!phone || !content) {
                alert('ì—°ë½ì²˜ì™€ ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const useApprovalFlow = currentUserData.useApproval === 1;
            const isStaff = currentUserData.role === 'user' || currentUserData.role === 'manager';
            const confirmationMessage = (useApprovalFlow && isStaff)
                ? 'ì „í™”ìƒë‹´ì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëŒ€í‘œ ìŠ¹ì¸ í›„ ì˜ˆì•½ì´ í™•ì •ë˜ë©°, ìƒë‹´ íšŸìˆ˜ê°€ ì°¨ê°ë©ë‹ˆë‹¤.'
                : 'ì „í™”ìƒë‹´ì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì „í™”ìƒë‹´ 1íšŒê°€ ì°¨ê°ë©ë‹ˆë‹¤)';

            if (!confirm(confirmationMessage)) {
                return;
            }

            const btn = document.querySelector('#btnSubmit');
            btn.innerText = 'ì‹ ì²­ ì¤‘...';
            btn.disabled = true;

            try {
                const slots = [slot1, slot2, slot3].filter(s => s);
                const title = `[ì „í™”ìƒë‹´] ${category} - ${currentUserData.managerName || ''}`;
                
                const requestPayload = {
                    category: 'phone_request',
                    title: title,
                    content: `[ìƒë‹´ ë¶„ì•¼] ${category}\n[í¬ë§ ì‹œê°„ëŒ€] ${slots.join(', ')}\n[ì—°ë½ì²˜] ${phone}\n[ìƒë‹´ ë‚´ìš©]\n${content}`.trim(),
                    status: 'pending',
                    requestCategory: category,
                    slots: slots,
                    phone: phone,
                    summary: content
                };

                if (useApprovalFlow && isStaff) {
                    await approvalRequests.createRequest({
                        requestType: 'ì „í™”ìƒë‹´',
                        requestData: requestPayload
                    });
                    alert('ì „í™”ìƒë‹´ ì‹ ì²­ì´ ëŒ€í‘œ(CEO)ì—ê²Œ ìŠ¹ì¸ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    await posts.create(requestPayload);
                    alert('ì „í™”ìƒë‹´ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜ê°€ 1íšŒ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }

                location.href = '../../pages/user/dashboard.html';

            } catch (error) {
                console.error('ì‹ ì²­ ì¤‘ ì—ëŸ¬:', error);
                alert('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                updatePhoneUsageBadge();
            }
        };

        window.handleLogout = async () => {
            await auth.logout();
            location.href = '../../index.html';
        };
    </script>
</body>
</html>
