<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© íšŒì› ê´€ë¦¬ (Admin) - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    
    <script src="admin_sidebar.js"></script>
    
    <style>
        /* --- [ê¸°ë³¸ ìŠ¤íƒ€ì¼] --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input, select { font-family: inherit; }

        /* ë ˆì´ì•„ì›ƒ */
        .main-content { flex: 1; margin-left: 260px; padding: 40px; display: grid; grid-template-columns: 1fr 320px; gap: 30px; align-items: start; }
        .left-panel { min-width: 0; }
        .right-panel { background: #fff; border-left: 1px solid #eee; padding: 20px; border-radius: 12px; height: calc(100vh - 80px); overflow-y: auto; position: sticky; top: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        /* í—¤ë” */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
        
        .btn-sync { font-size: 13px; background: #1a1a2e; color: #fff; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-sync:hover { background: #333; }
        .btn-auto-archive { background: #fa8c16; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 700; margin-left: 10px; }
        .btn-auto-archive:hover { background: #d46b08; }

        .search-container { position: relative; width: 350px; }
        .search-input { width: 100%; padding: 12px 15px; padding-left: 40px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition:0.2s; font-size: 14px; }
        .search-input:focus { border-color: #1a1a2e; box-shadow: 0 0 0 3px rgba(26,26,46,0.1); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

        /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ */
        .member-list { display: grid; gap: 15px; }
        .member-card { background: #ffffff; border-radius: 12px; padding: 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border-left: 5px solid transparent; }
        .member-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.06); }
        .member-card.has-pending { border-left-color: #faad14; background: #fffbe6; } 
        .member-card.over-limit { border-left-color: #ff4d4f; background: #fff1f0; }
        .member-card.suspended { opacity: 0.7; background: #f0f0f0; border-left-color: #fa8c16; } 

        .count-text { font-size: 12px; margin-top: 5px; color: #666; }
        .count-text.warning { color: #ff4d4f; font-weight: 800; }

        /* ë¹„í™œì„± ëª©ë¡ */
        .inactive-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .inactive-item:hover { background: #f9f9f9; }
        .inactive-info { flex: 1; cursor: pointer; }
        .inactive-name { font-weight: bold; color: #888; text-decoration: line-through; font-size: 13px; }
        .inactive-date { font-size: 11px; color: #aaa; margin-top: 4px; }
        .btn-restore { padding: 4px 8px; font-size: 11px; border: 1px solid #52c41a; color: #52c41a; background: #fff; border-radius: 4px; cursor: pointer; }
        .btn-restore:hover { background: #f6ffed; }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; border: 1px solid #ddd; display:inline-block; text-align:center;}
        .badge.Basic { background: #e6f7ff; color: #1890ff; border-color: #91d5ff; }
        .badge.Standard { background: #f6ffed; color: #389e0d; border-color: #b7eb8f; }
        .badge.Pro { background: #f9f0ff; color: #722ed1; border-color: #d3adf7; }
        .badge.Premium { background: #fff0f6; color: #c41d7f; border-color: #ffadd2; }
        .badge.Enterprise { background: #391085; color: #fff; border-color: #391085; }
        .badge.none { background: #f5f5f5; color: #999; }

        /* ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .magic-popup { background: #ffffff; width: 950px; height: 90vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popUp 0.3s ease; overflow: hidden; }
        .mini-modal { background: #fff; width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position:relative; }
        @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .popup-header { padding: 25px 30px; background: #fff; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .ph-title { margin: 0; font-size: 22px; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
        .ph-meta { margin-top: 8px; font-size: 13px; color: #666; display:flex; align-items:center; gap:10px; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00b894; }
        input:checked + .slider:before { transform: translateX(20px); }

        .plan-select { padding: 5px; border-radius: 6px; border: 1px solid #ddd; font-weight: bold; font-size: 12px; cursor:pointer; }
        .limit-edit-input { width: 50px; padding: 2px 5px; border: 1px solid #2c5bf2; border-radius: 4px; font-weight: bold; color: #2c5bf2; text-align: center; cursor:pointer;}

        .gauge-section { background: #fafafa; padding: 20px 30px; border-bottom: 1px solid #e0e0e0; }
        .gauge-bg { background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .gauge-fill { height: 100%; background: linear-gradient(90deg, #1a1a2e, #4a4a6a); width: 0%; transition: width 0.6s; }
        .gauge-fill.warning { background: #faad14; }
        .gauge-fill.danger { background: #ff4d4f; }

        .tab-menu { display: flex; padding: 0 30px; background: #fff; border-bottom: 1px solid #e0e0e0; }
        .tab-btn { padding: 15px 20px; font-size: 14px; font-weight: 600; color: #888; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: #1a1a2e; border-bottom-color: #1a1a2e; }
        .popup-body { flex: 1; overflow-y: auto; padding: 30px; background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .date-warning { color: #ff4d4f; font-weight: 700; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; background: #f5f5f5; color: #555; font-weight: 700; border-bottom: 1px solid #ddd; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }

        .btn-mini { padding: 5px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; background: #fff; margin-right: 4px; transition:0.2s; }
        .btn-mini:hover { background: #f0f0f0; }
        .btn-stop { color: #ff4d4f; border-color: #ffccc7; }
        .btn-stop:hover { background: #fff1f0; }
        .btn-archive { width: 100%; padding: 15px; background: #fff7e6; color: #d46b08; border: 1px solid #ffd591; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 30px; transition:0.2s; }
        .btn-archive:hover { background: #fa8c16; color:white; }
        .btn-save-info { background: #1a1a2e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 700; float: right; }
        .btn-modal-save { width: 100%; padding: 12px; background: #1a1a2e; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 15px; }

        .history-item { position: relative; padding-left: 20px; margin-bottom: 20px; font-size: 13px; }
        .history-item::before { content: ''; position: absolute; left: 0; top: 5px; width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .history-item::after { content: ''; position: absolute; left: 3px; top: 13px; width: 2px; height: 100%; background: #eee; }
        .history-item:last-child::after { display: none; }
        .history-date { font-weight: 700; color: #1a1a2e; margin-bottom: 3px; }
        .history-desc { color: #555; }
        .toggle-label { display: flex; align-items: center; justify-content: flex-end; gap: 8px; font-size: 12px; font-weight: 700; color: #555; }
        
        /* ì§ì› ë“±ë¡ ë²„íŠ¼ ê·¸ë£¹ */
        .emp-action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-add-staff { background: #2c5bf2; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-add-staff:hover { background: #1b42c4; }
        .btn-excel { background: #1a7f37; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-excel:hover { background: #136029; }
    </style>
</head>
<body>

<script>
    if (typeof renderAdminSidebar === 'function') {
        renderAdminSidebar();
    } else {
        console.error("admin_sidebar.js íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
</script>

<main class="main-content">
    <div class="left-panel">
        <div class="page-header">
            <h2 class="page-title">
                ğŸ‘¥ í†µí•© íšŒì› ê´€ë¦¬ 
                <button class="btn-sync" onclick="loadMemberData(true)">ğŸ”„ ìƒˆë¡œê³ ì¹¨ (ìë™ê²€ì‚¬)</button>
                <button class="btn-auto-archive" onclick="runAutoArchiveLogic()">âš¡ ì¥ê¸° ë¯¸í™œë™ ìë™ë³´ê´€ ì‹¤í–‰</button>
                <button class="btn-sync" style="background:#2c5bf2; margin-left:10px;" onclick="document.getElementById('manualRegisterModal').style.display='flex'">+ ê¸°ì—… ìˆ˜ë™ ë“±ë¡</button>
            </h2>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="ê¸°ì—…ëª…, ëŒ€í‘œì, ì‚¬ì—…ìë²ˆí˜¸..." onkeyup="filterList()">
            </div>
        </div>

        <div id="loadingMsg" style="text-align:center; padding:50px; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="member-list" id="companyList"></div>
    </div>

    <aside class="right-panel">
        <h3 style="font-size:16px; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ“ ë¹„í™œì„± (ë³´ê´€í•¨)</span>
            <span id="inactiveCount" style="font-size:12px; color:#888;">0ê°œ</span>
        </h3>
        <input type="text" id="searchInactive" class="search-input" style="width:100%; margin-bottom:15px; padding-left:15px; height:36px;" placeholder="ë³´ê´€ëœ ê¸°ì—… ê²€ìƒ‰..." onkeyup="filterInactive()">
        <div id="inactiveList">
            <div style="color:#999; font-size:13px; text-align:center; padding-top:20px;">ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>
        </div>
    </aside>
</main>

<div class="modal-overlay" id="popup">
    <div class="magic-popup">
        <div class="popup-header">
            <div class="ph-left">
                <h2 class="ph-title">
                    <span id="pName">-</span>
                    <label class="switch" title="ì¼ì‹œ ì •ì§€ / í™œì„±í™”">
                        <input type="checkbox" id="pActiveSwitch" onchange="toggleCompanyStatus()">
                        <span class="slider"></span>
                    </label>
                </h2>
                <div class="ph-meta">
                    <select id="pPlanSelect" class="plan-select" onchange="changeCompanyPlan()">
                        <option value="none">ë¯¸ê°€ì… (NONE)</option>
                        <option value="Basic">Basic (3ì¸)</option>
                        <option value="Standard">Standard (7ì¸)</option>
                        <option value="Pro">Pro (12ì¸)</option>
                        <option value="Premium">Premium (17ì¸)</option>
                        <option value="Enterprise">Enterprise (ë¬´ì œí•œ)</option>
                    </select>
                    <span style="color:#ddd;">|</span>
                    <span>ì‚¬ì—…ìë²ˆí˜¸: <span id="pBizNum">-</span></span>
                </div>
            </div>
            <button onclick="closePopup()" style="font-size:24px; border:none; background:none; cursor:pointer;">&times;</button>
        </div>

        <div class="gauge-section">
            <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:bold; margin-bottom:5px;">
                <span>ğŸ‘¥ ë¼ì´ì„ ìŠ¤ ì´ìš© í˜„í™©</span>
                <span id="gaugeTextContainer">
                    <span id="gaugeActive">0</span> / 
                    <input type="number" id="gaugeLimitInput" class="limit-edit-input" onchange="manualUpdateLimit()" title="í´ë¦­í•˜ì—¬ ìµœëŒ€ì¸ì› ì§ì ‘ ìˆ˜ì •"> ëª…
                </span>
            </div>
            <div class="gauge-bg"><div class="gauge-fill" id="gaugeBar"></div></div>
            <div id="cmsAlert" style="margin-top:10px; color:#ff4d4f; font-size:12px; font-weight:bold; display:none;"></div>
        </div>

        <div class="tab-menu">
            <div class="tab-btn active" onclick="switchTab('tabEmployees')">ğŸ‘¥ ì§ì› ê´€ë¦¬</div>
            <div class="tab-btn" onclick="switchTab('tabHistory')">ğŸ“œ ë³€ê²½ ì´ë ¥</div>
            <div class="tab-btn" onclick="switchTab('tabInfo')">ğŸ¢ íšŒì‚¬ ì •ë³´ (ìˆ˜ì •)</div>
        </div>

        <div class="popup-body">
            <div id="tabEmployees" class="tab-content active">
                <div class="emp-action-bar">
                    <div><h3 style="margin:0; font-size:16px;">ì†Œì† ì§ì› ëª©ë¡</h3></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-add-staff" onclick="openAddStaffModal()">+ ì§ì› ê°œë³„ ë“±ë¡</button>
                        <button class="btn-excel" onclick="location.href='admin_staff_upload.html'">ğŸ“¥ ì§ì› ì¼ê´„ ë“±ë¡ (ìƒˆì°½)</button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th width="15%">ì´ë¦„</th>
                            <th width="15%">ë¶€ì„œ</th>
                            <th width="15%">ê¶Œí•œ(Role)</th>
                            <th width="20%">ì´ë©”ì¼</th>
                            <th width="15%">ê°€ì…ì¼ì‹œ</th>
                            <th width="10%">ìƒíƒœ</th>
                            <th width="10%">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="empBody"></tbody>
                </table>
            </div>

            <div id="tabHistory" class="tab-content">
                <h3 style="margin:0 0 15px 0; font-size:16px;">ì‹œìŠ¤í…œ ë³€ê²½ ë¡œê·¸</h3>
                <div class="history-list" id="historyList"></div>
            </div>

            <div id="tabInfo" class="tab-content">
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                     <h3 style="margin:0; font-size:16px;">ê³„ì•½ ë° ê¸°ì—… ì •ë³´ ìˆ˜ì •</h3>
                     <button class="btn-save-info" onclick="saveCompanyInfo()">ì €ì¥í•˜ê¸°</button>
                 </div>
                 <div class="info-grid">
                     <div class="form-group"><label>ëŒ€í‘œìëª…</label><input type="text" id="editRepName" class="form-input"></div>
                     <div class="form-group"><label>ëŒ€í‘œ ì „í™”ë²ˆí˜¸</label><input type="text" id="editPhone" class="form-input"></div>
                     <div class="form-group"><label>ë‹´ë‹¹ì ì´ë©”ì¼ (ê³„ì • ID)</label><input type="text" id="editEmail" class="form-input"></div>
                     <div class="form-group"><label>ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸</label><input type="text" id="editBizNum" class="form-input"></div>
                 </div>
                 <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">
                 <h4 style="margin-bottom:15px; color:#1a1a2e;">ğŸ“… ê³„ì•½ ê¸°ê°„ ì„¤ì • (ìë™ê°±ì‹  ê´€ë¦¬)</h4>
                 <div class="info-grid">
                    <div class="form-group"><label>ìµœì´ˆ ê°€ì…ì¼</label><input type="date" id="dateJoin" class="form-input" disabled></div>
                    <div class="form-group"></div>
                    <div class="form-group">
                        <label>ê³„ì•½ ê°œì‹œì¼</label>
                        <input type="date" id="dateStart" class="form-input" onchange="autoCalcEndDate()">
                    </div>
                    <div class="form-group">
                        <div style="display:flex; justify-content:space-between;">
                            <label>ê³„ì•½ ë§Œë£Œì¼</label>
                            <div class="toggle-label">
                                ìë™ê°±ì‹  <label class="switch" style="width:34px; height:18px;"><input type="checkbox" id="autoRenewal"><span class="slider"></span></label>
                            </div>
                        </div>
                        <input type="date" id="dateEnd" class="form-input">
                        <div id="expiryWarning" style="font-size:12px; margin-top:5px; display:none;" class="date-warning"></div>
                    </div>
                 </div>
                 <button class="btn-archive" onclick="archiveCompany()">ğŸ“ ê¸°ì—… ê³„ì • ë¹„í™œì„±í™” (ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™)</button>
                 <p style="font-size:11px; color:#888; text-align:center; margin-top:5px;">* ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™ë˜ë©´ ë©”ì¸ ë¦¬ìŠ¤íŠ¸ì—ì„œ ìˆ¨ê²¨ì§€ë©°, ìš°ì¸¡ íŒ¨ë„ì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="empEditModal">
    <div class="mini-modal">
        <h3 style="margin-top:0;">ğŸ‘¤ ì§ì› ì •ë³´ ìˆ˜ì •</h3>
        <input type="hidden" id="editEmpId">
        <div class="form-group" style="margin-top:15px;"><label>ì´ë¦„</label><input type="text" id="editEmpName" class="form-input"></div>
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="editEmpDept" class="form-input"></div>
        <div class="form-group">
            <label>ê¶Œí•œ (Role)</label>
            <select id="editEmpRole" class="form-input" style="height:38px;">
                <option value="user">ì¼ë°˜ ì§ì› (User)</option>
                <option value="manager">ë¶€ì„œì¥ (Manager)</option>
                <option value="owner">ì´ê´„ ê´€ë¦¬ì (CEO)</option>
            </select>
        </div>
        <div class="form-group"><label>ì´ë©”ì¼ (ID)</label><input type="text" id="editEmpEmail" class="form-input"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-modal-save" onclick="saveMemberEdit()">ì €ì¥í•˜ê¸°</button>
            <button class="btn-modal-save" style="background:#fff; color:#555; border:1px solid #ddd;" onclick="document.getElementById('empEditModal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addStaffModal">
    <div class="mini-modal">
        <h3 style="margin-top:0;">+ ì§ì› ê°œë³„ ë“±ë¡</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">í•´ë‹¹ íšŒì‚¬ ì†Œì†ìœ¼ë¡œ ì§ì›ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
        
        <div class="form-group"><label>ì´ë©”ì¼ (ì•„ì´ë””)</label><input type="email" id="addStaffEmail" class="form-input"></div>
        <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸ (ì„ì‹œ)</label><input type="text" id="addStaffPw" class="form-input" value="123456"></div>
        <div class="form-group"><label>ì´ë¦„</label><input type="text" id="addStaffName" class="form-input"></div>
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="addStaffDept" class="form-input"></div>
        <div class="form-group"><label>ì—°ë½ì²˜</label><input type="text" id="addStaffPhone" class="form-input"></div>
        <div class="form-group">
            <label>ê¶Œí•œ</label>
            <select id="addStaffRole" class="form-input" style="height:38px;">
                <option value="user">ì¼ë°˜ ì§ì›</option>
                <option value="manager">ë¶€ì„œì¥</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-modal-save" onclick="handleAddStaff()">ë“±ë¡í•˜ê¸°</button>
            <button class="btn-modal-save" style="background:#fff; color:#555; border:1px solid #ddd;" onclick="document.getElementById('addStaffModal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="manualRegisterModal">
    <div class="mini-modal" style="width: 500px;">
        <h3 style="margin-top:0;">ğŸ¢ ê¸°ì—…/ê³ ê° ìˆ˜ë™ ë“±ë¡</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">ê´€ë¦¬ìê°€ ê³„ì •ì„ ìƒì„±í•˜ì—¬ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
        <div class="info-grid">
            <div class="form-group"><label>ì´ë©”ì¼</label><input type="email" id="regEmail" class="form-input"></div>
            <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="text" id="regPw" class="form-input"></div>
            <div class="form-group"><label>íšŒì‚¬ëª…</label><input type="text" id="regCompName" class="form-input"></div>
            <div class="form-group"><label>ëŒ€í‘œìëª…</label><input type="text" id="regRepName" class="form-input"></div>
            <div class="form-group"><label>ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="regBizNum" class="form-input"></div>
            <div class="form-group"><label>í”Œëœ</label><select id="regPlan" class="form-input" style="height:38px;"><option value="Basic">Basic</option><option value="Standard">Standard</option><option value="Pro">Pro</option><option value="Premium">Premium</option><option value="Enterprise">Enterprise</option></select></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-modal-save" onclick="handleManualRegister()">ìƒì„± ë° ë“±ë¡</button>
            <button class="btn-modal-save" style="background:#fff; color:#555; border:1px solid #ddd;" onclick="document.getElementById('manualRegisterModal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script type="module">
    import { auth, db } from "./firebase-config.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { collection, query, getDocs, doc, getDoc, updateDoc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const PLANS = { 'none': {limit:1}, 'Basic':{limit:3}, 'Standard':{limit:7}, 'Pro':{limit:12}, 'Premium':{limit:17}, 'Enterprise':{limit:999} };
    
    let allCompanies = [];
    let inactiveCompanies = [];
    let currentCompId = null;
    let currentAdminName = "Admin";

    // 1. ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === 'admin') {
                const userData = userDoc.data();
                currentAdminName = userData.managerName || "Admin";
                
                // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
                if(window.updateSidebarUser) {
                    window.updateSidebarUser(user, { dept: userData.department || 'ê´€ë¦¬ì', position: userData.role });
                }
                
                // ë°ì´í„° ë¡œë“œ ì‹œì‘
                loadMemberData(true); 
            } else { 
                alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); 
                location.href = "index.html"; 
            }
        } else { location.href = "login.html"; }
    });

    /// 2. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadMemberData(runAutoCheck = false) {
        document.getElementById('loadingMsg').style.display = 'block';
        try {
            const q = query(collection(db, "users"));
            const snapshot = await getDocs(q);
            const companiesMap = {};
            
            // 2-1. ê¸°ì—…(Owner) ë¨¼ì € ë§¤í•‘
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                data.id = docSnap.id;
                
                if (data.role === 'owner' || data.type === 'corp') {
                    const key = data.bizNum || "UNKNOWN";
                    
                    // 1. íšŒì‚¬ ê¸°ë³¸ ì •ë³´ ì„¸íŒ…
                    companiesMap[key] = { ...data, employees: [], logs: data.logs || [] };

                    // [ì¶”ê°€ëœ ë¶€ë¶„] â˜… ëŒ€í‘œë‹˜ ë³¸ì¸ë„ ì§ì› ë¦¬ìŠ¤íŠ¸ì— ì™ ë„£ê¸°!
                    // ë‹¨, 'corp' íƒ€ì…(ë²•ì¸ ê³„ì •)ì´ ì•„ë‹Œ ì‹¤ì œ ì‚¬ëŒ(Owner)ì¸ ê²½ìš°ë§Œ
                    if (data.role === 'owner') {
                        companiesMap[key].employees.push(data);
                    }
                } 
            });

            // 2-2. ì§ì›(Staff) ë§¤í•‘
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                data.id = docSnap.id;
                if (['user', 'manager', 'staff'].includes(data.role)) {
                    if(data.bizNum && companiesMap[data.bizNum]) {
                        companiesMap[data.bizNum].employees.push(data);
                    }
                }
            });

            allCompanies = [];
            inactiveCompanies = [];
            const today = new Date();

            // 2-3. ë¶„ë¥˜ ë° ìë™í™” ë¡œì§
            for (const comp of Object.values(companiesMap)) {
                // ìë™ ë³´ê´€: ê³„ì•½ ë§Œë£Œ
                if (runAutoCheck && comp.isActive !== false && comp.contractEndDate && !comp.autoRenewal) {
                    const end = new Date(comp.contractEndDate);
                    if (today > end) {
                        await updateDoc(doc(db, "users", comp.id), { isActive: false });
                        comp.isActive = false;
                        await logHistory(comp.id, "[ìë™ì¡°ì¹˜] ê³„ì•½ ë§Œë£Œë¡œ ë¹„í™œì„±í™”", "System");
                    }
                }

                // ë¦¬ìŠ¤íŠ¸ ë¶„ë¥˜
                if(comp.status === 'Archived') {
                    inactiveCompanies.push(comp);
                } else {
                    // ìë™ ì°¨ë‹¨: ì¸ì› ì´ˆê³¼
                    if (runAutoCheck) {
                        await checkAndSuspendOverLimit(comp, false);
                    }
                    allCompanies.push(comp);
                }
            }

            renderList(allCompanies);
            renderInactiveList(inactiveCompanies);
            document.getElementById('loadingMsg').style.display = 'none';

        } catch (error) { 
            console.error(error); 
            alert("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message); 
        }
    }

    // 3. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderList(list) {
        const container = document.getElementById('companyList');
        container.innerHTML = '';
        if (list.length === 0) { 
            container.innerHTML = '<div style="text-align:center; padding:20px;">í‘œì‹œí•  ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; 
            return; 
        }

        list.forEach((comp) => {
            const planName = comp.plan || 'none';
            const planLimit = PLANS[comp.plan] ? PLANS[comp.plan].limit : 1;
            const customLimit = comp.customLimit ? Number(comp.customLimit) : 0;
            const limit = customLimit > 0 ? customLimit : planLimit;

            const activeCount = comp.employees.filter(e => e.status !== 'Suspended').length;
            
            let countClass = "";
            let cardClass = "";
            
            if (activeCount > limit) { countClass = "warning"; cardClass = "over-limit"; }
            if (comp.isActive === false) { cardClass += " suspended"; }

            // [í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° í™•ì¸] onclick="openPopup(...)"
            const html = `
                <div class="member-card ${cardClass}" onclick="openPopup('${comp.id}')">
                    <div>
                        <div style="font-weight:bold; font-size:16px;">
                            ${comp.companyName || 'ì´ë¦„ ì—†ìŒ'}
                            ${comp.isActive === false ? '<span style="font-size:12px; color:#d46b08;"> (ì¼ì‹œì •ì§€)</span>' : ''}
                        </div>
                        <div style="font-size:12px; color:#888;">${comp.managerName || '-'} | ${comp.bizNum || '-'}</div>
                    </div>
                    <div style="text-align:right;">
                        <span class="badge ${planName}">${planName}</span>
                        <div class="count-text ${countClass}">${activeCount} / ${limit}ëª…</div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function renderInactiveList(list) {
        const container = document.getElementById('inactiveList');
        container.innerHTML = '';
        document.getElementById('inactiveCount').innerText = list.length + "ê°œ";
        
        if (list.length === 0) { 
            container.innerHTML = '<div style="color:#999; font-size:13px; text-align:center; padding-top:20px;">ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>'; 
            return; 
        }

        list.forEach(comp => {
            const html = `
                <div class="inactive-item">
                    <div class="inactive-info" onclick="openPopup('${comp.id}')">
                        <div class="inactive-name">${comp.companyName || 'ì´ë¦„ ì—†ìŒ'}</div>
                        <div class="inactive-date">${comp.bizNum}</div>
                    </div>
                    <button class="btn-restore" onclick="restoreCompany('${comp.id}')">ë³µêµ¬</button>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // 4. íŒì—… ì—´ê¸° (ì—¬ê¸°ê°€ ë¬¸ì œì˜€ì„ ìˆ˜ ìˆìŒ)
    function openPopup(id) {
        currentCompId = id;
        const comp = allCompanies.find(c => c.id === id) || inactiveCompanies.find(c => c.id === id);
        
        if(!comp) {
            console.error("í•´ë‹¹ ê¸°ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", id);
            return;
        }

        // ë°ì´í„° ë°”ì¸ë”©
        document.getElementById('pName').innerText = comp.companyName;
        document.getElementById('pBizNum').innerText = comp.bizNum;
        document.getElementById('pPlanSelect').value = comp.plan || 'none';
        document.getElementById('pActiveSwitch').checked = (comp.isActive !== false);

        renderEmpTable(comp);
        renderHistory(comp);

        // ìˆ˜ì • í¼ ë°”ì¸ë”©
        document.getElementById('editRepName').value = comp.managerName || '';
        document.getElementById('editPhone').value = comp.phone || '';
        document.getElementById('editEmail').value = comp.email || '';
        document.getElementById('editBizNum').value = comp.bizNum || '';

        // ë‚ ì§œ ë°”ì¸ë”©
        if(comp.createdAt) document.getElementById('dateJoin').value = formatDate(comp.createdAt.toDate());
        document.getElementById('dateStart').value = comp.contractStartDate || '';
        document.getElementById('dateEnd').value = comp.contractEndDate || '';
        document.getElementById('autoRenewal').checked = (comp.autoRenewal === true);

        checkExpiryWarning(comp.contractEndDate);
        updateGauge(comp);
        
        document.getElementById('popup').style.display = 'flex';
    }

    // 5. ì§ì› í…Œì´ë¸” ë Œë”ë§
    function renderEmpTable(comp) {
        const tbody = document.getElementById('empBody');
        tbody.innerHTML = '';
        
        comp.employees.forEach(emp => {
            let statusBadge = `<span style="color:#00b894; font-weight:bold;">Active</span>`;
            let actionBtn = "";

            if (emp.status === 'Pending') statusBadge = `<span style="color:#faad14;">ìŠ¹ì¸ëŒ€ê¸°</span>`;
            if (emp.status === 'Suspended') statusBadge = `<span style="color:#ff4d4f; font-weight:bold;">ê¶Œí•œì¤‘ì§€</span>`;
            
            actionBtn = `
                <button class="btn-mini" onclick="openEditModal('${emp.id}')">ìˆ˜ì •</button>
                ${emp.status === 'Suspended' 
                    ? `<button class="btn-mini" onclick="restoreMember('${emp.id}')">ë³µêµ¬</button>` 
                    : `<button class="btn-mini btn-stop" onclick="suspendMember('${emp.id}')">ê¶Œí•œì¤‘ì§€</button>`}
            `;
            
            let joinDate = emp.createdAt ? formatDateTime(emp.createdAt.toDate()) : "-";
            
            let roleText = "ì¼ë°˜ ì§ì›";
            if(emp.role === 'manager') roleText = "ë¶€ì„œì¥";
            if(emp.role === 'owner') roleText = "ì´ê´„(CEO)";

            tbody.innerHTML += `
                <tr>
                    <td>${emp.managerName}</td>
                    <td>${emp.department||'-'}</td>
                    <td><span style='font-size:12px; color:#555;'>${roleText}</span></td>
                    <td>${emp.email}</td>
                    <td style="color:#666; font-size:11px;">${joinDate}</td>
                    <td>${statusBadge}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        });
    }

    // 6. ì§ì› ê°œë³„ ë“±ë¡
    async function handleAddStaff() {
        const comp = allCompanies.find(c => c.id === currentCompId) || inactiveCompanies.find(c => c.id === currentCompId);
        if(!comp) return alert("íšŒì‚¬ ì •ë³´ ì˜¤ë¥˜");

        const email = document.getElementById('addStaffEmail').value;
        const password = document.getElementById('addStaffPw').value;
        const name = document.getElementById('addStaffName').value;
        const dept = document.getElementById('addStaffDept').value;
        const phone = document.getElementById('addStaffPhone').value;
        const role = document.getElementById('addStaffRole').value;

        if(!email || !password || !name) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        const btn = event.target;
        btn.innerText = "ë“±ë¡ ì¤‘..."; btn.disabled = true;

        // ê´€ë¦¬ì ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•œ ë³´ì¡° ì•±
        const secondaryConfig = {
            apiKey: "AIzaSyCuj5nd8P3lAMwrdxXtZOrWAtC69CYBNdw",
            authDomain: "corporatehyunillaw.firebaseapp.com",
            projectId: "corporatehyunillaw",
            storageBucket: "corporatehyunillaw.firebasestorage.app",
            messagingSenderId: "693639965402",
            appId: "1:693639965402:web:c5c4b22fb5bd50a39b53e3"
        };

        try {
            const secondaryApp = initializeApp(secondaryConfig, "AddStaff_" + new Date().getTime());
            const secondaryAuth = getAuth(secondaryApp);
            const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
            
            await setDoc(doc(db, "users", cred.user.uid), {
                uid: cred.user.uid,
                email: email, managerName: name, department: dept || "ì „ì‚¬", phone: phone, role: role,
                bizNum: comp.bizNum, companyName: comp.companyName,
                isFirstLogin: true, createdAt: new Date(), status: 'Active'
            });

            alert(`âœ… ë“±ë¡ ì™„ë£Œ: ${name}`);
            document.getElementById('addStaffModal').style.display = 'none';
            document.getElementById('addStaffEmail').value = "";
            document.getElementById('addStaffName').value = "";

            loadMemberData(); 
            setTimeout(() => openPopup(comp.id), 1000); 
            await signOut(secondaryAuth);
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
        finally { btn.innerText = "ë“±ë¡í•˜ê¸°"; btn.disabled = false; }
    }

    // 7. ì§ì› ìˆ˜ì •
    function openEditModal(id) {
        const comp = allCompanies.find(c => c.id === currentCompId) || inactiveCompanies.find(c => c.id === currentCompId);
        const emp = comp.employees.find(e => e.id === id);
        
        document.getElementById('editEmpId').value = id;
        document.getElementById('editEmpName').value = emp.managerName;
        document.getElementById('editEmpDept').value = emp.department || '';
        document.getElementById('editEmpEmail').value = emp.email;
        document.getElementById('editEmpRole').value = emp.role || 'user';
        
        document.getElementById('empEditModal').style.display = 'flex';
    }

    async function saveMemberEdit() {
        const uid = document.getElementById('editEmpId').value;
        const newName = document.getElementById('editEmpName').value;
        const newDept = document.getElementById('editEmpDept').value;
        const newEmail = document.getElementById('editEmpEmail').value;
        const newRole = document.getElementById('editEmpRole').value;

        try {
            await updateDoc(doc(db, "users", uid), { managerName: newName, department: newDept, email: newEmail, role: newRole });
            await logHistory(currentCompId, `[ì§ì›ìˆ˜ì •] ${newName} (${newRole}) ì •ë³´ ë³€ê²½`);
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('empEditModal').style.display = 'none';
            loadMemberData();
            setTimeout(() => openPopup(currentCompId), 500);
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    }

    // 8. ê¸°ì—… ìˆ˜ë™ ë“±ë¡
    async function handleManualRegister() {
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPw').value;
        const companyName = document.getElementById('regCompName').value;
        const repName = document.getElementById('regRepName').value;
        const bizNum = document.getElementById('regBizNum').value;
        const plan = document.getElementById('regPlan').value;

        if(!email || !password || !companyName) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        const btn = event.target;
        btn.innerText = "ìƒì„± ì¤‘..."; btn.disabled = true;

        const secondaryConfig = {
            apiKey: "AIzaSyCuj5nd8P3lAMwrdxXtZOrWAtC69CYBNdw",
            authDomain: "corporatehyunillaw.firebaseapp.com",
            projectId: "corporatehyunillaw",
            storageBucket: "corporatehyunillaw.firebasestorage.app",
            messagingSenderId: "693639965402",
            appId: "1:693639965402:web:c5c4b22fb5bd50a39b53e3"
        };

        try {
            const secondaryApp = initializeApp(secondaryConfig, "ManReg_" + new Date().getTime());
            const secondaryAuth = getAuth(secondaryApp);
            const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);

            await setDoc(doc(db, "users", cred.user.uid), {
                uid: cred.user.uid, email: email, companyName: companyName,
                managerName: repName, bizNum: bizNum, plan: plan, role: 'owner',
                isActive: true, isFirstLogin: true, createdAt: new Date(),
                customLimit: (plan === 'Enterprise' ? 999 : 0), qaUsedCount: 0, phoneUsedCount: 0
            });

            alert(`âœ… ê³„ì • ìƒì„± ì™„ë£Œ!\nID: ${email}\nPW: ${password}`);
            document.getElementById('manualRegisterModal').style.display = 'none';
            loadMemberData();
            await signOut(secondaryAuth);
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
        finally { btn.innerText = "ìƒì„± ë° ë“±ë¡"; btn.disabled = false; }
    }

    // 9. ê³µí†µ í•¨ìˆ˜ë“¤ (ìë™ì°¨ë‹¨, ë¡œê·¸, í•„í„° ë“±)
    async function checkAndSuspendOverLimit(comp, showAlert = true) {
        const limit = comp.customLimit || (PLANS[comp.plan] ? PLANS[comp.plan].limit : 1);
        const activeStaffs = comp.employees.filter(e => e.status === 'Active');

        if (activeStaffs.length > limit) {
            const diff = activeStaffs.length - limit;
            activeStaffs.sort((a, b) => {
                const dateA = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
                const dateB = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
                return dateB - dateA; 
            });

            let suspendedNames = [];
            for (let i = 0; i < diff; i++) {
                const target = activeStaffs[i];
                if (!target) continue;
                try { await updateDoc(doc(db, "users", target.id), { status: 'Suspended' }); } catch (e) {}
                target.status = 'Suspended';
                suspendedNames.push(target.managerName);
            }
            const msg = `âš ï¸ [${comp.companyName}] í•œë„ ì´ˆê³¼ë¡œ ${diff}ëª…(${suspendedNames.join(', ')}) ê¶Œí•œ ì •ì§€`;
            if (showAlert) alert(msg);
            await logHistory(comp.id, `[ìë™ì°¨ë‹¨] ${msg}`, "System");
        }
    }

    async function logHistory(compId, msg, author = null) {
        const writer = author || currentAdminName;
        const fullMsg = `${msg} - by ${writer}`;
        const logEntry = { date: new Date(), msg: fullMsg };
        try { await updateDoc(doc(db, "users", compId), { logs: arrayUnion(logEntry) }); } catch(e) {}
    }

    function renderHistory(comp) {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if(!comp.logs || comp.logs.length === 0) { list.innerHTML = `<div style="text-align:center; color:#999;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
        [...comp.logs].reverse().forEach(log => {
            const d = log.date.toDate ? log.date.toDate().toLocaleString() : new Date(log.date).toLocaleString();
            list.innerHTML += `<div class="history-item"><div class="history-date">${d}</div><div class="history-desc">${log.msg}</div></div>`;
        });
    }

    function updateGauge(comp) {
        const limit = comp.customLimit || (PLANS[comp.plan] ? PLANS[comp.plan].limit : 1);
        const active = comp.employees.filter(e => e.status !== 'Suspended').length;
        document.getElementById('gaugeActive').innerText = active;
        document.getElementById('gaugeLimitInput').value = limit;
        document.getElementById('gaugeBar').style.width = `${Math.min((active/limit)*100, 100)}%`;
        const alertBox = document.getElementById('cmsAlert');
        if(active > limit) { document.getElementById('gaugeBar').className = 'gauge-fill danger'; alertBox.style.display = 'block'; alertBox.innerText = `âš ï¸ ì¸ì› ì´ˆê³¼ (${active}/${limit})! ê´€ë¦¬ í•„ìš”`; } 
        else { document.getElementById('gaugeBar').className = 'gauge-fill'; alertBox.style.display = 'none'; }
    }

    // ê¸°íƒ€ ë‹¨ìˆœ ê¸°ëŠ¥
    async function toggleCompanyStatus() {
        const isActive = document.getElementById('pActiveSwitch').checked;
        const comp = allCompanies.find(c => c.id === currentCompId);
        if(!comp) return;
        await updateDoc(doc(db, "users", comp.id), { isActive: isActive });
        comp.isActive = isActive;
        await logHistory(comp.id, `[ìƒíƒœë³€ê²½] ${isActive ? 'í™œì„±í™”' : 'ì¼ì‹œì •ì§€'}`);
        renderList(allCompanies);
    }

    async function archiveCompany() {
        if(!confirm("ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const comp = allCompanies.find(c => c.id === currentCompId);
        if(!comp) return;
        await updateDoc(doc(db, "users", comp.id), { status: 'Archived', isActive: false });
        comp.status = 'Archived'; comp.isActive = false;
        const idx = allCompanies.indexOf(comp);
        if(idx > -1) allCompanies.splice(idx, 1);
        inactiveCompanies.push(comp);
        await logHistory(comp.id, "[ë³´ê´€ì´ë™] ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™ë¨");
        closePopup(); renderList(allCompanies); renderInactiveList(inactiveCompanies);
    }

    async function restoreCompany(id) {
        if(!confirm("ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const comp = inactiveCompanies.find(c => c.id === id);
        if(!comp) return;
        await updateDoc(doc(db, "users", id), { status: 'Active', isActive: true });
        comp.status = 'Active'; comp.isActive = true;
        const idx = inactiveCompanies.indexOf(comp);
        if(idx > -1) inactiveCompanies.splice(idx, 1);
        allCompanies.push(comp);
        await logHistory(id, "ë³´ê´€í•¨ì—ì„œ ë³µêµ¬ë¨");
        renderList(allCompanies); renderInactiveList(inactiveCompanies);
    }

    async function suspendMember(uid) {
        if(confirm("ê¶Œí•œì„ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await updateDoc(doc(db, "users", uid), { status: 'Suspended' });
            loadMemberData(); setTimeout(() => openPopup(currentCompId), 500);
        }
    }

    async function restoreMember(uid) {
        if(confirm("ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await updateDoc(doc(db, "users", uid), { status: 'Active' });
            loadMemberData(); setTimeout(() => openPopup(currentCompId), 500);
        }
    }

    async function saveCompanyInfo() {
        const comp = allCompanies.find(c => c.id === currentCompId) || inactiveCompanies.find(c => c.id === currentCompId);
        try {
            await updateDoc(doc(db, "users", comp.id), {
                managerName: document.getElementById('editRepName').value,
                phone: document.getElementById('editPhone').value,
                email: document.getElementById('editEmail').value,
                bizNum: document.getElementById('editBizNum').value,
                contractStartDate: document.getElementById('dateStart').value,
                contractEndDate: document.getElementById('dateEnd').value,
                autoRenewal: document.getElementById('autoRenewal').checked
            });
            await logHistory(comp.id, "íšŒì‚¬ ì •ë³´ ìˆ˜ì •ë¨");
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); loadMemberData();
        } catch(e) { alert("ì˜¤ë¥˜"); }
    }

    async function manualUpdateLimit() {
        const newLimit = parseInt(document.getElementById('gaugeLimitInput').value);
        if(isNaN(newLimit)) return;
        const comp = allCompanies.find(c => c.id === currentCompId);
        if(confirm(`ìµœëŒ€ ì¸ì›ì„ ${newLimit}ëª…ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            await updateDoc(doc(db, "users", comp.id), { customLimit: newLimit });
            await logHistory(comp.id, `[í•œë„ë³€ê²½] ${newLimit}ëª…ìœ¼ë¡œ ìˆ˜ë™ ë³€ê²½`);
            comp.customLimit = newLimit;
            await checkAndSuspendOverLimit(comp, true);
            updateGauge(comp);
        }
    }

    async function changeCompanyPlan() {
        const newPlan = document.getElementById('pPlanSelect').value;
        const comp = allCompanies.find(c => c.id === currentCompId);
        if(confirm("í”Œëœì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await updateDoc(doc(db, "users", comp.id), { plan: newPlan });
            await logHistory(comp.id, `[í”Œëœë³€ê²½] ${newPlan}ìœ¼ë¡œ ë³€ê²½`);
            const newLimit = PLANS[newPlan].limit;
            await updateDoc(doc(db, "users", comp.id), { customLimit: newLimit });
            comp.customLimit = newLimit; comp.plan = newPlan;
            await checkAndSuspendOverLimit(comp, true);
            updateGauge(comp); renderEmpTable(comp);
        }
    }

    async function runAutoArchiveLogic() {
        if(!confirm("6ê°œì›” ë¯¸í™œë™/ë§Œë£Œ ê¸°ì—…ì„ ìë™ ë³´ê´€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        let count = 0; const today = new Date(); const limit = new Date(); limit.setMonth(today.getMonth() - 6);
        for (const comp of allCompanies) {
            if(!comp.contractEndDate) continue;
            const end = new Date(comp.contractEndDate);
            if(end > limit) continue;
            const last = comp.lastLoginAt ? comp.lastLoginAt.toDate() : (comp.createdAt ? comp.createdAt.toDate() : new Date(0));
            if(last > limit) continue;
            await updateDoc(doc(db, "users", comp.id), { status: 'Archived', isActive: false });
            count++;
        }
        alert(`ì´ ${count}ê°œ ê¸°ì—… ë³´ê´€ ì™„ë£Œ`); loadMemberData();
    }

    function filterList() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allCompanies.filter(c => c.companyName.toLowerCase().includes(val) || c.managerName.toLowerCase().includes(val) || c.bizNum.includes(val));
        renderList(filtered);
    }
    
    function filterInactive() {
        const val = document.getElementById('searchInactive').value.toLowerCase();
        const filtered = inactiveCompanies.filter(c => c.companyName.toLowerCase().includes(val) || c.bizNum.includes(val));
        renderInactiveList(filtered);
    }

    function formatDateTime(date) { return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); }
    function formatDate(date) { return date.toISOString().split('T')[0]; }

    window.autoCalcEndDate = function() {
        const startVal = document.getElementById('dateStart').value;
        if(!startVal) return;
        const date = new Date(startVal);
        date.setFullYear(date.getFullYear() + 1); date.setDate(date.getDate() - 1); 
        document.getElementById('dateEnd').value = date.toISOString().split('T')[0];
    }

    function checkExpiryWarning(dateStr) {
        const box = document.getElementById('expiryWarning');
        if(!dateStr) { box.style.display = 'none'; return; }
        const end = new Date(dateStr);
        const diff = Math.ceil((end - new Date()) / (1000 * 60 * 60 * 24));
        if (diff <= 30 && diff >= 0) { box.style.display = 'block'; box.innerText = `âš ï¸ ë§Œë£Œ ${diff}ì¼ ì „`; } 
        else { box.style.display = 'none'; }
    }

    window.closePopup = function() { document.getElementById('popup').style.display = 'none'; }
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }
    
    window.openEditModal = openEditModal;
    window.openAddStaffModal = function() { document.getElementById('addStaffModal').style.display = 'flex'; };

    // ì „ì—­ ìŠ¤ì½”í”„ ë“±ë¡ (HTML onclick ìš©)
    window.loadMemberData = loadMemberData;
    window.filterInactive = filterInactive;
    window.restoreCompany = restoreCompany;
    window.toggleCompanyStatus = toggleCompanyStatus;
    window.archiveCompany = archiveCompany;
    window.manualUpdateLimit = manualUpdateLimit;
    window.changeCompanyPlan = changeCompanyPlan;
    window.saveCompanyInfo = saveCompanyInfo;
    window.openPopup = openPopup;
    window.closePopup = closePopup;
    window.switchTab = switchTab;
    window.openEditModal = openEditModal;
    window.saveMemberEdit = saveMemberEdit;
    window.handleManualRegister = handleManualRegister;
    window.handleAddStaff = handleAddStaff;
    window.runAutoArchiveLogic = runAutoArchiveLogic;
    window.filterList = filterList;
    window.suspendMember = suspendMember;
    window.restoreMember = restoreMember;
    window.autoCalcEndDate = autoCalcEndDate;

</script>
</body>
</html>