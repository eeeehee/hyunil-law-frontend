<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/hyunil-law-frontend/">
    <title>ê¸°ì—…ìë¬¸ ë§¤ì¶œ ë° CMS ê´€ë¦¬ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input, select { font-family: inherit; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 20px; padding-left: 10px; color: #fff; letter-spacing: 1px; }

        /* ì‚¬ìš©ì í”„ë¡œí•„ ì˜ì—­ */
        .user-profile-area { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.15); }
        .user-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .user-email { font-size: 11px; color: #b0b0b0; margin-bottom: 8px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-master { background: #722ed1; color: #fff; }
        .badge-admin { background: #2c5bf2; color: #fff; }
        .badge-general_manager { background: #52c41a; color: #fff; }
        .badge-lawyer { background: #fa8c16; color: #fff; }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; padding: 40px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e5e5e5; }
        .stat-label { font-size: 12px; color: #888; font-weight: 600; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1a1a1a; }
        .text-green { color: #52c41a; }
        .text-red { color: #ff4d4f; }
        .text-blue { color: #2c5bf2; }

        /* íƒ­ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border-radius: 8px; background: #fff; border: 1px solid #ddd; cursor: pointer; font-weight: 700; color: #555; transition: 0.2s; }
        .tab-btn.active { background: #1a1a2e; color: #fff; border-color: #1a1a2e; }
        .tab-btn:hover:not(.active) { background: #f0f0f0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* íˆ´ë°” */
        .toolbar { background:#fff; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
        .filter-group { display: flex; gap: 8px; align-items: center; }
        .filter-select { height: 36px; border: 1px solid #ddd; border-radius: 6px; padding: 0 10px; outline: none; min-width: 80px; font-size: 13px; }
        .search-input { width: 250px; height: 36px; border: 1px solid #ddd; border-radius: 6px; padding: 0 10px; outline: none; font-size: 13px; }

        .btn-group { display: flex; gap: 5px; }
        .btn-filter { padding: 0 12px; height: 36px; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #555; font-size: 12px; font-weight: 700; cursor: pointer; }
        .btn-filter.active { background: #e6f7ff; color: #096dd9; border-color: #91d5ff; }

        .btn-price-set { background-color: #fff; color: #2c5bf2; border: 1px solid #2c5bf2; padding: 0 15px; border-radius: 6px; font-weight: 700; cursor: pointer; height: 36px; font-size: 13px; }
        .btn-add { background-color: #1a1a2e; color: #fff; border: none; padding: 0 15px; border-radius: 6px; font-weight: 700; cursor: pointer; height: 36px; font-size: 13px; }
        .btn-generate { background-color: #722ed1; color: #fff; border: none; padding: 0 15px; border-radius: 6px; font-weight: 700; cursor: pointer; height: 36px; font-size: 13px; }

        /* í…Œì´ë¸” */
        .section-box { background: #fff; border-radius: 12px; border: 1px solid #e5e5e5; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .admin-table th { background-color: #f9f9f9; color: #555; font-weight: 600; }
        .admin-table tr:hover { background-color: #fafafa; }

        /* ë±ƒì§€ */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; display: inline-block; text-align: center; min-width: 60px; }
        .st-paid { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .st-scheduled { background: #e6f7ff; color: #096dd9; border: 1px solid #91d5ff; }
        .st-overdue { background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; }
        .st-refund { background: #f5f5f5; color: #595959; border: 1px solid #d9d9d9; text-decoration: line-through; }
        .st-cancel { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        .st-basic { background: #f9f0ff; color: #722ed1; border: 1px solid #d3adf7; }
        .st-ent { background: #fff0f6; color: #c41d7f; border: 1px solid #ffadd2; }

        .cycle-badge { font-size: 10px; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        .cy-mon { background: #e6f7ff; color: #096dd9; border: 1px solid #91d5ff; }
        .cy-ann { background: #fff7e6; color: #d46b08; border: 1px solid #ffd591; }

        .btn-sm { padding: 3px 6px; font-size: 11px; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; margin-right: 2px; }
        .btn-pay { border-color: #52c41a; color: #52c41a; } .btn-pay:hover { background: #f6ffed; }
        .btn-overdue { border-color: #ff4d4f; color: #ff4d4f; } .btn-overdue:hover { background: #fff1f0; }
        .btn-cancel { border-color: #d9d9d9; color: #595959; } .btn-cancel:hover { background: #f5f5f5; }
        .btn-edit { border-color: #1a1a2e; color: #1a1a2e; }

        /* ëª¨ë‹¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 480px; background-color: #fff; padding: 30px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; position: relative; }
        .form-label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 13px; color:#555; }
        .input-box { width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 6px; padding: 0 10px; box-sizing: border-box; }
        .btn-submit { width: 100%; height: 45px; background-color: #1a1a2e; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .close-btn { float: right; font-size: 24px; cursor: pointer; margin-top: -10px; }

        /* ê³„ì‚°ê¸° ì˜ì—­ */
        .calc-box { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .calc-total { border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px; font-weight: 700; color: #d32f2f; }

        /* ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ */
        .auto-list {
            position: absolute; top: 65px; left: 0; width: 100%; background: #fff; border: 1px solid #ddd; border-radius: 6px;
            max-height: 150px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .auto-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        .auto-item:hover { background: #f0f7ff; }
        .auto-item .ai-desc { font-size:11px; color:#888; display:block; margin-top:2px; }
        .tag-info { font-size:10px; padding:2px 4px; border-radius:3px; margin-right:5px; font-weight:bold;}
        .tag-cons { background:#e6f7ff; color:#096dd9; }
        .tag-lit { background:#fff0f6; color:#c41d7f; }
        .tag-corp { background:#f6ffed; color:#389e0d; }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="sidebar-brand">ADMINISTRATOR</div>

    <!-- ì‚¬ìš©ì í”„ë¡œí•„ ì˜ì—­ -->
    <div class="user-profile-area">
        <div class="user-name" id="adminUserName">ë¡œë”©ì¤‘...</div>
        <div class="user-email" id="adminUserEmail">...</div>
        <div class="user-role badge-admin" id="adminUserRole">...</div>
    </div>

    <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <div class="logout-btn" id="adminLogoutBtn">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>

    <ul class="sidebar-menu">
        <li>
            <div class="menu-category open active" onclick="toggleAdminMenu('groupCorp', this)">
                <div><span class="menu-icon">ğŸ¢</span> ê¸°ì—…ìë¬¸ì„¼í„°</div>
                <span class="menu-arrow">â–¼</span>
            </div>
            <ul id="groupCorp" class="submenu" style="display:block;">
                <li><a href="/pages/admin/admin.html">ğŸ“ ìë¬¸ ê´€ë¦¬ (ì „ì²´)</a></li>
                <li><a href="/pages/admin/admin_requests.html">ğŸ“© ìš”ì²­ ê´€ë¦¬í•¨</a></li>
                <li><a href="/pages/admin/admin_report.html">ğŸ“Š ë¦¬í¬íŠ¸ ë°œì†¡</a></li>
                <li><a href="/pages/admin/admin_members.html">ğŸ‘¥ íšŒì›/ê¸°ì—… ê´€ë¦¬</a></li>
                <li><a href="/pages/admin/admin_payments.html" class="active">ğŸ’³ ë§¤ì¶œ/CMS ê´€ë¦¬</a></li>
            </ul>
        </li>
        <li>
            <div class="menu-category" onclick="toggleAdminMenu('groupLitigation', this)">
                <div><span class="menu-icon">âš–ï¸</span> ì „ìì†Œì†¡/ì‚¬ê±´</div>
                <span class="menu-arrow">â–¼</span>
            </div>
            <ul id="groupLitigation" class="submenu">
                <li><a href="/pages/public/real_data_upload.html" style="color:#52c41a; font-weight:700;">ğŸ“¥ ì—‘ì…€ ë°ì´í„° ì—…ë¡œë“œ</a></li>
                <li><a href="/pages/admin/admin_litigation.html">ğŸ” ì „ìì†Œì†¡ ë°ì´í„° í™•ì¸</a></li>
                <li><a href="/pages/admin/admin_clients.html">ğŸ“‡ ë‹¹ì‚¬ì(ê³ ê°) ê´€ë¦¬</a></li>
                <li><a href="/pages/admin/admin_submit.html">ğŸ“¤ ë¬¸ì„œ ì œì¶œ/ë°œì†¡</a></li>
                <li><a href="/pages/admin/admin_billing.html" style="color:#d32f2f; font-weight:700;">ğŸ’° ë¹„ìš©/ì²­êµ¬ ê´€ë¦¬</a></li>
                <li><a href="admin_casereport.html">ğŸ“¢ ì‚¬ê±´ ë¦¬í¬íŠ¸ ë°œì†¡</a></li>
            </ul>
        </li>
        <li>
            <div class="menu-category" onclick="toggleAdminMenu('groupSpecial', this)">
                <div><span class="menu-icon">ğŸ“</span> íŒŒì‚°/ì¶”ì‹¬ ì„¼í„°</div>
                <span class="menu-arrow">â–¼</span>
            </div>
            <ul id="groupSpecial" class="submenu">
                <li><a href="/pages/admin/admin_collection_consult.html">ğŸ’° ì±„ê¶Œ ì¶”ì‹¬ ìƒë‹´</a></li>
                <li><a href="/pages/admin/admin_collection.html">ğŸ’° ì±„ê¶Œ ì¶”ì‹¬ ì‚¬ê±´</a></li>
                <li><a href="/pages/admin/admin_pasan_consult.html">ğŸ“‰ íŒŒì‚°/íšŒìƒ ìƒë‹´</a></li>
                <li><a href="/pages/admin/admin_pasan.html">ğŸ“‰ íŒŒì‚°/íšŒìƒ ì‚¬ê±´</a></li>
            </ul>
        </li>
        <li>
            <div class="menu-category" onclick="toggleAdminMenu('groupEtc', this)">
                <div><span class="menu-icon">âš”ï¸</span> ë¶„ìŸ ë° ì¢…ê²°</div>
                <span class="menu-arrow">â–¼</span>
            </div>
            <ul id="groupEtc" class="submenu">
                <li><a href="/pages/admin/admin_conflict.html" style="color:#fa8c16; font-weight:700;">âš”ï¸ ë¶„ìŸ/í˜‘ìƒ (Conflict)</a></li>
                <li><a href="/pages/admin/admin_finished.html" style="color:#999; font-weight:700;">ğŸ ì¢…ê²° ì‚¬ê±´ (Archive)</a></li>
            </ul>
        </li>
        <li class="menu-divider"></li>
        <li><a href="/pages/admin/admin_settings.html" class="menu-link">âš™ï¸ í™˜ê²½ ì„¤ì •</a></li>
        <li class="menu-divider"></li>
        <li><a href="http://www.hyunillaw.com" target="_blank" class="menu-link" style="color:#a6a6b5;">ğŸŒ ë²•ë¬´ê·¸ë£¹ í˜„ì¼ í™ˆí˜ì´ì§€</a></li>
        <li><a href="/index.html" class="menu-link">ğŸ¢ ê¸°ì—…ìë¬¸ í™ˆí˜ì´ì§€</a></li>
        <li><a href="/pages/user/dashboard.html" class="menu-link" style="color:#2c5bf2; font-weight:700;">ğŸ–¥ï¸ ê¸°ì—…ìë¬¸ ì‚¬ìš©ì ëª¨ë“œ</a></li>
    </ul>
</nav>

<script>
    function toggleAdminMenu(id, header) {
        const submenu = document.getElementById(id);
        if(!submenu) return;
        if (submenu.style.display === "block") { submenu.style.display = "none"; header.classList.remove("open"); header.classList.remove("active"); }
        else { submenu.style.display = "block"; header.classList.add("open"); header.classList.add("active"); }
    }
</script>

<main class="main-content">
    <div class="page-header">
        <h2 class="page-title">ê¸°ì—…ìë¬¸ ë§¤ì¶œ ë° CMS ê´€ë¦¬</h2>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">ğŸ’° ìë¬¸ë£Œ ìˆœë§¤ì¶œ (í™˜ë¶ˆì°¨ê°)</div>
            <div class="stat-value text-green" id="filteredRevenue">0 ì›</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ¤ êµ¬ë…(CMS) íšŒì› ìˆ˜</div>
            <div class="stat-value text-blue" id="statContract">0 ê°œì‚¬</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸš¨ í˜„ì¬ ë¯¸ë‚© ì´ì•¡</div>
            <div class="stat-value text-red" id="statOverdue">0 ì›</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ğŸ“… ì´ë²ˆë‹¬ ë°œí–‰ ê±´ìˆ˜</div>
            <div class="stat-value" id="statCount">0 ê±´</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('transactions')">ğŸ“Š ë§¤ì¶œ ì¥ë¶€ (Advisory)</button>
        <button class="tab-btn" onclick="switchTab('contracts')">ğŸ¤ êµ¬ë… íšŒì›/ê³„ì•½ ê´€ë¦¬</button>
    </div>

    <div id="tabTransactions" class="tab-content active">
        <div class="toolbar">
            <div class="filter-group">
                <span style="font-weight:700; margin-right:5px;">ğŸ“…</span>
                <select id="filterYear" class="filter-select" onchange="loadPayments()"></select>
                <select id="filterMonth" class="filter-select" onchange="loadPayments()">
                    <option value="all">ì „ì²´ ì›”</option>
                    <script>for(let i=1;i<=12;i++) document.write(`<option value="${i}">${i}ì›”</option>`);</script>
                </select>

                <div class="btn-group" style="margin-left:10px;">
                    <button class="btn-filter active" onclick="setStatusFilter('all', this)">ì „ì²´</button>
                    <button class="btn-filter" onclick="setStatusFilter('paid', this)">ì™„ë£Œ</button>
                    <button class="btn-filter" onclick="setStatusFilter('scheduled', this)">ì²­êµ¬ë¨</button>
                    <button class="btn-filter" onclick="setStatusFilter('overdue', this)">ë¯¸ë‚©</button>
                    <button class="btn-filter" onclick="setStatusFilter('refund', this)">í™˜ë¶ˆ/ì·¨ì†Œ</button>
                </div>
            </div>

            <div class="filter-group">
                <input type="text" class="search-input" id="searchTrans" placeholder="ê¸°ì—…ëª… ê²€ìƒ‰..." onkeyup="searchPaymentList(this.value)">
                <button class="btn-price-set" onclick="openPriceModal()">ğŸ’° ê¸°ë³¸ë‹¨ê°€ ì„¤ì •</button>
                <button class="btn-add" onclick="openPaymentModal()">+ ë§¤ì¶œ ìˆ˜ë™ ë“±ë¡</button>
            </div>
        </div>

        <div class="section-box">
            <table class="admin-table">
                <thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„ (í”Œëœ)</th><th>ê¸°ì—…ëª…</th><th>ë¹„ê³ </th><th>ê²°ì œìˆ˜ë‹¨</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="transListBody"><tr><td colspan="8" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tabContracts" class="tab-content">
        <div class="toolbar">
            <div class="filter-group">
                <span style="font-weight:700;">CMS íšŒì› ê²€ìƒ‰</span>
                <input type="text" class="search-input" id="searchContract" placeholder="ê¸°ì—…ëª… ê²€ìƒ‰" onkeyup="loadContracts()">
            </div>

            <div class="filter-group">
                <button class="btn-generate" onclick="generateMonthlyBills()">ğŸ“… ì´ë²ˆë‹¬ ì²­êµ¬ì„œ ìƒì„± (1íšŒ)</button>
                <button class="btn-add" onclick="openContractModal()">+ êµ¬ë… íšŒì› ìˆ˜ë™ ë“±ë¡</button>
            </div>
        </div>
        <div class="section-box">
            <table class="admin-table">
                <thead><tr><th>ê¸°ì—…ëª…</th><th>ì‚¬ì—…ìë²ˆí˜¸</th><th>ëŒ€í‘œì</th><th>ì—°ë½ì²˜</th><th>í˜„ì¬ êµ¬ë… í”Œëœ</th><th>ê²°ì œ ì£¼ê¸°</th><th>ì›” ê²°ì œì•¡</th><th>ê³„ì•½ì¢…ë£Œì¼</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="contractListBody"><tr><td colspan="10" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>
    </div>
</main>

<div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('paymentModal')">âœ•</span>
        <h3 style="margin-bottom:20px;">+ ìë¬¸ë£Œ/ë§¤ì¶œ ë“±ë¡</h3>

        <div class="form-group" style="position:relative;">
            <label class="form-label">ëŒ€ìƒ ê¸°ì—… (ì „ì²´ DB ê²€ìƒ‰)</label>
            <input type="text" id="payCompany" class="input-box" onkeyup="searchAllClients(this.value, 'payCompany')" placeholder="ì†Œì†¡ê³ ê°/ìƒë‹´DB/ê¸°ì—…íšŒì› í†µí•©ê²€ìƒ‰">
            <div id="payCompanyAuto" class="auto-list"></div>
        </div>

        <div class="form-group">
            <label class="form-label">êµ¬ë¶„ (Type)</label>
            <select id="payType" class="input-box">
                <option value="advisory">ğŸ¢ ê¸°ì—…ìë¬¸ (1íšŒì„±)</option>
                <option value="Basic">ğŸŒ± Basic (ì •ê¸°)</option>
                <option value="Standard">ğŸŒ¿ Standard (ì •ê¸°)</option>
                <option value="Pro">ğŸŒ³ Pro (ì •ê¸°)</option>
                <option value="Premium">ğŸ‘‘ Premium (ì •ê¸°)</option>
                <option value="Enterprise">ğŸ¢ Enterprise (ë§ì¶¤)</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">ê¸ˆì•¡</label>
            <input type="text" id="payAmount" class="input-box" placeholder="ìˆ«ìë§Œ ì…ë ¥" oninput="formatCurrency(this)">
        </div>

        <div class="form-group">
            <label class="form-label">ê²°ì œ ìˆ˜ë‹¨</label>
            <select id="payMethod" class="input-box">
                <option value="Transfer">ê³„ì¢Œì´ì²´ (ì„¸ê¸ˆê³„ì‚°ì„œ)</option>
                <option value="Card">ì‹ ìš©ì¹´ë“œ</option>
                <option value="Unknown">ë¯¸ì • (ì²­êµ¬ì„œ ë°œì†¡ìš©)</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">ê²°ì œ ìƒíƒœ</label>
            <select id="payStatus" class="input-box" style="font-weight:bold;">
                <option value="scheduled">ğŸ“… ì²­êµ¬ ì˜ˆì • (ë¯¸ë‚©)</option>
                <option value="paid">âœ… ê²°ì œ ì™„ë£Œ</option>
                <option value="overdue">ğŸš¨ ì—°ì²´ ì¤‘</option>
            </select>
        </div>

        <button class="btn-submit" onclick="savePayment()">ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div id="contractModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('contractModal')">âœ•</span>
        <h3 style="margin-bottom:20px;">ğŸ¤ êµ¬ë…(CMS) íšŒì› ì„¤ì •</h3>

        <input type="hidden" id="contractUid">

        <div class="form-group" style="position:relative;">
            <label class="form-label">ëŒ€ìƒ ê¸°ì—…ëª…</label>
            <input type="text" id="contractCompany" class="input-box" placeholder="ê¸°ì—…ëª… ì…ë ¥">
        </div>

        <div class="form-group">
            <label class="form-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
            <input type="text" id="contractBizNum" class="input-box" placeholder="000-00-00000" maxlength="12">
        </div>

        <div class="form-group">
            <label class="form-label">ì ìš© í”Œëœ</label>
            <select id="contractPlan" class="input-box">
                <option value="none">êµ¬ë… í•´ì§€ (None)</option>
                <option value="Basic">Basic (ì›” ì •ê¸°ê²°ì œ)</option>
                <option value="Standard">Standard (ì›” ì •ê¸°ê²°ì œ)</option>
                <option value="Pro">Pro (ì›” ì •ê¸°ê²°ì œ)</option>
                <option value="Premium">Premium (ì›” ì •ê¸°ê²°ì œ)</option>
                <option value="Enterprise">Enterprise (ê¸°ì—… ë§ì¶¤)</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">ê²°ì œ ì£¼ê¸° (Billing Cycle)</label>
            <select id="contractCycle" class="input-box">
                <option value="monthly">ğŸ“… ë§¤ì›” (ìë™ ì²­êµ¬ì„œ ìƒì„±)</option>
                <option value="annual">ğŸ—“ï¸ ì—°ë‚©/ì„ ë‚© (ìë™ ìƒì„± ì•ˆí•¨)</option>
            </select>
            <p style="font-size:11px; color:#888; margin-top:3px;">* ì—°ë‚© ì„ íƒ ì‹œ ë§¤ì›” ì²­êµ¬ì„œê°€ ìë™ ìƒì„±ë˜ì§€ ì•Šìœ¼ë©°, ë§¤ì¶œ ì¥ë¶€ì— ìˆ˜ë™ìœ¼ë¡œ 1ë…„ì¹˜ ê¸ˆì•¡ì„ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="form-group">
            <label class="form-label">ì›” ê²°ì œ ê¸ˆì•¡ (ì‚¬ìš©ì ì§€ì •)</label>
            <input type="text" id="contractCost" class="input-box" placeholder="ë¹„ì›Œë‘˜ ì‹œ ê¸°ë³¸ë‹¨ê°€ ì ìš©" oninput="formatCurrency(this)">
            <p style="font-size:11px; color:#888; margin-top:3px;">* EnterpriseëŠ” í•„ìˆ˜ ì…ë ¥, ê·¸ ì™¸ í”Œëœë„ ì…ë ¥ ì‹œ ì´ ê¸ˆì•¡ì´ ìš°ì„  ì ìš©ë¨</p>
        </div>

        <div class="form-group">
            <label class="form-label">ê³„ì•½ ì¢…ë£Œì¼ (ì„ íƒ)</label>
            <input type="date" id="contractEnd" class="input-box">
        </div>

        <button class="btn-submit" onclick="saveContract()">ì„¤ì • ì €ì¥</button>
    </div>
</div>

<div id="refundConfirmModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('refundConfirmModal')">âœ•</span>
        <h3 style="margin-bottom:20px;">ğŸ’¸ í™˜ë¶ˆ ì²˜ë¦¬ (ë§¤ì¶œì°¨ê°)</h3>
        <input type="hidden" id="rcDocId">
        <input type="hidden" id="rcOriginalAmt">

        <div class="form-group">
            <label class="form-label">ê¸°ì¡´ ê²°ì œ ê¸ˆì•¡</label>
            <input type="text" id="rcDisplayAmt" class="input-box" readonly style="background:#f9f9f9;">
        </div>

        <div class="form-group">
            <label class="form-label">ì‹¤ì œ í™˜ë¶ˆí•´ì¤„ ê¸ˆì•¡ (ì…ë ¥)</label>
            <input type="text" id="rcAmount" class="input-box" oninput="formatCurrency(this)" placeholder="ì˜ˆ: 50,000" style="color:#d32f2f; font-weight:bold;">
            <p style="font-size:11px; color:#888; margin-top:5px;">* ì´ ê¸ˆì•¡ë§Œí¼ë§Œ ë§¤ì¶œì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤.</p>
        </div>

        <button class="btn-submit" onclick="executeRefund()">í™˜ë¶ˆ ì²˜ë¦¬ ì™„ë£Œ</button>
    </div>
</div>

<div id="priceModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('priceModal')">âœ•</span>
        <h3 style="margin-bottom:20px;">ğŸ’° ê¸°ë³¸ ì„œë¹„ìŠ¤ ë‹¨ê°€ ì„¤ì •</h3>
        <div class="form-group"><label class="form-label">âš¡ ë‹¨ê¸° ìë¬¸ (1íšŒ)</label><input type="text" id="priceOneTime" class="input-box" oninput="formatCurrency(this)"></div>
        <div class="form-group"><label class="form-label">ğŸŒ± Basic í”Œëœ</label><input type="text" id="priceBasic" class="input-box" oninput="formatCurrency(this)"></div>
        <div class="form-group"><label class="form-label">ğŸŒ¿ Standard í”Œëœ</label><input type="text" id="priceStandard" class="input-box" oninput="formatCurrency(this)"></div>
        <div class="form-group"><label class="form-label">ğŸŒ³ Pro í”Œëœ</label><input type="text" id="pricePro" class="input-box" oninput="formatCurrency(this)"></div>
        <div class="form-group"><label class="form-label">ğŸ‘‘ Premium í”Œëœ</label><input type="text" id="pricePremium" class="input-box" oninput="formatCurrency(this)"></div>
        <button class="btn-submit" onclick="savePriceSettings()">ë‹¨ê°€ ì„¤ì • ì €ì¥</button>
    </div>
</div>


<script type="module">
    const API_BASE = 'http://localhost:3000/api';
    const token = localStorage.getItem('auth_token');

    let allPayments = [];
    let allClientsCache = [];
    let currentStatusFilter = 'all';
    let servicePrices = {};
    let editingUserId = null;

    // ì¸ì¦ í™•ì¸
    if (!token) {
        location.href = "/pages/public/login.html";
    }

    // ============================================
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ë° ë¡œê·¸ì•„ì›ƒ
    // ============================================
    async function loadAdminUserInfo() {
        try {
            const response = await fetch(`${API_BASE}/users/me`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            const user = await response.json();

            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('adminUserName').textContent = user.managerName || user.manager_name || user.email || 'ê´€ë¦¬ì';
            document.getElementById('adminUserEmail').textContent = user.email || '';

            // ì—­í•  ë°°ì§€
            const roleElement = document.getElementById('adminUserRole');
            const roleMap = {
                'master': { label: 'MASTER', class: 'badge-master' },
                'admin': { label: 'ADMIN', class: 'badge-admin' },
                'general_manager': { label: 'GENERAL', class: 'badge-general_manager' },
                'lawyer': { label: 'LAWYER', class: 'badge-lawyer' }
            };

            const roleInfo = roleMap[user.role] || { label: user.role?.toUpperCase() || 'USER', class: 'badge-admin' };
            roleElement.textContent = roleInfo.label;
            roleElement.className = `user-role ${roleInfo.class}`;

        } catch (error) {
            console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('adminUserName').textContent = 'ê´€ë¦¬ì';
            document.getElementById('adminUserEmail').textContent = '';
            document.getElementById('adminUserRole').textContent = 'ADMIN';
        }
    }

    // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
    document.getElementById('adminLogoutBtn').addEventListener('click', function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('current_user');
            location.href = '/pages/public/login.html';
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    loadAdminUserInfo();

    // API í˜¸ì¶œ í—¬í¼
    async function apiCall(endpoint, options = {}) {
        console.log(`ğŸ”Œ [API] í˜¸ì¶œ: ${options.method || 'GET'} ${endpoint}`);

        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                ...options.headers
            }
        });

        console.log(`ğŸ“¡ [API] ì‘ë‹µ: ${response.status} ${response.statusText}`);

        if (!response.ok) {
            console.error(`âŒ [API] ì˜¤ë¥˜ ì‘ë‹µ:`, response);
            if (response.status === 401 || response.status === 403) {
                alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                location.href = "/pages/public/login.html";
                throw new Error('Unauthorized');
            }
            try {
                const error = await response.json();
                throw new Error(error.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } catch(jsonError) {
                console.error('âŒ [API] JSON íŒŒì‹± ì˜¤ë¥˜:', jsonError);
                throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
            }
        }

        console.log('ğŸ“¥ [API] ì‘ë‹µ ë³¸ë¬¸ íŒŒì‹± ì¤‘...');
        try {
            // âœ… ë¹ˆ ë°”ë””(ì˜ˆ: 200 OK but no content) ëŒ€ì‘
            if (response.status === 204) return null;

            const ct = (response.headers.get('content-type') || '').toLowerCase();
            const text = await response.text();

            // ë°”ë””ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ null ë°˜í™˜ (ì €ì¥/ìˆ˜ì • APIì—ì„œ í”í•¨)
            if (!text) return null;

            // JSONì´ë©´ íŒŒì‹±, ì•„ë‹ˆë©´ ë¬¸ìì—´ë¡œ ë°˜í™˜
            if (ct.includes('application/json')) {
                const data = JSON.parse(text);
                console.log('âœ… [API] ì‘ë‹µ ë°ì´í„°:', data);
                return data;
            }

            // ì¼ë¶€ ì—”ë“œí¬ì¸íŠ¸ê°€ "OK" ê°™ì€ í…ìŠ¤íŠ¸ë¥¼ ì¤„ ìˆ˜ë„ ìˆìŒ
            console.log('âœ… [API] í…ìŠ¤íŠ¸ ì‘ë‹µ:', text);
            return { ok: true, text };
        } catch (parseError) {
            console.error('âŒ [API] ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', parseError);
            throw new Error('ì„œë²„ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // -------------------------------------------------------------------------
    // 1. ì´ˆê¸°í™” ë° í†µí•© ê²€ìƒ‰
    // -------------------------------------------------------------------------
    async function init() {
        initDateFilters();
        await loadPriceSettings();
        await loadAllClients();
        await loadPayments();
        await loadContracts();
    }

    async function loadAllClients() {
        try {
            const data = await apiCall('/payments-admin/search-clients');
            allClientsCache = data.clients || [];
        } catch(e) {
            console.error("Client load error:", e);
        }
    }

    window.searchAllClients = function(val, targetId) {
        let listId = targetId === 'payCompany' ? 'payCompanyAuto' : 'contractCompanyAuto';
        const list = document.getElementById(listId);
        list.innerHTML = "";

        if(!val || val.length < 1) { list.style.display = 'none'; return; }

        const filtered = allClientsCache.filter(c => c.name.includes(val));
        if(filtered.length > 0) {
            list.style.display = 'block';
            filtered.forEach(c => {
                const div = document.createElement('div');
                div.className = 'auto-item';

                let tagClass = 'tag-corp';
                if(c.type === 'lit') tagClass = 'tag-lit';
                if(c.type === 'cons') tagClass = 'tag-cons';

                div.innerHTML = `<span class="tag-info ${tagClass}">${c.info}</span><span class="ai-name">${c.name}</span>`;
                div.onclick = () => {
                    document.getElementById(targetId).value = c.name;
                    list.style.display = 'none';
                };
                list.appendChild(div);
            });
        } else { list.style.display = 'none'; }
    }

    // -------------------------------------------------------------------------
    // 2. ë§¤ì¶œ ì¥ë¶€ ë¡œì§
    // -------------------------------------------------------------------------
    async function loadPayments() {
        const yearEl = document.getElementById('filterYear');
        const monthEl = document.getElementById('filterMonth');
        const filterY = yearEl ? yearEl.value : 'all';
        const filterM = monthEl ? monthEl.value : 'all';
        const searchVal = document.getElementById('searchTrans')?.value || '';

        try {
            const params = new URLSearchParams();
            if (filterY !== 'all') params.append('year', filterY);
            if (filterM !== 'all') params.append('month', filterM);
            if (currentStatusFilter !== 'all') params.append('status', currentStatusFilter);
            if (searchVal) params.append('search', searchVal);

            const data = await apiCall(`/payments-admin?${params.toString()}`);
            allPayments = data.payments || [];

            // í†µê³„ ì¡°íšŒ
            const statsParams = new URLSearchParams();
            if (filterY !== 'all') statsParams.append('year', filterY);
            if (filterM !== 'all') statsParams.append('month', filterM);

            const stats = await apiCall(`/payments-admin/stats?${statsParams.toString()}`);

            document.getElementById('filteredRevenue').innerText = (stats.revenue || 0).toLocaleString() + " ì›";
            document.getElementById('statOverdue').innerText = (stats.overdueAmount || 0).toLocaleString() + " ì›";
            document.getElementById('statCount').innerText = (stats.totalCount || 0) + " ê±´";
            document.getElementById('statContract').innerText = (stats.contractCount || 0) + " ê°œì‚¬";

            renderPaymentTable(allPayments);
        } catch (e) {
            console.error("Load Error:", e);
            alert('ë§¤ì¶œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function renderPaymentTable(data) {
        const tbody = document.getElementById('transListBody');

        let html = "";
        if(data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; color:#888;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        data.forEach(p => {
            let dateStr = new Date(p.date).toLocaleDateString('ko-KR');
            const amt = Number(p.amount||0).toLocaleString();

            let typeBadge = `<span style="font-size:11px; background:#eee; padding:2px 6px; border-radius:4px;">ì¼ë°˜ìë¬¸</span>`;
            if(p.plan === 'Enterprise') typeBadge = `<span class="status-badge st-ent">Enterprise</span>`;
            else if(['Basic','Standard','Pro','Premium'].includes(p.plan || p.type)) {
                typeBadge = `<span style="background:#f9f0ff; color:#722ed1; font-weight:700; padding:2px 6px; border-radius:4px;">${p.plan||p.type}</span>`;
            }

            let statusBadge = "";
            let actionBtn = "";

            if(p.status === 'paid') {
                statusBadge = `<span class="status-badge st-paid">ì™„ë£Œ</span>`;
                actionBtn = `<button class="btn-sm" onclick="openRefundConfirmModal('${p.docId}', ${p.amount})">í™˜ë¶ˆ/ì·¨ì†Œ</button>`;
            } else if(p.status === 'scheduled') {
                statusBadge = `<span class="status-badge st-scheduled">ì²­êµ¬ë¨</span>`;
                actionBtn = `
                    <button class="btn-sm btn-pay" onclick="updateStatus('${p.docId}', 'paid')">ì…ê¸ˆí™•ì¸</button>
                    <button class="btn-sm btn-overdue" onclick="updateStatus('${p.docId}', 'overdue')">ë¯¸ë‚©</button>
                    <button class="btn-sm btn-cancel" onclick="updateStatus('${p.docId}', 'cancelled')">ì·¨ì†Œ</button>
                `;
            } else if(p.status === 'overdue') {
                statusBadge = `<span class="status-badge st-overdue">ë¯¸ë‚©</span>`;
                actionBtn = `<button class="btn-sm btn-pay" onclick="updateStatus('${p.docId}', 'paid')">ì…ê¸ˆí™•ì¸</button>`;
            } else if(p.status === 'refund') {
                statusBadge = `<span class="status-badge st-refund">í™˜ë¶ˆë¨</span>`;
            } else if(p.status === 'cancelled') {
                statusBadge = `<span class="status-badge st-cancel">ì·¨ì†Œë¨</span>`;
            }

            html += `<tr>
                <td>${dateStr}</td>
                <td>${typeBadge}</td>
                <td style="font-weight:600;">${p.companyName || '(ë¯¸ì§€ì •)'}</td>
                <td style="color:#666;">${p.note || '-'}</td>
                <td>${p.method || '-'}</td>
                <td style="text-align:right; font-weight:700; ${p.status==='refund' || p.status==='cancelled'?'text-decoration:line-through; color:#999;':''}">${amt}ì›</td>
                <td>${statusBadge}</td>
                <td>${actionBtn}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    window.searchPaymentList = function(val) { loadPayments(); }

    window.setStatusFilter = function(status, btn) {
        currentStatusFilter = status;
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadPayments();
    }

    // -------------------------------------------------------------------------
    // 3. êµ¬ë… íšŒì› ê´€ë¦¬
    // -------------------------------------------------------------------------
    async function loadContracts() {
        const tbody = document.getElementById('contractListBody');
        const searchVal = document.getElementById('searchContract')?.value || '';

        try {
            const params = new URLSearchParams();
            if (searchVal) params.append('search', searchVal);

            const data = await apiCall(`/payments-admin/contracts?${params.toString()}`);
            const contracts = data.contracts || [];

            let html = "";

            if(contracts.length === 0) {
                html = `<tr><td colspan="10" style="text-align:center; padding:30px;">êµ¬ë… íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                contracts.forEach(u => {
                    let costDisplay = u.customCost ? `<span style="font-weight:bold; color:#096dd9;">${Number(u.customCost).toLocaleString()}ì›</span>` : `<span style="color:#888;">ê¸°ë³¸ë‹¨ê°€</span>`;
                    let endDate = u.contractEndDate ? new Date(u.contractEndDate).toLocaleDateString('ko-KR') : '-';
                    let bizNum = u.bizNum || '-';

                    let cycleBadge = `<span class="cycle-badge cy-mon">ë§¤ì›”</span>`;
                    if(u.billingCycle === 'annual') cycleBadge = `<span class="cycle-badge cy-ann">ì—°ë‚©(ì„ ë‚©)</span>`;

                    html += `<tr>
                        <td style="font-weight:bold;">${u.companyName}</td>
                        <td style="font-size:12px; color:#555;">${bizNum}</td>
                        <td>${u.ownerName || '-'}</td>
                        <td>${u.phone || '-'}</td>
                        <td><span class="status-badge st-basic">${u.plan}</span></td>
                        <td>${cycleBadge}</td>
                        <td>${costDisplay}</td>
                        <td>${endDate}</td>
                        <td><span style="color:#2c5bf2; font-weight:700;">êµ¬ë…ì¤‘</span></td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="openContractModal('${u.uid}', '${u.companyName}', '${u.plan}', '${u.customCost||''}', '${u.contractEndDate||''}', '${u.billingCycle||'monthly'}', '${bizNum}')">ìˆ˜ì •</button>
                            <button class="btn-sm btn-cancel" onclick="cancelSubscription('${u.uid}', '${u.companyName}')">í•´ì§€/í™˜ë¶ˆ</button>
                        </td>
                    </tr>`;
                });
            }

            tbody.innerHTML = html;
        } catch(e) {
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:30px; color:#ff4d4f;">ì˜¤ë¥˜: ${e.message}</td></tr>`;
        }
    }

    window.generateMonthlyBills = async function() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth() + 1;

        if(!confirm(`${y}ë…„ ${m}ì›” ì •ê¸°ê²°ì œ ì²­êµ¬ì„œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ë¯¸ ìƒì„±ëœ ê¸°ì—… ë° 'ì—°ë‚©' íšŒì›ì€ ì œì™¸ë©ë‹ˆë‹¤)`)) return;

        try {
            const data = await apiCall('/payments-admin/generate-monthly', { method: 'POST' });
            alert(`ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹ ê·œ: ${data.generated}ê±´`);
            loadPayments();
        } catch(e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    }

    // -------------------------------------------------------------------------
    // 4. ëª¨ë‹¬ ë° ì €ì¥ ë¡œì§
    // -------------------------------------------------------------------------
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        if(tabName === 'transactions') { document.getElementById('tabTransactions').classList.add('active'); loadPayments(); }
        else if(tabName === 'contracts') { document.getElementById('tabContracts').classList.add('active'); loadContracts(); }
    }

    window.openPaymentModal = function() {
        document.getElementById('payCompany').value = '';
        document.getElementById('payAmount').value = '';
        document.getElementById('payType').value = 'advisory';
        document.getElementById('payMethod').value = 'Transfer';
        document.getElementById('payStatus').value = 'scheduled';
        document.getElementById('paymentModal').style.display = 'block';
    }

    window.savePayment = async function() {
        const company = document.getElementById('payCompany').value;
        const type = document.getElementById('payType').value;
        const amount = Number(document.getElementById('payAmount').value.replace(/,/g,''));
        const status = document.getElementById('payStatus').value;
        const method = document.getElementById('payMethod').value;

        if(!company || !amount) { alert("ê¸°ì—…ëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

        try {
            await apiCall('/payments-admin', {
                method: 'POST',
                body: JSON.stringify({
                    companyName: company,
                    type: type === 'advisory' ? 'advisory' : 'subscription',
                    plan: type,
                    amount: amount,
                    method: method,
                    status: status,
                    note: 'ìˆ˜ë™ ë“±ë¡'
                })
            });

            alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeModal('paymentModal');
            loadPayments();
        } catch(e) { alert("ì‹¤íŒ¨: " + e.message); }
    }


    window.saveContract = async function() {
        const uid = document.getElementById('contractUid').value;
        const name = document.getElementById('contractCompany').value;
        const bizNum = document.getElementById('contractBizNum').value;
        const plan = document.getElementById('contractPlan').value;
        const cycle = document.getElementById('contractCycle').value;
        const costStr = document.getElementById('contractCost').value.replace(/,/g,'');
        const cost = costStr ? Number(costStr) : null;
        const end = document.getElementById('contractEnd').value;

        if(!uid) { alert("íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        if(!name) { alert("ê¸°ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

        if(plan === 'Enterprise' && cycle === 'monthly' && !cost) {
            alert("Enterprise í”Œëœ(ì›”ë‚©)ì€ ì›” ê²°ì œ ê¸ˆì•¡ì„ ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }

        try {
            await apiCall(`/payments-admin/contracts/${uid}`, {
                method: 'PUT',
                body: JSON.stringify({
                    plan: plan,
                    customCost: cost,
                    contractEndDate: end || null,
                    billingCycle: cycle,
                    bizNum: bizNum || null
                })
            });

            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeModal('contractModal');
            loadContracts();
        } catch(e) { alert("ì˜¤ë¥˜: "+e.message); }
    }

    window.updateStatus = async function(docId, newStatus) {
        if(!confirm("ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            await apiCall(`/payments-admin/${docId}`, {
                method: 'PUT',
                body: JSON.stringify({ status: newStatus })
            });
            loadPayments();
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    }

    window.openRefundConfirmModal = function(id, amount) {
        document.getElementById('refundConfirmModal').style.display = 'block';
        document.getElementById('rcDocId').value = id;
        document.getElementById('rcOriginalAmt').value = amount;
        document.getElementById('rcDisplayAmt').value = Number(amount).toLocaleString() + "ì›";
        document.getElementById('rcAmount').value = '';
    }

    window.executeRefund = async function() {
        const id = document.getElementById('rcDocId').value;
        const realRefundStr = document.getElementById('rcAmount').value.replace(/,/g, '');
        const realRefund = realRefundStr ? Number(realRefundStr) : 0;

        if(!realRefund) { alert("í™˜ë¶ˆ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        if(!confirm(`ì‹¤ì œ í™˜ë¶ˆì•¡ ${realRefund.toLocaleString()}ì›ìœ¼ë¡œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në§¤ì¶œì€ (ì›ê¸ˆ - ${realRefund.toLocaleString()})ì›ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.`)) return;

        try {
            await apiCall(`/payments-admin/${id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    status: 'refund',
                    refundAmount: realRefund
                })
            });

            alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeModal('refundConfirmModal');
            loadPayments();
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    }

    // -------------------------------------------------------------------------
    // 5. ì„œë¹„ìŠ¤ ë‹¨ê°€ ì„¤ì •
    // -------------------------------------------------------------------------
    async function loadPriceSettings() {
        try {
            const data = await apiCall('/payments-admin/service-prices');
            servicePrices = {};

            // âœ… ì„œë²„ ì‘ë‹µ í˜•ì‹ í˜¸í™˜:
            // 1) { prices: [{type, price}, ...] }
            // 2) { prices: { oneTime: 110000, Basic: 550000, ... } }
            // 3) { prices: { onetime: 110000, basic: 550000, ... } }
            const prices = data && data.prices ? data.prices : null;

            if (Array.isArray(prices)) {
                prices.forEach(p => {
                    if (!p) return;
                    servicePrices[p.type] = p.price;
                });
            } else if (prices && typeof prices === 'object') {
                Object.entries(prices).forEach(([k, v]) => {
                    servicePrices[k] = v;
                    // ëŒ€ì†Œë¬¸ì í˜¼ì¬ ëŒ€ë¹„
                    servicePrices[String(k).toLowerCase()] = v;
                });
            }

            const vOneTime = servicePrices.oneTime ?? servicePrices.onetime ?? 110000;
            const vBasic = servicePrices.Basic ?? servicePrices.basic ?? 110000;
            const vStandard = servicePrices.Standard ?? servicePrices.standard ?? 330000;
            const vPro = servicePrices.Pro ?? servicePrices.pro ?? 550000;
            const vPremium = servicePrices.Premium ?? servicePrices.premium ?? 990000;

            document.getElementById('priceOneTime').value = Number(vOneTime || 0).toLocaleString();
            document.getElementById('priceBasic').value = Number(vBasic || 0).toLocaleString();
            document.getElementById('priceStandard').value = Number(vStandard || 0).toLocaleString();
            document.getElementById('pricePro').value = Number(vPro || 0).toLocaleString();
            document.getElementById('pricePremium').value = Number(vPremium || 0).toLocaleString();
        } catch(e) {
            console.error("Price load error:", e);
        }
    }

    window.openPriceModal = function() {
        document.getElementById('priceModal').style.display = 'block';
    }

    window.savePriceSettings = async function() {
        const prices = {
            oneTime: Number(document.getElementById('priceOneTime').value.replace(/,/g,'')),
            Basic: Number(document.getElementById('priceBasic').value.replace(/,/g,'')),
            Standard: Number(document.getElementById('priceStandard').value.replace(/,/g,'')),
            Pro: Number(document.getElementById('pricePro').value.replace(/,/g,'')),
            Premium: Number(document.getElementById('pricePremium').value.replace(/,/g,''))
        };

        console.log('ğŸ“ [ë‹¨ê°€ ì„¤ì •] ì €ì¥ ì‹œì‘');
        console.log('ì „ì†¡í•  ë°ì´í„°:', prices);

        try {
            console.log('ğŸš€ [ë‹¨ê°€ ì„¤ì •] API í˜¸ì¶œ ì¤‘...');

            const result = await apiCall('/payments-admin/service-prices', {
                method: 'PUT',
                body: JSON.stringify({ prices })
            });

            console.log('âœ… [ë‹¨ê°€ ì„¤ì •] API ì‘ë‹µ:', result);

            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeModal('priceModal');
            await loadPriceSettings();
        } catch(e) {
            console.error('âŒ [ë‹¨ê°€ ì„¤ì •] ì˜¤ë¥˜ ë°œìƒ:', e);
            console.error('ì˜¤ë¥˜ ìƒì„¸:', e.message);
            console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', e.stack);
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    }

    // -------------------------------------------------------------------------
    // 6. ìœ í‹¸ë¦¬í‹°
    // -------------------------------------------------------------------------
    function initDateFilters() {
        const y = document.getElementById('filterYear');
        const cy = new Date().getFullYear();
        y.innerHTML = `<option value="all">ì „ì²´ ì—°ë„</option>`;
        for(let i=cy; i>=2023; i--) y.innerHTML += `<option value="${i}">${i}ë…„</option>`;
    }

    window.closeModal = function(id) {
        document.getElementById(id).style.display = 'none';
    }

    window.formatCurrency = function(input) {
        let val = input.value.replace(/[^0-9]/g, '');
        input.value = val ? Number(val).toLocaleString() : '';
    }

    // -------------------------------------------------------------------------
    // 7. êµ¬ë… íšŒì› ë“±ë¡/ìˆ˜ì •
    // -------------------------------------------------------------------------
    window.openContractModal = function(uid, name, plan, cost, end, cycle, bizNum) {
        editingUserId = uid || null;
        const companyInput = document.getElementById('contractCompany');

        companyInput.value = name || '';
        document.getElementById('contractBizNum').value = bizNum || '';
        document.getElementById('contractPlan').value = plan || 'none';
        document.getElementById('contractCycle').value = cycle || 'monthly';
        document.getElementById('contractCost').value = cost ? Number(cost).toLocaleString() : '';
        document.getElementById('contractEnd').value = end || '';

        // ì‹ ê·œ ë“±ë¡ ì‹œ: íšŒì‚¬ëª… ì…ë ¥ ê°€ëŠ¥, ìˆ˜ì • ì‹œ: ì…ë ¥ ë¶ˆê°€
        if (uid) {
            companyInput.readOnly = true;
            companyInput.style.background = '#f9f9f9';
        } else {
            companyInput.readOnly = false;
            companyInput.style.background = '#fff';
        }

        document.getElementById('contractModal').style.display = 'block';
    }

    window.saveContract = async function() {
        const name = document.getElementById('contractCompany').value;
        const bizNum = document.getElementById('contractBizNum').value;
        const plan = document.getElementById('contractPlan').value;
        const cycle = document.getElementById('contractCycle').value;
        const costStr = document.getElementById('contractCost').value.replace(/,/g, '');
        const cost = costStr ? Number(costStr) : null;
        const end = document.getElementById('contractEnd').value;

        if (!name) {
            alert("ê¸°ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        if (plan === 'Enterprise' && cycle === 'monthly' && !cost) {
            alert("Enterprise í”Œëœ(ì›”ë‚©)ì€ ì›” ê²°ì œ ê¸ˆì•¡ì„ ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }

        try {
            if (editingUserId) {
                // ê¸°ì¡´ íšŒì› ìˆ˜ì •
                await apiCall(`/payments-admin/contracts/${editingUserId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        plan: plan,
                        customCost: cost,
                        contractEndDate: end,
                        billingCycle: cycle,
                        bizNum: bizNum
                    })
                });
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                // ì‹ ê·œ ë“±ë¡ - users í…Œì´ë¸”ì—ì„œ ê¸°ì—…ëª…ìœ¼ë¡œ ê²€ìƒ‰
                const usersData = await apiCall('/users');
                const users = usersData.users || [];
                const foundUser = users.find(u => u.company_name === name);

                if (!foundUser) {
                    alert("í•´ë‹¹ ê¸°ì—…ëª…ìœ¼ë¡œ ë“±ë¡ëœ íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ê¸°ì—…íšŒì›ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // ì°¾ì€ ìœ ì € ì—…ë°ì´íŠ¸
                await apiCall(`/payments-admin/contracts/${foundUser.uid}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        plan: plan,
                        customCost: cost,
                        contractEndDate: end,
                        billingCycle: cycle,
                        bizNum: bizNum
                    })
                });
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            closeModal('contractModal');
            loadContracts();
        } catch(e) {
            alert("ì˜¤ë¥˜: " + e.message);
        }
    }

    // -------------------------------------------------------------------------
    // 8. êµ¬ë… í•´ì§€/í™˜ë¶ˆ
    // -------------------------------------------------------------------------
    window.cancelSubscription = async function(uid, companyName) {
        if (!confirm(`${companyName}ì˜ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•´ì§€ ì‹œ ë‹¤ìŒê³¼ ê°™ì´ ì²˜ë¦¬ë©ë‹ˆë‹¤:\n- êµ¬ë… í”Œëœì´ 'none'ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤\n- ì´í›„ ìë™ ì²­êµ¬ì„œê°€ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n- ê¸°ì¡´ ë¯¸ë‚© ì²­êµ¬ì„œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤\n\ní™˜ë¶ˆì´ í•„ìš”í•œ ê²½ìš° ë§¤ì¶œ ì¥ë¶€ì—ì„œ ë³„ë„ë¡œ í™˜ë¶ˆ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.`)) {
            return;
        }

        try {
            await apiCall(`/payments-admin/contracts/${uid}`, {
                method: 'PUT',
                body: JSON.stringify({
                    plan: 'none'
                })
            });

            alert("êµ¬ë…ì´ í•´ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadContracts();
        } catch(e) {
            alert("ì˜¤ë¥˜: " + e.message);
        }
    }

    // ì´ˆê¸°í™”
    init();
</script>
</body>
</html>
