<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ì—…ìë¬¸ í†µí•© ê´€ë¦¬ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; overflow-x:hidden; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        textarea { font-family: inherit; resize: vertical; }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 20px; padding-left: 10px; color: #fff; letter-spacing: 1px; }

        /* ì‚¬ìš©ì í”„ë¡œí•„ ì˜ì—­ */
        .user-profile-area { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.15); }
        .user-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .user-email { font-size: 11px; color: #b0b0b0; margin-bottom: 8px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-master { background: #722ed1; color: #fff; }
        .badge-admin { background: #2c5bf2; color: #fff; }
        .badge-general_manager { background: #52c41a; color: #fff; }
        .badge-lawyer { background: #fa8c16; color: #fff; }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; margin-right: 320px; padding: 40px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; }

        /* ê²€ìƒ‰ì°½ */
        .search-box { background: #fff; border: 1px solid #ddd; padding: 10px 15px; border-radius: 8px; width: 100%; margin-bottom: 20px; display:flex; align-items:center; }
        .search-input { border: none; outline: none; width: 100%; font-size: 14px; margin-left: 10px; }

        /* íšŒì‚¬ ê·¸ë£¹ ë°•ìŠ¤ */
        .company-group { background: #fff; border-radius: 12px; border: 1px solid #e5e5e5; margin-bottom: 20px; overflow: hidden; transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .company-group.highlight { border: 2px solid #ff4d4f; box-shadow: 0 4px 15px rgba(255, 77, 79, 0.15); }

        .company-header {
            background: #fff; padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid transparent; transition: 0.2s;
        }
        .company-header:hover { background-color: #f9f9f9; }
        .company-header.active { background-color: #f0f7ff; border-bottom: 1px solid #cce5ff; }

        .comp-left { display: flex; flex-direction: column; gap: 5px; }
        .comp-row-1 { display: flex; align-items: center; gap: 8px; }
        .comp-name { font-size: 18px; font-weight: 800; color: #1a1a1a; }
        .comp-biz { font-size: 12px; color: #888; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

        /* ìš”ê¸ˆì œ ì…€ë ‰íŠ¸ */
        .plan-select {
            font-size: 11px; padding: 3px 8px; border-radius: 12px; font-weight: 700; border: 1px solid #ddd;
            appearance: none; cursor: pointer; outline: none; text-align: center;
        }
        .plan-select:hover { opacity: 0.8; }
        .plan-basic { background: #f6ffed; color: #389e0d; border-color: #b7eb8f; }
        .plan-std { background: #e6f7ff; color: #096dd9; border-color: #91d5ff; }
        .plan-pro { background: #f9f0ff; color: #722ed1; border-color: #d3adf7; }
        .plan-prem { background: #fff0f6; color: #c41d7f; border-color: #ffadd2; }
        .plan-ent { background: #391085; color: #fff; border-color: #391085; }
        .plan-none { background: #f5f5f5; color: #999; border-color: #ddd; }

        /* ì‚¬ìš©ëŸ‰ ê²Œì´ì§€ */
        .quota-row { display: flex; gap: 10px; margin-top: 8px; align-items: center;}
        .quota-box { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #555; background: #fafafa; padding: 4px 10px; border-radius: 6px; border: 1px solid #eee; }
        .quota-val { font-weight: 800; color: #1a1a1a; }
        .q-label { font-weight: 700; color: #888; }

        .btn-deduct { background: #fff; border: 1px solid #ddd; color: #555; font-size: 11px; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-weight: 700; transition:0.2s; }
        .btn-deduct:hover { background: #f0f0f0; }
        .btn-phone-log { background: #1a1a2e; border: 1px solid #1a1a2e; color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 3px; }

        .comp-right { display: flex; gap: 8px; align-items: center; }
        .count-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .cb-waiting { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; animation: pulse 2s infinite; }
        .cb-analyzing { background: #e6f7ff; color: #096dd9; border: 1px solid #91d5ff; animation: pulse 2s infinite; }
        .cb-progress { background: #f9f0ff; color: #722ed1; border: 1px solid #d3adf7; animation: pulse 2s infinite; }
        .cb-done { background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; opacity: 0.8; }

        /* [NEW] í”Œëœ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; border: 1px solid #ddd; display:inline-block; text-align:center; vertical-align:middle; margin-left:5px; }
        .badge.Basic { background: #e6f7ff; color: #1890ff; border-color: #91d5ff; }
        .badge.Standard { background: #f6ffed; color: #389e0d; border-color: #b7eb8f; }
        .badge.Pro { background: #f9f0ff; color: #722ed1; border-color: #d3adf7; }
        .badge.Premium { background: #fff0f6; color: #c41d7f; border-color: #ffadd2; }
        .badge.Enterprise { background: #391085; color: #fff; border-color: #391085; }
        .badge.none { background: #f5f5f5; color: #999; border-color: #ddd; }

        .dept-container { display: none; padding: 20px; background-color: #fff; border-top: 1px solid #eee; }
        .dept-group { margin-bottom: 20px; border-left: 3px solid #eee; padding-left: 15px; }
        .dept-title { font-size: 15px; font-weight: 700; color: #555; margin-bottom: 10px; }

        .case-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .case-table th { text-align: left; padding: 10px; color: #888; border-bottom: 1px solid #eee; background: #fafafa; }
        .case-table td { padding: 12px 10px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; }
        .case-table tr:hover { background-color: #f8f9fa; cursor: pointer; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-start-work { background: #722ed1; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; }
        .btn-start-work:hover { background: #531dab; }
        .btn-write-ans { background: #096dd9; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-card { background: #fff; width: 600px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: 800; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .close-btn { font-size: 24px; cursor: pointer; margin-top: -5px; }

        .q-view { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; line-height: 1.6; border: 1px solid #eee; }
        .a-view { background: #e6f7ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; line-height: 1.6; border: 1px solid #91d5ff; }
        .q-label { font-weight: bold; color: #2c5bf2; margin-bottom: 5px; display: block; padding: 5px 10px; background: #fff; border-radius: 4px; display: inline-block; }
        .a-input { width: 100%; height: 200px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-size: 14px; outline: none; margin-bottom: 10px; }
        .btn-reply-save { width: 100%; height: 50px; background: #2c5bf2; color: #fff; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }

        /* ìš°ì¸¡ íŒ¨ë„ */
        .right-panel {
            width: 320px; background-color: #fff; border-left: 1px solid #eee;
            position: fixed; right: 0; top: 0; height: 100vh; padding: 30px 20px;
            z-index: 90; overflow-y: auto; box-shadow: -4px 0 20px rgba(0,0,0,0.02);
        }
        .rp-title { font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 20px; display:flex; align-items:center; gap:5px; }
        .task-card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #ccc; cursor:pointer; transition:0.2s; }
        .task-card:hover { transform:translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .task-urgent { border-left-color: #ff4d4f; background-color: #fff1f0; }
        .task-warning { border-left-color: #fa8c16; background-color: #fff7e6; }

        .t-header { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px; }
        .t-dday { font-weight: 800; color: #ff4d4f; }
        .t-title { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 5px; line-height: 1.4; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 79, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0); } }
    
        .post-title-link { color: inherit; text-decoration: none; }
        .post-title-link:hover { text-decoration: underline; }
</style>
</head>
<body>


    <!-- ì‚¬ì´ë“œë°”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->

    <script src="../../js/admin_sidebar.js?v=2"></script>
    <script>
        // ì‚¬ì´ë“œë°” ì¦‰ì‹œ ë Œë”ë§
        if (typeof renderAdminSidebar === 'function') {
            renderAdminSidebar();
        }
    </script>

<main class="main-content">
    <div class="page-header">
        <div>
            <h2 class="page-title">ğŸ“ ê¸°ì—…ìë¬¸ í†µí•© ê´€ë¦¬</h2>
            <div style="font-size:13px; color:#666; margin-top:5px;">
                ì‚¬ì—…ìë²ˆí˜¸ ê¸°ì¤€ ìë™ ê·¸ë£¹í•‘ & ìš”ê¸ˆì œë³„ íšŸìˆ˜ ê´€ë¦¬
            </div>
        </div>
    </div>

    <div class="search-box">
        <span>ğŸ”</span>
        <input type="text" id="searchInput" class="search-input" placeholder="íšŒì‚¬ëª…, ì‚¬ì—…ìë²ˆí˜¸ë¡œ ê²€ìƒ‰..." onkeyup="filterCompanies()">
    </div>

    <div id="companyListContainer">
        <div style="text-align:center; padding:50px; color:#999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</main>

<aside class="right-panel">
    <div class="rp-title">â³ ë§ˆê° ì„ë°• (D-Day) <span id="urgentCount">0</span></div>
    <div id="urgentList"></div>
</aside>

<div id="replyModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <span>ìë¬¸ ë‹µë³€ ì‘ì„±</span>
            <span class="close-btn" onclick="closeReplyModal()">âœ•</span>
        </div>

        <input type="hidden" id="replyDocId">
        <input type="hidden" id="replyOwnerUid">

        <div class="q-view">
            <span class="q-label" id="qaLabel">Q. ì§ˆë¬¸ ë‚´ìš©</span>
            <div id="q_content_view"></div>
            <div id="q_meta_line" style="margin-top:8px; font-size:12px; color:#666;"></div>
            <div id="q_files_view" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd; display:none;">
                <div style="font-weight:700; color:#555; margin-bottom:8px; font-size:13px;">ğŸ“ ì²¨ë¶€íŒŒì¼</div>
                <div id="q_files_list"></div>
            </div>
        </div>

        <div class="a-view" id="a_content_view_box" style="display:none;">
            <span class="q-label" style="background:#2c5bf2; color:#fff;">A. ë‹µë³€ ë‚´ìš©</span>
            <div id="a_content_view"></div>
            <div id="a_meta_line" style="margin-top:8px; font-size:12px; color:#666; display:none;"></div>
        </div>

        <textarea id="a_content_input" class="a-input" placeholder="ë‹µë³€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. (ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ ì˜ë¢°ì¸ì—ê²Œ ì•Œë¦¼ ë©”ì¼ì´ ë°œì†¡ë©ë‹ˆë‹¤)"></textarea>

        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-size:13px;">
                <input type="checkbox" id="deductCheck" checked> ğŸ“ ì„œë©´ ìë¬¸ íšŸìˆ˜ 1íšŒ ì°¨ê°
            </label>
        </div>

        <button class="btn-reply-save" onclick="saveReply()">ë‹µë³€ ì €ì¥ ë° ì•Œë¦¼ ë°œì†¡</button>
    </div>
</div>

<div id="phoneLogModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <span>ğŸ“ ì „í™”/ëŒ€ë©´ ìƒë‹´ ê¸°ë¡</span>
            <span class="close-btn" onclick="closeLogModal()">âœ•</span>
        </div>
        <input type="hidden" id="logOwnerUid">
        <input type="hidden" id="logCompanyName">

        <textarea id="logContent" class="a-input" style="height:150px;" placeholder="ìƒë‹´ ë‚´ìš©ì„ ê¸°ë¡í•´ì£¼ì„¸ìš”.&#13;&#10;(ë‚´ìš©ì€ í•´ë‹¹ íšŒì‚¬ì˜ ìë¬¸ ì´ë ¥ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤)"></textarea>

        <div style="font-size:12px; color:#d32f2f; margin-bottom:15px;">
            âš ï¸ ì €ì¥ ì‹œ ì „í™”ìƒë‹´ íšŸìˆ˜ê°€ 1íšŒ ì°¨ê°ë©ë‹ˆë‹¤.
        </div>

        <button class="btn-reply-save" onclick="savePhoneLog()">ì €ì¥ ë° ì°¨ê°</button>
    </div>
</div>

<script type="module">
    import { auth, users, posts, admin } from '../../js/api.js';

    const PLAN_SPECS = {
        'none': { qa: 0, phone: 0, label: 'ë¯¸ê°€ì…' },
        'Basic': { qa: 1, phone: 0, label: 'ğŸŒ± Basic' },
        'Standard': { qa: 3, phone: 1, label: 'â­ Standard' },
        'Pro': { qa: 5, phone: 2, label: 'ğŸ’ Pro' },
        'Premium': { qa: 8, phone: 5, label: 'ğŸ‘‘ Premium' },
        'Enterprise': { qa: 999, phone: 999, label: 'ğŸ¢ Enterprise' }
    };

    let allGroups = [];
    let companyMeta = {};
    let allPostsMap = {}; // docId -> post ë°ì´í„° ë§¤í•‘

   
    // ============================================
    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ í•¨ìˆ˜
    // ============================================
    function displayAdminUserInfo(user) {
        // admin_sidebar.jsì—ì„œ ìƒì„±í•˜ëŠ” ID(sb_userName/sb_userEmail/sb_userRole)ì— ë§ì¶° í‘œì‹œ
        const nameEl = document.getElementById('sb_userName') || document.getElementById('adminUserName');
        const emailEl = document.getElementById('sb_userEmail') || document.getElementById('adminUserEmail');
        const roleEl = document.getElementById('sb_userRole') || document.getElementById('adminUserRole');

        if (nameEl) nameEl.textContent = user.managerName || user.manager_name || user.email || 'ê´€ë¦¬ì';
        if (emailEl) emailEl.textContent = user.email || '';

        const roleMap = {
            'master': { label: 'ìµœê³  ê´€ë¦¬ì', class: 'badge-admin' },
            'admin': { label: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì', class: 'badge-admin' },
            'general_manager': { label: 'ì´ê´„ ê´€ë¦¬ì', class: 'badge-general_manager' },
            'lawyer': { label: 'ë³€í˜¸ì‚¬', class: 'badge-lawyer' }
        };

        if (roleEl) {
            // const roleInfo = roleMap[user.role] || { label: (user.role?.toUpperCase() || 'USER'), class: 'badge-admin' };
            // roleEl.textContent = roleInfo.label;
            // const baseClass = roleEl.classList.contains('profile-role') ? 'profile-role' : 'user-role';
            // roleEl.className = `${baseClass} ${roleInfo.class}`;
        }
    }

    // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
    document.getElementById('adminLogoutBtn')?.addEventListener('click', async function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            await auth.logout();
            location.href = '../../pages/public/login.html';
        }
    });

    // ê¶Œí•œ í™•ì¸ ë° ë°ì´í„° ë¡œë“œ
    (async () => {
        try {
            const userData = await users.getMe();
            console.log('ğŸ” [ê´€ë¦¬ì í˜ì´ì§€] ì‚¬ìš©ì ì •ë³´:', userData);

            // âœ… ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            displayAdminUserInfo(userData);

            const adminRoles = ['master', 'admin', 'general_manager', 'lawyer'];
            if (!adminRoles.includes(userData.role)) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ê¶Œí•œ: ' + userData.role);
                location.href = '../user/dashboard.html';
                return;
            }

            // âœ… ë³€í˜¸ì‚¬ ê¶Œí•œì¼ ê²½ìš° íŠ¹ì • ë©”ë‰´ ìˆ¨ê¹€
            if (userData.role === 'lawyer') {
                const hideMenus = [
                    'admin_report.html',
                    'admin_corpbilling.html',
                    'admin_members.html',
                    'admin_payments.html'
                ];

                hideMenus.forEach(menuFile => {
                    const menuLink = document.querySelector(`a[href="${menuFile}"]`);
                    if (menuLink) {
                        menuLink.parentElement.style.display = 'none';
                    }
                });
            }

            await loadData();
        } catch (error) {
            console.error('ê¶Œí•œ í™•ì¸ ì—ëŸ¬:', error);
            alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n' + (error?.message || error));
            location.href = '../public/login.html';
        }
    })();

    async function loadData() {
        try {
            // 1. íšŒì‚¬(owner) ëª©ë¡ ì¡°íšŒ
            const companiesData = await admin.getCompanies();
            const companies = companiesData.companies || [];

            // íšŒì‚¬ ë©”íƒ€ ì •ë³´ ì €ì¥
            companies.forEach(comp => {
                if (comp.bizNum) {
                    companyMeta[comp.bizNum] = {
                        plan: comp.plan || 'none',
                        qaUsedCount: comp.qaUsedCount || 0,
                        phoneUsedCount: comp.phoneUsedCount || 0,
                        customQaLimit: comp.customQaLimit || 0,
                        customPhoneLimit: comp.customPhoneLimit || 0,
                        ownerUid: comp.uid,
                        companyName: comp.companyName || comp.company_name
                    };
                    console.log('ğŸ“Š [íšŒì‚¬ ë©”íƒ€ ì €ì¥]', comp.bizNum, 'â†’', {
                        plan: comp.plan,
                        ownerUid: comp.uid,
                        companyName: comp.companyName || comp.company_name
                    });
                }
            });

            // 2. âœ… ëª¨ë“  ê²Œì‹œê¸€ ì¡°íšŒ (ì™„ë£Œëœ ê±´ë„ í¬í•¨)
            const postsData = await posts.getAll({
                limit: 200,
                // 'status: 'waiting' ì œê±° - ëª¨ë“  ìƒíƒœì˜ ê²Œì‹œê¸€ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•¨
                offset: 0
            });
            // ê²°ì œìˆ˜ë‹¨/ìš”ê¸ˆì œ ë³€ê²½/ì¶”ê°€ì´ìš©ë¬¸ì˜ ê±´ ì œì™¸, archived ìƒíƒœë„ ì œì™¸
            const allPosts = (postsData.posts || []).filter(p => {
                return p.category !== 'payment_method' && p.category !== 'plan_change' && p.category !== 'extra_usage_quote' && p.status !== 'archived';
            });

            // ì‚¬ì—…ìë²ˆí˜¸ë³„ ê·¸ë£¹í•‘
            const groupedData = {};
            const urgentTasks = [];
            const now = new Date();

            allPosts.forEach(p => {
                // ê²Œì‹œê¸€ ë§µì— ì €ì¥ (ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
                allPostsMap[p.docId] = p;

                // ì‚¬ì—…ìë²ˆí˜¸ ìš°ì„ ìˆœìœ„: authorBizNum > users.biz_num(JWTí† í°)
                const bizNum = p.authorBizNum || p.companyBizNum || "NO_BIZ";
                const companyName = p.companyName || p.userCompanyName || "ê¸°íƒ€(ë¯¸ë¶„ë¥˜)";
                const dept = (p.category === "phone_log") ? "ê´€ë¦¬ìë“±ë¡" : (p.userDepartment || p.authorDepartment || p.department || "ë¶€ì„œ ë¯¸ì§€ì •");

                // ë””ë²„ê¹…: ì²« 5ê°œ ê²Œì‹œê¸€ì˜ bizNum í™•ì¸
                if (allPosts.indexOf(p) < 5) {
                    console.log(`ğŸ“‹ [ê²Œì‹œê¸€ #${allPosts.indexOf(p)} bizNum í™•ì¸]`, {
                        docId: p.docId,
                        title: p.title?.substring(0, 20),
                        authorBizNum: p.authorBizNum,
                        companyBizNum: p.companyBizNum,
                        'ìµœì¢…ì„ íƒ': bizNum,
                        'íšŒì‚¬ëª…': companyName,
                        'companyMetaì—ìˆë‚˜?': !!companyMeta[bizNum],
                        'plan': companyMeta[bizNum]?.plan
                    });
                }

                if (!groupedData[bizNum]) {
                    groupedData[bizNum] = {
                        name: companyName,
                        bizNum: bizNum,
                        total: 0,
                        waiting: 0,
                        analyzing: 0,
                        progress: 0,
                        done: 0,
                        departments: {},
                        lastAction: new Date(p.createdAt)
                    };
                }

                groupedData[bizNum].total++;

                // âœ… ì¶”ê°€ì§ˆë¬¸ ì—¬ë¶€ í™•ì¸
                const hasFollowup = p.content && p.content.includes('[FOLLOWUP_SEPARATOR]');
                let isFollowupWaiting = false;

                if (hasFollowup) {
                    const questions = p.content.split('[FOLLOWUP_SEPARATOR]');
                    const followupCount = questions.length - 1;

                    let answerCount = 0;
                    if (p.answer && p.answer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
                        answerCount = p.answer.split('[FOLLOWUP_ANSWER_SEPARATOR]').length;
                    } else if (p.answer) {
                        answerCount = 1;
                    }

                    isFollowupWaiting = followupCount > (answerCount - 1);
                }

                // ìƒíƒœë³„ ì¹´ìš´íŠ¸
                if(p.status === 'pending' || p.status === 'waiting') {
                    groupedData[bizNum].waiting++;
                } else if(isFollowupWaiting) {
                    // ì¶”ê°€ì§ˆë¬¸ì´ ìˆê³  ë‹µë³€ ëŒ€ê¸°ì¤‘
                    groupedData[bizNum].progress++;
                } else if(p.status === 'analyzing' || p.status === 'processing' || p.status === 'InProgress' || p.status === 'progress') {
                    groupedData[bizNum].analyzing++;
                } else if(p.status === 'done' || p.status === 'completed' || p.status === 'answered' || p.status === 'resolved' || p.status === 'Completed') {
                    groupedData[bizNum].done++;
                }

                if (!groupedData[bizNum].departments[dept]) groupedData[bizNum].departments[dept] = [];
                groupedData[bizNum].departments[dept].push(p);

                // ë§ˆê° ì„ë°• ì²´í¬ (ë‹µë³€ ëŒ€ê¸°ì¤‘ì¸ ê±´ë“¤ë§Œ)
                if (p.status === 'pending' || p.status === 'waiting' || p.status === 'analyzing' || p.status === 'processing' || p.status === 'InProgress' || p.status === 'progress') {
                    const created = new Date(p.createdAt);
                    const deadline = new Date(created);
                    deadline.setDate(deadline.getDate() + 7);
                    const diffDays = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));

                    // ë””ë²„ê¹…: ì²« 5ê°œ ëŒ€ê¸°ì¤‘ ê²Œì‹œê¸€ì˜ ë§ˆê°ì¼ í™•ì¸
                    if (urgentTasks.length < 5) {
                        console.log(`â° [ë§ˆê°ì¼ ì²´í¬]`, {
                            title: p.title?.substring(0, 20),
                            status: p.status,
                            ìƒì„±ì¼: created.toLocaleDateString(),
                            ë§ˆê°ì¼: deadline.toLocaleDateString(),
                            ë‚¨ì€ì¼ìˆ˜: diffDays,
                            ì„ë°•ì—¬ë¶€: diffDays <= 4
                        });
                    }

                    if (diffDays <= 4) {
                        urgentTasks.push({
                            id: p.docId,
                            title: p.title,
                            client: companyName,
                            dDay: diffDays,
                            date: deadline,
                            status: p.status,
                            content: p.content,
                            answer: p.answer
                        });
                    }
                }
            });

            allGroups = Object.values(groupedData);

            // ì •ë ¬: ê¸´ê¸‰ ê±´ ìš°ì„ 
            allGroups.sort((a, b) => {
                const aUrgent = a.analyzing + a.progress;
                const bUrgent = b.analyzing + b.progress;

                if (aUrgent > 0 && bUrgent === 0) return -1;
                if (aUrgent === 0 && bUrgent > 0) return 1;

                if (a.waiting > 0 && b.waiting === 0) return -1;
                if (a.waiting === 0 && b.waiting > 0) return 1;

                return b.lastAction - a.lastAction;
            });

            renderTree(allGroups);

            urgentTasks.sort((a, b) => a.dDay - b.dDay);
            console.log('â³ ë§ˆê°ì„ë°• ë°ì´í„°:', {
                ì´ê²Œì‹œê¸€ìˆ˜: allPosts.length,
                ë§ˆê°ì„ë°•ê±´ìˆ˜: urgentTasks.length,
                urgentTasks: urgentTasks
            });
            renderUrgentPanel(urgentTasks);

        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
            document.getElementById('companyListContainer').innerHTML =
                '<div style="text-align:center; padding:50px; color:#ff4d4f;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ìš”ê¸ˆì œ ìˆ˜ë™ ë³€ê²½
    window.changePlan = async function(bizNum, newPlan) {
        event.stopPropagation();
        const meta = companyMeta[bizNum];
        if(!meta || !meta.ownerUid) return alert("ëŒ€í‘œì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        if(!confirm(`[${bizNum}] ê¸°ì—…ì˜ ìš”ê¸ˆì œë¥¼ [${newPlan}]ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        try {
            await admin.updateCompanyPlan(meta.ownerUid, newPlan);
            // âœ… ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì œê±°)
            meta.plan = newPlan;
            renderTree(allGroups);
            alert("ìš”ê¸ˆì œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) {
            console.error(e);
            alert("ë³€ê²½ ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    }

    function renderTree(groups) {
        const container = document.getElementById('companyListContainer');
        container.innerHTML = "";

        if (groups.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">ë‚´ì—­ ì—†ìŒ</div>`;
            return;
        }

        groups.forEach((comp, idx) => {
            const meta = companyMeta[comp.bizNum] || { plan: 'none', qaUsedCount: 0, phoneUsedCount: 0, ownerUid: null };
            let planSpec = PLAN_SPECS[meta.plan] || { qa: 0, phone: 0, label: 'ë¯¸ê°€ì…' };

            // ë””ë²„ê¹…: ì²« 3ê°œ íšŒì‚¬ ë¡œê·¸
            if (idx < 3) {
                console.log(`ğŸ¢ [ë Œë”ë§ íšŒì‚¬ #${idx}]`, {
                    'íšŒì‚¬ëª…': comp.name,
                    'bizNum': comp.bizNum,
                    'companyMeta[bizNum]': companyMeta[comp.bizNum],
                    'ì°¾ì€ plan': meta.plan,
                    'planSpec label': planSpec.label,
                    'ì „ì²´ companyMeta í‚¤ë“¤': Object.keys(companyMeta).join(', ')
                });
            }
            const planClass = meta.plan === 'none' ? 'plan-none' : (meta.plan === 'Basic' ? 'plan-basic' : (meta.plan === 'Standard' ? 'plan-std' : (meta.plan === 'Pro' ? 'plan-pro' : (meta.plan === 'Premium' ? 'plan-prem' : 'plan-ent'))));

            let qaLimit = planSpec.qa;
            let phoneLimit = planSpec.phone;

            if (meta.plan === 'Enterprise') {
                qaLimit = meta.customQaLimit || 999;
                phoneLimit = meta.customPhoneLimit || 999;
            }

            const planSelectHtml = `
                <select onchange="changePlan('${comp.bizNum}', this.value)" class="plan-select ${planClass}" onclick="event.stopPropagation()">
                    <option value="none" ${meta.plan=='none'?'selected':''}>ë¯¸ê°€ì…</option>
                    <option value="Basic" ${meta.plan=='Basic'?'selected':''}>ğŸŒ± Basic</option>
                    <option value="Standard" ${meta.plan=='Standard'?'selected':''}>â­ Standard</option>
                    <option value="Pro" ${meta.plan=='Pro'?'selected':''}>ğŸ’ Pro</option>
                    <option value="Premium" ${meta.plan=='Premium'?'selected':''}>ğŸ‘‘ Premium</option>
                    <option value="Enterprise" ${meta.plan=='Enterprise'?'selected':''}>ğŸ¢ Enterprise</option>
                </select>
            `;

            let quotaHtml = "";
            // if (meta.plan !== 'none') { // <- ì´ ì¡°ê±´ ì œê±°
                let entEditBtn = "";
                if(meta.plan === 'Enterprise') {
                    entEditBtn = `<button class="btn-deduct" onclick="editEnterpriseLimit('${comp.bizNum}', ${qaLimit}, ${phoneLimit})" style="margin-left:5px; background:#1a1a2e; color:white; border:none;">âš™ï¸ í•œë„ì„¤ì •</button>`;
                }

                quotaHtml = `
                    <div class="quota-row">
                        <div class="quota-box">
                            <span class="q-label">ğŸ“ ì„œë©´</span> <span class="quota-val">${meta.qaUsedCount}</span> / ${qaLimit}
                            <button class="btn-deduct" onclick="adjustQuota('${comp.bizNum}', 'qa')">â–</button>
                        </div>
                        <div class="quota-box">
                            <span class="q-label">ğŸ“ ì „í™”</span> <span class="quota-val">${meta.phoneUsedCount}</span> / ${phoneLimit}
                            <button class="btn-phone-log" onclick="openLogModal('${comp.bizNum}', '${comp.name}')">ğŸ“ ê¸°ë¡+ì°¨ê°</button>
                        </div>
                        ${entEditBtn}
                    </div>
                `;
            // }

            let badges = "";
            let alertClass = "";
            if(comp.progress > 0) { badges += `<span class="count-badge cb-progress">ğŸ’¬ ì¶”ê°€ì§ˆë¬¸ ${comp.progress}</span>`; alertClass = "highlight"; }
            if(comp.analyzing > 0) { badges += `<span class="count-badge cb-analyzing">â³ ë‹µë³€ëŒ€ê¸° ${comp.analyzing}</span>`; alertClass = "highlight"; }
            if(comp.waiting > 0) { badges += `<span class="count-badge cb-waiting">ğŸ”¥ ì ‘ìˆ˜ëŒ€ê¸° ${comp.waiting}</span>`; }

            const html = `
                <div class="company-group ${alertClass}">
                    <div class="company-header" onclick="toggleGroup(this)">
                        <div class="comp-left">
                            <div class="comp-row-1">
                                <span class="comp-name">${comp.name}</span>
                                <span class="badge ${meta.plan}">${meta.plan}</span>
                                ${planSelectHtml}
                            </div>
                            <div class="comp-row-2">
                                <span class="comp-biz">${comp.bizNum}</span>
                                ${quotaHtml}
                            </div>
                        </div>
                        <div class="comp-right">
                            ${badges}
                            <span class="count-badge cb-done">ì™„ë£Œ ${comp.done}</span>
                        </div>
                    </div>
                    <div class="dept-container">
                        ${renderDepartments(comp.departments, comp.bizNum)}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    window.editEnterpriseLimit = async function(bizNum, currentQa, currentPhone) {
        event.stopPropagation();
        const meta = companyMeta[bizNum];

        const newQa = prompt("ğŸ“ ì„œë©´ ìë¬¸ í•œë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", currentQa);
        if(newQa === null) return;
        const newPhone = prompt("ğŸ“ ì „í™” ìƒë‹´ í•œë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", currentPhone);
        if(newPhone === null) return;

        try {
            await admin.updateCompanyLimits(meta.ownerUid, {
                customQaLimit: Number(newQa),
                customPhoneLimit: Number(newPhone)
            });
            // âœ… ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì œê±°)
            meta.customQaLimit = Number(newQa);
            meta.customPhoneLimit = Number(newPhone);
            renderTree(allGroups);
            alert("í•œë„ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message); }
    }

    window.adjustQuota = async function(bizNum, type) {
        event.stopPropagation();
        const meta = companyMeta[bizNum];
        if(!meta || !meta.ownerUid) return alert("ì •ë³´ ì˜¤ë¥˜");
        if(!confirm("ì„œë©´ ìë¬¸ íšŸìˆ˜ë¥¼ 1íšŒ ì°¨ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            await admin.incrementUsage(meta.ownerUid, type);
            // âœ… ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸ (ìƒˆë¡œê³ ì¹¨ ì œê±°)
            if (type === 'qa') {
                meta.qaUsedCount = (meta.qaUsedCount || 0) + 1;
            } else if (type === 'phone') {
                meta.phoneUsedCount = (meta.phoneUsedCount || 0) + 1;
            }
            renderTree(allGroups);
            alert("ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    }

    window.openLogModal = function(bizNum, compName) {
        event.stopPropagation();
        const meta = companyMeta[bizNum];
        if(!meta || !meta.ownerUid) return alert("ì •ë³´ ì˜¤ë¥˜");

        document.getElementById('logOwnerUid').value = meta.ownerUid;
        document.getElementById('logCompanyName').value = compName;
        document.getElementById('logContent').value = "";
        document.getElementById('phoneLogModal').style.display = 'flex';
    }

    window.closeLogModal = function() { document.getElementById('phoneLogModal').style.display = 'none'; }

    window.savePhoneLog = async function() {
        const ownerUid = document.getElementById('logOwnerUid').value;
        const compName = document.getElementById('logCompanyName').value;
        const content = document.getElementById('logContent').value;

        if(!content) return alert("ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
            // postsì— ì „í™”ìƒë‹´ ê¸°ë¡ ì €ì¥
            await posts.create({
                title: "[ì „í™”ìƒë‹´] ìƒë‹´ ê¸°ë¡",
                content: content,
                companyName: compName,
                category: "phone_log",
                status: "done"
            });

            // ì „í™”ìƒë‹´ íšŸìˆ˜ ì°¨ê°
            await admin.incrementUsage(ownerUid, 'phone');

            alert("ì €ì¥ ë° ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeLogModal();
            loadData();
        } catch(e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }

    function renderDepartments(depts, bizNum) {
        let html = "";
        for (const [deptName, postList] of Object.entries(depts)) {
            let rows = "";
            postList.forEach(p => {
                const date = new Date(p.createdAt).toLocaleDateString();
                // âœ… ì‘ì„±ì/ë‹µë³€ì í‘œì‹œ ê·œì¹™
                // - phone_log: í•­ìƒ ê´€ë¦¬ì(ë¡œê·¸ì¸) ê¸°ë¡ì = answeredBy
                // - ì¼ë°˜ ìë¬¸: ë‹µë³€ ì™„ë£Œ ì‹œ answeredBy(ê´€ë¦¬ì) í‘œì‹œ, ê·¸ ì™¸ëŠ” ê¸°ì¡´ ì‘ì„±ì í‘œì‹œ
                let writerDisplay = '-';
                if (p.category === 'phone_log') {
                    writerDisplay = p.answeredBy || p.answererName || p.adminName || '-';
                } else if (p.answeredBy) {
                    writerDisplay = p.answeredBy;
                } else {
                    writerDisplay = p.userManagerName || p.authorManager || '-';
                }

                let statusText = "";
                let actionBtn = "";

                if (p.category === 'phone_log') {
                    statusText = `<span style="color:#666; font-weight:bold; background:#eee; padding:2px 6px; border-radius:4px;">ğŸ“ ì „í™”ê¸°ë¡</span>`;
                    actionBtn = `<button class="btn-write-ans" style="background:#888; cursor:default;">ê¸°ë¡ë¨</button>`;
                } else {
                    // âœ… ì¶”ê°€ì§ˆë¬¸ ì—¬ë¶€ í™•ì¸
                    const hasFollowup = p.content && p.content.includes('[FOLLOWUP_SEPARATOR]');
                    let isFollowupWaiting = false;

                    if (hasFollowup) {
                        const questions = p.content.split('[FOLLOWUP_SEPARATOR]');
                        const followupCount = questions.length - 1;

                        let answerCount = 0;
                        if (p.answer && p.answer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
                            answerCount = p.answer.split('[FOLLOWUP_ANSWER_SEPARATOR]').length;
                        } else if (p.answer) {
                            answerCount = 1;
                        }

                        isFollowupWaiting = followupCount > (answerCount - 1);
                    }

                    // ë‹µë³€ ëŒ€ê¸°ì¤‘ ìƒíƒœë“¤: pending, waiting, analyzing, processing, InProgress
                    if(p.status === 'pending' || p.status === 'waiting') {
                        statusText = `<span style="color:#ff4d4f; font-weight:bold;">ì ‘ìˆ˜ëŒ€ê¸°</span>`;
                        actionBtn = `<button class="btn-start-work" onclick="changeStatus('${p.docId}', 'analyzing', event)">ì ‘ìˆ˜í™•ì¸(ì‘ì„±ì‹œì‘)</button>`;
                    }
                    else if(isFollowupWaiting) {
                        // ì¶”ê°€ì§ˆë¬¸ì´ ìˆê³  ë‹µë³€ ëŒ€ê¸°ì¤‘
                        statusText = `<span style="color:#722ed1; font-weight:bold;">ì¶”ê°€ì§ˆë¬¸</span>`;
                        actionBtn = `<button class="btn-write-ans" onclick="openReplyModal('${p.docId}', '${bizNum}')">ë‹µë³€ì‘ì„±</button>`;
                    }
                    else if(p.status === 'analyzing' || p.status === 'processing' || p.status === 'InProgress' || p.status === 'progress') {
                        statusText = `<span style="color:#096dd9; font-weight:bold;">ë‹µë³€ëŒ€ê¸°</span>`;
                        actionBtn = `<button class="btn-write-ans" onclick="openReplyModal('${p.docId}', '${bizNum}')">ë‹µë³€ì‘ì„±</button>`;
                    }
                    // ë‹µë³€ ì™„ë£Œ ìƒíƒœë“¤: done, completed, answered, resolved, Completed
                    else if(p.status === 'done' || p.status === 'completed' || p.status === 'answered' || p.status === 'resolved' || p.status === 'Completed') {
                        statusText = `<span style="color:#52c41a; font-weight:bold;">ì™„ë£Œ</span>`;
                        actionBtn = `
                            <button class="btn-write-ans" style="background:#fff; color:#555; border:1px solid #ddd;" onclick="openReplyModal('${p.docId}', '${bizNum}')">ë‚´ìš©ë³´ê¸°</button>
                            <button class="btn-write-ans" style="background:#fff; color:#999; border:1px solid #ddd; margin-left:3px;" onclick="archivePost('${p.docId}')">ìˆ¨ê¸°ê¸°</button>
                        `;
                    }
                    else {
                        // ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ
                        statusText = `<span style="color:#999; font-weight:bold;">${p.status || 'ë¯¸í™•ì¸'}</span>`;
                        actionBtn = `<button class="btn-write-ans" onclick="openReplyModal('${p.docId}', '${bizNum}')">í™•ì¸</button>`;
                    }
                }

                rows += `
                    <tr>
                        <td width="10%">${statusText}</td>
                        <td width="10%">${p.category || "ì¼ë°˜"}</td>
                        <td><a href="javascript:void(0)" class="post-title-link" onclick="openPostPopup('${p.docId}', '${bizNum}')"><strong>${p.title}</strong></a></td>
                        <td width="15%" class="writer-info">${writerDisplay}</td>
                        <td width="15%" class="time-info">${date}</td>
                        <td width="15%">${actionBtn}</td>
                    </tr>
                `;
            });

            html += `
                <div class="dept-group">
                    <div class="dept-title">ğŸ“‚ ${deptName}</div>
                    <table class="case-table">
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }
        return html;
    }

    window.changeStatus = async function(docId, newStatus, e) {
        if(e) e.stopPropagation();
        if(!confirm("ì ‘ìˆ˜ë¥¼ í™•ì¸í•˜ê³  ë‹µë³€ ì‘ì„±ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê³ ê°ì€ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤)")) return;

        try {
            await posts.update(docId, { status: newStatus });
            loadData();
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    }

    window.openPostPopup = function(docId, bizNum) {
        // âœ… ì œëª© í´ë¦­ ì‹œ ë¬´ì¡°ê±´ íŒì—… ì˜¤í”ˆ (ìš”ì²­/ë‹µë³€ëŒ€ê¸°/ì™„ë£Œ/ì „í™”ê¸°ë¡ ëª¨ë‘)
        openReplyModal(docId, bizNum);
    };

window.openReplyModal = function(docId, bizNum) {
        event?.stopPropagation();

        // allPostsMapì—ì„œ ê²Œì‹œê¸€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const post = allPostsMap[docId];
        // âœ… phone_log(ì „í™” ìƒë‹´ ê¸°ë¡)ë„ ì œëª© í´ë¦­ ì‹œ íŒì—…ì´ ì—´ë ¤ì•¼ í•¨
        // - ë‹µë³€ ì‘ì„± UI ëŒ€ì‹  "ê¸°ë¡ ë³´ê¸°" í˜•íƒœë¡œ ì „í™˜
        const replyModal = document.getElementById('replyModal');
        const headerSpan = replyModal?.querySelector('.modal-header span');
        const aInput = document.getElementById('a_content_input');
        const saveBtn = replyModal?.querySelector('.btn-reply-save');
        const deductWrap = document.getElementById('deductWrap');
        const writtenDeductWrap = document.getElementById('writtenDeductWrap');
        const aViewBox = document.getElementById('a_content_view_box');

        if (!post) {
            alert('ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        if (post?.category === 'phone_log') {
            if (headerSpan) headerSpan.textContent = 'ì „í™” ìƒë‹´ ê¸°ë¡';
            const qaLabel = document.getElementById('qaLabel');
            if (qaLabel) qaLabel.textContent = 'A. ìƒë‹´ ê¸°ë¡';
            if (aViewBox) aViewBox.style.display = 'none';
            if (aInput) { aInput.style.display = 'none'; aInput.value = ''; }
            if (saveBtn) saveBtn.style.display = 'none';
            if (deductWrap) deductWrap.style.display = 'none';
            if (writtenDeductWrap) writtenDeductWrap.style.display = 'none';
        } else {
            if (headerSpan) headerSpan.textContent = 'ìë¬¸ ë‹µë³€ ì‘ì„±';
            const qaLabel = document.getElementById('qaLabel');
            if (qaLabel) qaLabel.textContent = 'Q. ì§ˆë¬¸ ë‚´ìš©';
            if (aInput) aInput.style.display = '';
            if (saveBtn) saveBtn.style.display = '';
            if (deductWrap) deductWrap.style.display = '';
            if (writtenDeductWrap) writtenDeductWrap.style.display = '';
        }

        document.getElementById('replyDocId').value = docId;

        // âœ… ì¶”ê°€ì§ˆë¬¸ ì²˜ë¦¬: ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ëŒ€í™” í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
        let originalContent = post.content || '';
        let originalAnswer = post.answer || '';
        let followupQuestions = [];
        let followupAnswers = [];

        // ì§ˆë¬¸ íŒŒì‹±
        if (originalContent.includes('[FOLLOWUP_SEPARATOR]')) {
            const parts = originalContent.split('[FOLLOWUP_SEPARATOR]');
            originalContent = parts[0].trim();
            followupQuestions = parts.slice(1).filter(q => q.trim());
        }

        // ë‹µë³€ íŒŒì‹±
        if (originalAnswer && originalAnswer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
            const answerParts = originalAnswer.split('[FOLLOWUP_ANSWER_SEPARATOR]');
            originalAnswer = answerParts[0].trim();
            followupAnswers = answerParts.slice(1).filter(a => a.trim());
        }

        // ì§ˆë¬¸ ì˜ì—­ì€ ì›ë˜ ì§ˆë¬¸ë§Œ í‘œì‹œ
        document.getElementById('q_content_view').innerHTML = originalContent;
        // âœ… ì§ˆë¬¸/ë‹µë³€ ë©”íƒ€ í‘œì‹œ
        // ì§ˆë¬¸: ì‘ì„±ì + ì‘ì„±ì¼ì‹œ
        const qMetaLine = document.getElementById('q_meta_line');
        if (qMetaLine) {
            const qWriter =
                post.userManagerName ||
                post.authorManager ||
                post.authorName ||
                post.managerName ||
                post.manager_name ||
                '-';
            const qAt = post.createdAt ? new Date(post.createdAt).toLocaleString() : '';
            const qAtText = qAt ? (' Â· ' + qAt) : '';
            qMetaLine.innerText = `ì‘ì„±ì: ${qWriter}${qAtText}`;
        }

        // ë‹µë³€: ë‹µë³€ì + ë‹µë³€ì¼ì‹œ (ë‹µë³€ì´ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ)
        const aMetaLine = document.getElementById('a_meta_line');
        if (aMetaLine) {
            const aWriter = post.answeredBy || post.answererName || post.adminName || '';
            const aAt = post.answeredAt ? new Date(post.answeredAt).toLocaleString() : '';
            if (aWriter) {
                const aAtText = aAt ? (' Â· ' + aAt) : '';
                aMetaLine.innerText = `ë‹µë³€ì: ${aWriter}${aAtText}`;
                aMetaLine.style.display = 'block';
            } else {
                aMetaLine.innerText = '';
                aMetaLine.style.display = 'none';
            }
        }
// ì²¨ë¶€íŒŒì¼ í‘œì‹œ
        let fileUrls = [];
        if (post.fileUrls) {
            try {
                fileUrls = typeof post.fileUrls === 'string' ? JSON.parse(post.fileUrls) : post.fileUrls;
                if (!Array.isArray(fileUrls)) fileUrls = [];
            } catch (e) {
                fileUrls = [];
            }
        }

        const filesView = document.getElementById('q_files_view');
        const filesList = document.getElementById('q_files_list');

        if (fileUrls.length > 0) {
            filesList.innerHTML = fileUrls.map(url => {
                const fileName = url.split('/').pop();
                return `<div style="margin-bottom:5px;">
                    <a href="http://localhost:3000${url}" target="_blank" style="color:#2c5bf2; text-decoration:none; font-size:13px;">
                        ğŸ“„ ${decodeURIComponent(fileName)}
                    </a>
                </div>`;
            }).join('');
            filesView.style.display = 'block';
        } else {
            filesView.style.display = 'none';
        }

        const answerViewBox = document.getElementById('a_content_view_box');
        const answerView = document.getElementById('a_content_view');
        const answerInput = document.getElementById('a_content_input');

        // âœ… ì›ë˜ ë‹µë³€ì´ ìˆìœ¼ë©´ í‘œì‹œ
        if (originalAnswer && originalAnswer !== '' && originalAnswer !== 'undefined') {
            answerView.innerText = originalAnswer;
            answerViewBox.style.display = 'block';

            // ë‹µë³€ ë©”íƒ€ í‘œì‹œ
            const aMetaLine2 = document.getElementById('a_meta_line');
            if (aMetaLine2) {
                const aWriter2 = post.answeredBy || post.answererName || post.adminName || '';
                const aAt2 = post.answeredAt ? new Date(post.answeredAt).toLocaleString() : '';
                if (aWriter2) {
                    const aAtText2 = aAt2 ? (' Â· ' + aAt2) : '';
                    aMetaLine2.innerText = `ë‹µë³€ì: ${aWriter2}${aAtText2}`;
                    aMetaLine2.style.display = 'block';
                } else {
                    aMetaLine2.style.display = 'none';
                }
            }
        } else {
            answerViewBox.style.display = 'none';
            const aMetaLine3 = document.getElementById('a_meta_line');
            if (aMetaLine3) { aMetaLine3.style.display = 'none'; aMetaLine3.innerText=''; }
        }

        // âœ… ì¶”ê°€ì§ˆë¬¸ê³¼ ì¶”ê°€ë‹µë³€ì„ ì›ë˜ ë‹µë³€ ì•„ë˜ì— í‘œì‹œ
        let followupContainer = document.getElementById('followup-qa-container');
        if (!followupContainer) {
            followupContainer = document.createElement('div');
            followupContainer.id = 'followup-qa-container';
            // a_content_view_box ë‹¤ìŒì— ì‚½ì…
            answerViewBox.parentElement.insertBefore(followupContainer, answerInput);
        }

        let followupHTML = '';
        if (followupQuestions.length > 0) {
            followupQuestions.forEach((followup, index) => {
                // ì¶”ê°€ ì§ˆë¬¸ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹±
                const followupTimeMatch = followup.match(/\((\d{4}\.\s*\d{1,2}\.\s*\d{1,2}\.\s*ì˜¤[ì „í›„]\s*\d{1,2}:\d{2}:\d{2})\)/);
                const followupTime = followupTimeMatch ? followupTimeMatch[1] : '';
                const followupText = followup.replace(/\[ì¶”ê°€ë¬¸ì˜ \d+\]\s*\([\d\.\sì˜¤ì „í›„:]+\)\s*/, '').trim();

                followupHTML += `
                    <div style="margin-top:20px; padding:15px; background:#fff7e6; border-left:4px solid #fa8c16; border-radius:6px;">
                        <div style="font-weight:700; color:#fa8c16; margin-bottom:8px;">Q ${index + 2}. ì¶”ê°€ ì§ˆë¬¸ ${index + 1}</div>
                        <div style="color:#333; white-space:pre-wrap;">${followupText}</div>
                        <div style="margin-top:8px; font-size:12px; color:#888; text-align:right;">
                            ì‘ì„±ì: ${post.userManagerName || post.managerName || '-'}${followupTime ? ' Â· ' + followupTime : ''}
                        </div>
                    </div>
                `;

                // í•´ë‹¹ ì¶”ê°€ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì´ ìˆìœ¼ë©´ í‘œì‹œ
                if (followupAnswers[index]) {
                    followupHTML += `
                        <div style="margin-top:10px; padding:15px; background:#e6f7ff; border-left:4px solid #1890ff; border-radius:6px; margin-bottom:10px;">
                            <div style="font-weight:700; color:#1890ff; margin-bottom:8px;">A ${index + 2}. ë‹µë³€</div>
                            <div style="color:#333; white-space:pre-wrap;">${followupAnswers[index].trim()}</div>
                            <div style="margin-top:8px; font-size:12px; color:#888; text-align:right;">
                                ë‹µë³€ì: ${post.answeredBy || post.answererName || '-'}${post.answeredAt ? ' Â· ' + new Date(post.answeredAt).toLocaleString('ko-KR') : ''}
                            </div>
                        </div>
                    `;
                }
            });
        }
        followupContainer.innerHTML = followupHTML;

        // âœ… ì¶”ê°€ì§ˆë¬¸ ë‹µë³€ ì…ë ¥ì°½ ì²˜ë¦¬
        const unansweredFollowupIndex = followupQuestions.length - followupAnswers.length;

        if (unansweredFollowupIndex > 0) {
            // ë‹µë³€ë˜ì§€ ì•Šì€ ì¶”ê°€ì§ˆë¬¸ì´ ìˆëŠ” ê²½ìš°
            const followupNumber = followupAnswers.length + 1;
            answerInput.placeholder = `ì¶”ê°€ ì§ˆë¬¸ ${followupNumber}ì— ëŒ€í•œ ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.`;
            answerInput.value = "";
            answerInput.disabled = false;
            answerInput.style.display = 'block';

            // ì¶”ê°€ì§ˆë¬¸ ë‹µë³€ ê°€ì´ë“œ í‘œì‹œ
            let guideEl = document.getElementById('followup-answer-guide');
            if (!guideEl) {
                guideEl = document.createElement('div');
                guideEl.id = 'followup-answer-guide';
                answerInput.parentElement.insertBefore(guideEl, answerInput);
            }
            guideEl.innerHTML = `
                <div style="background:#fff7e6; border:1px solid #ffa940; border-radius:6px; padding:12px; margin-bottom:10px;">
                    <div style="font-weight:700; color:#fa8c16; margin-bottom:5px;">ğŸ“ ì¶”ê°€ ì§ˆë¬¸ ${followupNumber}ì— ëŒ€í•œ ë‹µë³€ ì‘ì„±</div>
                    <div style="font-size:13px; color:#666;">ìœ„ì— í‘œì‹œëœ ì¶”ê°€ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì•„ë˜ì— ì‘ì„±í•´ì£¼ì„¸ìš”.</div>
                </div>
            `;
        } else if (originalAnswer && originalAnswer !== '' && originalAnswer !== 'undefined') {
            // ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€ì´ ì™„ë£Œëœ ê²½ìš°
            answerInput.style.display = 'none';

            let guideEl = document.getElementById('followup-answer-guide');
            if (guideEl) guideEl.remove();
        } else {
            // ìµœì´ˆ ë‹µë³€ ì‘ì„±
            answerInput.placeholder = "ë‹µë³€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. (ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ ì˜ë¢°ì¸ì—ê²Œ ì•Œë¦¼ ë©”ì¼ì´ ë°œì†¡ë©ë‹ˆë‹¤)";
            answerInput.value = "";
            answerInput.disabled = false;
            answerInput.style.display = 'block';

            let guideEl = document.getElementById('followup-answer-guide');
            if (guideEl) guideEl.remove();
        }

        const meta = companyMeta[bizNum];
        if (meta) document.getElementById('replyOwnerUid').value = meta.ownerUid;

        document.getElementById('replyModal').style.display = 'flex';
    }

    window.closeReplyModal = function() { document.getElementById('replyModal').style.display = 'none'; }

    // ê²Œì‹œê¸€ ìˆ¨ê¸°ê¸° (ì•„ì¹´ì´ë¸Œ)
    window.archivePost = async function(docId) {
        if (!confirm("ì´ ìë¬¸ ë‚´ì—­ì„ ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            // í˜„ì¬ ê²Œì‹œê¸€ ì •ë³´ ì¡°íšŒí•˜ì—¬ í˜„ì¬ ìƒíƒœ ì €ì¥
            const post = await posts.getById(docId);
            const currentStatus = post.status;

            // í˜„ì¬ ìƒíƒœë¥¼ previousStatusì— ì €ì¥í•˜ê³  archivedë¡œ ë³€ê²½
            await posts.update(docId, {
                previousStatus: currentStatus,
                status: 'archived'
            });
            alert("ìˆ¨ê¹€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadData(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        } catch (error) {
            console.error('ìˆ¨ê¹€ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    window.saveReply = async function() {
        const docId = document.getElementById('replyDocId').value;
        const newAnswer = document.getElementById('a_content_input').value;
        const ownerUid = document.getElementById('replyOwnerUid').value;
        const deduct = document.getElementById('deductCheck').checked;

        if (!newAnswer) return alert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
            // í˜„ì¬ ê²Œì‹œê¸€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const post = allPostsMap[docId];
            if (!post) {
                alert('ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let finalAnswer = newAnswer;

            // âœ… ì¶”ê°€ì§ˆë¬¸ì´ ìˆëŠ” ê²½ìš° ë‹µë³€ ì²˜ë¦¬
            if (post.content && post.content.includes('[FOLLOWUP_SEPARATOR]')) {
                // ê¸°ì¡´ ë‹µë³€ì´ ìˆìœ¼ë©´ ì¶”ê°€ë‹µë³€ìœ¼ë¡œ ì €ì¥
                if (post.answer && post.answer.trim()) {
                    finalAnswer = post.answer + '\n[FOLLOWUP_ANSWER_SEPARATOR]\n' + newAnswer;
                }
                // ê¸°ì¡´ ë‹µë³€ì´ ì—†ìœ¼ë©´ ìµœì´ˆ ë‹µë³€
            }

            // ë‹µë³€ ì €ì¥
            await posts.update(docId, {
                answer: finalAnswer,
                status: 'completed',
                answeredAt: new Date().toISOString()
            });

            // íšŸìˆ˜ ì°¨ê°
            if (deduct && ownerUid) {
                await admin.incrementUsage(ownerUid, 'qa');
            }

            alert("âœ… ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ê³ ê°ì—ê²Œ ì•Œë¦¼ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤)");
            closeReplyModal();
            loadData();
        } catch(e) {
            console.error(e);
            alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
        }
    }

    function renderUrgentPanel(tasks) {
        const container = document.getElementById('urgentList');
        document.getElementById('urgentCount').innerText = tasks.length;
        container.innerHTML = "";

        tasks.forEach(t => {
            let dDayText = `D-${t.dDay}`;
            let cardClass = "task-warning";
            if (t.dDay <= 0) {
                dDayText = t.dDay === 0 ? "D-Day" : `ì§€ì—° ${Math.abs(t.dDay)}ì¼`;
                cardClass = "task-urgent";
            }

            // âœ… ì¶”ê°€ì§ˆë¬¸ ì—¬ë¶€ í™•ì¸
            const hasFollowup = t.content && t.content.includes('[FOLLOWUP_SEPARATOR]');
            let isFollowupWaiting = false;

            if (hasFollowup) {
                const questions = t.content.split('[FOLLOWUP_SEPARATOR]');
                const followupCount = questions.length - 1;

                let answerCount = 0;
                if (t.answer && t.answer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
                    answerCount = t.answer.split('[FOLLOWUP_ANSWER_SEPARATOR]').length;
                } else if (t.answer) {
                    answerCount = 1;
                }

                isFollowupWaiting = followupCount > (answerCount - 1);
            }

            let stBadge = "";
            if(t.status === 'pending' || t.status === 'waiting') {
                stBadge = `<span style="font-size:10px; background:#fff1f0; color:#ff4d4f; padding:2px 4px; border-radius:3px;">ì ‘ìˆ˜ëŒ€ê¸°</span>`;
            } else if(isFollowupWaiting) {
                stBadge = `<span style="font-size:10px; background:#f9f0ff; color:#722ed1; padding:2px 4px; border-radius:3px;">ì¶”ê°€ì§ˆë¬¸</span>`;
            } else if(t.status === 'analyzing' || t.status === 'processing' || t.status === 'InProgress' || t.status === 'progress') {
                stBadge = `<span style="font-size:10px; background:#e6f7ff; color:#096dd9; padding:2px 4px; border-radius:3px;">ë‹µë³€ëŒ€ê¸°</span>`;
            }

            const html = `
                <div class="task-card ${cardClass}">
                    <div class="t-header">
                        <span class="t-dday">${dDayText} ${stBadge}</span>
                        <span>~ ${new Date(t.date).toLocaleDateString()}</span>
                    </div>
                    <div class="t-title">${t.title}</div>
                    <div class="t-info">${t.client}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    window.filterCompanies = function() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allGroups.filter(g => g.name.toLowerCase().includes(val) || g.bizNum.includes(val));
        renderTree(filtered);
    }

    window.toggleGroup = function(header) {
        header.classList.toggle('active');
        const content = header.nextElementSibling;
        content.style.display = content.style.display === "block" ? "none" : "block";
    }
</script>

</body>
</html>
