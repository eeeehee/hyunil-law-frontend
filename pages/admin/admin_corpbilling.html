<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­êµ¬ì„œ/ì˜ìˆ˜ì¦ ìë™í™” ì„¼í„° - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }

        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 30px; padding-left: 10px; color: #fff; letter-spacing: 1px; }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        .main-content { flex: 1; margin-left: 260px; padding: 40px; }
        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; }

        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e5e5e5; }
        .stat-label { font-size: 12px; color: #888; font-weight: 600; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1a1a1a; }
        .text-blue { color: #2c5bf2; }
        .text-green { color: #52c41a; }
        .text-red { color: #ff4d4f; }

        .toolbar-box { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e5e5e5; margin-bottom: 20px; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .filter-item { display: flex; flex-direction: column; gap: 6px; }
        .filter-label { font-size: 12px; font-weight: 700; color: #555; }
        .input-control { height: 40px; border: 1px solid #ddd; border-radius: 6px; padding: 0 12px; min-width: 160px; font-size: 13px; }
        .btn-search { height: 40px; padding: 0 20px; background: #1a1a2e; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .btn-manual { height: 40px; padding: 0 20px; background: #2c5bf2; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-left: auto; }
        .btn-manual:hover { background: #1b44c9; }

        .table-container { background: #fff; border-radius: 12px; border: 1px solid #e5e5e5; overflow: hidden; }
        .billing-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .billing-table th { background: #f9fafb; padding: 15px; text-align: left; font-weight: 600; color: #555; border-bottom: 1px solid #eee; }
        .billing-table td { padding: 15px; border-bottom: 1px solid #f0f0f0; color: #333; vertical-align: middle; }
        .billing-table tr:hover { background: #f8f9fa; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; display: inline-block; }
        .bd-bill { background: #e6f7ff; color: #096dd9; border: 1px solid #91d5ff; }
        .bd-receipt { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-box { background: #fff; width: 550px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #333; }
        .close-modal { float: right; font-size: 24px; cursor: pointer; color: #999; }

        .form-row { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 13px; color: #555; }
        .form-input { width: 100%; height: 42px; border: 1px solid #ddd; border-radius: 6px; padding: 0 12px; }
        .form-textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; resize: vertical; }
        .btn-full { width: 100%; height: 50px; background: #2c5bf2; color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 10px; }
        .btn-full:hover { background: #1b44c9; }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="sidebar-brand">ADMINISTRATOR</div>
    <ul class="sidebar-menu">
        <li>
            <div class="menu-category open active" onclick="toggleAdminMenu('groupCorp', this)">
                <div><span class="menu-icon">ğŸ¢</span> ê¸°ì—…ìë¬¸ì„¼í„°</div>
                <span class="menu-arrow">â–¼</span>
            </div>
            <ul id="groupCorp" class="submenu" style="display:block;">
                <li><a href="admin.html">ğŸ“ ìë¬¸ ê´€ë¦¬ (ì „ì²´)</a></li>
                <li><a href="admin_requests.html">ğŸ“© ìš”ì²­ ê´€ë¦¬í•¨</a></li>
                <li><a href="admin_report.html">ğŸ“Š ë¦¬í¬íŠ¸ ë°œì†¡</a></li>
                <li><a href="admin_corpbilling.html" class="active">ğŸ’¸ ìë¬¸ë£Œ ì²­êµ¬/ë°œì†¡</a></li>
                <li><a href="admin_members.html">ğŸ‘¥ íšŒì›/ê¸°ì—… ê´€ë¦¬</a></li>
                <li><a href="admin_payments.html">ğŸ’³ ë§¤ì¶œ/CMS ê´€ë¦¬</a></li>
            </ul>
        </li>

        <li>
            <div class="menu-category" onclick="toggleAdminMenu('groupLitigation', this)">
                <div><span class="menu-icon">âš–ï¸</span> ì „ìì†Œì†¡/ì‚¬ê±´</div>
                <span class="menu-arrow">â–¼</span>
            </div>
            <ul id="groupLitigation" class="submenu">
                <li><a href="admin_litigation.html">ğŸ” ì „ìì†Œì†¡ ë°ì´í„° í™•ì¸</a></li>
                <li><a href="admin_clients.html">ğŸ“‡ ë‹¹ì‚¬ì(ê³ ê°) ê´€ë¦¬</a></li>
            </ul>
        </li>

        <li>
            <div class="menu-category" onclick="toggleAdminMenu('groupSpecial', this)">
                <div><span class="menu-icon">ğŸ“</span> íŒŒì‚°/ì¶”ì‹¬ ì„¼í„°</div>
                <span class="menu-arrow">â–¼</span>
            </div>
            <ul id="groupSpecial" class="submenu">
                <li><a href="admin_collection_consult.html">ğŸ’° ì±„ê¶Œ ì¶”ì‹¬ ìƒë‹´</a></li>
                <li><a href="admin_collection.html">ğŸ’° ì±„ê¶Œ ì¶”ì‹¬ ì‚¬ê±´</a></li>
                <li><a href="admin_pasan_consult.html">ğŸ“‰ íŒŒì‚°/íšŒìƒ ìƒë‹´</a></li>
                <li><a href="admin_pasan.html">ğŸ“‰ íŒŒì‚°/íšŒìƒ ì‚¬ê±´</a></li>
            </ul>
        </li>

        <li class="menu-divider"></li>

        <li><a href="admin_settings.html" class="menu-link">âš™ï¸ í™˜ê²½ ì„¤ì •</a></li>
        <li class="menu-divider"></li>
        <li><a href="../../index.html" class="menu-link">ğŸ¢ ê¸°ì—…ìë¬¸ í™ˆí˜ì´ì§€</a></li>
        <li><a href="../user/dashboard.html" class="menu-link" style="color:#2c5bf2; font-weight:700;">ğŸ–¥ï¸ ê¸°ì—…ìë¬¸ ì‚¬ìš©ì ëª¨ë“œ</a></li>
    </ul>
</nav>

<script>
    function toggleAdminMenu(id, header) {
        const submenu = document.getElementById(id);
        if(!submenu) return;
        if (submenu.style.display === "block") { submenu.style.display = "none"; header.classList.remove("open"); header.classList.remove("active"); }
        else { submenu.style.display = "block"; header.classList.add("open"); header.classList.add("active"); }
    }
</script>

<main class="main-content">
    <h2 class="page-title">ì²­êµ¬ì„œ ë° ì˜ìˆ˜ì¦ ìë™í™” ì„¼í„°</h2>
    <p style="color:#666; margin-bottom:20px;">ë©”ì¼ ë°œì†¡ í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê³  ìˆ˜ë™ ì²­êµ¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-label">ì´ë²ˆë‹¬ ë°œì†¡ëœ ì²­êµ¬ì„œ</div>
            <div class="stat-value text-blue" id="statBillCount">0 ê±´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì´ë²ˆë‹¬ ë°œì†¡ëœ ì˜ìˆ˜ì¦</div>
            <div class="stat-value text-green" id="statReceiptCount">0 ê±´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ë§¤ì¶œ ë¯¸ì—°ë™ ê±´</div>
            <div class="stat-value" id="statPendingCount">0 ê±´</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ë°œì†¡ ì‹¤íŒ¨ / ì˜¤ë¥˜</div>
            <div class="stat-value text-red" id="statFailCount">0 ê±´</div>
        </div>
    </div>

    <div class="toolbar-box">
        <div class="filter-item">
            <label class="filter-label">ê¸°ê°„ ì„¤ì • (Start)</label>
            <input type="date" id="filterStart" class="input-control">
        </div>
        <div class="filter-item">
            <label class="filter-label">ê¸°ê°„ ì„¤ì • (End)</label>
            <input type="date" id="filterEnd" class="input-control">
        </div>
        <div class="filter-item">
            <label class="filter-label">ê¸°ì—…ëª… ê²€ìƒ‰</label>
            <input type="text" id="searchCompany" class="input-control" placeholder="ê¸°ì—…ëª… ì…ë ¥">
        </div>
        <div class="filter-item">
            <label class="filter-label">&nbsp;</label>
            <button class="btn-search" onclick="loadBillingHistory()">ì¡°íšŒí•˜ê¸°</button>
        </div>
        <button class="btn-manual" onclick="openManualModal()">âœ‰ï¸ ìˆ˜ë™ ì²­êµ¬ì„œ ì‘ì„±</button>
    </div>

    <div class="table-container">
        <table class="billing-table">
            <thead>
                <tr>
                    <th>ë°œì†¡ ì¼ì‹œ</th>
                    <th>ìœ í˜•</th>
                    <th>ê¸°ì—…ëª… (ìˆ˜ì‹ ì)</th>
                    <th>ì œëª©</th>
                    <th>ê¸ˆì•¡ (ì›)</th>
                    <th>ë§¤ì¶œì¥ë¶€ ì—°ë™</th>
                    <th>ë°œì†¡ ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="billingListBody">
                <tr><td colspan="7" style="text-align:center; padding:50px; color:#888;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<div id="manualModal" class="modal-overlay">
    <div class="modal-box">
        <h3 class="modal-title">âœ‰ï¸ ìˆ˜ë™ ì²­êµ¬ì„œ ì‘ì„± ë° ë°œì†¡ <span class="close-modal" onclick="closeModal()">âœ•</span></h3>

        <div class="form-row">
            <label class="form-label">ìˆ˜ì‹  ê¸°ì—…ëª…</label>
            <input type="text" id="manualCompany" class="form-input" placeholder="ê¸°ì—…ëª… ì…ë ¥">
        </div>

        <div class="form-row">
            <label class="form-label">ìˆ˜ì‹  ì´ë©”ì¼</label>
            <input type="email" id="manualEmail" class="form-input" placeholder="example@company.com">
        </div>

        <div class="form-row" style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label class="form-label">ì²­êµ¬ ìœ í˜•</label>
                <select id="manualType" class="form-input">
                    <option value="BILL">ì²­êµ¬ì„œ (Invoice)</option>
                    <option value="RECEIPT">ì˜ìˆ˜ì¦ (Receipt)</option>
                </select>
            </div>
            <div style="flex:1;">
                <label class="form-label">ì²­êµ¬ ê¸ˆì•¡ (ì›)</label>
                <input type="text" id="manualAmount" class="form-input" placeholder="ìˆ«ìë§Œ ì…ë ¥" oninput="formatCurrency(this)">
            </div>
        </div>

        <div class="form-row">
            <label class="form-label">ë¬¸ì„œ ì œëª©</label>
            <input type="text" id="manualTitle" class="form-input" placeholder="ì˜ˆ: 12ì›” ì¶”ê°€ ìë¬¸ë£Œ ì²­êµ¬ì˜ ê±´">
        </div>

        <div class="form-row">
            <label class="form-label">ìƒì„¸ ë‚´ìš© (ë©”ì¼ ë³¸ë¬¸/ë¹„ê³ )</label>
            <textarea id="manualNote" class="form-textarea" placeholder="ì²­êµ¬ ìƒì„¸ ë‚´ìš© ë˜ëŠ” ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        </div>

        <div style="background:#f0f7ff; padding:10px; border-radius:6px; font-size:12px; color:#096dd9; margin-bottom:15px;">
            â„¹ï¸ <strong>ìë™ ì—°ë™:</strong> ë°œì†¡ ì™„ë£Œ ì‹œ, í•´ë‹¹ ë‚´ìš©ì„ ë§¤ì¶œ ì¥ë¶€(CMS ê´€ë¦¬)ì— ìë™ ë“±ë¡í• ì§€ ë¬¼ì–´ë´…ë‹ˆë‹¤.
        </div>

        <button class="btn-full" onclick="sendManualInvoice()">ë°œì†¡í•˜ê¸°</button>
    </div>
</div>

<script type="module">
    import { users, billing, admin } from '/js/api.js';

    // ë¡œê·¸ì¸ í™•ì¸
    const token = localStorage.getItem('auth_token');
    if (!token) {
        location.href = '../public/login.html';
    }

    // ê¶Œí•œ í™•ì¸ ë° ì´ˆê¸°í™”
    (async () => {
        try {
            const userData = await users.getMe();
            const adminRoles = ['master', 'admin'];
            if (!adminRoles.includes(userData.role)) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                location.href = '../user/dashboard.html';
                return;
            }

            initDateFilter();
            await updateStats();
            await loadBillingHistory();
        } catch (error) {
            console.error('ì´ˆê¸°í™” ì—ëŸ¬:', error);
            alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            location.href = '../public/login.html';
        }
    })();

    function initDateFilter() {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2,'0');
        document.getElementById('filterStart').value = `${y}-${m}-01`;
        document.getElementById('filterEnd').value = today.toISOString().split('T')[0];
    }

    async function updateStats() {
        try {
            const stats = await billing.getStats();
            document.getElementById('statBillCount').innerText = (stats.billCount || 0) + ' ê±´';
            document.getElementById('statReceiptCount').innerText = (stats.receiptCount || 0) + ' ê±´';
            document.getElementById('statPendingCount').innerText = (stats.pendingCount || 0) + ' ê±´';
            document.getElementById('statFailCount').innerText = (stats.failCount || 0) + ' ê±´';
        } catch (error) {
            console.error('í†µê³„ ì¡°íšŒ ì—ëŸ¬:', error);
        }
    }

    window.loadBillingHistory = async function() {
        const tbody = document.getElementById('billingListBody');
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>`;

        const startDate = document.getElementById('filterStart').value;
        const endDate = document.getElementById('filterEnd').value;
        const companyName = document.getElementById('searchCompany').value;

        try {
            const params = {};
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            if (companyName) params.companyName = companyName;

            const data = await billing.getLogs(params);
            const logs = data.logs || [];

            let html = "";

            logs.forEach(d => {
                const date = new Date(d.sentAt).toLocaleString();
                const typeBadge = d.type === 'BILL'
                    ? `<span class="badge bd-bill">ì²­êµ¬ì„œ</span>`
                    : `<span class="badge bd-receipt">ì˜ìˆ˜ì¦</span>`;

                const statusText = d.status === 'sent' ? 'âœ… ë°œì†¡ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';
                const linkedText = d.linkedToPayment
                    ? `<span style="color:#52c41a; font-weight:bold;">âœ” ì—°ë™ë¨</span>`
                    : `<span style="color:#999;">ë¯¸ì—°ë™</span>`;

                html += `<tr>
                    <td>${date}</td>
                    <td>${typeBadge}</td>
                    <td style="font-weight:bold;">${d.companyName}</td>
                    <td>${d.title}</td>
                    <td style="font-weight:700;">${Number(d.amount).toLocaleString()}ì›</td>
                    <td>${linkedText}</td>
                    <td>${statusText}</td>
                </tr>`;
            });

            if(html === "") html = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#888;">ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            tbody.innerHTML = html;

        } catch(e) {
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
        }
    }

    window.openManualModal = function() {
        document.getElementById('manualCompany').value = '';
        document.getElementById('manualEmail').value = '';
        document.getElementById('manualAmount').value = '';
        document.getElementById('manualTitle').value = '';
        document.getElementById('manualNote').value = '';
        document.getElementById('manualModal').style.display = 'flex';
    }

    window.closeModal = function() {
        document.getElementById('manualModal').style.display = 'none';
    }

    window.sendManualInvoice = async function() {
        const companyName = document.getElementById('manualCompany').value;
        const email = document.getElementById('manualEmail').value;
        const type = document.getElementById('manualType').value;
        const amtStr = document.getElementById('manualAmount').value.replace(/,/g,'');
        const title = document.getElementById('manualTitle').value;
        const note = document.getElementById('manualNote').value;

        if(!companyName || !email || !amtStr || !title) {
            alert("í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        const amount = Number(amtStr);

        if(!confirm(`[${companyName}] ì•ìœ¼ë¡œ ë©”ì¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            let registerToPayment = false;

            if(type === 'BILL') {
                registerToPayment = confirm(`ë§¤ì¶œ/CMS ê´€ë¦¬ í˜ì´ì§€(ì¥ë¶€)ì—\n'${title}' ê±´ì„ 'ì²­êµ¬ë¨(Scheduled)' ìƒíƒœë¡œ ìë™ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì´ë¯¸ ë“±ë¡í–ˆë‹¤ë©´ 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ì„¸ìš”)`);
            } else if (type === 'RECEIPT') {
                registerToPayment = confirm(`ì˜ìˆ˜ì¦ ë°œì†¡ ê±´ì…ë‹ˆë‹¤. ë§¤ì¶œ ì¥ë¶€ì— 'ê²°ì œì™„ë£Œ(Paid)' ìƒíƒœë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            }

            await billing.sendAndRegister({
                companyName,
                email,
                type,
                amount,
                title,
                note,
                registerToPayment
            });

            alert("âœ… ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeModal();
            loadBillingHistory();
            updateStats();

        } catch(e) {
            console.error(e);
            alert("ë°œì†¡ ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    }

    window.formatCurrency = function(e) {
        e.value = e.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
</script>

</body>
</html>
