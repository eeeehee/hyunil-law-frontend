<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ìš”ì²­ ê´€ë¦¬í•¨ - ADMIN</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size: 14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 20px; padding-left: 10px; color: #fff; letter-spacing: 1px; }

        /* ì‚¬ìš©ì í”„ë¡œí•„ ì˜ì—­ */
        .user-profile-area { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.15); }
        .user-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .user-email { font-size: 11px; color: #b0b0b0; margin-bottom: 8px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-master { background: #722ed1; color: #fff; }
        .badge-admin { background: #2c5bf2; color: #fff; }
        .badge-general_manager { background: #52c41a; color: #fff; }
        .badge-lawyer { background: #fa8c16; color: #fff; }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; padding: 40px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; margin: 0; }
        .btn-toggle-archived { padding: 10px 18px; background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px; color: #666; transition: 0.2s; }
        .btn-toggle-archived:hover { background: #f5f5f5; border-color: #bbb; }
        .btn-toggle-archived.active { background: #2c5bf2; color: #fff; border-color: #2c5bf2; }

        /* íƒ­ ë©”ë‰´ */
        .tab-menu { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 30px; gap: 20px; }
        .tab-btn { padding: 15px 10px; cursor: pointer; font-size: 15px; font-weight: 700; color: #888; border-bottom: 2px solid transparent; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .tab-btn:hover { color: #555; }
        .tab-btn.active { color: #2c5bf2; border-bottom-color: #2c5bf2; }
        .badge-count { background: #ff4d4f; color: #fff; font-size: 11px; padding: 2px 6px; border-radius: 10px; font-weight: 700; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .req-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .req-table th, .req-table td { padding: 18px 15px; text-align: left; border-bottom: 1px solid #f5f5f5; font-size: 14px; vertical-align: middle; }
        .req-table th { background-color: #fafafa; font-weight: 700; color: #666; border-bottom: 2px solid #eee; }
        .req-table tr:hover { background-color: #f9f9f9; }

        /* ìƒíƒœ ë°°ì§€ */
        .st-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700; display: inline-block; }
        .st-waiting { background: #fff7e6; color: #fa8c16; border: 1px solid #ffe7ba; }
        .st-quoted { background: #e6f7ff; color: #096dd9; border: 1px solid #91d5ff; }
        .st-approved { background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; }
        .st-rejected { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
        .st-change { background: #f9f0ff; color: #722ed1; border: 1px solid #d3adf7; }
        .st-member { background: #f0f5ff; color: #2f54eb; border: 1px solid #adc6ff; }
        .st-dept { background: #fff0f6; color: #c41d7f; border: 1px solid #ffadd2; }
        .st-progress { background: #f9f0ff; color: #722ed1; border: 1px solid #d3adf7; }

        /* ì•¡ì…˜ ë²„íŠ¼ë“¤ */
        .btn-action { padding: 6px 12px; border-radius: 4px; border: none; font-weight: 700; cursor: pointer; font-size: 13px; transition: 0.2s; margin-right: 5px; }
        .btn-approve { background: #2c5bf2; color: #fff; }
        .btn-approve:hover { background: #1b42c4; }
        .btn-reject { background: #fff; border: 1px solid #ddd; color: #555; }
        .btn-reject:hover { background: #f5f5f5; }

        .quote-input { width: 100px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; margin-right: 5px; text-align: right; outline: none; }
        .quote-input:focus { border-color: #2c5bf2; }

        /* íƒ­ ì»¨í…ì¸  ì œì–´ */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
            padding: 15px 0;
        }
        .pagination-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 10px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #bbb;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: #2c5bf2;
            color: #fff;
            border-color: #2c5bf2;
        }
        .pagination-info {
            margin: 0 15px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>

    <!-- ì‚¬ì´ë“œë°” -->
    
    <!-- ì‚¬ì´ë“œë°”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->

    <script src="../../js/admin_sidebar.js"></script>
    <script>
        // ì‚¬ì´ë“œë°” ì¦‰ì‹œ ë Œë”ë§
        if (typeof renderAdminSidebar === 'function') {
            renderAdminSidebar();
        }
    </script>

    <main class="main-content">
        <div class="page-header">
            <h2 class="page-title">ğŸ“© í†µí•© ìš”ì²­ ê´€ë¦¬í•¨</h2>
            <button class="btn-toggle-archived" id="btnToggleArchived" onclick="toggleArchivedView()">
                ğŸ“¦ ìˆ¨ê¸´ ë‚´ì—­ ë³´ê¸°
            </button>
        </div>

        <div class="tab-menu">
            <div class="tab-btn active" id="btn-consult" onclick="switchTab('consult')">
                âœï¸ ìë¬¸ ì‹ ì²­ (ì ‘ìˆ˜ëŒ€ê¸°) <span class="badge-count" id="cnt-consult">0</span>
            </div>
            <div class="tab-btn" id="btn-payment" onclick="switchTab('payment')">
                ğŸ’³ ê²°ì œ/ìš”ê¸ˆì œ ë³€ê²½ <span class="badge-count" id="cnt-payment">0</span>
            </div>
            <div class="tab-btn" id="btn-member" onclick="switchTab('member')">
                ğŸ‘¥ ì§ì› ê¶Œí•œ ìš”ì²­ <span class="badge-count" id="cnt-member">0</span>
            </div>
            <div class="tab-btn" id="btn-guest" onclick="switchTab('guest')">
                ğŸ“ ë¹„íšŒì› ìƒë‹´ <span class="badge-count" id="cnt-guest">0</span>
            </div>
        </div>

        <div id="tab-consult" class="tab-content active">
            <table class="req-table">
                <thead><tr><th>ìƒíƒœ</th><th>ê¸°ì—…ëª… (ì‹ ì²­ì)</th><th>ìš”ì²­ ë‚´ìš©</th><th>ì‹ ì²­ì¼</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="list-consult">
                    <tr><td colspan="5" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
            <div id="pagination-consult" class="pagination-container"></div>
        </div>

        <div id="tab-payment" class="tab-content">
            <table class="req-table">
                <thead>
                    <tr>
                        <th width="10%">ìœ í˜•</th>
                        <th width="20%">ê¸°ì—…ëª… (ì‹ ì²­ì)</th>
                        <th>ìš”ì²­ ë‚´ìš©</th>
                        <th width="15%">ê¸ˆì•¡/ìƒíƒœ</th>
                        <th width="25%">ê´€ë¦¬ Action</th>
                    </tr>
                </thead>
                <tbody id="list-payment">
                    <tr><td colspan="5" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
            <div id="pagination-payment" class="pagination-container"></div>
        </div>

        <div id="tab-member" class="tab-content">
            <table class="req-table">
                <thead>
                    <tr>
                        <th width="10%">ìœ í˜•</th>
                        <th width="20%">ì‹ ì²­ì (í˜„ì¬ ì •ë³´)</th>
                        <th>ë³€ê²½ ìš”ì²­ ë‚´ìš©</th>
                        <th width="15%">ì‹ ì²­ì¼</th>
                        <th width="20%">ìŠ¹ì¸ ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="list-member">
                    <tr><td colspan="5" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
            <div id="pagination-member" class="pagination-container"></div>
        </div>

        <div id="tab-guest" class="tab-content">
            <table class="req-table">
                <thead><tr><th>ìƒíƒœ</th><th>ì‹ ì²­ì (ì—°ë½ì²˜)</th><th>ë¬¸ì˜ ë‚´ìš©</th><th>ì‹ ì²­ì¼</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="list-guest">
                    <tr><td colspan="5" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
            <div id="pagination-guest" class="pagination-container"></div>
        </div>

    </main>

    <script type="module">
        import { auth, users, posts } from "../../js/api.js";

        // âœ… ìˆ¨ê¸´ ë‚´ì—­ ë³´ê¸° ìƒíƒœ ê´€ë¦¬
        let showArchivedMode = false;

        // âœ… í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ ê´€ë¦¬
        const ITEMS_PER_PAGE = 10;
        const paginationState = {
            consult: { currentPage: 1, totalPages: 1, data: [] },
            payment: { currentPage: 1, totalPages: 1, data: [] },
            member: { currentPage: 1, totalPages: 1, data: [] },
            guest: { currentPage: 1, totalPages: 1, data: [] }
        };

        // âœ… í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§ í•¨ìˆ˜
        function renderPagination(tabName, totalItems) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            paginationState[tabName].totalPages = totalPages;
            const currentPage = paginationState[tabName].currentPage;
            const container = document.getElementById(`pagination-${tabName}`);

            // 10ê°œ ì´í•˜ë©´ í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¹€
            if (totalItems <= ITEMS_PER_PAGE) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // ì´ì „ ë²„íŠ¼
            html += `<button class="pagination-btn" onclick="goToPage('${tabName}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>â—€</button>`;

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="goToPage('${tabName}', 1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-info">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage('${tabName}', ${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="pagination-info">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="goToPage('${tabName}', ${totalPages})">${totalPages}</button>`;
            }

            // ë‹¤ìŒ ë²„íŠ¼
            html += `<button class="pagination-btn" onclick="goToPage('${tabName}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>â–¶</button>`;

            // í˜ì´ì§€ ì •ë³´
            html += `<span class="pagination-info">${currentPage} / ${totalPages} í˜ì´ì§€</span>`;

            container.innerHTML = html;
        }

        // âœ… í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
        window.goToPage = function(tabName, page) {
            const state = paginationState[tabName];
            if (page < 1 || page > state.totalPages) return;

            state.currentPage = page;

            // íƒ­ë³„ë¡œ ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
            switch(tabName) {
                case 'consult':
                    renderConsultPage();
                    break;
                case 'payment':
                    renderPaymentPage();
                    break;
                case 'member':
                    renderMemberPage();
                    break;
                case 'guest':
                    renderGuestPage();
                    break;
            }
        }

        // âœ… í˜„ì¬ í˜ì´ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getCurrentPageData(tabName) {
            const state = paginationState[tabName];
            const start = (state.currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            return state.data.slice(start, end);
        }

        // âœ… ìˆ¨ê¸´ ë‚´ì—­ ë³´ê¸° í† ê¸€ í•¨ìˆ˜
        window.toggleArchivedView = async function() {
            showArchivedMode = !showArchivedMode;
            const btn = document.getElementById('btnToggleArchived');

            if (showArchivedMode) {
                btn.classList.add('active');
                btn.textContent = 'ğŸ“‹ ì¼ë°˜ ë‚´ì—­ ë³´ê¸°';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ğŸ“¦ ìˆ¨ê¸´ ë‚´ì—­ ë³´ê¸°';
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™”
            paginationState.consult.currentPage = 1;
            paginationState.payment.currentPage = 1;
            paginationState.member.currentPage = 1;
            paginationState.guest.currentPage = 1;

            // ëª¨ë“  íƒ­ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            await loadAllRequests();
        };

        // ============================================
        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        // ============================================
        function displayAdminUserInfo(user) {
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('adminUserName').textContent = user.managerName || user.manager_name || user.email || 'ê´€ë¦¬ì';
            document.getElementById('adminUserEmail').textContent = user.email || '';

            // ì—­í•  ë°°ì§€
            const roleElement = document.getElementById('adminUserRole');
            const roleMap = {
                'master': { label: 'MASTER', class: 'badge-master' },
                'admin': { label: 'ADMIN', class: 'badge-admin' },
                'general_manager': { label: 'GENERAL', class: 'badge-general_manager' },
                'lawyer': { label: 'LAWYER', class: 'badge-lawyer' }
            };

            const roleInfo = roleMap[user.role] || { label: user.role?.toUpperCase() || 'USER', class: 'badge-admin' };
            roleElement.textContent = roleInfo.label;
            roleElement.className = `user-role ${roleInfo.class}`;
        }

        // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
        document.getElementById('adminLogoutBtn')?.addEventListener('click', async function() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await auth.logout();
                location.href = '../../pages/public/login.html';
            }
        });

        // ê¶Œí•œ í™•ì¸ ë° ë°ì´í„° ë¡œë“œ
        (async () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                location.href = '../public/login.html';
                return;
            }

            try {
                const userData = await users.getMe();
                console.log('ğŸ” [ìš”ì²­ ê´€ë¦¬í•¨] ì‚¬ìš©ì ì •ë³´:', userData);

                // âœ… ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                displayAdminUserInfo(userData);

                const adminRoles = ['master', 'admin', 'general_manager', 'lawyer'];
                if (!adminRoles.includes(userData.role)) {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ê¶Œí•œ: ' + userData.role);
                    location.href = '../user/dashboard.html';
                    return;
                }

                // âœ… ë³€í˜¸ì‚¬ ê¶Œí•œì¼ ê²½ìš° íŠ¹ì • ë©”ë‰´ ìˆ¨ê¹€
                if (userData.role === 'lawyer') {
                    const hideMenus = [
                        'admin_report.html',
                        'admin_corpbilling.html',
                        'admin_members.html',
                        'admin_payments.html'
                    ];

                    hideMenus.forEach(menuFile => {
                        const menuLink = document.querySelector(`a[href="${menuFile}"]`);
                        if (menuLink) {
                            menuLink.parentElement.style.display = 'none';
                        }
                    });
                }

                await loadAllRequests();

            } catch (error) {
                console.error('ê¶Œí•œ í™•ì¸ ì—ëŸ¬:', error);
                alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                location.href = '../public/login.html';
            }
        })();

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('btn-' + tabName).classList.add('active');
        }

        // ëª¨ë“  ìš”ì²­ ë°ì´í„° ë¡œë“œ
        async function loadAllRequests() {
            await Promise.all([
                loadConsultRequests(),
                loadPaymentRequests(),
                loadMemberRequests(),
                loadGuestRequests()
            ]);
        }

        // 1. ê²°ì œ/ìš”ê¸ˆì œ ë³€ê²½ ìš”ì²­ ë¡œë“œ
        async function loadPaymentRequests() {
            try {
                const categories = ['payment_request', 'plan_change', 'payment_method', 'extra_usage_quote'];
                const results = await Promise.all(
                    categories.map(cat => posts.getAll({ category: cat, limit: 200 }))
                );
                const map = new Map();
                results.forEach(r => (r.posts || []).forEach(p => {
                    if (showArchivedMode) {
                        if (p.status === 'archived') map.set(p.docId, p);
                    } else {
                        if (p.status !== 'archived') map.set(p.docId, p);
                    }
                }));
                const list = Array.from(map.values()).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                paginationState.payment.data = list;
                document.getElementById('cnt-payment').innerText = list.length;
                paginationState.payment.currentPage = 1;
                renderPaymentPage();
                renderPagination('payment', list.length);

            } catch (error) {
                console.error('ê²°ì œ/ìš”ê¸ˆì œ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('list-payment').innerHTML =
                    `<tr><td colspan="5" style="text-align:center; color:red; padding:30px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
            }
        }

        // âœ… ê²°ì œ/ìš”ê¸ˆì œ í˜ì´ì§€ ë Œë”ë§ í•¨ìˆ˜
        function renderPaymentPage() {
            const pageData = getCurrentPageData('payment');
            const tbody = document.getElementById('list-payment');

            // ìš”ê¸ˆì œ ê¸ˆì•¡ ë§¤í•‘
            const PLANS = {
                'Basic': { price: 290000 },
                'Standard': { price: 390000 },
                'Premium': { price: 590000 },
                'Business': { price: 990000 }
            };

            tbody.innerHTML = pageData.map(d => {
                let badge = '';
                let descHtml = '';
                let priceText = '-';
                let statusHtml = '';
                let actionHtml = '';

                // âœ… ìˆ¨ê¸´ ë‚´ì—­ì¸ ê²½ìš° ë³µì› ë²„íŠ¼ë§Œ í‘œì‹œ
                if (showArchivedMode && d.status === 'archived') {
                    badge = '<span class="st-badge" style="background:#e0e0e0; color:#666;">ğŸ“¦ ìˆ¨ê¹€</span>';
                    descHtml = d.title || d.content || '(ë‚´ìš© ì—†ìŒ)';

                    // ì›ë˜ ìƒíƒœ í‘œì‹œ
                    const originalStatus = d.previousStatus || d.status;
                    const statusLabel = originalStatus === 'done' ? 'ì™„ë£Œ' :
                                      originalStatus === 'completed' ? 'ì²˜ë¦¬ì™„ë£Œ' :
                                      originalStatus === 'approved' ? 'ìŠ¹ì¸ë¨' :
                                      originalStatus === 'quoted' ? 'ê²¬ì ë°œì†¡' :
                                      originalStatus === 'pending' ? 'ì ‘ìˆ˜' : originalStatus;
                    statusHtml = `<span style="color:#888;">ì›ë˜: ${statusLabel}</span>`;

                    actionHtml = `<button class="btn-action btn-approve" onclick="unarchiveRequest('${d.docId}')">ë³µì›</button>`;

                    const userName = d.userManagerName || d.managerName || '-';
                    const company = d.companyName || d.userCompanyName || '-';
                    const created = d.createdAt ? new Date(d.createdAt).toLocaleString() : '-';

                    return `
                        <tr style="opacity:0.6;">
                            <td>${badge}</td>
                            <td>
                                <div style="font-weight:700;">${company}</div>
                                <div style="color:#888; font-size:12px;">ë‹´ë‹¹: ${userName}</div>
                            </td>
                            <td>${descHtml}</td>
                            <td>
                                <div>${priceText}</div>
                                <div style="font-size:12px; color:#888;">${created}</div>
                                ${statusHtml}
                            </td>
                            <td>${actionHtml}</td>
                        </tr>
                    `;
                }

                // ìœ í˜• ë°°ì§€/ì„¤ëª…
                if (d.category === 'plan_change') {
                    badge = '<span class="st-badge st-change">ìš”ê¸ˆì œ ë³€ê²½</span>';

                    // title ë˜ëŠ” contentì—ì„œ ëª©í‘œ ìš”ê¸ˆì œ ì¶”ì¶œ
                    let targetPlan = '';
                    const m = (d.title || '').match(/ë³€ê²½\s*:\s*(.+)$/);
                    targetPlan = m ? m[1] : (d.title || '');

                    descHtml = `ìš”ê¸ˆì œ ë³€ê²½: <strong>${targetPlan || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong>`;
                    const planPrice = PLANS[targetPlan]?.price || 0;
                    priceText = planPrice > 0 ? `${planPrice.toLocaleString()}ì›` : '-';

                    if (d.status === 'done' || d.status === 'completed') {
                        statusHtml = `<span style="color:#52c41a; font-weight:700;">ë³€ê²½ì™„ë£Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else if (d.status === 'cancelled') {
                        statusHtml = `<span style="color:#ff4d4f; font-weight:700;">ì‚¬ìš©ì ì·¨ì†Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else {
                        statusHtml = `<span style="color:#722ed1; font-weight:700;">ìŠ¹ì¸ ëŒ€ê¸°</span>`;
                        actionHtml = `
                            <button class="btn-action btn-approve" onclick="approvePlanChange('${d.docId}', '${d.authorUid}', '${targetPlan}')">ìŠ¹ì¸</button>
                            <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                        `;
                    }
                } else if (d.category === 'payment_method') {
                    badge = '<span class="st-badge st-pay">ê²°ì œìˆ˜ë‹¨</span>';
                    descHtml = `ê²°ì œìˆ˜ë‹¨ ë“±ë¡ ìš”ì²­`;

                    if (d.status === 'done' || d.status === 'completed') {
                        statusHtml = `<span style="color:#52c41a; font-weight:700;">ì²˜ë¦¬ì™„ë£Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else if (d.status === 'cancelled') {
                        statusHtml = `<span style="color:#ff4d4f; font-weight:700;">ì‚¬ìš©ì ì·¨ì†Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else {
                        statusHtml = `<span style="color:#1890ff; font-weight:700;">ì ‘ìˆ˜</span>`;
                        actionHtml = `
                            <button class="btn-action btn-approve" onclick="markAsCompleted('${d.docId}')">ì²˜ë¦¬ì™„ë£Œ</button>
                            <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                        `;
                    }
                } else if (d.category === 'extra_usage_quote') {
                    badge = '<span class="st-badge st-change">ğŸ’¸ ì¶”ê°€ì´ìš©ê²¬ì </span>';
                    descHtml = `ì¶”ê°€ ì´ìš©/ê²¬ì  ìš”ì²­`;
                    // ê²¬ì  ê¸ˆì•¡ í‘œì‹œ (ê´€ë¦¬ì ë°œì†¡ í›„)
                    const quoted = (d.quotedPrice ?? d.quotePrice);
                    priceText = quoted ? `${Number(quoted).toLocaleString()}ì›` : '-';

                    // ìƒíƒœë³„ í‘œì‹œ
                    if (d.status === 'done' || d.status === 'completed') {
                        statusHtml = `<span style="color:#52c41a; font-weight:700;">ì²˜ë¦¬ì™„ë£Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else if (d.status === 'quoted') {
                        statusHtml = `<span style="color:#fa8c16; font-weight:700;">ê²¬ì  í™•ì¸ì¤‘</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="cancelQuoteByAdmin('${d.docId}')">ì·¨ì†Œ</button>`;
                    } else if (d.status === 'approved') {
                        statusHtml = `<span style="color:#52c41a; font-weight:700;">âœ“ ìŠ¹ì¸ë¨</span>`;
                        actionHtml = `
                            <button class="btn-action btn-approve" onclick="markAsCompleted('${d.docId}')">ì²˜ë¦¬ì™„ë£Œ</button>
                            <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                        `;
                    } else if (d.status === 'rejected') {
                        statusHtml = `<span style="color:#ff4d4f; font-weight:700;">âœ— ê±°ì ˆë¨</span>`;
                        actionHtml = `
                            <button class="btn-action btn-approve" onclick="markAsCompleted('${d.docId}')">í™•ì¸ì™„ë£Œ</button>
                            <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                        `;
                    } else if (d.status === 'cancelled') {
                        statusHtml = `<span style="color:#ff4d4f; font-weight:700;">ì‚¬ìš©ì ì·¨ì†Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else if (d.status === 'auto_cancelled') {
                        statusHtml = `<span style="color:#ff4d4f; font-weight:700;">ìë™ ì·¨ì†Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else if (d.status === 'admin_cancelled') {
                        statusHtml = `<span style="color:#ff4d4f; font-weight:700;">ê´€ë¦¬ì ì·¨ì†Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else {
                        statusHtml = `<span style="color:#1890ff; font-weight:700;">ì ‘ìˆ˜</span>`;
                        actionHtml = `<button class="btn-action btn-approve" onclick="openQuoteModal('${d.docId}')">ê²¬ì  ë°œì†¡</button>`;
                    }
                } else {
                    // payment_request ë“±
                    badge = '<span class="st-badge st-pay">ê²°ì œìš”ì²­</span>';
                    descHtml = d.title || 'ê²°ì œ ìš”ì²­';

                    if (d.status === 'done' || d.status === 'completed') {
                        statusHtml = `<span style="color:#52c41a; font-weight:700;">ì²˜ë¦¬ì™„ë£Œ</span>`;
                        actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else {
                        statusHtml = `<span style="color:#1890ff; font-weight:700;">ì ‘ìˆ˜</span>`;
                        actionHtml = `
                            <button class="btn-action btn-approve" onclick="markAsCompleted('${d.docId}')">ì²˜ë¦¬ì™„ë£Œ</button>
                            <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                        `;
                    }
                }

                const userName = d.userManagerName || d.managerName || '-';
                const company = d.companyName || d.userCompanyName || '-';
                const created = d.createdAt ? new Date(d.createdAt).toLocaleString() : '-';

                return `
                    <tr>
                        <td>${badge}</td>
                        <td>
                            <div style="font-weight:700;">${company}</div>
                            <div style="color:#888; font-size:12px;">ë‹´ë‹¹: ${userName}</div>
                        </td>
                        <td><a href="#" onclick="showRequestDetail('${d.docId}'); return false;" style="color:#1890ff; text-decoration:underline; cursor:pointer;">${descHtml}</a></td>
                        <td>
                            <div>${priceText}</div>
                            <div style="font-size:12px; color:#888;">${created}</div>
                            ${statusHtml}
                        </td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
            }).join('');

            renderPagination('payment', paginationState.payment.data.length);
        }



        // (FIX) ì¤‘ë³µ/ê¹¨ì§„ ê²°ì œìš”ì²­ ë Œë”ë§ ë¸”ë¡ ì œê±°ë¨

        async function loadConsultRequests() {
            try {
                // âœ… ìˆ¨ê¸´ ë‚´ì—­ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ ìƒíƒœ ì¡°íšŒ
                const result = await posts.getAll({ limit: 200 });
                let list = result.posts || [];

                // ê²°ì œ/ìš”ê¸ˆì œ/ë¶€ì„œë³€ê²½ ê´€ë ¨ ì¹´í…Œê³ ë¦¬ ì œì™¸ (ì „í™”ìƒë‹´ ìš”ì²­ì€ í¬í•¨)
                const excludeCategories = ['payment_request', 'plan_change', 'payment_method', 'extra_usage_quote', 'member_req', 'member_req_internal', 'member_req_admin'];
                list = list.filter(d => !excludeCategories.includes(d.category));

                // âœ… ìˆ¨ê¸´ ë‚´ì—­ ëª¨ë“œì— ë”°ë¼ í•„í„°ë§
                if (showArchivedMode) {
                    // ìˆ¨ê¸´ ë‚´ì—­ ëª¨ë“œ: archivedë§Œ
                    list = list.filter(d => d.status === 'archived');
                } else {
                    // ì¼ë°˜ ëª¨ë“œ: pending, waiting ìƒíƒœ + ì¶”ê°€ì§ˆë¬¸ì´ ìˆëŠ” analyzing ìƒíƒœ
                    list = list.filter(d => {
                        // pending, waitingì€ ë¬´ì¡°ê±´ í‘œì‹œ
                        if (d.status === 'pending' || d.status === 'waiting') {
                            return true;
                        }

                        // analyzing ìƒíƒœ ì¤‘ì—ì„œ ì¶”ê°€ì§ˆë¬¸ì´ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ
                        if (d.status === 'analyzing' || d.status === 'processing') {
                            const hasFollowup = d.content && d.content.includes('[FOLLOWUP_SEPARATOR]');
                            if (!hasFollowup) return false;

                            // ì¶”ê°€ì§ˆë¬¸ê³¼ ì¶”ê°€ë‹µë³€ ê°œìˆ˜ í™•ì¸
                            const questions = d.content.split('[FOLLOWUP_SEPARATOR]');
                            const followupCount = questions.length - 1;

                            let answerCount = 0;
                            if (d.answer && d.answer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
                                answerCount = d.answer.split('[FOLLOWUP_ANSWER_SEPARATOR]').length;
                            } else if (d.answer) {
                                answerCount = 1;
                            }

                            // ì¶”ê°€ì§ˆë¬¸ì´ ì¶”ê°€ë‹µë³€ë³´ë‹¤ ë§ìœ¼ë©´ ë‹µë³€ ëŒ€ê¸°ì¤‘
                            return followupCount > (answerCount - 1);
                        }

                        return false;
                    });
                }

                document.getElementById('cnt-consult').innerText = list.length;
                const tbody = document.getElementById('list-consult');

                if (list.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999; padding:30px;">ëŒ€ê¸° ì¤‘ì¸ ìë¬¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    return;
                }

                tbody.innerHTML = list.map(d => {
                    // âœ… ìˆ¨ê¸´ ë‚´ì—­ì¸ ê²½ìš° ë³µì› ë²„íŠ¼ë§Œ í‘œì‹œ
                    if (showArchivedMode && d.status === 'archived') {
                        const companyName = d.userCompanyName || d.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                        const authorName = d.userManagerName || d.managerName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                        const date = d.createdAt ? new Date(d.createdAt).toLocaleDateString('ko-KR') : '-';

                        return `
                            <tr style="opacity:0.6;">
                                <td><span class="st-badge" style="background:#e0e0e0; color:#666;">ğŸ“¦ ìˆ¨ê¹€</span></td>
                                <td>${companyName} (${authorName})</td>
                                <td>${d.title || 'ì œëª© ì—†ìŒ'}</td>
                                <td>${date}</td>
                                <td><button class="btn-action btn-approve" onclick="unarchiveRequest('${d.docId}')">ë³µì›</button></td>
                            </tr>
                        `;
                    }

                    // âœ… ì¶”ê°€ì§ˆë¬¸ ì—¬ë¶€ í™•ì¸
                    const hasFollowup = d.content && d.content.includes('[FOLLOWUP_SEPARATOR]');
                    let isFollowupWaiting = false;

                    if (hasFollowup) {
                        const questions = d.content.split('[FOLLOWUP_SEPARATOR]');
                        const followupCount = questions.length - 1;

                        let answerCount = 0;
                        if (d.answer && d.answer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
                            answerCount = d.answer.split('[FOLLOWUP_ANSWER_SEPARATOR]').length;
                        } else if (d.answer) {
                            answerCount = 1;
                        }

                        isFollowupWaiting = followupCount > (answerCount - 1);
                    }

                    // ì¹´í…Œê³ ë¦¬ì™€ ìƒíƒœì— ë”°ë¥¸ ë°°ì§€
                    let badge;
                    if (isFollowupWaiting) {
                        badge = '<span class="st-badge st-progress">ğŸ’¬ ì¶”ê°€ì§ˆë¬¸</span>';
                    } else if (d.category === 'phone_log') {
                        badge = '<span class="st-badge st-change">ğŸ“ ì „í™”ìƒë‹´ ê¸°ë¡</span>';
                    } else if (d.category === 'phone_request') {
                        badge = '<span class="st-badge st-change">ğŸ“ ì „í™”ìƒë‹´ ìš”ì²­</span>';
                    } else if (d.category === 'debt') {
                        badge = '<span class="st-badge st-waiting">ğŸ’¼ ì±„ë¬´</span>';
                    } else if (d.category === 'contract') {
                        badge = '<span class="st-badge st-waiting">ğŸ“„ ê³„ì•½</span>';
                    } else {
                        badge = '<span class="st-badge st-waiting">ğŸ“ ì„œë©´ìë¬¸</span>';
                    }

                    const date = d.createdAt ? new Date(d.createdAt).toLocaleDateString('ko-KR') : '-';

                    // ì‘ì„±ì ì •ë³´ (userCompanyNameê³¼ userManagerName ì‚¬ìš©)
                    const companyName = d.userCompanyName || d.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const authorName = d.userManagerName || d.managerName || 'ì•Œ ìˆ˜ ì—†ìŒ';

                    // ë²„íŠ¼ ê²°ì •: ì¶”ê°€ì§ˆë¬¸ì´ë©´ "ë‹µë³€ì‘ì„±", pending/waitingì´ë©´ "ì ‘ìˆ˜ ìŠ¹ì¸"
                    let actionButton = '';
                    if (isFollowupWaiting) {
                        actionButton = `<button class="btn-action btn-approve" onclick="goToAdminPage('${d.docId}')">ë‹µë³€ì‘ì„±</button>`;
                    } else if (d.status === 'pending' || d.status === 'waiting') {
                        actionButton = `<button class="btn-action btn-approve" onclick="acceptConsult('${d.docId}')">ì ‘ìˆ˜ ìŠ¹ì¸</button>`;
                    }

                    return `
                        <tr>
                            <td>${badge}</td>
                            <td>${companyName} (${authorName})</td>
                            <td><a href="#" onclick="showRequestDetail('${d.docId}'); return false;" style="color:#1890ff; text-decoration:underline; cursor:pointer;">${d.title || 'ì œëª© ì—†ìŒ'}</a></td>
                            <td>${date}</td>
                            <td>
                                ${actionButton}
                                <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                            </td>
                        </tr>`;
                }).join('');

            } catch (error) {
                console.error('ìë¬¸ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('list-consult').innerHTML =
                    `<tr><td colspan="5" style="text-align:center; color:red; padding:30px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
            }
        }

        // âœ… ìë¬¸ ìš”ì²­ í˜ì´ì§€ ë Œë”ë§ í•¨ìˆ˜
        function renderConsultPage() {
            const pageData = getCurrentPageData('consult');
            const tbody = document.getElementById('list-consult');

            tbody.innerHTML = pageData.map(d => {
                // âœ… ìˆ¨ê¸´ ë‚´ì—­ì¸ ê²½ìš° ë³µì› ë²„íŠ¼ë§Œ í‘œì‹œ
                if (showArchivedMode && d.status === 'archived') {
                    const companyName = d.userCompanyName || d.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const authorName = d.userManagerName || d.managerName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const date = d.createdAt ? new Date(d.createdAt).toLocaleDateString('ko-KR') : '-';

                    return `
                        <tr style="opacity:0.6;">
                            <td><span class="st-badge" style="background:#e0e0e0; color:#666;">ğŸ“¦ ìˆ¨ê¹€</span></td>
                            <td>${companyName} (${authorName})</td>
                            <td>${d.title || 'ì œëª© ì—†ìŒ'}</td>
                            <td>${date}</td>
                            <td><button class="btn-action btn-approve" onclick="unarchiveRequest('${d.docId}')">ë³µì›</button></td>
                        </tr>
                    `;
                }

                // âœ… ì¶”ê°€ì§ˆë¬¸ ì—¬ë¶€ í™•ì¸
                const hasFollowup = d.content && d.content.includes('[FOLLOWUP_SEPARATOR]');
                let isFollowupWaiting = false;

                if (hasFollowup) {
                    const questions = d.content.split('[FOLLOWUP_SEPARATOR]');
                    const followupCount = questions.length - 1;

                    let answerCount = 0;
                    if (d.answer && d.answer.includes('[FOLLOWUP_ANSWER_SEPARATOR]')) {
                        answerCount = d.answer.split('[FOLLOWUP_ANSWER_SEPARATOR]').length;
                    } else if (d.answer) {
                        answerCount = 1;
                    }

                    isFollowupWaiting = followupCount > (answerCount - 1);
                }

                // ì¹´í…Œê³ ë¦¬ì™€ ìƒíƒœì— ë”°ë¥¸ ë°°ì§€
                let badge;
                if (isFollowupWaiting) {
                    badge = '<span class="st-badge st-progress">ğŸ’¬ ì¶”ê°€ì§ˆë¬¸</span>';
                } else if (d.category === 'phone_log') {
                    badge = '<span class="st-badge st-change">ğŸ“ ì „í™”ìƒë‹´ ê¸°ë¡</span>';
                } else if (d.category === 'phone_request') {
                    badge = '<span class="st-badge st-change">ğŸ“ ì „í™”ìƒë‹´ ìš”ì²­</span>';
                } else if (d.category === 'debt') {
                    badge = '<span class="st-badge st-waiting">ğŸ’¼ ì±„ë¬´</span>';
                } else if (d.category === 'contract') {
                    badge = '<span class="st-badge st-waiting">ğŸ“„ ê³„ì•½</span>';
                } else {
                    badge = '<span class="st-badge st-waiting">ğŸ“ ì„œë©´ìë¬¸</span>';
                }

                const date = d.createdAt ? new Date(d.createdAt).toLocaleDateString('ko-KR') : '-';

                // ì‘ì„±ì ì •ë³´ (userCompanyNameê³¼ userManagerName ì‚¬ìš©)
                const companyName = d.userCompanyName || d.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const authorName = d.userManagerName || d.managerName || 'ì•Œ ìˆ˜ ì—†ìŒ';

                // ë²„íŠ¼ ê²°ì •: ì¶”ê°€ì§ˆë¬¸ì´ë©´ "ë‹µë³€ì‘ì„±", pending/waitingì´ë©´ "ì ‘ìˆ˜ ìŠ¹ì¸"
                let actionButton = '';
                if (isFollowupWaiting) {
                    actionButton = `<button class="btn-action btn-approve" onclick="goToAdminPage('${d.docId}')">ë‹µë³€ì‘ì„±</button>`;
                } else if (d.status === 'pending' || d.status === 'waiting') {
                    actionButton = `<button class="btn-action btn-approve" onclick="acceptConsult('${d.docId}')">ì ‘ìˆ˜ ìŠ¹ì¸</button>`;
                }

                return `
                    <tr>
                        <td>${badge}</td>
                        <td>${companyName} (${authorName})</td>
                        <td><a href="#" onclick="showRequestDetail('${d.docId}'); return false;" style="color:#1890ff; text-decoration:underline; cursor:pointer;">${d.title || 'ì œëª© ì—†ìŒ'}</a></td>
                        <td>${date}</td>
                        <td>
                            ${actionButton}
                            <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                        </td>
                    </tr>`;
            }).join('');

            renderPagination('consult', paginationState.consult.data.length);
        }

        // 3. ì§ì› ê¶Œí•œ ìš”ì²­ ë¡œë“œ (member_req, member_req_adminë§Œ - ëŒ€í‘œì ìŠ¹ì¸ ìš”ì²­ ì œì™¸)
        async function loadMemberRequests() {
            try {
                const categories = ['member_req', 'member_req_admin', 'member_req_internal'];
                const results = await Promise.all(
                    categories.map(cat => posts.getAll({ category: cat, limit: 200 }))
                );

                const map = new Map();
                results.forEach(r => (r.posts || []).forEach(p => {
                     if (showArchivedMode) {
                        if (p.status === 'archived') map.set(p.docId, p);
                    } else {
                        if (p.status !== 'archived') map.set(p.docId, p);
                    }
                }));
                const list = Array.from(map.values()).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                paginationState.member.data = list;
                document.getElementById('cnt-member').innerText = list.length;
                paginationState.member.currentPage = 1;
                renderMemberPage();
                renderPagination('member', list.length);

            } catch (error) {
                console.error('ì§ì› ê¶Œí•œ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('list-member').innerHTML =
                    `<tr><td colspan="5" style="text-align:center; color:red; padding:30px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
            }
        }

        // 4. ë¹„íšŒì› ìƒë‹´ ë¡œë“œ
        async function loadGuestRequests() {
            try {
                const results = await Promise.all([posts.getAll({ category: 'guest', limit: 200 })]);
                const map = new Map();
                results.forEach(r => (r.posts || []).forEach(p => {
                    if (showArchivedMode) {
                        if (p.status === 'archived') map.set(p.docId, p);
                    } else {
                        if (p.status !== 'archived') map.set(p.docId, p); // 'archiced' ì˜¤íƒ€ ìˆ˜ì •
                    }
                }));
                const list = Array.from(map.values()).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                paginationState.guest.data = list;
                document.getElementById('cnt-guest').innerText = list.length;
                paginationState.guest.currentPage = 1;
                renderGuestPage();
                renderPagination('guest', list.length);

            } catch (error) {
                console.error('ë¹„íšŒì› ìƒë‹´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('list-guest').innerHTML =
                    `<tr><td colspan="5" style="text-align:center; color:red; padding:30px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
            }
        }
        
        // âœ… 3. ì§ì› ê¶Œí•œ ìš”ì²­ í˜ì´ì§€ ë Œë”ë§ í•¨ìˆ˜ (ìœ í˜•-ìƒíƒœ ë¶„ë¦¬ ë° UI ê°œì„ )
        function renderMemberPage() {
            const pageData = getCurrentPageData('member');
            const tbody = document.getElementById('list-member');

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999; padding:30px;">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                renderPagination('member', 0);
                return;
            }

            tbody.innerHTML = pageData.map(d => {
                const date = d.createdAt ? new Date(d.createdAt).toLocaleDateString('ko-KR') : '-';
                const companyName = d.userCompanyName || d.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const authorName = d.userManagerName || d.managerName || 'ì•Œ ìˆ˜ ì—†ìŒ';

                // ìˆ¨ê¹€ ëª¨ë“œ ì²˜ë¦¬
                if (showArchivedMode && d.status === 'archived') {
                    return `
                        <tr style="opacity:0.6;">
                            <td><span class="st-badge" style="background:#e0e0e0; color:#666;">ğŸ“¦ ìˆ¨ê¹€</span></td>
                            <td>${companyName}<br>(${authorName})</td>
                            <td>(ìˆ¨ê¹€ ì²˜ë¦¬ëœ ìš”ì²­)</td>
                            <td>${date}</td>
                            <td><button class="btn-action btn-approve" onclick="unarchiveRequest('${d.docId}')">ë³µì›</button></td>
                        </tr>
                    `;
                }

                let typeBadgeText, typeBadgeClass, contentDisplay; // ìœ í˜• ê´€ë ¨
                let actionButtonsHtml = ''; // ì•¡ì…˜ ë²„íŠ¼
                let statusDisplayHtml = ''; // ìƒíƒœ í‘œì‹œ
                let managementColumnContent = ''; // ìµœì¢… 'ìŠ¹ì¸ ê´€ë¦¬' ì»¬ëŸ¼ ë‚´ìš©

                // ì¹´í…Œê³ ë¦¬ë³„ ë¶„ê¸° (ìœ í˜• ê²°ì • ë° ë‚´ìš© íŒŒì‹±)
                if (d.category === 'member_req_internal' || d.category === 'member_req_admin') {
                    typeBadgeText = 'ë¶€ì„œ/ì§ê¸‰ ë³€ê²½';
                    typeBadgeClass = 'st-dept';
                    try {
                        const parsed = JSON.parse(d.content || '{}');
                        contentDisplay = `
                            <strong>[From]</strong> ${parsed.fromDepartment || 'ë¯¸ì§€ì •'} &rarr; ${parsed.newDepartment || 'ë¯¸ì§€ì •'}<br>
                            <small style="color:#666;">ìš”ì²­ì: ${parsed.requesterName || 'ë¯¸ì§€ì •'} / ëŒ€ìƒ: ${parsed.requestTo === 'ceo' ? 'ëŒ€í‘œ' : 'ê´€ë¦¬ì'}</small>
                        `;
                        // íŒŒì¼ ì²¨ë¶€ ë§í¬ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                        let parsedFileUrl = null, parsedFileName = null;
                        if (parsed.fileUrl) {
                            parsedFileUrl = parsed.fileUrl;
                            parsedFileName = parsed.fileName || 'ì¦ë¹™ì„œë¥˜';
                        }
                        const finalFileUrl = parsedFileUrl || d.fileUrl;
                        if (finalFileUrl) {
                            const displayName = parsedFileName || 'ì¦ë¹™ì„œë¥˜';
                            contentDisplay += `<br><a href="${getApiBaseUrl().replace('/api', '')}${finalFileUrl}" target="_blank" style="color:#2c5bf2; font-weight:700; text-decoration:underline;">[ğŸ“„ ${displayName}]</a>`;
                        }

                    } catch (e) {
                        contentDisplay = d.content || 'ë‚´ìš© ì—†ìŒ';
                    }

                    // ìƒíƒœë³„ ê´€ë¦¬ ì»¬ëŸ¼ ë‚´ìš© êµ¬ì„±
                    if (d.status === 'completed' || d.status === 'approved') {
                        statusDisplayHtml = `<span style="color:#52c41a; font-weight:700;">ìŠ¹ì¸ë¨</span>`;
                        managementColumnContent = statusDisplayHtml + `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else if (d.status === 'rejected') {
                        statusDisplayHtml = `<span style="color:#ff4d4f; font-weight:700;">ê±°ì ˆë¨</span>`;
                        managementColumnContent = statusDisplayHtml + `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else { // pending
                        statusDisplayHtml = `<span style="color:#fa8c16; font-weight:700;">ëŒ€ê¸°ì¤‘</span>`;
                        actionButtonsHtml = `
                            <button class="btn-action btn-approve" onclick="approveDepartmentChange('${d.docId}')">ìŠ¹ì¸</button>
                            <button class="btn-action btn-reject" onclick="rejectDepartmentChange('${d.docId}')">ê±°ì ˆ</button>
                        `;
                        managementColumnContent = statusDisplayHtml + '<br>' + actionButtonsHtml + ` <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    }

                } else { // 'member_req' (ì¼ë°˜ ì •ë³´ë³€ê²½ ìš”ì²­)
                    typeBadgeText = 'ì •ë³´ë³€ê²½ ìš”ì²­';
                    typeBadgeClass = 'st-member';
                    try {
                        const parsed = JSON.parse(d.content || '{}');
                        contentDisplay = `
                            <strong>[ìš”ì²­]</strong> ${parsed.name || ''} (${parsed.email || ''})<br>
                            <strong style="color:#2c5bf2;">[ê¶Œí•œ]</strong> ${parsed.role || 'ì§ì›'}
                        `;
                    } catch (e) {
                        contentDisplay = d.content || 'ë‚´ìš© ì—†ìŒ';
                    }

                    // ìƒíƒœë³„ ê´€ë¦¬ ì»¬ëŸ¼ ë‚´ìš© êµ¬ì„±
                    if (d.status === 'completed' || d.status === 'approved' || d.status === 'done') {
                         statusDisplayHtml = `<span style="color:#52c41a; font-weight:700;">ì²˜ë¦¬ì™„ë£Œ</span>`;
                         managementColumnContent = statusDisplayHtml + `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    } else { // pending
                        statusDisplayHtml = `<span style="color:#fa8c16; font-weight:700;">ëŒ€ê¸°ì¤‘</span>`;
                        actionButtonsHtml = `
                            <button class="btn-action btn-approve" onclick="approveAndClear('${d.docId}', '${d.targetUid || d.authorUid}')">ìŠ¹ì¸(ì •ë³´ë³€ê²½)</button>
                        `;
                        managementColumnContent = statusDisplayHtml + '<br>' + actionButtonsHtml + ` <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                    }
                }

                return `
                    <tr>
                        <td><span class="st-badge ${typeBadgeClass}">${typeBadgeText}</span></td> <!-- ìœ í˜• í‘œì‹œ -->
                        <td>${companyName}<br>(${authorName})</td>
                        <td>
                            ${contentDisplay}
                        </td>
                        <td>${date}</td>
                        <td>${managementColumnContent}</td> <!-- ìƒíƒœ ë° ê´€ë¦¬ ë²„íŠ¼ -->
                    </tr>`;
            }).join('');

            renderPagination('member', paginationState.member.data.length);
        }

        // âœ… 4. ë¹„íšŒì› ìƒë‹´ í˜ì´ì§€ ë Œë”ë§ í•¨ìˆ˜
        function renderGuestPage() {
            const pageData = getCurrentPageData('guest');
            const tbody = document.getElementById('list-guest');

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#999; padding:30px;">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                renderPagination('guest', 0);
                return;
            }

            tbody.innerHTML = pageData.map(d => {
                const authorName = d.authorName || 'ì´ë¦„ì—†ìŒ';
                const authorPhone = d.authorPhone || 'ì—°ë½ì²˜ì—†ìŒ';
                const created = d.createdAt ? new Date(d.createdAt).toLocaleString() : '-';

                // ìˆ¨ê¹€ ëª¨ë“œ
                if (showArchivedMode && d.status === 'archived') {
                     return `<tr style="opacity:0.6;">
                        <td><span class="st-badge" style="background:#e0e0e0; color:#666;">ğŸ“¦ ìˆ¨ê¹€</span></td>
                        <td>${authorName} (${authorPhone})</td>
                        <td>(ìˆ¨ê¹€ ì²˜ë¦¬ëœ ìš”ì²­)</td>
                        <td>${created}</td>
                        <td><button class="btn-action btn-approve" onclick="unarchiveRequest('${d.docId}')">ë³µì›</button></td>
                    </tr>`;
                }

                let statusBadge, actionHtml;

                if (d.status === 'completed' || d.status === 'done') {
                    statusBadge = '<span class="st-badge st-approved">ë‹µë³€ì™„ë£Œ</span>';
                    actionHtml = `<button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>`;
                } else { // 'pending' ë˜ëŠ” ê¸°íƒ€ ìƒíƒœ
                    statusBadge = '<span class="st-badge st-waiting">ì ‘ìˆ˜ëŒ€ê¸°</span>';
                    actionHtml = `
                        <button class="btn-action btn-approve" onclick="markAsCompleted('${d.docId}')">ë‹µë³€ì™„ë£Œ</button>
                        <button class="btn-action btn-reject" onclick="archiveRequest('${d.docId}')">ìˆ¨ê¸°ê¸°</button>
                    `;
                }

                return `<tr>
                    <td>${statusBadge}</td>
                    <td>${authorName} (${authorPhone})</td>
                    <td><a href="#" onclick="showRequestDetail('${d.docId}'); return false;" style="color:#1890ff;">${d.title || d.content.substring(0, 30)}...</a></td>
                    <td>${created}</td>
                    <td>${actionHtml}</td>
                </tr>`;
            }).join('');

            renderPagination('guest', paginationState.guest.data.length);
        }

        // --- Action í•¨ìˆ˜ë“¤ ---

        // ê´€ë¦¬ìê°€ ê²¬ì ì„ ì§ì ‘ ì·¨ì†Œ
        window.cancelQuoteByAdmin = async function(docId) {
            if (!confirm("ê´€ë¦¬ìê°€ ì´ ìš”ì²­ì„ ì§ì ‘ ì·¨ì†Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                await posts.update(docId, { status: 'admin_cancelled' });
                alert("ê´€ë¦¬ìê°€ ìš”ì²­ì„ ì·¨ì†Œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.");
                await loadAllRequests();
            } catch (error) {
                console.error('ê´€ë¦¬ì ì·¨ì†Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ìš”ê¸ˆì œ ë³€ê²½ ìŠ¹ì¸
        window.approvePlanChange = async function(docId, targetUid, newPlan) {
            if (!confirm("ë³€ê²½ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                await users.update(targetUid, { plan: newPlan });
                await posts.update(docId, { status: 'done' });
                alert("ë³€ê²½ ì™„ë£Œ");
                await loadPaymentRequests();
            } catch (error) {
                console.error('ë³€ê²½ ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ì²˜ë¦¬ì™„ë£Œ (ìƒíƒœë§Œ ë³€ê²½, ìˆ¨ê¸°ì§€ ì•ŠìŒ)
        window.markAsCompleted = async function(docId) {
            try {
                await posts.update(docId, { status: 'completed' });
                await loadAllRequests();
            } catch (error) {
                console.error('ì²˜ë¦¬ì™„ë£Œ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ê²°ì œìˆ˜ë‹¨ ë“±ë¡ í™•ì¸ ì™„ë£Œ
        window.approvePaymentMethod = async function(docId) {
            if (!confirm("ê²°ì œìˆ˜ë‹¨ ì •ë³´ë¥¼ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?")) return;

            try {
                await posts.update(docId, { status: 'done' });
                alert("í™•ì¸ ì™„ë£Œ");
                await loadPaymentRequests();
            } catch (error) {
                console.error('í™•ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ì§ì› ì •ë³´ ë³€ê²½ ìŠ¹ì¸ ë° ìš”ì²­ ì‚­ì œ
        window.approveAndClear = async function(docId, targetUid) {
            const newValue = prompt("ë³€ê²½í•  'ë¶€ì„œëª…' ë˜ëŠ” 'ì§ê¸‰'ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì…ë ¥í•œ ë‚´ìš©ìœ¼ë¡œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤)");
            if (!newValue) return;

            if (!confirm(`'${newValue}'(ìœ¼)ë¡œ ì •ë³´ë¥¼ ë³€ê²½í•˜ê³ , ìš”ì²­ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                await users.update(targetUid, { department: newValue });
                await posts.delete(docId);
                alert("âœ… ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©°, ìš”ì²­ ë‚´ì—­ì€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                await loadMemberRequests();
            } catch (error) {
                console.error('ë³€ê²½ ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // âœ… API ê¸°ë³¸ URL ì„¤ì • í•¨ìˆ˜
        function getApiBaseUrl() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000/api'
                : 'https://hyunil-law-backend.onrender.com/api';
        }

        // ë¶€ì„œ ë³€ê²½ ìš”ì²­ ìŠ¹ì¸ (member_req_internal, member_req_admin)
        window.approveDepartmentChange = async function(docId) {
            if (!confirm("ë¶€ì„œ ë³€ê²½ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const response = await fetch(`${getApiBaseUrl()}/posts/${docId}/approve-department-change`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ìŠ¹ì¸ ì‹¤íŒ¨');
                }

                alert("âœ… ë¶€ì„œ ë³€ê²½ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                await loadMemberRequests();
            } catch (error) {
                console.error('ë¶€ì„œ ë³€ê²½ ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        }

        // ë¶€ì„œ ë³€ê²½ ìš”ì²­ ê±°ì ˆ (member_req_internal, member_req_admin)
        window.rejectDepartmentChange = async function(docId) {
            const reason = prompt("ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            if (reason === null) return; // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­

            if (!confirm("ë¶€ì„œ ë³€ê²½ ìš”ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const response = await fetch(`${getApiBaseUrl()}/posts/${docId}/reject-department-change`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rejectReason: reason })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ê±°ì ˆ ì‹¤íŒ¨');
                }

                alert("âœ… ë¶€ì„œ ë³€ê²½ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.");
                await loadMemberRequests();
            } catch (error) {
                console.error('ë¶€ì„œ ë³€ê²½ ê±°ì ˆ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        }

        // ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™
        window.goToAdminPage = function(docId) {
            // admin.html í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ì„œ í•´ë‹¹ ê²Œì‹œê¸€ë¡œ ìŠ¤í¬ë¡¤
            location.href = `admin.html?docId=${docId}`;
        }

        // ìë¬¸ ì ‘ìˆ˜ ìŠ¹ì¸
        window.acceptConsult = async function(docId) {
            if (!confirm("ì ‘ìˆ˜ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                await posts.update(docId, { status: 'analyzing' });
                alert("ì ‘ìˆ˜ ìŠ¹ì¸ë¨");
                await loadConsultRequests();
            } catch (error) {
                console.error('ì ‘ìˆ˜ ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        window.deletePost = async function(docId) {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                await posts.delete(docId);
                alert("ì‚­ì œë¨");
                await loadAllRequests();
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ìš”ì²­ ìˆ¨ê¸°ê¸° (ì•„ì¹´ì´ë¸Œ)
        window.archiveRequest = async function(docId) {
            if (!confirm("ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                // í˜„ì¬ ê²Œì‹œê¸€ ì •ë³´ ì¡°íšŒí•˜ì—¬ í˜„ì¬ ìƒíƒœ ì €ì¥
                const post = await posts.getById(docId);
                const currentStatus = post.status;

                // í˜„ì¬ ìƒíƒœë¥¼ previousStatusì— ì €ì¥í•˜ê³  archivedë¡œ ë³€ê²½
                await posts.update(docId, {
                    previousStatus: currentStatus,
                    status: 'archived'
                });
                alert("ìˆ¨ê¹€ ì²˜ë¦¬ë¨");
                await loadAllRequests();
            } catch (error) {
                console.error('ìˆ¨ê¹€ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // âœ… ìš”ì²­ ìˆ¨ê¸°ê¸° í•´ì œ (ë³µì›)
        window.unarchiveRequest = async function(docId) {
            try {
                // í˜„ì¬ ê²Œì‹œê¸€ ì •ë³´ ì¡°íšŒí•˜ì—¬ ì´ì „ ìƒíƒœ í™•ì¸
                const post = await posts.getById(docId);

                console.log('ğŸ“Œ ë³µì› ëŒ€ìƒ:', {
                    docId: post.docId,
                    currentStatus: post.status,
                    previousStatus: post.previousStatus
                });

                let restoreStatus;

                // previousStatusê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                if (post.previousStatus) {
                    restoreStatus = post.previousStatus;
                } else {
                    // previousStatusê°€ ì—†ëŠ” ê²½ìš° í˜„ì¬ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ ì¶”
                    if (post.status === 'done' || post.status === 'completed') {
                        restoreStatus = post.status; // done/completedëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                    } else if (post.status === 'archived') {
                        // archivedì´ê³  previousStatus ì—†ìœ¼ë©´ ì™„ë£Œ ìƒíƒœì˜€ì„ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
                        restoreStatus = 'done';
                    } else {
                        restoreStatus = 'pending';
                    }
                }

                if (!confirm(`ìˆ¨ê¸°ê¸°ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në³µì› ìƒíƒœ: ${restoreStatus}`)) return;

                // ì´ì „ ìƒíƒœë¡œ ë³µì›í•˜ê³  previousStatus ì´ˆê¸°í™”
                await posts.update(docId, {
                    status: restoreStatus,
                    previousStatus: null
                });

                console.log('âœ… ë³µì› ì™„ë£Œ:', { docId, restoredStatus: restoreStatus });
                alert(`ë³µì› ì™„ë£Œ (ìƒíƒœ: ${restoreStatus})`);
                await loadAllRequests();
            } catch (error) {
                console.error('ë³µì› ì‹¤íŒ¨:', error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ìš”ì²­ ìƒì„¸ ë‚´ìš© íŒì—…
        window.showRequestDetail = async function(docId) {
            try {
                const post = await posts.getById(docId);

                const modal = document.getElementById('detailModal');
                const modalTitle = document.getElementById('detailModalTitle');
                const modalBody = document.getElementById('detailModalBody');

                modalTitle.textContent = post.title || 'ìƒì„¸ ë‚´ìš©';

                let detailHtml = '';

                // ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ë‚´ìš©
                if (post.category === 'payment_method') {
                    // ê²°ì œìˆ˜ë‹¨ ë“±ë¡
                    try {
                        const paymentData = JSON.parse(post.content || '{}');
                        if (paymentData.type === 'card') {
                            detailHtml = `
                                <div style="line-height:1.8;">
                                    <strong>ê²°ì œ ìœ í˜•:</strong> ì¹´ë“œ ê²°ì œ<br>
                                    <strong>ì¹´ë“œì‚¬:</strong> ${paymentData.cardCompany || '-'}<br>
                                    <strong>ì¹´ë“œë²ˆí˜¸:</strong> ${paymentData.cardNum || '-'}<br>
                                    <strong>ìœ íš¨ê¸°ê°„:</strong> ${paymentData.cardExpiry || '-'}<br>
                                    <strong>ì‚¬ì—…ìë²ˆí˜¸:</strong> ${paymentData.cardBizNum || '-'}<br>
                                    <strong>ì•½ê´€ë™ì˜:</strong> ${paymentData.cardAgree ? 'ë™ì˜í•¨' : 'ë¯¸ë™ì˜'}<br>
                                </div>
                            `;
                        } else {
                            detailHtml = `
                                <div style="line-height:1.8;">
                                    <strong>ê²°ì œ ìœ í˜•:</strong> CMS ìë™ì´ì²´<br>
                                    <strong>ì€í–‰:</strong> ${paymentData.bank || '-'}<br>
                                    <strong>ê³„ì¢Œë²ˆí˜¸:</strong> ${paymentData.accountNumber || '-'}<br>
                                    <strong>ì˜ˆê¸ˆì£¼:</strong> ${paymentData.depositor || '-'}<br>
                                    <strong>ìƒë…„ì›”ì¼:</strong> ${paymentData.birth || '-'}<br>
                                    <strong>CMS ë™ì˜:</strong> ${paymentData.agreeCms ? 'ë™ì˜í•¨' : 'ë¯¸ë™ì˜'}<br>
                                    <strong>ì œ3ì ì œê³µ ë™ì˜:</strong> ${paymentData.agreeThirdParty ? 'ë™ì˜í•¨' : 'ë¯¸ë™ì˜'}<br>
                                </div>
                            `;
                        }
                    } catch (e) {
                        detailHtml = `<pre style="white-space:pre-wrap; word-break:break-all;">${post.content}</pre>`;
                    }
                } else if (post.category === 'plan_change') {
                    // ìš”ê¸ˆì œ ë³€ê²½
                    detailHtml = `
                        <div style="line-height:1.8;">
                            <strong>ì œëª©:</strong> ${post.title || '-'}<br>
                            <strong>ë‚´ìš©:</strong><br>
                            <pre style="white-space:pre-wrap; word-break:break-all; margin-top:10px;">${post.content || '-'}</pre>
                        </div>
                    `;
                } else if (post.category === 'member_req_internal' || post.category === 'member_req_admin') {
                    // âœ… ë¶€ì„œ ë³€ê²½ ìš”ì²­ ìƒì„¸
                    try {
                        const deptData = JSON.parse(post.content || '{}');
                        detailHtml = `
                            <div style="line-height:1.8;">
                                <strong>ìš”ì²­ ìœ í˜•:</strong> ë¶€ì„œ ë³€ê²½ ìš”ì²­<br>
                                <strong>í˜„ì¬ ë¶€ì„œ:</strong> ${deptData.fromDepartment || '-'}<br>
                                <strong>ë³€ê²½ í¬ë§ ë¶€ì„œ:</strong> ${deptData.newDepartment || '-'}<br>
                                <strong>ìš”ì²­ì:</strong> ${deptData.requesterName || '-'}<br>
                                <strong>ìŠ¹ì¸ ëŒ€ìƒ:</strong> ${deptData.requestTo === 'ceo' ? 'ëŒ€í‘œì' : 'ê´€ë¦¬ì'}<br>
                            </div>
                        `;

                        // ì²¨ë¶€íŒŒì¼ í‘œì‹œ
                        if (deptData.fileUrl) {
                            detailHtml += `
                                <div style="margin-top:20px; padding:15px; background:#f6ffed; border-radius:6px; border-left:4px solid #52c41a;">
                                    <strong style="color:#52c41a;">ğŸ“ ì²¨ë¶€ëœ ì¦ë¹™ì„œë¥˜:</strong><br>
                                    <a href="${window.API_BASE}${deptData.fileUrl}" target="_blank" style="color:#2c5bf2; font-weight:700; text-decoration:underline; display:inline-block; margin-top:8px;">
                                        ${deptData.fileName || 'ì¦ë¹™ì„œë¥˜ ë‹¤ìš´ë¡œë“œ'}
                                    </a>
                                </div>
                            `;
                        }
                    } catch (e) {
                        detailHtml = `<pre style="white-space:pre-wrap; word-break:break-all;">${post.content}</pre>`;
                    }
                } else {
                    // ê¸°íƒ€ ìš”ì²­ (ì¶”ê°€ì´ìš©ê²¬ì  í¬í•¨)
                    detailHtml = `
                        <div style="line-height:1.8;">
                            <strong>ë‚´ìš©:</strong><br>
                            <pre style="white-space:pre-wrap; word-break:break-all; margin-top:10px; padding:15px; background:#f9f9f9; border-radius:6px;">${post.content || '-'}</pre>
                        </div>
                    `;

                    // ê²¬ì  ê´€ë ¨ ì •ë³´ ì¶”ê°€
                    if (post.quotedPrice) {
                        detailHtml += `
                            <div style="margin-top:20px; padding:15px; background:#e6f7ff; border-radius:6px; border-left:4px solid #1890ff;">
                                <strong style="color:#1890ff;">ğŸ’° ê²¬ì  ê¸ˆì•¡:</strong> <span style="font-size:18px; font-weight:700; color:#1890ff;">${Number(post.quotedPrice).toLocaleString()}ì›</span><br>
                                <strong style="color:#666;">ê²¬ì  ë°œì†¡ì¼:</strong> ${post.quotedAt ? new Date(post.quotedAt).toLocaleString('ko-KR') : '-'}
                            </div>
                        `;
                    }

                    // ê±°ì ˆ ì‚¬ìœ  í‘œì‹œ
                    if (post.status === 'rejected' && post.rejectReason) {
                        detailHtml += `
                            <div style="margin-top:20px; padding:15px; background:#fff1f0; border-radius:6px; border-left:4px solid #ff4d4f;">
                                <strong style="color:#ff4d4f;">âœ— ê±°ì ˆ ì‚¬ìœ :</strong><br>
                                <div style="margin-top:8px; color:#333;">${post.rejectReason}</div>
                            </div>
                        `;
                    }
                }

                // ì‘ì„±ì ì •ë³´ ì¶”ê°€
                const companyName = post.userCompanyName || post.companyName || '-';
                const authorName = post.userManagerName || '-';
                const createdAt = post.createdAt ? new Date(post.createdAt).toLocaleString('ko-KR') : '-';

                detailHtml += `
                    <hr style="margin:20px 0; border:none; border-top:1px solid #eee;">
                    <div style="line-height:1.8; color:#666;">
                        <strong>ì‹ ì²­ ê¸°ì—…:</strong> ${companyName}<br>
                        <strong>ì‹ ì²­ì:</strong> ${authorName}<br>
                        <strong>ì‹ ì²­ì¼ì‹œ:</strong> ${createdAt}<br>
                        <strong>ìƒíƒœ:</strong> ${post.status || '-'}
                    </div>
                `;

                modalBody.innerHTML = detailHtml;
                modal.style.display = 'block';

            } catch (error) {
                console.error('ìƒì„¸ ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeDetailModal = function() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const quoteModal = document.getElementById('quoteModal');

            if (event.target === detailModal) {
                detailModal.style.display = 'none';
            }
            if (event.target === quoteModal) {
                quoteModal.style.display = 'none';
            }
        }

        // ê²¬ì  ë°œì†¡ ëª¨ë‹¬ ì—´ê¸°
        window.openQuoteModal = function(docId) {
            document.getElementById('quoteDocId').value = docId;
            document.getElementById('quotePrice').value = '';
            document.getElementById('quoteModal').style.display = 'block';
        }

        // ê²¬ì  ë°œì†¡ ëª¨ë‹¬ ë‹«ê¸°
        window.closeQuoteModal = function() {
            document.getElementById('quoteModal').style.display = 'none';
        }

        // ê²¬ì  ë°œì†¡ ì²˜ë¦¬
        window.submitQuote = async function() {
            const docId = document.getElementById('quoteDocId').value;
            const priceVal = document.getElementById('quotePrice').value.replace(/,/g, '');

            if (!priceVal || isNaN(priceVal) || Number(priceVal) <= 0) {
                alert("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (!confirm(`ê²¬ì  ê¸ˆì•¡: ${Number(priceVal).toLocaleString()}ì›\n\nê²¬ì ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                await posts.update(docId, {
                    status: 'quoted',
                    quotedPrice: Number(priceVal),
                    quotedAt: new Date().toISOString()
                });

                alert("ê²¬ì ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeQuoteModal();
                await loadAllRequests();
            } catch (error) {
                console.error('ê²¬ì  ë°œì†¡ ì‹¤íŒ¨:', error);
                alert("ê²¬ì  ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

    </script>

    <!-- ìƒì„¸ ë‚´ìš© íŒì—… ëª¨ë‹¬ -->
    <div id="detailModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div style="background-color:#fff; margin:5% auto; padding:0; border-radius:8px; width:90%; max-width:600px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
            <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="detailModalTitle" style="margin:0; font-size:18px; color:#333;">ìƒì„¸ ë‚´ìš©</h3>
                <button onclick="closeDetailModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div id="detailModalBody" style="padding:20px; max-height:500px; overflow-y:auto;">
                ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            <div style="padding:15px 20px; border-top:1px solid #eee; text-align:right;">
                <button onclick="closeDetailModal()" style="padding:8px 20px; background:#1890ff; color:#fff; border:none; border-radius:4px; cursor:pointer;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê²¬ì  ë°œì†¡ ëª¨ë‹¬ -->
    <div id="quoteModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div style="background-color:#fff; margin:10% auto; padding:0; border-radius:8px; width:90%; max-width:500px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
            <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:18px; color:#333;">ğŸ’¸ ê²¬ì  ë°œì†¡</h3>
                <button onclick="closeQuoteModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div style="padding:30px;">
                <input type="hidden" id="quoteDocId">

                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:700; color:#555;">ê²¬ì  ê¸ˆì•¡ (ì›)</label>
                    <input type="text" id="quotePrice" placeholder="ì˜ˆ: 500000"
                        style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:16px; outline:none;"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    >
                    <div style="margin-top:8px; font-size:13px; color:#666;">
                        â„¹ï¸ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì½¤ë§ˆ ìë™ ì ìš©)
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button onclick="submitQuote()"
                        style="flex:1; padding:14px; background:#2c5bf2; color:#fff; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:15px;">
                        ê²¬ì  ë°œì†¡í•˜ê¸°
                    </button>
                    <button onclick="closeQuoteModal()"
                        style="flex:1; padding:14px; background:#fff; color:#666; border:1px solid #ddd; border-radius:6px; font-weight:600; cursor:pointer; font-size:15px;">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
