<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© íšŒì› ê´€ë¦¬ (Admin) - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <style>
        /* --- [ê¸°ë³¸ ìŠ¤íƒ€ì¼] --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input, select { font-family: inherit; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 20px; padding-left: 10px; color: #fff; letter-spacing: 1px; }

        /* ì‚¬ìš©ì í”„ë¡œí•„ ì˜ì—­ */
        .user-profile-area { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.15); }
        .user-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .user-email { font-size: 11px; color: #b0b0b0; margin-bottom: 8px; word-break: break-all; }
        .user-role { display: inline-block; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; }
        .badge-master { background: #722ed1; color: #fff; }
        .badge-admin { background: #2c5bf2; color: #fff; }
        .badge-general_manager { background: #52c41a; color: #fff; }
        .badge-lawyer { background: #fa8c16; color: #fff; }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        /* ë ˆì´ì•„ì›ƒ */
        .main-content { flex: 1; margin-left: 260px; padding: 40px; display: grid; grid-template-columns: 1fr 320px; gap: 30px; align-items: start; }
        .left-panel { min-width: 0; }
        .right-panel { background: #fff; border-left: 1px solid #eee; padding: 20px; border-radius: 12px; height: calc(100vh - 80px); overflow-y: auto; position: sticky; top: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        /* í—¤ë” */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }

        .btn-sync { font-size: 13px; background: #1a1a2e; color: #fff; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-sync:hover { background: #333; }
        .btn-auto-archive { background: #fa8c16; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 700; margin-left: 10px; }
        .btn-auto-archive:hover { background: #d46b08; }

        .search-container { position: relative; width: 350px; }
        .search-input { width: 100%; padding: 12px 15px; padding-left: 40px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition:0.2s; font-size: 14px; }
        .search-input:focus { border-color: #1a1a2e; box-shadow: 0 0 0 3px rgba(26,26,46,0.1); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

        /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ */
        .member-list { display: grid; gap: 15px; }
        .member-card { background: #ffffff; border-radius: 12px; padding: 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border-left: 5px solid transparent; }
        .member-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.06); }
        .member-card.has-pending { border-left-color: #faad14; background: #fffbe6; }
        .member-card.over-limit { border-left-color: #ff4d4f; background: #fff1f0; }
        .member-card.suspended { opacity: 0.7; background: #f0f0f0; border-left-color: #fa8c16; }

        .count-text { font-size: 12px; margin-top: 5px; color: #666; }
        .count-text.warning { color: #ff4d4f; font-weight: 800; }

        /* ë¹„í™œì„± ëª©ë¡ */
        .inactive-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .inactive-item:hover { background: #f9f9f9; }
        .inactive-info { flex: 1; cursor: pointer; }
        .inactive-name { font-weight: bold; color: #888; text-decoration: line-through; font-size: 13px; }
        .inactive-date { font-size: 11px; color: #aaa; margin-top: 4px; }
        .btn-restore { padding: 4px 8px; font-size: 11px; border: 1px solid #52c41a; color: #52c41a; background: #fff; border-radius: 4px; cursor: pointer; }
        .btn-restore:hover { background: #f6ffed; }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; border: 1px solid #ddd; display:inline-block; text-align:center;}
        .badge.Basic { background: #e6f7ff; color: #1890ff; border-color: #91d5ff; }
        .badge.Standard { background: #f6ffed; color: #389e0d; border-color: #b7eb8f; }
        .badge.Pro { background: #f9f0ff; color: #722ed1; border-color: #d3adf7; }
        .badge.Premium { background: #fff0f6; color: #c41d7f; border-color: #ffadd2; }
        .badge.Enterprise { background: #391085; color: #fff; border-color: #391085; }
        .badge.none { background: #f5f5f5; color: #999; }

        /* ìŠ¹ì¸ ìš”ì²­ ì•Œë¦¼ ë°•ìŠ¤ */
        .approval-alert {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5D6 100%);
            border: 2px solid #FFD666;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(255, 214, 102, 0.15);
        }
        .approval-alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #B8860B;
            margin-bottom: 15px;
        }
        .approval-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .approval-table {
            width: 100%;
            border-collapse: collapse;
        }
        .approval-table th {
            background: #FAFAFA;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            color: #666;
            border-bottom: 2px solid #E8E8E8;
        }
        .approval-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #F0F0F0;
            font-size: 13px;
        }
        .approval-table tr:last-child td {
            border-bottom: none;
        }
        .approval-arrow {
            color: #2c5bf2;
            font-weight: 700;
            margin: 0 8px;
        }
        .btn-approve {
            background: #52c41a;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
            font-weight: 700;
        }
        .btn-approve:hover { background: #389e0d; }
        .btn-reject {
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
        }
        .btn-reject:hover { background: #cf1322; }

        /* ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .magic-popup { background: #ffffff; width: 950px; height: 90vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popUp 0.3s ease; overflow: hidden; }
        .mini-modal { background: #fff; width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position:relative; }
        @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .popup-header { padding: 25px 30px; background: #fff; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .ph-title { margin: 0; font-size: 22px; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
        .ph-meta { margin-top: 8px; font-size: 13px; color: #666; display:flex; align-items:center; gap:10px; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00b894; }
        input:checked + .slider:before { transform: translateX(20px); }

        .plan-select { padding: 5px; border-radius: 6px; border: 1px solid #ddd; font-weight: bold; font-size: 12px; cursor:pointer; }
        .limit-edit-input { width: 50px; padding: 2px 5px; border: 1px solid #2c5bf2; border-radius: 4px; font-weight: bold; color: #2c5bf2; text-align: center; cursor:pointer;}

        .gauge-section { background: #fafafa; padding: 20px 30px; border-bottom: 1px solid #e0e0e0; }
        .gauge-bg { background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .gauge-fill { height: 100%; background: linear-gradient(90deg, #1a1a2e, #4a4a6a); width: 0%; transition: width 0.6s; }
        .gauge-fill.warning { background: #faad14; }
        .gauge-fill.danger { background: #ff4d4f; }

        .tab-menu { display: flex; padding: 0 30px; background: #fff; border-bottom: 1px solid #e0e0e0; }
        .tab-btn { padding: 15px 20px; font-size: 14px; font-weight: 600; color: #888; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: #1a1a2e; border-bottom-color: #1a1a2e; }
        .popup-body { flex: 1; overflow-y: auto; padding: 30px; background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .date-warning { color: #ff4d4f; font-weight: 700; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; background: #f5f5f5; color: #555; font-weight: 700; border-bottom: 1px solid #ddd; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }

        .btn-mini { padding: 5px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; background: #fff; margin-right: 4px; transition:0.2s; }
        .btn-mini:hover { background: #f0f0f0; }
        .btn-stop { color: #ff4d4f; border-color: #ffccc7; }
        .btn-stop:hover { background: #fff1f0; }
        .btn-archive { width: 100%; padding: 15px; background: #fff7e6; color: #d46b08; border: 1px solid #ffd591; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 30px; transition:0.2s; }
        .btn-archive:hover { background: #fa8c16; color:white; }
        .btn-save-info { background: #1a1a2e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 700; float: right; }
        .btn-modal-save { width: 100%; padding: 12px; background: #1a1a2e; color: #fff; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 15px; }

        .history-item { position: relative; padding-left: 20px; margin-bottom: 20px; font-size: 13px; }
        .history-item::before { content: ''; position: absolute; left: 0; top: 5px; width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .history-item::after { content: ''; position: absolute; left: 3px; top: 13px; width: 2px; height: 100%; background: #eee; }
        .history-item:last-child::after { display: none; }
        .history-date { font-weight: 700; color: #1a1a2e; margin-bottom: 3px; }
        .history-desc { color: #555; }
        .toggle-label { display: flex; align-items: center; justify-content: flex-end; gap: 8px; font-size: 12px; font-weight: 700; color: #555; }

        /* ì§ì› ë“±ë¡ ë²„íŠ¼ ê·¸ë£¹ */
        .emp-action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-add-staff { background: #2c5bf2; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-add-staff:hover { background: #1b42c4; }
        .btn-excel { background: #1a7f37; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn-excel:hover { background: #136029; }
    </style>
</head>
<body>

    <!-- ì‚¬ì´ë“œë°” -->
    
    <!-- ì‚¬ì´ë“œë°”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->

    <script src="../../js/admin_sidebar.js"></script>
    <script>
        // ì‚¬ì´ë“œë°” ì¦‰ì‹œ ë Œë”ë§
        if (typeof renderAdminSidebar === 'function') {
            renderAdminSidebar();
        }
    </script>

<main class="main-content">
    <div class="left-panel">
        <div class="page-header">
            <h2 class="page-title">
                ğŸ‘¥ í†µí•© íšŒì› ê´€ë¦¬
                <button class="btn-sync" onclick="loadMemberData(true)">ğŸ”„ ìƒˆë¡œê³ ì¹¨ (ìë™ê²€ì‚¬)</button>
                <button class="btn-auto-archive" onclick="runAutoArchiveLogic()">âš¡ ì¥ê¸° ë¯¸í™œë™ ìë™ë³´ê´€ ì‹¤í–‰</button>
                <button class="btn-sync" style="background:#2c5bf2; margin-left:10px;" onclick="document.getElementById('manualRegisterModal').style.display='flex'">+ ê¸°ì—… ìˆ˜ë™ ë“±ë¡</button>
            </h2>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="ê¸°ì—…ëª…, ëŒ€í‘œì, ì‚¬ì—…ìë²ˆí˜¸..." onkeyup="filterList()">
            </div>
        </div>

        <!-- ìŠ¹ì¸ ìš”ì²­ ì•Œë¦¼ ì„¹ì…˜ - CEO í˜ì´ì§€(company_members.html)ë¡œ ì´ë™ë¨ -->
        <!-- <div id="approvalAlertSection" style="display:none;">
            <div class="approval-alert">
                <div class="approval-alert-header">
                    âš ï¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ <span id="pendingCount">0</span>ê±´ ìˆìŠµë‹ˆë‹¤.
                </div>
                <div class="approval-table-container">
                    <table class="approval-table">
                        <thead>
                            <tr>
                                <th width="15%">ìš”ì²­ì</th>
                                <th width="12%">ìŠ¹ì¸ìš”ì²­</th>
                                <th width="35%">ìš”ì²­ ë‚´ìš©</th>
                                <th width="20%">ìš”ì²­ì¼ì‹œ</th>
                                <th width="18%">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="approvalTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div> -->

        <div id="loadingMsg" style="text-align:center; padding:50px; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="member-list" id="companyList"></div>
    </div>

    <aside class="right-panel">
        <h3 style="font-size:16px; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ“ ë¹„í™œì„± (ë³´ê´€í•¨)</span>
            <span id="inactiveCount" style="font-size:12px; color:#888;">0ê°œ</span>
        </h3>
        <input type="text" id="searchInactive" class="search-input" style="width:100%; margin-bottom:15px; padding-left:15px; height:36px;" placeholder="ë³´ê´€ëœ ê¸°ì—… ê²€ìƒ‰..." onkeyup="filterInactive()">
        <div id="inactiveList">
            <div style="color:#999; font-size:13px; text-align:center; padding-top:20px;">ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>
        </div>
    </aside>
</main>

<div class="modal-overlay" id="popup">
    <div class="magic-popup">
        <div class="popup-header">
            <div class="ph-left">
                <h2 class="ph-title">
                    <span id="pName">-</span>
                    <label class="switch" title="ì¼ì‹œ ì •ì§€ / í™œì„±í™”">
                        <input type="checkbox" id="pActiveSwitch" onchange="toggleCompanyStatus()">
                        <span class="slider"></span>
                    </label>
                </h2>
                <div class="ph-meta">
                    <select id="pPlanSelect" class="plan-select" onchange="changeCompanyPlan()">
                        <option value="none">ë¯¸ê°€ì… (NONE)</option>
                        <option value="Basic">Basic (3ì¸)</option>
                        <option value="Standard">Standard (7ì¸)</option>
                        <option value="Pro">Pro (12ì¸)</option>
                        <option value="Premium">Premium (17ì¸)</option>
                        <option value="Enterprise">Enterprise (ë¬´ì œí•œ)</option>
                    </select>
                    <span style="color:#ddd;">|</span>
                    <span>ì‚¬ì—…ìë²ˆí˜¸: <span id="pBizNum">-</span></span>
                </div>
            </div>
            <button onclick="closePopup()" style="font-size:24px; border:none; background:none; cursor:pointer;">&times;</button>
        </div>

        <div class="gauge-section">
            <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:bold; margin-bottom:5px;">
                <span>ğŸ‘¥ ë¼ì´ì„ ìŠ¤ ì´ìš© í˜„í™©</span>
                <span id="gaugeTextContainer">
                    <span id="gaugeActive">0</span> /
                    <input type="number" id="gaugeLimitInput" class="limit-edit-input" onchange="manualUpdateLimit()" title="í´ë¦­í•˜ì—¬ ìµœëŒ€ì¸ì› ì§ì ‘ ìˆ˜ì •"> ëª…
                </span>
            </div>
            <div class="gauge-bg"><div class="gauge-fill" id="gaugeBar"></div></div>
            <div id="cmsAlert" style="margin-top:10px; color:#ff4d4f; font-size:12px; font-weight:bold; display:none;"></div>
        </div>

        <div class="tab-menu">
            <div class="tab-btn active" onclick="switchTab('tabEmployees')">ğŸ‘¥ ì§ì› ê´€ë¦¬</div>
            <div class="tab-btn" onclick="switchTab('tabHistory')">ğŸ“œ ë³€ê²½ ì´ë ¥</div>
            <div class="tab-btn" onclick="switchTab('tabInfo')">ğŸ¢ íšŒì‚¬ ì •ë³´ (ìˆ˜ì •)</div>
        </div>

        <div class="popup-body">
            <div id="tabEmployees" class="tab-content active">
                <div class="emp-action-bar">
                    <div><h3 style="margin:0; font-size:16px;">ì†Œì† ì§ì› ëª©ë¡</h3></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-add-staff" onclick="openAddStaffModal()">+ ì§ì› ê°œë³„ ë“±ë¡</button>
                        <button class="btn-excel" onclick="window.open('admin_staff_upload.html', '_blank')">ğŸ“¥ ì§ì› ì¼ê´„ ë“±ë¡ (ìƒˆì°½)</button>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th width="12%">ì´ë¦„</th>
                            <th width="12%">ë¶€ì„œ</th>
                            <th width="13%">ê¶Œí•œ(Role)</th>
                            <th width="10%">í”Œëœ</th>
                            <th width="18%">ì´ë©”ì¼</th>
                            <th width="12%">íœ´ëŒ€í°</th>
                            <th width="13%">ê°€ì…ì¼ì‹œ</th>
                            <th width="10%">ìƒíƒœ</th>
                            <th width="10%">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="empBody"></tbody>
                </table>
            </div>

            <div id="tabHistory" class="tab-content">
                <h3 style="margin:0 0 15px 0; font-size:16px;">ì‹œìŠ¤í…œ ë³€ê²½ ë¡œê·¸</h3>
                <div class="history-list" id="historyList"></div>
            </div>

            <div id="tabInfo" class="tab-content">
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                     <h3 style="margin:0; font-size:16px;">ê³„ì•½ ë° ê¸°ì—… ì •ë³´ ìˆ˜ì •</h3>
                     <button class="btn-save-info" onclick="saveCompanyInfo()">ì €ì¥í•˜ê¸°</button>
                 </div>
                 <div class="info-grid">
                     <div class="form-group"><label>ëŒ€í‘œìëª…</label><input type="text" id="editRepName" class="form-input"></div>
                     <div class="form-group"><label>ëŒ€í‘œ ì „í™”ë²ˆí˜¸</label><input type="text" id="editPhone" class="form-input"></div>
                     <div class="form-group"><label>ë‹´ë‹¹ì ì´ë©”ì¼ (ê³„ì • ID)</label><input type="text" id="editEmail" class="form-input"></div>
                     <div class="form-group"><label>ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸</label><input type="text" id="editBizNum" class="form-input"></div>
                 </div>
                 <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">
                 <h4 style="margin-bottom:15px; color:#1a1a2e;">ğŸ’³ ë“±ë¡ëœ ê²°ì œìˆ˜ë‹¨ ì •ë³´</h4>
                 <div id="paymentMethodInfo" class="info-grid">
                     <p>ë“±ë¡ëœ ê²°ì œìˆ˜ë‹¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                 </div>
                 <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">
                 <h4 style="margin-bottom:15px; color:#1a1a2e;">ğŸ“… ê³„ì•½ ê¸°ê°„ ì„¤ì • (ìë™ê°±ì‹  ê´€ë¦¬)</h4>
                 <div class="info-grid">
                    <div class="form-group"><label>ìµœì´ˆ ê°€ì…ì¼</label><input type="date" id="dateJoin" class="form-input" disabled></div>
                    <div class="form-group"></div>
                    <div class="form-group">
                        <label>ê³„ì•½ ê°œì‹œì¼</label>
                        <input type="date" id="dateStart" class="form-input" onchange="autoCalcEndDate()">
                    </div>
                    <div class="form-group">
                        <div style="display:flex; justify-content:space-between;">
                            <label>ê³„ì•½ ë§Œë£Œì¼</label>
                            <div class="toggle-label">
                                ìë™ê°±ì‹  <label class="switch" style="width:34px; height:18px;"><input type="checkbox" id="autoRenewal"><span class="slider"></span></label>
                            </div>
                        </div>
                        <input type="date" id="dateEnd" class="form-input">
                        <div id="expiryWarning" style="font-size:12px; margin-top:5px; display:none;" class="date-warning"></div>
                    </div>
                 </div>
                 <button class="btn-archive" onclick="archiveCompany()">ğŸ“ ê¸°ì—… ê³„ì • ë¹„í™œì„±í™” (ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™)</button>
                 <p style="font-size:11px; color:#888; text-align:center; margin-top:5px;">* ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™ë˜ë©´ ë©”ì¸ ë¦¬ìŠ¤íŠ¸ì—ì„œ ìˆ¨ê²¨ì§€ë©°, ìš°ì¸¡ íŒ¨ë„ì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="empEditModal">
    <div class="mini-modal">
        <h3 style="margin-top:0;">ğŸ‘¤ ì§ì› ì •ë³´ ìˆ˜ì •</h3>
        <input type="hidden" id="editEmpId">
        <div class="form-group" style="margin-top:15px;"><label>ì´ë¦„</label><input type="text" id="editEmpName" class="form-input"></div>
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="editEmpDept" class="form-input"></div>
        <div class="form-group">
            <label>ê¶Œí•œ (Role)</label>
            <select id="editEmpRole" class="form-input" style="height:38px;">
                <option value="user">ì¼ë°˜ ì§ì› (User)</option>
                <option value="manager">ë¶€ì„œì¥ (Manager)</option>
                <option value="owner">ì´ê´„ ê´€ë¦¬ì (CEO)</option>
            </select>
        </div>
        <div class="form-group"><label>ì´ë©”ì¼ (ID)</label><input type="text" id="editEmpEmail" class="form-input"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-modal-save" onclick="saveMemberEdit()">ì €ì¥í•˜ê¸°</button>
            <button class="btn-modal-save" style="background:#fff; color:#555; border:1px solid #ddd;" onclick="document.getElementById('empEditModal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addStaffModal">
    <div class="mini-modal">
        <h3 style="margin-top:0;">+ ì§ì› ê°œë³„ ë“±ë¡</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">í•´ë‹¹ íšŒì‚¬ ì†Œì†ìœ¼ë¡œ ì§ì›ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>

        <div class="form-group"><label>ì´ë©”ì¼ (ì•„ì´ë””)</label><input type="email" id="addStaffEmail" class="form-input"></div>
        <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸ (ì„ì‹œ)</label><input type="text" id="addStaffPw" class="form-input" value="123456"></div>
        <div class="form-group"><label>ì´ë¦„</label><input type="text" id="addStaffName" class="form-input"></div>
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="addStaffDept" class="form-input"></div>
        <div class="form-group"><label>ì—°ë½ì²˜</label><input type="text" id="addStaffPhone" class="form-input"></div>
        <div class="form-group">
            <label>ê¶Œí•œ</label>
            <select id="addStaffRole" class="form-input" style="height:38px;">
                <option value="user">ì¼ë°˜ ì§ì›</option>
                <option value="manager">ë¶€ì„œì¥</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-modal-save" onclick="handleAddStaff(event)">ë“±ë¡í•˜ê¸°</button>
            <button class="btn-modal-save" style="background:#fff; color:#555; border:1px solid #ddd;" onclick="document.getElementById('addStaffModal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="manualRegisterModal">
    <div class="mini-modal" style="width: 500px;">
        <h3 style="margin-top:0;">ğŸ¢ ê¸°ì—…/ê³ ê° ìˆ˜ë™ ë“±ë¡</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">ê´€ë¦¬ìê°€ ê³„ì •ì„ ìƒì„±í•˜ì—¬ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
        <div class="info-grid">
            <div class="form-group"><label>ì´ë©”ì¼</label><input type="email" id="regEmail" class="form-input"></div>
            <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="text" id="regPw" class="form-input" value="123456"></div>
            <div class="form-group"><label>íšŒì‚¬ëª…</label><input type="text" id="regCompName" class="form-input"></div>
            <div class="form-group"><label>ëŒ€í‘œìëª…</label><input type="text" id="regRepName" class="form-input"></div>
            <div class="form-group"><label>ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="regBizNum" class="form-input"></div>
            <div class="form-group"><label>í”Œëœ</label><select id="regPlan" class="form-input" style="height:38px;"><option value="Basic">Basic</option><option value="Standard">Standard</option><option value="Pro">Pro</option><option value="Premium">Premium</option><option value="Enterprise">Enterprise</option></select></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-modal-save" onclick="handleManualRegister(event)">ìƒì„± ë° ë“±ë¡</button>
            <button class="btn-modal-save" style="background:#fff; color:#555; border:1px solid #ddd;" onclick="document.getElementById('manualRegisterModal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script type="module">
    import { auth, users, admin, posts, requireAuth, checkRole, approvalRequests } from "../../js/api.js";

    const PLANS = {
        'none': {limit:1},
        'Basic':{limit:3},
        'Standard':{limit:7},
        'Pro':{limit:12},
        'Premium':{limit:17},
        'Enterprise':{limit:999}
    };

    let allCompanies = [];
    let inactiveCompanies = [];
    let currentCompId = null;
    let currentCompBizNum = null;
    let currentAdminName = "Admin";

    // 1. ê´€ë¦¬ì ë¡œê·¸ì¸ ì²´í¬
    (async () => {
        if (!requireAuth()) {
            location.href = '../../pages/public/login.html';
            return;
        }

        try {
            const userData = await users.getMe();

            // ============================================
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            // ============================================
            document.getElementById('adminUserName').textContent = userData.managerName || userData.manager_name || userData.email || 'ê´€ë¦¬ì';
            document.getElementById('adminUserEmail').textContent = userData.email || '';

            // ì—­í•  ë°°ì§€
            const roleElement = document.getElementById('adminUserRole');
            const roleMap = {
                'master': { label: 'MASTER', class: 'badge-master' },
                'admin': { label: 'ADMIN', class: 'badge-admin' },
                'general_manager': { label: 'GENERAL', class: 'badge-general_manager' },
                'lawyer': { label: 'LAWYER', class: 'badge-lawyer' }
            };

            const roleInfo = roleMap[userData.role] || { label: userData.role?.toUpperCase() || 'USER', class: 'badge-admin' };
            roleElement.textContent = roleInfo.label;
            roleElement.className = `user-role ${roleInfo.class}`;

            // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
            document.getElementById('adminLogoutBtn')?.addEventListener('click', async function() {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    await auth.logout();
                    location.href = '../../pages/public/login.html';
                }
            });

            // âœ… ë³€í˜¸ì‚¬ ê¶Œí•œ ì ‘ê·¼ ì°¨ë‹¨
            if (userData.role === 'lawyer') {
                alert('ë³€í˜¸ì‚¬ ê¶Œí•œìœ¼ë¡œëŠ” í•´ë‹¹ í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìë¬¸ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                location.href = 'admin.html';
                return;
            }

            const roleNorm = (userData.role || '').toLowerCase();
            if (!['master', 'admin', 'general_manager'].includes(roleNorm)) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '../../pages/user/dashboard.html';
                return;
            }

            currentAdminName = userData.managerName || "Admin";

            // ë°ì´í„° ë¡œë“œ ì‹œì‘
            await loadMemberData(true);
            // ìŠ¹ì¸ ìš”ì²­ì€ CEO í˜ì´ì§€(company_members.html)ì—ì„œë§Œ í‘œì‹œ
            // await loadApprovalRequests();

        } catch (error) {
            console.error('ê¶Œí•œ ì²´í¬ ì—ëŸ¬:', error);
            location.href = '../../pages/public/login.html';
        }
    })();

    /// 2. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadMemberData(runAutoCheck = false) {
        document.getElementById('loadingMsg').style.display = 'block';
        try {
            console.log('ğŸ”„ íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì‹œì‘...');
            const response = await admin.getCompanies({ includeInactive: true });
            console.log('âœ… API ì‘ë‹µ:', response);

            if (!response) {
                throw new Error('API ì‘ë‹µì´ nullì…ë‹ˆë‹¤.');
            }

            const companiesData = response.companies || [];
            console.log(`ğŸ“Š ë¡œë“œëœ íšŒì‚¬ ìˆ˜: ${companiesData.length}`);

            allCompanies = [];
            inactiveCompanies = [];
            const today = new Date();

            // âœ… ì„±ëŠ¥ ìµœì í™”: ëª¨ë“  íšŒì‚¬ì˜ ì§ì› ëª©ë¡ì„ í•œ ë²ˆì— ì¡°íšŒ
            const bizNums = companiesData.filter(c => c.bizNum).map(c => c.bizNum);
            let employeesByBizNum = {};

            if (bizNums.length > 0) {
                try {
                    const batchResponse = await admin.getEmployeesBatch(bizNums);
                    console.log(`âœ… ì¼ê´„ ì§ì› ëª©ë¡ ë¡œë“œ ì™„ë£Œ (${bizNums.length}ê°œ íšŒì‚¬)`);
                    employeesByBizNum = batchResponse.employeesByBizNum || {};
                    const ownerPlans = batchResponse.ownerPlans || {};

                    // ê° íšŒì‚¬ ê°ì²´ì— ëŒ€í‘œ í”Œëœ ì •ë³´ ì£¼ì…
                    companiesData.forEach(c => {
                        if (ownerPlans[c.bizNum]) {
                            c.plan = ownerPlans[c.bizNum];
                        }
                    });

                } catch (err) {
                    console.error('ì¼ê´„ ì§ì› ë¡œë“œ ì‹¤íŒ¨, ê°œë³„ ì¡°íšŒë¡œ í´ë°±:', err);
                    // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ í´ë°±
                    for (const comp of companiesData) {
                        if (comp.bizNum) {
                            try {
                                const empResponse = await admin.getEmployees(comp.bizNum);
                                employeesByBizNum[comp.bizNum] = empResponse.employees || [];
                            } catch (err2) {
                                console.error(`ì§ì› ë¡œë“œ ì‹¤íŒ¨ (${comp.bizNum}):`, err2);
                                employeesByBizNum[comp.bizNum] = [];
                            }
                        }
                    }
                }
            }

            for (const comp of companiesData) {
                // ì§ì› ëª©ë¡ í• ë‹¹
                comp.employees = employeesByBizNum[comp.bizNum] || [];

                // logs íŒŒì‹± (JSON ë¬¸ìì—´ì¸ ê²½ìš°)
                if (typeof comp.logs === 'string') {
                    try {
                        comp.logs = JSON.parse(comp.logs);
                    } catch {
                        comp.logs = [];
                    }
                } else if (!Array.isArray(comp.logs)) {
                    comp.logs = [];
                }

                // ìë™ ë³´ê´€: ê³„ì•½ ë§Œë£Œ
                if (runAutoCheck && comp.isActive !== 0 && comp.contractEndDate && !comp.autoRenewal) {
                    const end = new Date(comp.contractEndDate);
                    if (today > end) {
                        await admin.updateCompanyStatus(comp.uid, false);
                        comp.isActive = 0;
                        await logHistory(comp.uid, "[ìë™ì¡°ì¹˜] ê³„ì•½ ë§Œë£Œë¡œ ë¹„í™œì„±í™”", "System");
                    }
                }

                // ë¦¬ìŠ¤íŠ¸ ë¶„ë¥˜
                if(comp.status === 'Archived' || comp.isActive === 0) {
                    inactiveCompanies.push(comp);
                } else {
                    // ìë™ ì°¨ë‹¨: ì¸ì› ì´ˆê³¼ (ë‚˜ì¤‘ì— êµ¬í˜„)
                    // if (runAutoCheck) {
                    //     await checkAndSuspendOverLimit(comp, false);
                    // }
                    allCompanies.push(comp);
                }
            }

            renderList(allCompanies);
            renderInactiveList(inactiveCompanies);
            document.getElementById('loadingMsg').style.display = 'none';

        } catch (error) {
            console.error('âŒ íšŒì‚¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            console.error('Error type:', error.constructor.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);

            let errorMsg = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n";

            if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                errorMsg += "âŒ ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n";
                errorMsg += "â†’ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.\n";
                errorMsg += "â†’ CORS ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.";
            } else if (error.message.includes('Unauthorized') || error.message.includes('401')) {
                errorMsg += "âŒ ì¸ì¦ ì˜¤ë¥˜: ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.\n";
            } else if (error.message.includes('403')) {
                errorMsg += "âŒ ê¶Œí•œ ì˜¤ë¥˜: ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n";
            } else {
                errorMsg += "ìƒì„¸: " + error.message;
            }

            alert(errorMsg);
            document.getElementById('companyList').innerHTML =
                '<div style="text-align:center; padding:40px; color:#999;">' +
                '<h3 style="color:#ff4d4f; margin-bottom:10px;">âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h3>' +
                '<p>' + error.message + '</p>' +
                '<p style="font-size:12px; margin-top:10px; color:#666;">ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>' +
                '</div>';
            document.getElementById('loadingMsg').style.display = 'none';
        }
    }

    // 3. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderList(list) {
        const container = document.getElementById('companyList');
        container.innerHTML = '';
        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px;">í‘œì‹œí•  ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        list.forEach((comp) => {
            const planName = comp.plan || 'none';
            const planLimit = PLANS[planName] ? PLANS[planName].limit : 1;
            const customLimit = comp.customLimit ? Number(comp.customLimit) : 0;
            const limit = customLimit > 0 ? customLimit : planLimit;

            const activeCount = comp.employees.filter(e => e.status !== 'Suspended').length;

            let countClass = "";
            let cardClass = "";

            if (activeCount > limit) { countClass = "warning"; cardClass = "over-limit"; }
            if (comp.isActive === 0) { cardClass += " suspended"; }

            const html = `
                <div class="member-card ${cardClass}" onclick="openPopup('${comp.uid}')">
                    <div>
                        <div style="font-weight:bold; font-size:16px;">
                            ${comp.companyName || 'ì´ë¦„ ì—†ìŒ'}
                            ${comp.isActive === 0 ? '<span style="font-size:12px; color:#d46b08;"> (ì¼ì‹œì •ì§€)</span>' : ''}
                        </div>
                        <div style="font-size:12px; color:#888;">${comp.managerName || '-'} | ${comp.bizNum || '-'}</div>
                    </div>
                    <div style="text-align:right;">
                        <span class="badge ${planName}">${planName}</span>
                        <div class="count-text ${countClass}">${activeCount} / ${limit}ëª…</div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function renderInactiveList(list) {
        const container = document.getElementById('inactiveList');
        container.innerHTML = '';
        document.getElementById('inactiveCount').innerText = list.length + "ê°œ";

        if (list.length === 0) {
            container.innerHTML = '<div style="color:#999; font-size:13px; text-align:center; padding-top:20px;">ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
            return;
        }

        list.forEach(comp => {
            const html = `
                <div class="inactive-item">
                    <div class="inactive-info" onclick="openPopup('${comp.uid}')">
                        <div class="inactive-name">${comp.companyName || 'ì´ë¦„ ì—†ìŒ'}</div>
                        <div class="inactive-date">${comp.bizNum}</div>
                    </div>
                    <button class="btn-restore" onclick="restoreCompany('${comp.uid}')">ë³µêµ¬</button>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // 3-1. ê²°ì œìˆ˜ë‹¨ ì •ë³´ ë Œë”ë§
    async function renderPaymentMethod(bizNum) {
        const container = document.getElementById('paymentMethodInfo');
        if (!container) return;
        container.innerHTML = '<p>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        try {
            const response = await posts.getAll({
                category: 'payment_method',
                bizNum: bizNum,
                limit: 1 // ê°€ì¥ ìµœê·¼ 1ê±´ë§Œ
            });

            const paymentPost = response.posts && response.posts[0];
            if (!paymentPost || !paymentPost.content) {
                container.innerHTML = '<p>ë“±ë¡ëœ ê²°ì œìˆ˜ë‹¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const info = JSON.parse(paymentPost.content);
            let html = '';

            if (info.type === 'cms') {
                html = `
                    <div class="form-group"><label>ì¢…ë¥˜</label><input class="form-input" value="ê³„ì¢Œ ìë™ì´ì²´ (CMS)" readonly></div>
                    <div class="form-group"><label>ì€í–‰</label><input class="form-input" value="${info.bank || '-'}" readonly></div>
                    <div class="form-group"><label>ê³„ì¢Œë²ˆí˜¸</label><input class="form-input" value="${info.accountNumber ? '***' + info.accountNumber.slice(-4) : '-'}" readonly></div>
                    <div class="form-group"><label>ì˜ˆê¸ˆì£¼</label><input class="form-input" value="${info.depositor || '-'}" readonly></div>
                `;
            } else if (info.type === 'card') {
                html = `
                    <div class="form-group"><label>ì¢…ë¥˜</label><input class="form-input" value="ì‹ ìš©ì¹´ë“œ ì •ê¸°ê²°ì œ" readonly></div>
                    <div class="form-group"><label>ì¹´ë“œì‚¬</label><input class="form-input" value="${info.cardCompany || '-'}" readonly></div>
                    <div class="form-group"><label>ì¹´ë“œë²ˆí˜¸</label><input class="form-input" value="${info.cardNum ? info.cardNum.slice(0, 4) + '-****-****-' + info.cardNum.slice(-4) : '-'}" readonly></div>
                    <div class="form-group"><label>ìœ íš¨ê¸°ê°„</label><input class="form-input" value="${info.cardExpiry || '-'}" readonly></div>
                `;
            } else {
                 container.innerHTML = '<p>ì•Œ ìˆ˜ ì—†ëŠ” ê²°ì œìˆ˜ë‹¨ ì •ë³´ì…ë‹ˆë‹¤.</p>';
                 return;
            }

            // ì¦ë¹™ ì„œë¥˜ ì •ë³´ ì¶”ê°€
            if (info.taxEvidenceType === 'tax_invoice') {
                html += `
                    <h5 style="font-size:14px; margin-bottom:10px; color:#1a1a2e; margin-top:20px; grid-column: 1 / -1;">ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ì •ë³´</h5>
                    <div class="form-group"><label>ê¸°ì—…ëª…</label><input class="form-input" value="${info.taxCompanyName || '-'}" readonly></div>
                    <div class="form-group"><label>ì‚¬ì—…ìë²ˆí˜¸</label><input class="form-input" value="${info.taxBizNum || '-'}" readonly></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label>ìˆ˜ì‹  ì´ë©”ì¼</label><input class="form-input" value="${info.taxEmail || '-'}" readonly></div>
                `;
            } else if (info.taxEvidenceType === 'cash_receipt') {
                html += `
                    <h5 style="font-size:14px; margin-bottom:10px; color:#1a1a2e; margin-top:20px; grid-column: 1 / -1;">í˜„ê¸ˆì˜ìˆ˜ì¦ ë°œí–‰ ì •ë³´</h5>
                    <div class="form-group"><label>ì´ë¦„</label><input class="form-input" value="${info.cashReceiptName || '-'}" readonly></div>
                    <div class="form-group"><label>íœ´ëŒ€í°ë²ˆí˜¸</label><input class="form-input" value="${info.cashReceiptPhone || '-'}" readonly></div>
                `;
            }

            container.innerHTML = html;

        } catch (error) {
            console.error("ê²°ì œìˆ˜ë‹¨ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error);
            container.innerHTML = '<p style="color:red;">ê²°ì œìˆ˜ë‹¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
        // 4. íŒì—… ì—´ê¸°
        window.openPopup = async function(uid) {
        currentCompId = uid;
        const comp = allCompanies.find(c => c.uid === uid) || inactiveCompanies.find(c => c.uid === uid);

        if(!comp) {
            console.error("í•´ë‹¹ ê¸°ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", uid);
            return;
        }

        currentCompBizNum = comp.bizNum;

        // ë°ì´í„° ë°”ì¸ë”©
        document.getElementById('pName').innerText = comp.companyName;
        document.getElementById('pBizNum').innerText = comp.bizNum;
        document.getElementById('pPlanSelect').value = comp.plan || 'none';
        document.getElementById('pActiveSwitch').checked = (comp.isActive !== 0);

        renderEmpTable(comp);
        renderHistory(comp);

        // ìˆ˜ì • í¼ ë°”ì¸ë”©
        document.getElementById('editRepName').value = comp.managerName || '';
        document.getElementById('editPhone').value = comp.phone || '';
        document.getElementById('editEmail').value = comp.email || '';
        document.getElementById('editBizNum').value = comp.bizNum || '';

        // ë‚ ì§œ ë°”ì¸ë”©
        if(comp.createdAt) document.getElementById('dateJoin').value = formatDate(new Date(comp.createdAt));
        document.getElementById('dateStart').value = comp.contractStartDate || '';
        document.getElementById('dateEnd').value = comp.contractEndDate || '';
        document.getElementById('autoRenewal').checked = (comp.autoRenewal === 1);

        checkExpiryWarning(comp.contractEndDate);
        updateGauge(comp);

        // ê²°ì œìˆ˜ë‹¨ ì •ë³´ ë¡œë“œ ë° ë Œë”ë§
        renderPaymentMethod(comp.bizNum);

        document.getElementById('popup').style.display = 'flex';
    }

    // 5. ì§ì› í…Œì´ë¸” ë Œë”ë§
    function renderEmpTable(comp) {
        console.log('[í˜„ì¼ ì‹œìŠ¤í…œ] renderEmpTable í•¨ìˆ˜ ì‹¤í–‰. ì§ì› ìˆ˜:', comp?.employees?.length);
        const tbody = document.getElementById('empBody');
        tbody.innerHTML = '';

        if (!comp || !comp.employees) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:#999;">ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        const reversedEmployees = [...comp.employees].reverse();

        const rowsHtml = reversedEmployees.map(emp => {
            const isSuspended = emp.isActive === 0;

            let statusBadge = `<span style="color:#00b894; font-weight:bold;">Active</span>`;
            if (isSuspended) {
                statusBadge = `<span style="color:#ff4d4f; font-weight:bold;">ê¶Œí•œì¤‘ì§€</span>`;
            }

            const actionBtn = `
                <button class="btn-mini" onclick="openEditModal('${emp.uid}')">ìˆ˜ì •</button>
                ${isSuspended
                    ? `<button class="btn-mini" onclick="restoreMember('${emp.uid}')">ì¬í™œì„±í™”</button>`
                    : `<button class="btn-mini btn-stop" onclick="suspendMember('${emp.uid}')">ê¶Œí•œì¤‘ì§€</button>`}
            `;

            let joinDate = emp.createdAt ? formatDateTime(new Date(emp.createdAt)) : "-";

            let roleText = "ì¼ë°˜ ì§ì›";
            if(emp.role === 'manager') roleText = "ë¶€ì„œì¥";
            if(emp.role === 'owner') roleText = "ì´ê´„(CEO)";

            const planName = comp.plan || 'none';

            return `
                <tr style="${isSuspended ? 'background-color: #fafafa; opacity: 0.6;' : ''}">
                    <td>${emp.managerName || '-'}</td>
                    <td>${emp.department||'-'}</td>
                    <td>
                        <select class="role-select" onchange="changeRole('${emp.uid}', this.value)" data-uid="${emp.uid}" style="width:100%; padding:4px 8px; border:1px solid #d9d9d9; border-radius:4px; font-size:13px;">
                            <option value="owner" ${emp.role === 'owner' ? 'selected' : ''}>ëŒ€í‘œ (CEO)</option>
                            <option value="manager" ${emp.role === 'manager' ? 'selected' : ''}>ë¶€ì„œì¥</option>
                            <option value="user" ${emp.role === 'user' || emp.role === 'staff' || emp.role === 'employee' ? 'selected' : ''}>ì¼ë°˜ ì§ì›</option>
                        </select>
                    </td>
                    <td><span class="badge ${planName}">${planName}</span></td>
                    <td>${emp.email}</td>
                    <td>${emp.phone || '-'}</td>
                    <td style="color:#666; font-size:11px;">${joinDate}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="display:flex; gap:4px; flex-wrap:nowrap;">
                            <button class="btn-mini" onclick="openEditModal('${emp.uid}')" style="white-space:nowrap; font-size:11px; padding:4px 8px;">ìˆ˜ì •</button>
                            ${isSuspended
                                ? `<button class="btn-mini" onclick="restoreMember('${emp.uid}')" style="white-space:nowrap; font-size:11px; padding:4px 8px;">ì¬í™œì„±í™”</button>`
                                : `<button class="btn-mini btn-stop" onclick="suspendMember('${emp.uid}')" style="white-space:nowrap; font-size:11px; padding:4px 8px;">ê¶Œí•œì¤‘ì§€</button>`}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        if (rowsHtml.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:#999;">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
            tbody.innerHTML = rowsHtml;
        }
    }

    // 6. ì§ì› ê°œë³„ ë“±ë¡
    window.handleAddStaff = async function(ev) {
        const comp = allCompanies.find(c => c.uid === currentCompId) || inactiveCompanies.find(c => c.uid === currentCompId);
        if(!comp) return alert("íšŒì‚¬ ì •ë³´ ì˜¤ë¥˜");

        const email = document.getElementById('addStaffEmail').value;
        const password = document.getElementById('addStaffPw').value;
        const name = document.getElementById('addStaffName').value;
        const dept = document.getElementById('addStaffDept').value;
        const phone = document.getElementById('addStaffPhone').value;
        const role = document.getElementById('addStaffRole').value;

        if(!email || !password || !name) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const btn = (ev && ev.target) ? ev.target : null;
        btn.innerText = "ë“±ë¡ ì¤‘..."; btn.disabled = true;

        try {
            await admin.createEmployee({
        email,
        password,
        managerName: name,
        department: dept || "ì „ì‚¬",
        phone: phone,
        bizNum: comp.bizNum,
        role: role
    });
alert(`âœ… ë“±ë¡ ì™„ë£Œ: ${name}`);
            document.getElementById('addStaffModal').style.display = 'none';
            document.getElementById('addStaffEmail').value = "";
            document.getElementById('addStaffName').value = "";

            await loadMemberData();
            setTimeout(() => openPopup(comp.uid), 1000);
        } catch(e) {
            alert("ì˜¤ë¥˜: " + e.message);
        }
        finally { if (btn) btn.innerText = "ë“±ë¡í•˜ê¸°"; if (btn) btn.disabled = false; }
    }

    // 7. ì§ì› ìˆ˜ì •
    window.openEditModal = function(uid) {
        const comp = allCompanies.find(c => c.uid === currentCompId) || inactiveCompanies.find(c => c.uid === currentCompId);
        const emp = comp.employees.find(e => e.uid === uid);

        document.getElementById('editEmpId').value = uid;
        document.getElementById('editEmpName').value = emp.managerName;
        document.getElementById('editEmpDept').value = emp.department || '';
        document.getElementById('editEmpEmail').value = emp.email;
        document.getElementById('editEmpRole').value = emp.role || 'user';

        document.getElementById('empEditModal').style.display = 'flex';
    }

    window.saveMemberEdit = async function() {
        const uid = document.getElementById('editEmpId').value;
        const newName = document.getElementById('editEmpName').value;
        const newDept = document.getElementById('editEmpDept').value;
        const newEmail = document.getElementById('editEmpEmail').value;
        const newRole = document.getElementById('editEmpRole').value;

        try {
            await admin.updateEmployee(uid, {
                managerName: newName,
                department: newDept,
                email: newEmail,
                role: newRole
            });
            await logHistory(currentCompId, `[ì§ì›ìˆ˜ì •] ${newName} (${newRole}) ì •ë³´ ë³€ê²½`);
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('empEditModal').style.display = 'none';
            await loadMemberData();
            setTimeout(() => openPopup(currentCompId), 500);
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    }

    // ê¶Œí•œ ë³€ê²½ (ì…€ë ‰íŠ¸ë°•ìŠ¤ onChange)
    window.changeRole = async function(uid, newRole) {
        try {
            const comp = allCompanies.find(c => c.uid === currentCompId) || inactiveCompanies.find(c => c.uid === currentCompId);
            if (!comp) return;

            const emp = comp.employees.find(e => e.uid === uid);
            if (!emp) return;

            await admin.updateEmployee(uid, { role: newRole });

            // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
            emp.role = newRole;

            await logHistory(currentCompId, `[ê¶Œí•œë³€ê²½] ${emp.managerName || emp.email} â†’ ${newRole}`);

            // íŒì—… ì¬ë Œë”ë§
            renderEmpTable(comp);
        } catch(e) {
            alert("ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨: " + e.message);
            // ì‹¤íŒ¨ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            await loadMemberData();
            setTimeout(() => openPopup(currentCompId), 500);
        }
    }

    // 8. ê¸°ì—… ìˆ˜ë™ ë“±ë¡
    window.handleManualRegister = async function(ev) {
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPw').value;
        const companyName = document.getElementById('regCompName').value;
        const repName = document.getElementById('regRepName').value;
        const bizNum = document.getElementById('regBizNum').value;
        const plan = document.getElementById('regPlan').value;

        if(!email || !password || !companyName) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        const btn = (ev && ev.target) ? ev.target : null;
        btn.innerText = "ìƒì„± ì¤‘..."; btn.disabled = true;

        try {
            // ê¸°ì—… ìˆ˜ë™ ë“±ë¡ì€ /auth/signup ì„ ì‚¬ìš©í•˜ë˜(ë°±ì—”ë“œ êµ¬ì¡°ìƒ), ê´€ë¦¬ì ì„¸ì…˜ì´ ë®ì´ì§€ ì•Šë„ë¡ í† í°ì„ ë°±ì—…/ë³µêµ¬í•©ë‹ˆë‹¤.
    const prevToken = localStorage.getItem('auth_token');
    const prevUser = localStorage.getItem('current_user');

    const signupResp = await auth.signup({
        email,
        password,
        companyName,
        representativeName: repName,
        bizNum,
        companyPhone: '',
        managerName: repName,
        phone: '',
        department: 'ì „ì‚¬'
    });

    // ê´€ë¦¬ì ì„¸ì…˜ ë³µêµ¬
    if (prevToken) localStorage.setItem('token', prevToken);
    else localStorage.removeItem('token');

    if (prevUser) localStorage.setItem('current_user', prevUser);
    else localStorage.removeItem('current_user');

    // í”Œëœ ì ìš© (ì„ íƒ)
    if (plan && signupResp?.user?.uid) {
        await admin.updateCompanyPlan(signupResp.user.uid, plan);
    }
alert(`âœ… ê³„ì • ìƒì„± ì™„ë£Œ!\nID: ${email}\nPW: ${password}`);
            document.getElementById('manualRegisterModal').style.display = 'none';
            await loadMemberData();
        } catch(e) {
            alert("ì˜¤ë¥˜: " + e.message);
        }
        finally { if (btn) btn.innerText = "ìƒì„± ë° ë“±ë¡"; if (btn) btn.disabled = false; }
    }

    // 9. ê³µí†µ í•¨ìˆ˜ë“¤
    async function logHistory(compUid, msg, author = null) {
        const writer = author || currentAdminName;
        const fullMsg = `${msg} - by ${writer}`;

        try {
            await admin.addCompanyLog(compUid, fullMsg);
        } catch(e) {
            console.error('ë¡œê·¸ ì¶”ê°€ ì‹¤íŒ¨:', e);
        }
    }

    function renderHistory(comp) {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if(!comp.logs || comp.logs.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#999;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
        }

        [...comp.logs].reverse().forEach(log => {
            const d = new Date(log.date).toLocaleString('ko-KR');
            list.innerHTML += `<div class="history-item"><div class="history-date">${d}</div><div class="history-desc">${log.msg}</div></div>`;
        });
    }

    function updateGauge(comp) {
        const planLimit = PLANS[comp.plan || 'none'] ? PLANS[comp.plan || 'none'].limit : 1;
        const limit = comp.customLimit || planLimit;
        const active = comp.employees.filter(e => e.status !== 'Suspended').length;

        document.getElementById('gaugeActive').innerText = active;
        document.getElementById('gaugeLimitInput').value = limit;
        document.getElementById('gaugeBar').style.width = `${Math.min((active/limit)*100, 100)}%`;

        const alertBox = document.getElementById('cmsAlert');
        if(active > limit) {
            document.getElementById('gaugeBar').className = 'gauge-fill danger';
            alertBox.style.display = 'block';
            alertBox.innerText = `âš ï¸ ì¸ì› ì´ˆê³¼ (${active}/${limit})! ê´€ë¦¬ í•„ìš”`;
        } else {
            document.getElementById('gaugeBar').className = 'gauge-fill';
            alertBox.style.display = 'none';
        }
    }

    // ê¸°íƒ€ ë‹¨ìˆœ ê¸°ëŠ¥
    window.toggleCompanyStatus = async function() {
        const isActive = document.getElementById('pActiveSwitch').checked;
        const comp = allCompanies.find(c => c.uid === currentCompId);
        if(!comp) return;

        await admin.updateCompanyStatus(comp.uid, isActive);
        comp.isActive = isActive ? 1 : 0;
        await logHistory(comp.uid, `[ìƒíƒœë³€ê²½] ${isActive ? 'í™œì„±í™”' : 'ì¼ì‹œì •ì§€'}`);
        renderList(allCompanies);
    }

    window.archiveCompany = async function() {
        if(!confirm("ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const comp = allCompanies.find(c => c.uid === currentCompId);
        if(!comp) return;

        await admin.updateCompanyInfo(comp.uid, { status: 'Archived' });
        comp.status = 'Archived';
        comp.isActive = 0;

        const idx = allCompanies.indexOf(comp);
        if(idx > -1) allCompanies.splice(idx, 1);
        inactiveCompanies.push(comp);

        await logHistory(comp.uid, "[ë³´ê´€ì´ë™] ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™ë¨");
        closePopup();
        renderList(allCompanies);
        renderInactiveList(inactiveCompanies);
    }

    window.restoreCompany = async function(uid) {
        if(!confirm("ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const comp = inactiveCompanies.find(c => c.uid === uid);
        if(!comp) return;

        await admin.updateCompanyInfo(uid, { status: 'Active' });
        comp.status = 'Active';
        comp.isActive = 1;

        const idx = inactiveCompanies.indexOf(comp);
        if(idx > -1) inactiveCompanies.splice(idx, 1);
        allCompanies.push(comp);

        await logHistory(uid, "ë³´ê´€í•¨ì—ì„œ ë³µêµ¬ë¨");
        renderList(allCompanies);
        renderInactiveList(inactiveCompanies);
    }

    window.suspendMember = async function(uid) {
        if(confirm("ê¶Œí•œì„ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await admin.suspendEmployee(uid, true);
            // ë¡œì»¬ ë°ì´í„° ì§ì ‘ ìˆ˜ì •
            const comp = allCompanies.find(c => c.uid === currentCompId) || inactiveCompanies.find(c => c.uid === currentCompId);
            if (comp) {
                const emp = comp.employees.find(e => e.uid === uid);
                if (emp) emp.status = 'Suspended';
            }
            // íŒì—… ì¦‰ì‹œ ì¬ë Œë”ë§
            openPopup(currentCompId);
        }
    }

    window.restoreMember = async function(uid) {
        if(confirm("ì¬í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await admin.suspendEmployee(uid, false);
            // ë¡œì»¬ ë°ì´í„° ì§ì ‘ ìˆ˜ì •
            const comp = allCompanies.find(c => c.uid === currentCompId) || inactiveCompanies.find(c => c.uid === currentCompId);
            if (comp) {
                const emp = comp.employees.find(e => e.uid === uid);
                if (emp) emp.status = 'Active';
            }
            // íŒì—… ì¦‰ì‹œ ì¬ë Œë”ë§
            openPopup(currentCompId);
        }
    }

    window.saveCompanyInfo = async function() {
        const comp = allCompanies.find(c => c.uid === currentCompId) || inactiveCompanies.find(c => c.uid === currentCompId);
        try {
            await admin.updateCompany(comp.uid, {
                managerName: document.getElementById('editRepName').value,
                phone: document.getElementById('editPhone').value,
                email: document.getElementById('editEmail').value,
                bizNum: document.getElementById('editBizNum').value,
                contractStartDate: document.getElementById('dateStart').value,
                contractEndDate: document.getElementById('dateEnd').value,
                autoRenewal: document.getElementById('autoRenewal').checked
            });
            await logHistory(comp.uid, "íšŒì‚¬ ì •ë³´ ìˆ˜ì •ë¨");
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            await loadMemberData();
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    }

    window.manualUpdateLimit = async function() {
        const newLimit = parseInt(document.getElementById('gaugeLimitInput').value);
        if(isNaN(newLimit)) return;
        const comp = allCompanies.find(c => c.uid === currentCompId);

        if(confirm(`ìµœëŒ€ ì¸ì›ì„ ${newLimit}ëª…ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            await admin.updateCompanyLimits(comp.uid, { customLimit: newLimit });
            await logHistory(comp.uid, `[í•œë„ë³€ê²½] ${newLimit}ëª…ìœ¼ë¡œ ìˆ˜ë™ ë³€ê²½`);
            comp.customLimit = newLimit;
            updateGauge(comp);
        }
    }

    window.changeCompanyPlan = async function() {
        const newPlan = document.getElementById('pPlanSelect').value;
        const comp = allCompanies.find(c => c.uid === currentCompId);

        if(confirm("í”Œëœì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await admin.updateCompanyPlan(comp.uid, newPlan);
            await logHistory(comp.uid, `[í”Œëœë³€ê²½] ${newPlan}ìœ¼ë¡œ ë³€ê²½`);

            const newLimit = PLANS[newPlan].limit;
            comp.customLimit = newLimit;
            comp.plan = newPlan;

            updateGauge(comp);
            renderEmpTable(comp);
            await loadMemberData();
        }
    }

    window.runAutoArchiveLogic = async function() {
        if(!confirm("6ê°œì›” ë¯¸í™œë™/ë§Œë£Œ ê¸°ì—…ì„ ìë™ ë³´ê´€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        let count = 0;
        const today = new Date();
        const limit = new Date();
        limit.setMonth(today.getMonth() - 6);

        for (const comp of allCompanies) {
            if(!comp.contractEndDate) continue;
            const end = new Date(comp.contractEndDate);
            if(end > limit) continue;

            const last = comp.lastLoginAt ? new Date(comp.lastLoginAt) : (comp.createdAt ? new Date(comp.createdAt) : new Date(0));
            if(last > limit) continue;

            await admin.updateCompany(comp.uid, { status: 'Archived', isActive: false });
            count++;
        }

        alert(`ì´ ${count}ê°œ ê¸°ì—… ë³´ê´€ ì™„ë£Œ`);
        await loadMemberData();
    }

    window.filterList = function() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allCompanies.filter(c =>
            (c.companyName || '').toLowerCase().includes(val) ||
            (c.managerName || '').toLowerCase().includes(val) ||
            (c.bizNum || '').includes(val)
        );
        renderList(filtered);
    }

    window.filterInactive = function() {
        const val = document.getElementById('searchInactive').value.toLowerCase();
        const filtered = inactiveCompanies.filter(c =>
            (c.companyName || '').toLowerCase().includes(val) ||
            (c.bizNum || '').includes(val)
        );
        renderInactiveList(filtered);
    }

    function formatDateTime(date) {
        return date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    }

    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    window.autoCalcEndDate = function() {
        const startVal = document.getElementById('dateStart').value;
        if(!startVal) return;
        const date = new Date(startVal);
        date.setFullYear(date.getFullYear() + 1);
        date.setDate(date.getDate() - 1);
        document.getElementById('dateEnd').value = date.toISOString().split('T')[0];
    }

    function checkExpiryWarning(dateStr) {
        const box = document.getElementById('expiryWarning');
        if(!dateStr) { box.style.display = 'none'; return; }
        const end = new Date(dateStr);
        const diff = Math.ceil((end - new Date()) / (1000 * 60 * 60 * 24));
        if (diff <= 30 && diff >= 0) {
            box.style.display = 'block';
            box.innerText = `âš ï¸ ë§Œë£Œ ${diff}ì¼ ì „`;
        } else {
            box.style.display = 'none';
        }
    }

    window.closePopup = function() {
        document.getElementById('popup').style.display = 'none';
    }

    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    window.openAddStaffModal = function() {
        document.getElementById('addStaffModal').style.display = 'flex';
    };

    // ì „ì—­ ìŠ¤ì½”í”„ ë“±ë¡
    window.loadMemberData = loadMemberData;

    // ============================================
    // ìŠ¹ì¸ ìš”ì²­ ê´€ë ¨ í•¨ìˆ˜ - CEO í˜ì´ì§€(company_members.html)ë¡œ ì´ë™ë¨
    // ============================================
    // async function loadApprovalRequests() {
    //     try {
    //         const response = await approvalRequests.getRequests({ status: 'Pending' });
    //         const requests = response.requests || [];

    //         if (requests.length === 0) {
    //             document.getElementById('approvalAlertSection').style.display = 'none';
    //             return;
    //         }

    //         document.getElementById('approvalAlertSection').style.display = 'block';
    //         document.getElementById('pendingCount').textContent = requests.length;

    //         const tbody = document.getElementById('approvalTableBody');
    //         tbody.innerHTML = '';

    //         requests.forEach(req => {
    //             const requestData = req.requestData;
    //             let contentHtml = '';

    //             if (req.requestType === 'ë¶€ì„œë³€ê²½') {
    //                 contentHtml = `
    //                     ${requestData.fromDepartment}
    //                     <span class="approval-arrow">â¡ï¸</span>
    //                     ${requestData.toDepartment}
    //                 `;
    //             } else {
    //                 contentHtml = JSON.stringify(requestData);
    //             }

    //             const dateStr = new Date(req.createdAt).toLocaleString('ko-KR', {
    //                 year: 'numeric',
    //                 month: '2-digit',
    //                 day: '2-digit',
    //                 hour: '2-digit',
    //                 minute: '2-digit'
    //             });

    //             tbody.innerHTML += `
    //                 <tr>
    //                     <td>
    //                         <div style="font-weight:700;">${req.requesterName}</div>
    //                         <div style="font-size:11px; color:#888;">${req.requesterDepartment || '-'}</div>
    //                     </td>
    //                     <td><span style="font-weight:700; color:#2c5bf2;">${req.requestType}</span></td>
    //                     <td>${contentHtml}</td>
    //                     <td style="font-size:12px; color:#666;">${dateStr}</td>
    //                     <td>
    //                         <button class="btn-approve" onclick="handleApproval(${req.id}, true)">ìŠ¹ì¸</button>
    //                         <button class="btn-reject" onclick="handleApproval(${req.id}, false)">ê±°ì ˆ</button>
    //                     </td>
    //                 </tr>
    //             `;
    //         });
    //     } catch (error) {
    //         console.error('ìŠ¹ì¸ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
    //     }
    // }

    // window.handleApproval = async function(requestId, isApprove) {
    //     try {
    //         if (isApprove) {
    //             if (!confirm('ì´ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    //             await approvalRequests.approve(requestId);
    //             alert('âœ… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    //         } else {
    //             const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    //             if (!reason) return;
    //             await approvalRequests.reject(requestId, reason);
    //             alert('âŒ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
    //         }

    //         // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    //         await loadApprovalRequests();
    //         await loadMemberData();
    //     } catch (error) {
    //         console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì—ëŸ¬:', error);
    //         alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    //     }
    // };


    // ============================================
    // âœ… [NEW] ë¶€ì„œ ë³€ê²½ ìš”ì²­ ê´€ë ¨ í•¨ìˆ˜
    // ============================================
    async function loadDeptChangeRequests() {
        try {
            const response = await posts.getAll({ category: 'member_req_internal', status: 'pending' });
            const requests = response.posts || [];

            if (requests.length === 0) {
                document.getElementById('approvalAlertSection').style.display = 'none';
                return;
            }

            document.getElementById('approvalAlertSection').style.display = 'block';
            document.getElementById('pendingCount').textContent = requests.length;

            const tbody = document.getElementById('approvalTableBody');
            tbody.innerHTML = '';

            requests.forEach(req => {
                let requestData = {};
                try {
                    requestData = JSON.parse(req.content);
                } catch(e) {
                    console.error('ìš”ì²­ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', req.content);
                }

                const contentHtml = `
                    ${requestData.fromDepartment || '?'}
                    <span class="approval-arrow">â¡ï¸</span>
                    ${requestData.newDepartment || '?'}
                `;

                const dateStr = new Date(req.createdAt).toLocaleString('ko-KR');

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-weight:700;">${req.userManagerName}</div>
                            <div style="font-size:11px; color:#888;">${req.companyName}</div>
                        </td>
                        <td><span style="font-weight:700; color:#2c5bf2;">ë¶€ì„œ ë³€ê²½</span></td>
                        <td>${contentHtml}</td>
                        <td style="font-size:12px; color:#666;">${dateStr}</td>
                        <td>
                            <button class="btn-approve" onclick="handleDeptChangeApproval('${req.docId}')">ìŠ¹ì¸</button>
                            <button class="btn-reject" onclick="alert('ê±°ì ˆ ê¸°ëŠ¥ì€ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.')">ê±°ì ˆ</button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('ë¶€ì„œ ë³€ê²½ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    window.handleDeptChangeApproval = async function(docId) {
        try {
            if (!confirm('ì´ ë¶€ì„œ ë³€ê²½ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚¬ìš©ìì˜ ë¶€ì„œê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.')) return;
            
            await posts.approveDepartmentChange(docId);
            
            alert('âœ… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadDeptChangeRequests();
            await loadMemberData(); // ì†Œì† ì§ì› ì •ë³´ê°€ ë³€ê²½ë˜ë¯€ë¡œ ì „ì²´ ë°ì´í„° ë¦¬ë¡œë“œ
        } catch (error) {
            console.error('ë¶€ì„œ ë³€ê²½ ìŠ¹ì¸ ì²˜ë¦¬ ì—ëŸ¬:', error);
            alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    };

    window.loadDeptChangeRequests = loadDeptChangeRequests;

    // ============================================
    // ìŠ¹ì¸ ìš”ì²­ ê´€ë ¨ í•¨ìˆ˜ - CEO í˜ì´ì§€(company_members.html)ë¡œ ì´ë™ë¨
    // ============================================
    // async function loadApprovalRequests() {
    //     try {
    //         const response = await approvalRequests.getRequests({ status: 'Pending' });
    //         const requests = response.requests || [];

    //         if (requests.length === 0) {
    //             document.getElementById('approvalAlertSection').style.display = 'none';
    //             return;
    //         }

    //         document.getElementById('approvalAlertSection').style.display = 'block';
    //         document.getElementById('pendingCount').textContent = requests.length;

    //         const tbody = document.getElementById('approvalTableBody');
    //         tbody.innerHTML = '';

    //         requests.forEach(req => {
    //             const requestData = req.requestData;
    //             let contentHtml = '';

    //             if (req.requestType === 'ë¶€ì„œë³€ê²½') {
    //                 contentHtml = `
    //                     ${requestData.fromDepartment}
    //                     <span class="approval-arrow">â¡ï¸</span>
    //                     ${requestData.toDepartment}
    //                 `;
    //             } else {
    //                 contentHtml = JSON.stringify(requestData);
    //             }

    //             const dateStr = new Date(req.createdAt).toLocaleString('ko-KR', {
    //                 year: 'numeric',
    //                 month: '2-digit',
    //                 day: '2-digit',
    //                 hour: '2-digit',
    //                 minute: '2-digit'
    //             });

    //             tbody.innerHTML += `
    //                 <tr>
    //                     <td>
    //                         <div style="font-weight:700;">${req.requesterName}</div>
    //                         <div style="font-size:11px; color:#888;">${req.requesterDepartment || '-'}
    //                         </div>
    //                     </td>
    //                     <td><span style="font-weight:700; color:#2c5bf2;">${req.requestType}</span></td>
    //                     <td>${contentHtml}</td>
    //                     <td style="font-size:12px; color:#666;">${dateStr}</td>
    //                     <td>
    //                         <button class="btn-approve" onclick="handleApproval(${req.id}, true)">ìŠ¹ì¸</button>
    //                         <button class="btn-reject" onclick="handleApproval(${req.id}, false)">ê±°ì ˆ</button>
    //                     </td>
    //                 </tr>
    //             `;
    //         });
    //     } catch (error) {
    //         console.error('ìŠ¹ì¸ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', error);
    //     }
    // }

    // window.handleApproval = async function(requestId, isApprove) {
    //     try {
    //         if (isApprove) {
    //             if (!confirm('ì´ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    //             await approvalRequests.approve(requestId);
    //             alert('âœ… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    //         } else {
    //             const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    //             if (!reason) return;
    //             await approvalRequests.reject(requestId, reason);
    //             alert('âŒ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');
    //         }

    //         // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    //         await loadApprovalRequests();
    //         await loadMemberData();
    //     } catch (error) {
    //         console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì—ëŸ¬:', error);
    //         alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    //     }
    // };

    // window.loadApprovalRequests = loadApprovalRequests;

</script>
</body>
</html>
