<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬í¬íŠ¸ ë°œì†¡ ê´€ë¦¬ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input, select, textarea { font-family: inherit; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 30px; padding-left: 10px; color: #fff; letter-spacing: 1px; }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; margin-right: 350px; padding: 40px; }
        .page-header { margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; }

        /* ê²€ìƒ‰ì°½ */
        .search-box { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e5e5e5; margin-bottom: 20px; display: flex; gap: 10px; }
        .search-input { flex: 1; height: 42px; border: 1px solid #ddd; border-radius: 6px; padding: 0 15px; font-size: 14px; outline: none; }

        /* í…Œì´ë¸” */
        .section-box { background: #fff; border-radius: 12px; border: 1px solid #e5e5e5; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .admin-table th { background-color: #f9f9f9; color: #555; font-weight: 600; }
        .admin-table tr:hover { background-color: #fafafa; }
        .btn-gen-rep { background-color: #2c5bf2; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; }

        /* ìš°ì¸¡ íˆìŠ¤í† ë¦¬ íŒ¨ë„ */
        .right-panel {
            width: 350px; background-color: #fff; border-left: 1px solid #eee;
            position: fixed; right: 0; top: 0; height: 100vh; padding: 30px 20px;
            z-index: 90; overflow-y: auto; box-shadow: -4px 0 20px rgba(0,0,0,0.02);
        }
        .rp-title { font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        /* ì‹ ê·œ ë¦¬í¬íŠ¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .report-modal-content { background: #fff; padding: 0; border-radius: 12px; width: 900px; display:flex; flex-direction:column; height: 700px; }
        .report-modal-header { display:flex; justify-content:space-between; align-items:center; padding: 20px 30px; border-bottom: 1px solid #eee; }
        .report-modal-title { font-size: 18px; font-weight: 700; }
        .report-modal-body { flex: 1; padding: 20px 30px; overflow-y:auto; display:flex; flex-direction:column; }
        .report-controls { display: flex; gap: 10px; align-items: center; background: #f7f8fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .report-main { flex: 1; display:flex; flex-direction:column; }
        .report-main textarea { flex: 1; border-radius: 8px; border: 1px solid #ddd; padding: 15px; font-size: 14px; resize: none; }
        .report-modal-footer { padding: 20px 30px; border-top: 1px solid #eee; text-align: right; }
        .form-select { height: 40px; border: 1px solid #ddd; border-radius: 6px; padding: 0 10px; }
    </style>
</head>
<body>

    <!-- ì‚¬ì´ë“œë°”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->

<main class="main-content">
    <h2 class="page-title">ğŸ“Š ë¦¬í¬íŠ¸ ë°œì†¡ ê´€ë¦¬ (ê¸°ì—…ë³„)</h2>
    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="ê¸°ì—…ëª…, ëŒ€í‘œìëª… ê²€ìƒ‰.." onkeyup="filterCompanies()">
    </div>
    <div class="section-box">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ê¸°ì—…ëª… (ì‚¬ì—…ìë²ˆí˜¸)</th>
                    <th>ëŒ€í‘œì</th>
                    <th>ì§ì› ìˆ˜</th>
                    <th>ë¦¬í¬íŠ¸ ìƒì„±</th>
                </tr>
            </thead>
            <tbody id="companyListBody">
                <tr><td colspan="4" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<aside class="right-panel">
    <div class="rp-title">ğŸ“œ ìµœê·¼ ë°œì†¡ ì´ë ¥ (History)</div>
    <div id="historyList">
        <div style="text-align:center; color:#999; padding:20px;">ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</aside>

    <!-- ë¦¬í¬íŠ¸ ìƒì„± ëª¨ë‹¬ -->
    <div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center;">
        <div class="report-modal-content">
            <div class="report-modal-header">
                <h3 class="report-modal-title">ë¦¬í¬íŠ¸ ìƒì„±: <span id="modalCompanyName"></span></h3>
                <button onclick="closeReportModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div class="report-modal-body">
                <div class="report-controls">
                    <select id="reportDeptSelect" class="form-select" style="min-width:150px;" onchange="loadDraftOpinion()"></select>
                    <select id="reportYearSelect" class="form-select" onchange="loadDraftOpinion()"></select>
                    <select id="reportMonthSelect" class="form-select" onchange="loadDraftOpinion()"></select>
                    <button class="btn-gen-rep" onclick="generateAndPreviewReport()">ì¡°íšŒ ë° ìƒì„±</button>
                </div>
                <div class="report-main">
                    <label style="font-weight:600; margin-bottom:8px;">ğŸ“¢ ì¢…í•© ì˜ê²¬ ì‘ì„±</label>
                    <textarea id="reportContent" placeholder="ì´í‰ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                </div>
                <input type="hidden" id="targetUid">
                <input type="hidden" id="targetBizNum">
            </div>
            <div class="report-modal-footer">
                <button onclick="closeReportModal()" style="background:#f0f0f0; color:#333; border:1px solid #ccc; padding:10px 20px; border-radius:6px; font-weight:600; cursor:pointer;">ì·¨ì†Œ</button>
                <button onclick="saveDraftOpinion()" style="background:#1a7f37; color:#fff; border:none; padding:10px 20px; border-radius:6px; font-weight:700; cursor:pointer;">ì¢…í•© ì˜ê²¬ ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="../../js/admin_sidebar.js"></script>
    <script>
        // ì‚¬ì´ë“œë°” ì¦‰ì‹œ ë Œë”ë§
        if (typeof renderAdminSidebar === 'function') {
            renderAdminSidebar();
        }
    </script>
    <script type="module">
        import { auth, users, admin, reports, posts } from '../../js/api.js';

        let allCompanyData = []; // ëª¨ë“  íšŒì‚¬ ì •ë³´ë¥¼ ì €ì¥í•  ë°°ì—´

        // ê¶Œí•œ í™•ì¸ ë° ì´ˆê¸°í™”
        (async () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                location.href = '../public/login.html';
                return;
            }

            try {
                const userData = await users.getMe();
                console.log('ğŸ” [ë¦¬í¬íŠ¸ ë°œì†¡] ì‚¬ìš©ì ì •ë³´:', userData);

                const adminRoles = ['master', 'admin', 'general_manager', 'lawyer'];
                if (!adminRoles.includes(userData.role)) {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ê¶Œí•œ: ' + userData.role);
                    location.href = '../user/dashboard.html';
                    return;
                }

                await loadCompanies();
                await loadReportHistory();

            } catch (error) {
                console.error('ê¶Œí•œ í™•ì¸ ì—ëŸ¬:', error);
                alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                location.href = '../public/login.html';
            }
        })();

        // íšŒì‚¬ ëª©ë¡ ë¡œë“œ
        async function loadCompanies() {
            try {
                const result = await admin.getCompanies();
                allCompanyData = result.companies || []; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

                renderCompanyList(allCompanyData);

            } catch (error) {
                console.error('íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                let errorMsg = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#ff4d4f;">';
                errorMsg += '<h3 style="margin-bottom:10px;">âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h3>';

                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    errorMsg += '<p>âŒ ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    errorMsg += '<p style="font-size:12px; color:#666; margin-top:10px;">ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: http://localhost:3000</p>';
                } else {
                    errorMsg += '<p>' + error.message + '</p>';
                }

                errorMsg += '</td></tr>';
                document.getElementById('companyListBody').innerHTML = errorMsg;
            }
        }
        
        function renderCompanyList(companies) {
            const tbody = document.getElementById('companyListBody');
            if (companies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">ë“±ë¡ëœ ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = companies.map(company => `
                <tr data-company-name="${(company.companyName || '').toLowerCase()}" data-manager-name="${(company.managerName || '').toLowerCase()}" data-biz-num="${company.bizNum || ''}">
                    <td>
                        <strong>${company.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong><br>
                        <span style="font-size:12px; color:#888;">${company.bizNum || '-'}</span>
                    </td>
                    <td>${company.managerName || '-'}</td>
                    <td>${company.employeeCount || 0}ëª…</td>
                    <td>
                        <button class="btn-gen-rep" onclick="openReportModal('${company.uid}', '${company.companyName}', '${company.bizNum}')">
                            ë¦¬í¬íŠ¸ ìƒì„±
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ë¦¬í¬íŠ¸ ë°œì†¡ ì´ë ¥ ë¡œë“œ
        async function loadReportHistory() {
            try {
                const result = await reports.getAll({ limit: 10 });
                const reportsList = result.reports || [];

                const historyContainer = document.getElementById('historyList');

                if (reportsList.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ë°œì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                historyContainer.innerHTML = reportsList.map(report => {
                    const date = report.created_at ? new Date(report.created_at).toLocaleDateString('ko-KR') : '-';
                    return `
                        <div style="padding:15px; border-bottom:1px solid #f0f0f0;">
                            <div style="font-weight:700; color:#333; margin-bottom:4px; font-size:14px;">
                                ${report.title || 'ì œëª© ì—†ìŒ'}
                            </div>
                            <div style="font-size:12px; color:#888;">
                                ${date} | ${report.type || 'ì›”ê°„ ë¦¬í¬íŠ¸'}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('historyList').innerHTML =
                    '<div style="text-align:center; color:#999; padding:20px;">ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // ê²€ìƒ‰ í•„í„°
        window.filterCompanies = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredCompanies = allCompanyData.filter(company => 
                (company.companyName || '').toLowerCase().includes(searchTerm) ||
                (company.managerName || '').toLowerCase().includes(searchTerm) ||
                (company.bizNum || '').toLowerCase().includes(searchTerm)
            );
            renderCompanyList(filteredCompanies);
        }
        
        async function loadDepartmentsForModal(bizNum) {
            const deptSelect = document.getElementById('reportDeptSelect');
            deptSelect.innerHTML = '<option value="">ë¶€ì„œ ë¡œë”©ì¤‘...</option>';
            try {
                const response = await admin.getEmployees(bizNum);
                const employees = response.employees || [];
                const depts = new Set(employees.map(e => e.department).filter(Boolean));
                
                deptSelect.innerHTML = '<option value="all">ì „ì²´ ë¶€ì„œ</option>';
                depts.forEach(d => {
                    deptSelect.innerHTML += `<option value="${d}">${d}</option>`;
                });
            } catch(e) {
                deptSelect.innerHTML = '<option value="">ë¶€ì„œ ë¡œë“œ ì‹¤íŒ¨</option>';
            }
        }

        function getDraftKey() {
            const bizNum = document.getElementById('targetBizNum').value;
            const year = document.getElementById('reportYearSelect').value;
            const month = document.getElementById('reportMonthSelect').value;
            return `draft_opinion_${bizNum}_${year}-${month}`;
        }

        window.loadDraftOpinion = function() {
            const key = getDraftKey();
            const savedDraft = localStorage.getItem(key);
            document.getElementById('reportContent').value = savedDraft || '';
        }

        // ë¦¬í¬íŠ¸ ëª¨ë‹¬ ì—´ê¸°
        window.openReportModal = function(uid, companyName, bizNum) {
            document.getElementById('reportModal').style.display = 'flex';
            document.getElementById('modalCompanyName').innerText = companyName;
            document.getElementById('targetUid').value = uid;
            document.getElementById('targetBizNum').value = bizNum;
            
            // ë…„/ì›” ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            const yearSelect = document.getElementById('reportYearSelect');
            const monthSelect = document.getElementById('reportMonthSelect');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            yearSelect.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const year = currentYear - i;
                yearSelect.innerHTML += `<option value="${year}" ${i===0 ? 'selected':''}>${year}ë…„</option>`;
            }
            
            monthSelect.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                monthSelect.innerHTML += `<option value="${i}" ${i===currentMonth ? 'selected':''}>${i}ì›”</option>`;
            }
            
            // ë¶€ì„œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ë° ì˜ê²¬ ë¡œë“œ
            loadDepartmentsForModal(bizNum).then(() => {
                loadDraftOpinion();
            });
        }

        window.closeReportModal = function() {
            document.getElementById('reportModal').style.display = 'none';
        }

        window.saveDraftOpinion = function() {
            const key = getDraftKey();
            const content = document.getElementById('reportContent').value;
            localStorage.setItem(key, content);
            alert('ì¢…í•© ì˜ê²¬ì´ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        window.generateAndPreviewReport = async function() {
            const bizNum = document.getElementById('targetBizNum').value;
            const companyName = document.getElementById('modalCompanyName').innerText;
            const year = document.getElementById('reportYearSelect').value;
            const month = document.getElementById('reportMonthSelect').value;
            const dept = document.getElementById('reportDeptSelect').value;
            const overallOpinion = document.getElementById('reportContent').value;
            
            const btn = event.target;
            btn.innerText = 'ìƒì„± ì¤‘...';
            btn.disabled = true;

            try {
                const response = await posts.getAll({
                    bizNum: bizNum,
                    category: 'general_counsel,contract_review,legal_document,certification,phone_log,visit_consult,case_representation,phone_request'
                });
                const allPosts = response.posts || [];
                
                const year = document.getElementById('reportYearSelect').value;
                const month = document.getElementById('reportMonthSelect').value; // month is 1-indexed from UI

                // Normalize start and end dates to UTC
                const startDate = new Date(Date.UTC(year, month - 1, 1)); // First day of selected month, UTC
                const endDate = new Date(Date.UTC(year, month, 1));       // First day of next month, UTC
                
                const filteredPosts = allPosts.filter(p => {
                    const postDate = new Date(p.createdAt);
                    // Convert postDate to UTC equivalent for comparison
                    const postDateUTC = new Date(Date.UTC(postDate.getFullYear(), postDate.getMonth(), postDate.getDate(),
                                                            postDate.getHours(), postDate.getMinutes(), postDate.getSeconds()));

                    const isInDate = postDateUTC >= startDate && postDateUTC < endDate;
                    if (!isInDate) return false;
                    if (dept === 'all') return true;
                    return p.userDepartment === dept || p.department === dept;
                });

                const stats = {
                    total: filteredPosts.length,
                    completed: filteredPosts.filter(p => ['done', 'completed', 'answered'].includes(p.status)).length,
                    pending: filteredPosts.filter(p => !['done', 'completed', 'answered'].includes(p.status)).length
                };
                
                const deptStats = filteredPosts.reduce((acc, p) => {
                    const deptName = p.userDepartment || p.department || 'ë¯¸ì§€ì •';
                    acc[deptName] = (acc[deptName] || 0) + 1;
                    return acc;
                }, {});

                const reportData = {
                    companyName: companyName,
                    opinion: overallOpinion,
                    stats,
                    deptStats,
                    posts: filteredPosts.map(p => ({
                        date: p.createdAt,
                        category: p.category,
                        title: p.title,
                        requester: p.userManagerName || 'N/A',
                        status: p.status
                    }))
                };

                const payload = {
                    title: `[${companyName}] ${year}ë…„ ${month}ì›” ë¦¬í¬íŠ¸ (${dept === 'all' ? 'ì „ì‚¬' : dept})`,
                    content: JSON.stringify(reportData),
                    type: 'month',
                    period: `${year}-${String(month).padStart(2, '0')}`,
                    target_biz_num: bizNum,
                    status: 'draft'
                };

                const newReport = await reports.create(payload);
                alert('ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ! ë¯¸ë¦¬ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = `../user/preview_report.html?id=${newReport.doc_id}`;

            } catch (error) {
                console.error("ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:", error);
                alert(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            } finally {
                btn.innerText = 'ì¡°íšŒ ë° ìƒì„±';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>