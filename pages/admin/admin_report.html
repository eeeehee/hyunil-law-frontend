<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/hyunil-law-frontend/">
    <title>ë¦¬í¬íŠ¸ ë°œì†¡ ê´€ë¦¬ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input, select, textarea { font-family: inherit; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 30px; padding-left: 10px; color: #fff; letter-spacing: 1px; }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; margin-right: 350px; padding: 40px; }
        .page-header { margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; }

        /* ê²€ìƒ‰ì°½ */
        .search-box { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e5e5e5; margin-bottom: 20px; display: flex; gap: 10px; }
        .search-input { flex: 1; height: 42px; border: 1px solid #ddd; border-radius: 6px; padding: 0 15px; font-size: 14px; outline: none; }

        /* í…Œì´ë¸” */
        .section-box { background: #fff; border-radius: 12px; border: 1px solid #e5e5e5; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .admin-table th { background-color: #f9f9f9; color: #555; font-weight: 600; }
        .admin-table tr:hover { background-color: #fafafa; }
        .btn-gen-rep { background-color: #2c5bf2; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; }

        /* ìš°ì¸¡ íˆìŠ¤í† ë¦¬ íŒ¨ë„ */
        .right-panel {
            width: 350px; background-color: #fff; border-left: 1px solid #eee;
            position: fixed; right: 0; top: 0; height: 100vh; padding: 30px 20px;
            z-index: 90; overflow-y: auto; box-shadow: -4px 0 20px rgba(0,0,0,0.02);
        }
        .rp-title { font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    </style>
</head>
<body>

    <!-- ì‚¬ì´ë“œë°” -->
    <nav class="sidebar">
        <div class="sidebar-brand">ADMINISTRATOR</div>
        <ul class="sidebar-menu">
            <li>
                <div class="menu-category open active" onclick="toggleAdminMenu('groupCorp', this)">
                    <div><span class="menu-icon">ğŸ¢</span> ê¸°ì—…ìë¬¸ì„¼í„°</div>
                    <span class="menu-arrow">â–¼</span>
                </div>
                <ul id="groupCorp" class="submenu" style="display:block;">
                    <li><a href="admin.html">ğŸ“ ìë¬¸ ê´€ë¦¬ (ì „ì²´)</a></li>
                    <li><a href="admin_requests.html">ğŸ“© ìš”ì²­ ê´€ë¦¬í•¨</a></li>
                    <li><a href="admin_report.html" class="active">ğŸ“Š ë¦¬í¬íŠ¸ ë°œì†¡</a></li>
                    <li><a href="admin_corpbilling.html">ğŸ’¸ ìë¬¸ë£Œ ì²­êµ¬/ë°œì†¡</a></li>
                    <li><a href="admin_members.html">ğŸ‘¥ íšŒì›/ê¸°ì—… ê´€ë¦¬</a></li>
                    <li><a href="admin_payments.html">ğŸ’³ ë§¤ì¶œ/CMS ê´€ë¦¬</a></li>
                </ul>
            </li>

            <li>
                <div class="menu-category" onclick="toggleAdminMenu('groupLitigation', this)">
                    <div><span class="menu-icon">âš–ï¸</span> ì „ìì†Œì†¡/ì‚¬ê±´</div>
                    <span class="menu-arrow">â–¼</span>
                </div>
                <ul id="groupLitigation" class="submenu">
                    <li><a href="admin_litigation.html">ğŸ” ì „ìì†Œì†¡ ë°ì´í„° í™•ì¸</a></li>
                    <li><a href="admin_clients.html">ğŸ“‡ ë‹¹ì‚¬ì(ê³ ê°) ê´€ë¦¬</a></li>
                </ul>
            </li>

            <li>
                <div class="menu-category" onclick="toggleAdminMenu('groupSpecial', this)">
                    <div><span class="menu-icon">ğŸ“</span> íŒŒì‚°/ì¶”ì‹¬ ì„¼í„°</div>
                    <span class="menu-arrow">â–¼</span>
                </div>
                <ul id="groupSpecial" class="submenu">
                    <li><a href="admin_collection_consult.html">ğŸ’° ì±„ê¶Œ ì¶”ì‹¬ ìƒë‹´</a></li>
                    <li><a href="admin_collection.html">ğŸ’° ì±„ê¶Œ ì¶”ì‹¬ ì‚¬ê±´</a></li>
                    <li><a href="admin_pasan_consult.html">ğŸ“‰ íŒŒì‚°/íšŒìƒ ìƒë‹´</a></li>
                    <li><a href="admin_pasan.html">ğŸ“‰ íŒŒì‚°/íšŒìƒ ì‚¬ê±´</a></li>
                </ul>
            </li>

            <li class="menu-divider"></li>

            <li><a href="admin_settings.html" class="menu-link">âš™ï¸ í™˜ê²½ ì„¤ì •</a></li>
            <li class="menu-divider"></li>
            <li><a href="/" class="menu-link">ğŸ¢ ê¸°ì—…ìë¬¸ í™ˆí˜ì´ì§€</a></li>
            <li><a href="../user/dashboard.html" class="menu-link" style="color:#2c5bf2; font-weight:700;">ğŸ–¥ï¸ ê¸°ì—…ìë¬¸ ì‚¬ìš©ì ëª¨ë“œ</a></li>
        </ul>
    </nav>

    <script>
        function toggleAdminMenu(id, header) {
            const submenu = document.getElementById(id);
            if(!submenu) return;
            if (submenu.style.display === "block") {
                submenu.style.display = "none";
                header.classList.remove("open");
                header.classList.remove("active");
            } else {
                submenu.style.display = "block";
                header.classList.add("open");
                header.classList.add("active");
            }
        }
    </script>

<main class="main-content">
    <h2 class="page-title">ğŸ“Š ë¦¬í¬íŠ¸ ë°œì†¡ ê´€ë¦¬ (ê¸°ì—…ë³„)</h2>
    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="ê¸°ì—…ëª…, ëŒ€í‘œìëª… ê²€ìƒ‰.." onkeyup="filterCompanies()">
    </div>
    <div class="section-box">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ê¸°ì—…ëª… (ì‚¬ì—…ìë²ˆí˜¸)</th>
                    <th>ëŒ€í‘œì</th>
                    <th>ì§ì› ìˆ˜</th>
                    <th>ë¦¬í¬íŠ¸ ìƒì„±</th>
                </tr>
            </thead>
            <tbody id="companyListBody">
                <tr><td colspan="4" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<aside class="right-panel">
    <div class="rp-title">ğŸ“œ ìµœê·¼ ë°œì†¡ ì´ë ¥ (History)</div>
    <div id="historyList">
        <div style="text-align:center; color:#999; padding:20px;">ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</aside>

    <script type="module">
        import { auth, users, admin, reports } from '/js/api.js';

        // ê¶Œí•œ í™•ì¸ ë° ì´ˆê¸°í™”
        (async () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                location.href = '../public/login.html';
                return;
            }

            try {
                const userData = await users.getMe();
                console.log('ğŸ” [ë¦¬í¬íŠ¸ ë°œì†¡] ì‚¬ìš©ì ì •ë³´:', userData);

                const adminRoles = ['master', 'admin', 'general_manager', 'lawyer'];
                if (!adminRoles.includes(userData.role)) {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ê¶Œí•œ: ' + userData.role);
                    location.href = '../user/dashboard.html';
                    return;
                }

                await loadCompanies();
                await loadReportHistory();

            } catch (error) {
                console.error('ê¶Œí•œ í™•ì¸ ì—ëŸ¬:', error);
                alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                location.href = '../public/login.html';
            }
        })();

        // íšŒì‚¬ ëª©ë¡ ë¡œë“œ
        async function loadCompanies() {
            try {
                const result = await admin.getCompanies();
                const companies = result.companies || [];

                const tbody = document.getElementById('companyListBody');

                if (companies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">ë“±ë¡ëœ ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = companies.map(company => `
                    <tr>
                        <td>
                            <strong>${company.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong><br>
                            <span style="font-size:12px; color:#888;">${company.bizNum || '-'}</span>
                        </td>
                        <td>${company.managerName || '-'}</td>
                        <td>${company.employeeCount || 0}ëª…</td>
                        <td>
                            <button class="btn-gen-rep" onclick="openReportModal('${company.uid}', '${company.companyName}')">
                                ë¦¬í¬íŠ¸ ìƒì„±
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                let errorMsg = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#ff4d4f;">';
                errorMsg += '<h3 style="margin-bottom:10px;">âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h3>';

                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    errorMsg += '<p>âŒ ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    errorMsg += '<p style="font-size:12px; color:#666; margin-top:10px;">ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: http://localhost:3000</p>';
                } else {
                    errorMsg += '<p>' + error.message + '</p>';
                }

                errorMsg += '</td></tr>';
                document.getElementById('companyListBody').innerHTML = errorMsg;
            }
        }

        // ë¦¬í¬íŠ¸ ë°œì†¡ ì´ë ¥ ë¡œë“œ
        async function loadReportHistory() {
            try {
                const result = await reports.getAll({ limit: 10 });
                const reportsList = result.reports || [];

                const historyContainer = document.getElementById('historyList');

                if (reportsList.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ë°œì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                historyContainer.innerHTML = reportsList.map(report => {
                    const date = report.createdAt ? new Date(report.createdAt).toLocaleDateString('ko-KR') : '-';
                    return `
                        <div style="padding:15px; border-bottom:1px solid #f0f0f0;">
                            <div style="font-weight:700; color:#333; margin-bottom:4px; font-size:14px;">
                                ${report.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                            </div>
                            <div style="font-size:12px; color:#888;">
                                ${date} | ${report.reportType || 'ì›”ê°„ ë¦¬í¬íŠ¸'}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('historyList').innerHTML =
                    '<div style="text-align:center; color:#999; padding:20px;">ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // ê²€ìƒ‰ í•„í„°
        window.filterCompanies = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#companyListBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // ë¦¬í¬íŠ¸ ëª¨ë‹¬ ì—´ê¸° (ì¶”í›„ êµ¬í˜„)
        window.openReportModal = function(uid, companyName) {
            alert(`${companyName}ì˜ ë¦¬í¬íŠ¸ ìƒì„± ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.`);
        }
    </script>
</body>
</html>
