<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬í¬íŠ¸ ë°œì†¡ ê´€ë¦¬ - ë²•ë¬´ê·¸ë£¹ í˜„ì¼</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Pretendard Variable", Pretendard, sans-serif; }
        body { background-color: #f5f7fa; color: #333; display: flex; min-height: 100vh; font-size:14px; }
        a { text-decoration: none; color: inherit; }
        ul, li { list-style: none; }
        input, select, textarea { font-family: inherit; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background-color: #1a1a2e; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; z-index: 100; overflow-y: auto; }
        .sidebar-brand { font-size: 20px; font-weight: 700; margin-bottom: 30px; padding-left: 10px; color: #fff; letter-spacing: 1px; }
        .sidebar-menu { list-style: none; padding: 0; margin-top: 10px; }
        .menu-category { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; color: #a6a6b5; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 2px; }
        .menu-category:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .menu-category.active { color: #fff; background-color: #2c2c45; }
        .menu-arrow { font-size: 10px; transition: 0.3s; color: #666; }
        .menu-category.open .menu-arrow { transform: rotate(180deg); color: #fff; }
        .submenu { display: none; padding-left: 10px; margin-bottom: 10px; background-color: rgba(0,0,0,0.1); border-radius: 6px; }
        .submenu li a { display: block; padding: 8px 15px 8px 32px; font-size: 13px; color: #888; border-radius: 4px; transition: 0.2s; position: relative; }
        .submenu li a:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .submenu li a.active { color: #fff; font-weight: 700; background-color: #2c5bf2; }
        .menu-divider { border-top: 1px solid #2c2c45; margin: 15px 0; }
        .menu-link { display: block; padding: 12px 15px; border-radius: 8px; color: #a6a6b5; font-size: 14px; transition: 0.2s; }
        .menu-link:hover { background-color: #2c2c45; color: #fff; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; margin-left: 260px; margin-right: 350px; padding: 40px; }
        .page-header { margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1a1a1a; }

        /* ê²€ìƒ‰ì°½ */
        .search-box { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e5e5e5; margin-bottom: 20px; display: flex; gap: 10px; }
        .search-input { flex: 1; height: 42px; border: 1px solid #ddd; border-radius: 6px; padding: 0 15px; font-size: 14px; outline: none; }

        /* í…Œì´ë¸” */
        .section-box { background: #fff; border-radius: 12px; border: 1px solid #e5e5e5; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .admin-table th { background-color: #f9f9f9; color: #555; font-weight: 600; }
        .admin-table tr:hover { background-color: #fafafa; }
        .btn-gen-rep { background-color: #2c5bf2; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 12px; }

        /* ìš°ì¸¡ íˆìŠ¤í† ë¦¬ íŒ¨ë„ */
        .right-panel {
            width: 350px; background-color: #fff; border-left: 1px solid #eee;
            position: fixed; right: 0; top: 0; height: 100vh; padding: 30px 20px;
            z-index: 90; overflow-y: auto; box-shadow: -4px 0 20px rgba(0,0,0,0.02);
        }
        .rp-title { font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    </style>
</head>
<body>

    <!-- ì‚¬ì´ë“œë°”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->

<main class="main-content">
    <h2 class="page-title">ğŸ“Š ë¦¬í¬íŠ¸ ë°œì†¡ ê´€ë¦¬ (ê¸°ì—…ë³„)</h2>
    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="ê¸°ì—…ëª…, ëŒ€í‘œìëª… ê²€ìƒ‰.." onkeyup="filterCompanies()">
    </div>
    <div class="section-box">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ê¸°ì—…ëª… (ì‚¬ì—…ìë²ˆí˜¸)</th>
                    <th>ëŒ€í‘œì</th>
                    <th>ì§ì› ìˆ˜</th>
                    <th>ë¦¬í¬íŠ¸ ìƒì„±</th>
                </tr>
            </thead>
            <tbody id="companyListBody">
                <tr><td colspan="4" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<aside class="right-panel">
    <div class="rp-title">ğŸ“œ ìµœê·¼ ë°œì†¡ ì´ë ¥ (History)</div>
    <div id="historyList">
        <div style="text-align:center; color:#999; padding:20px;">ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</aside>

    <!-- ë¦¬í¬íŠ¸ ìƒì„± ëª¨ë‹¬ -->
    <div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center;">
        <div style="background: #fff; padding: 30px; border-radius: 12px; width: 700px;">
            <h3 style="margin-top:0; margin-bottom:20px;">ë¦¬í¬íŠ¸ ìƒì„±: <span id="modalCompanyName"></span></h3>
            <input type="hidden" id="targetUid">
            <input type="hidden" id="targetBizNum">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="form-group">
                    <label>ë¦¬í¬íŠ¸ ì œëª©</label>
                    <input type="text" id="reportTitle" class="search-input" style="width:100%; height:40px;">
                </div>
                <div class="form-group">
                    <label>ë¦¬í¬íŠ¸ ìœ í˜•</label>
                    <select id="reportType" class="search-input" style="width:100%; height:40px;">
                        <option value="month">ì›”ê°„ ë¦¬í¬íŠ¸</option>
                        <option value="quarter">ë¶„ê¸° ë¦¬í¬íŠ¸</option>
                        <option value="year">ì—°ê°„ ë¦¬í¬íŠ¸</option>
                        <option value="custom">ê¸°íƒ€</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>ëŒ€ìƒ ê¸°ê°„ (YYYY-MM)</label>
                <input type="month" id="reportPeriod" class="search-input" style="width:100%; height:40px;">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>ì£¼ìš” ë‚´ìš© (ìš”ì•½)</label>
                <textarea id="reportContent" class="search-input" style="width:100%; height:120px; padding-top:10px; resize:vertical;"></textarea>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeReportModal()" style="background:#f0f0f0; color:#333; border:1px solid #ccc; padding:10px 20px; border-radius:6px; font-weight:600; cursor:pointer;">ì·¨ì†Œ</button>
                <button onclick="saveReport()" style="background:#2c5bf2; color:#fff; border:none; padding:10px 20px; border-radius:6px; font-weight:700; cursor:pointer;">ìƒì„± ë° ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="../../js/admin_sidebar.js"></script>
    <script>
        // ì‚¬ì´ë“œë°” ì¦‰ì‹œ ë Œë”ë§
        if (typeof renderAdminSidebar === 'function') {
            renderAdminSidebar();
        }
    </script>
    <script type="module">
        import { auth, users, admin, reports } from '../../js/api.js';

        // ê¶Œí•œ í™•ì¸ ë° ì´ˆê¸°í™”
        (async () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                location.href = '../public/login.html';
                return;
            }

            try {
                const userData = await users.getMe();
                console.log('ğŸ” [ë¦¬í¬íŠ¸ ë°œì†¡] ì‚¬ìš©ì ì •ë³´:', userData);

                const adminRoles = ['master', 'admin', 'general_manager', 'lawyer'];
                if (!adminRoles.includes(userData.role)) {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ê¶Œí•œ: ' + userData.role);
                    location.href = '../user/dashboard.html';
                    return;
                }

                await loadCompanies();
                await loadReportHistory();

            } catch (error) {
                console.error('ê¶Œí•œ í™•ì¸ ì—ëŸ¬:', error);
                alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                location.href = '../public/login.html';
            }
        })();

        // íšŒì‚¬ ëª©ë¡ ë¡œë“œ
        async function loadCompanies() {
            try {
                const result = await admin.getCompanies();
                const companies = result.companies || [];

                const tbody = document.getElementById('companyListBody');

                if (companies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">ë“±ë¡ëœ ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = companies.map(company => `
                    <tr>
                        <td>
                            <strong>${company.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong><br>
                            <span style="font-size:12px; color:#888;">${company.bizNum || '-'}</span>
                        </td>
                        <td>${company.managerName || '-'}</td>
                        <td>${company.employeeCount || 0}ëª…</td>
                        <td>
                            <button class="btn-gen-rep" onclick="openReportModal('${company.uid}', '${company.companyName}', '${company.bizNum}')">
                                ë¦¬í¬íŠ¸ ìƒì„±
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                let errorMsg = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#ff4d4f;">';
                errorMsg += '<h3 style="margin-bottom:10px;">âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h3>';

                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    errorMsg += '<p>âŒ ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    errorMsg += '<p style="font-size:12px; color:#666; margin-top:10px;">ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: http://localhost:3000</p>';
                } else {
                    errorMsg += '<p>' + error.message + '</p>';
                }

                errorMsg += '</td></tr>';
                document.getElementById('companyListBody').innerHTML = errorMsg;
            }
        }

        // ë¦¬í¬íŠ¸ ë°œì†¡ ì´ë ¥ ë¡œë“œ
        async function loadReportHistory() {
            try {
                const result = await reports.getAll({ limit: 10 });
                const reportsList = result.reports || [];

                const historyContainer = document.getElementById('historyList');

                if (reportsList.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ë°œì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                historyContainer.innerHTML = reportsList.map(report => {
                    const date = report.createdAt ? new Date(report.createdAt).toLocaleDateString('ko-KR') : '-';
                    return `
                        <div style="padding:15px; border-bottom:1px solid #f0f0f0;">
                            <div style="font-weight:700; color:#333; margin-bottom:4px; font-size:14px;">
                                ${report.companyName || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                            </div>
                            <div style="font-size:12px; color:#888;">
                                ${date} | ${report.reportType || 'ì›”ê°„ ë¦¬í¬íŠ¸'}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('historyList').innerHTML =
                    '<div style="text-align:center; color:#999; padding:20px;">ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // ê²€ìƒ‰ í•„í„°
        window.filterCompanies = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#companyListBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // ë¦¬í¬íŠ¸ ëª¨ë‹¬ ì—´ê¸° (ì¶”í›„ êµ¬í˜„)
        window.openReportModal = function(uid, companyName, bizNum) {
            document.getElementById('reportModal').style.display = 'flex';
            document.getElementById('modalCompanyName').innerText = companyName;
            document.getElementById('targetUid').value = uid;
            document.getElementById('targetBizNum').value = bizNum;

            // í¼ ì´ˆê¸°í™”
            document.getElementById('reportTitle').value = '';
            document.getElementById('reportType').value = 'month';
            document.getElementById('reportPeriod').value = new Date().toISOString().slice(0, 7); // YYYY-MM í˜•ì‹
            document.getElementById('reportContent').value = '';
        }

        window.closeReportModal = function() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // ë¦¬í¬íŠ¸ ì €ì¥
        window.saveReport = async function() {
            const payload = {
                title: document.getElementById('reportTitle').value,
                type: document.getElementById('reportType').value,
                period: document.getElementById('reportPeriod').value,
                content: document.getElementById('reportContent').value,
                targetBizNum: document.getElementById('targetBizNum').value,
                status: 'draft' // ì´ˆê¸° ìƒíƒœëŠ” 'ì´ˆì•ˆ'
            };

            if (!payload.title || !payload.period || !payload.targetBizNum) {
                alert('ì œëª©, ëŒ€ìƒ ê¸°ê°„, ëŒ€ìƒ ê¸°ì—… ì •ë³´ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            try {
                await reports.create(payload);
                alert('ë¦¬í¬íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeReportModal();
                await loadReportHistory(); // ì´ë ¥ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                alert(`ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }
    </script>
</body>
</html>
